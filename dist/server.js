!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=43)}([function(e,t){e.exports=require("rxjs")},function(e,t){e.exports=require("rxjs/operators")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(32);t.isDot=r.isDot;var o=n(8);t.IdentifierTuple=o.IdentifierTuple;var i=n(6);t.Identifier=i.Identifier;var s=n(5);t.IdentifierInterval=s.IdentifierInterval;var a=n(7);t.LogootSBlock=a.LogootSBlock;var c=n(31);t.LogootSRopes=c.LogootSRopes;var l=n(14);t.RopesNodes=l.RopesNodes;var u=n(16);t.LogootSAdd=u.LogootSAdd;var h=n(15);t.LogootSDel=h.LogootSDel;var d=n(13);t.TextDelete=d.TextDelete;var p=n(12);t.TextInsert=p.TextInsert;var f=n(11);t.insert=f.insert,t.del=f.del,t.occurrences=f.occurrences},function(e,t,n){"use strict";function r(e){return Number.isSafeInteger(e)&&t.INT32_BOTTOM<=e&&e<=t.INT32_TOP}Object.defineProperty(t,"__esModule",{value:!0}),t.INT32_BOTTOM=-2147483648,t.INT32_TOP=2147483647,t.isInt32=r,t.randomInt32=function(e,t){console.assert(r(e),"l must be an int32"),console.assert(r(t),"u must be an int32"),console.assert(e<t,"u is greater than l");var n=Math.random()*(t-e)+e,o=Math.floor(n);return console.assert(r(o)&&e<=o&&o<t,"result is an integer 32 in [l, u["),o}},function(e,t){e.exports=require("protobufjs/minimal")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),o=n(3),i=function(){function e(e,t){console.assert(o.isInt32(t),"end ∈ int32"),console.assert(e.lastOffset<=t,"idBegin must be less than or equal to idEnd"),this.idBegin=e,this.end=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=r.Identifier.fromPlain(t.idBegin);if(null!==n&&"number"==typeof t.end&&o.isInt32(t.end)&&n.lastOffset<=t.end)return new e(n,t.end)}return null},Object.defineProperty(e.prototype,"begin",{get:function(){return this.idBegin.lastOffset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"idEnd",{get:function(){return this.getBaseId(this.end)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.end-this.begin+1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){return this.idBegin.base},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dot",{get:function(){return this.idBegin.dot},enumerable:!0,configurable:!0}),e.prototype.equals=function(e){return this.idBegin.equals(e.idBegin)&&this.begin===e.begin&&this.end===e.end},e.prototype.union=function(t,n){console.assert(o.isInt32(t),"aBegin ∈ int32"),console.assert(o.isInt32(n),"aEnd ∈ int32");var i=Math.min(this.begin,t),s=Math.max(this.end,n);return new e(r.Identifier.fromBase(this.idBegin,i),s)},e.prototype.containsId=function(e){return-1===this.idBegin.compareTo(e)&&1===this.idEnd.compareTo(e)},e.prototype.getBaseId=function(e){return console.assert(o.isInt32(e),"offset ∈ int32"),console.assert(this.begin<=e&&e<=this.end,"offset must be included in the interval"),r.Identifier.fromBase(this.idBegin,e)},e.prototype.digest=function(){return 17*this.idBegin.digest()+this.end|0},e.prototype.toString=function(){return"IdInterval["+this.idBegin.tuples.join(",")+" .. "+this.end+"]"},e}();t.IdentifierInterval=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(8),o=n(3),i=function(){function e(e){console.assert(e.length>0,"tuples must not be empty");var t=e[e.length-1].random;console.assert(t>o.INT32_BOTTOM),this.tuples=e}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.tuples;if(n instanceof Array&&n.length>0){for(var i=!0,s=0,a=[];i&&s<n.length;){var c=r.IdentifierTuple.fromPlain(n[s]);null!==c?a.push(c):i=!1,s++}if(i&&a[a.length-1].random>o.INT32_BOTTOM)return new e(a)}}return null},e.fromBase=function(t,n){return console.assert(o.isInt32(n),"offset ∈ int32"),new e(t.tuples.map(function(e,o){return o===t.length-1?r.IdentifierTuple.fromBase(e,n):e}))},Object.defineProperty(e.prototype,"generator",{get:function(){return this.tuples[this.tuples.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.tuples.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"replicaNumber",{get:function(){return this.tuples[this.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clock",{get:function(){return this.tuples[this.length-1].clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dot",{get:function(){return{replicaNumber:this.replicaNumber,clock:this.clock}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastOffset",{get:function(){return this.tuples[this.length-1].offset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){var e=this.tuples.reduce(function(e,t){return e.concat(t.asArray())},[]);return e.pop(),e},enumerable:!0,configurable:!0}),e.prototype.longestCommonPrefix=function(e){for(var t=[],n=Math.min(this.tuples.length,e.tuples.length),r=0;r<n&&this.tuples[r].equals(e.tuples[r]);)t.push(this.tuples[r]),r++;return t},e.prototype.longestCommonBase=function(e){for(var t=[],n=Math.min(this.tuples.length,e.tuples.length),r=0,o=!1;!o&&r<n;){var i=this.tuples[r],s=e.tuples[r];i.equals(s)?t.push(i):(o=!0,i.equalsBase(s)&&t.push(i)),r++}return t},e.prototype.isPrefix=function(e){return this.isBasePrefix(e)&&this.lastOffset===e.tuples[this.length-1].offset},e.prototype.isBasePrefix=function(e){var t=this;return this.length<=e.length&&this.tuples.every(function(n,r){var o=e.tuples[r];return r===t.tuples.length-1?n.equalsBase(o):n.equals(o)})},e.prototype.commonPrefixLength=function(e){for(var t=Math.min(this.tuples.length,e.tuples.length),n=0;n<t&&this.tuples[n].equals(e.tuples[n]);)n++;return n},e.prototype.equals=function(e){return this.equalsBase(e)&&this.lastOffset===e.lastOffset},e.prototype.equalsBase=function(e){var t=this;return this.length===e.length&&this.tuples.every(function(n,r){var o=e.tuples[r];return r<t.length-1?n.equals(o):n.equalsBase(o)})},e.prototype.compareTo=function(e){if(this.equals(e))return 0;if(this.isPrefix(e))return-1;if(e.isPrefix(this))return 1;var t=this.commonPrefixLength(e);return this.tuples[t].compareTo(e.tuples[t])},e.prototype.hasPlaceAfter=function(e){return console.assert(o.isInt32(e),"length ∈ int32"),console.assert(e>0,"length > 0 "),this.lastOffset<=o.INT32_TOP-e},e.prototype.hasPlaceBefore=function(e){return console.assert(o.isInt32(e),"length ∈ int32"),console.assert(e>0,"length > 0 "),this.lastOffset>=o.INT32_BOTTOM+e},e.prototype.maxOffsetBeforeNext=function(e,t){if(console.assert(o.isInt32(t),"max ∈ int32"),console.assert(-1===this.compareTo(e),"this must be less than next"),this.equalsBase(e))return console.assert(t<e.lastOffset,"max must be less than next.lastOffset"),t;if(this.isBasePrefix(e)){var n=e.tuples[this.length-1].offset;return Math.min(n,t)}return t},e.prototype.minOffsetAfterPrev=function(e,t){if(console.assert(o.isInt32(t),"min ∈ int32"),this.equalsBase(e))return console.assert(t>e.lastOffset,"min must be greater than prev.lastOffset"),t;if(this.isBasePrefix(e)){var n=e.tuples[this.length-1].offset;return Math.max(n+1,t)}return t},e.prototype.digest=function(){return this.tuples.reduce(function(e,t){return 17*e+t.digest()|0},0)},e.prototype.toString=function(){return"Id["+this.tuples.join(",")+"]"},e}();t.Identifier=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5),o=n(3),i=function(){function e(e,t){console.assert(o.isInt32(t)&&t>=0,"nbElt must be a non-negative integer"),this.idInterval=e,this.nbElement=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.idInterval,i=t.nbElement;if(n instanceof Object&&"number"==typeof i&&o.isInt32(i)&&i>=0){var s=r.IdentifierInterval.fromPlain(n);if(null!==s)return new e(s,i)}}return null},e.prototype.isMine=function(e){return this.idInterval.idBegin.generator===e},e.prototype.addBlock=function(e,t){console.assert(o.isInt32(t)&&t>0,"length must be a positive int32"),this.nbElement+=t,this.idInterval=this.idInterval.union(e,e+t-1)},e.prototype.delBlock=function(e){console.assert(o.isInt32(e)&&e>0,"nbElt must be a positive int32"),this.nbElement-=e},e.prototype.toString=function(){return"{"+this.nbElement+","+this.idInterval.toString()+"}"},e}();t.LogootSBlock=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=function(){function e(e,t,n,o){console.assert([e,t,n,o].every(r.isInt32),"each value ∈ int32"),this.random=e,this.replicaNumber=t,this.clock=n,this.offset=o}return e.fromPlain=function(t){return"object"==typeof t&&null!==t&&"number"==typeof t.random&&r.isInt32(t.random)&&"number"==typeof t.replicaNumber&&r.isInt32(t.replicaNumber)&&"number"==typeof t.clock&&r.isInt32(t.clock)&&"number"==typeof t.offset&&r.isInt32(t.offset)?new e(t.random,t.replicaNumber,t.clock,t.offset):null},e.fromBase=function(t,n){return console.assert(r.isInt32(n),"offset ∈ int32"),new e(t.random,t.replicaNumber,t.clock,n)},e.prototype.compareTo=function(e){for(var t=this.asArray(),n=e.asArray(),r=0;r<t.length&&t[r]===n[r];)r++;return r===t.length?0:t[r]<n[r]?-1:1},e.prototype.equals=function(e){return this.equalsBase(e)&&this.offset===e.offset},e.prototype.equalsBase=function(e){return this.random===e.random&&this.replicaNumber===e.replicaNumber&&this.clock===e.clock},e.prototype.asArray=function(){return[this.random,this.replicaNumber,this.clock,this.offset]},e.prototype.digest=function(){return this.asArray().reduce(function(e,t){return 17*e+t|0},0)},e.prototype.toString=function(){return this.random+","+this.replicaNumber+","+this.clock+","+this.offset},e}();t.IdentifierTuple=o},function(e,t,n){"use strict";n.r(t);var r={};try{var o=n(!function(){var e=new Error("Cannot find module 'wrtc'");throw e.code="MODULE_NOT_FOUND",e}());r.RTCPeerConnection=o.RTCPeerConnection,r.RTCIceCandidate=o.RTCIceCandidate}catch(e){console.warn(e.message)}r.WebSocket=n(18);var i=n(36);r.TextEncoder=i.TextEncoder,r.TextDecoder=i.TextDecoder,r.cryptoNode=n(17);var s,a=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s},c=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(a(arguments[t]));return e},l="background-color: #FFCA28; padding: 0 3px",u="background-color: #b3ba2e; padding: 0 3px",h="background-color: #CE93D8; padding: 0 3px",d="background-color: #90CAF9; padding: 0 3px",p="background-color: #26A69A; padding: 0 3px",f="background-color: #66BB6A; padding: 0 3px",g="background-color: #F57C00; padding: 0 3px",b="background-color: #9FA8DA; padding: 0 2px",y="background-color: #EF9A9A; padding: 0 2px",m="background-color: #FF5252; padding: 0 2px",v={webgroup:function(){},signalingState:function(){},webGroupState:function(){},webrtc:function(){},channel:function(){},topology:function(){},signaling:function(){},channelBuilder:function(){},debug:function(){},warn:function(){}};!function(e){e[e.DEBUG=0]="DEBUG",e[e.WEB_GROUP=1]="WEB_GROUP",e[e.WEBRTC=2]="WEBRTC",e[e.CHANNEL=3]="CHANNEL",e[e.TOPOLOGY=4]="TOPOLOGY",e[e.SIGNALING=5]="SIGNALING",e[e.CHANNEL_BUILDER=6]="CHANNEL_BUILDER"}(s||(s={}));var S=[];function w(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];(S=e).includes(s.WEB_GROUP)?(v.webgroup=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WebGroup%c: "+e,l,""):console.info.apply(console,c(["%cNETFLUX WebGroup%c: "+e,l,""],t))},v.signalingState=function(e,t){console.info("%cNETFLUX "+t+" WebGroup%c: Signaling: %c"+e+"%c",l,"",b,"")},v.webGroupState=function(e,t){console.info("%cNETFLUX "+t+" WebGroup%c: WebGroup: %c"+e+"%c",l,"",y,"")}):(v.webgroup=function(){},v.signalingState=function(){},v.webGroupState=function(){}),S.includes(s.WEBRTC)?v.webrtc=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WebRTC%c: "+e,h,""):console.info.apply(console,c(["%cNETFLUX WebRTC%c: "+e,h,""],t))}:v.webrtc=function(){},S.includes(s.CHANNEL)?v.channel=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Channel%c: "+e,d,""):console.info.apply(console,c(["%cNETFLUX Channel%c: "+e,d,""],t))}:v.channel=function(){},S.includes(s.TOPOLOGY)?v.topology=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Topology%c: "+e,p,""):console.info.apply(console,c(["%cNETFLUX Topology%c: "+e,p,""],t))}:v.topology=function(){},S.includes(s.SIGNALING)?v.signaling=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Signaling%c: "+e,f,""):console.info.apply(console,c(["%cNETFLUX Signaling%c: "+e,f,""],t))}:v.signaling=function(){},S.includes(s.CHANNEL_BUILDER)?v.channelBuilder=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX ChannelBuilder%c: "+e,g,""):console.info.apply(console,c(["%cNETFLUX ChannelBuilder%c: "+e,g,""],t))}:v.channelBuilder=function(){},S.includes(s.DEBUG)?v.debug=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Debug%c: "+e,u,""):console.info.apply(console,c(["%cNETFLUX Debug%c: "+e,u,""],t))}:v.debug=function(){},v.warn=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WARNING%c: "+e,m,""):console.info.apply(console,c(["%cNETFLUX WARNING%c: "+e,m,""],t))}}var I=2147483648,O="undefined"!=typeof window;function j(){return!O||navigator.onLine}function k(){return!O||"visible"===document.visibilityState}function M(e){if(!new RegExp(/^(wss|ws):\/\/((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])|(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]))(:[0-9]{1,5})?(\/.*)?$/,"i").test(e))throw new Error("Invalid URL: "+e)}function T(e){void 0===e&&(e=[]);var t=L()[0];return t<I&&(t+=I),e.includes(t)?T(e):t}var E=512;function C(e){return e.split("/")[2]}function L(e){var t;if(void 0===e&&(e=1),O)t=new Uint32Array(e),r.crypto.getRandomValues(t);else{t=[];for(var n=r.cryptoNode.randomBytes(4*e),o=0;o<n.length;o+=4)t[t.length]=n.readUInt32BE(o,!0)}return t}function R(){return!!r.WebSocket}var N,B,P=n(0),D=n(1),x=function(){function e(e,t){this.serviceId=e,this.proto=t}return e.prototype.useWebChannelStream=function(e){var t=this;return{id:e.STREAM_ID,message:e.messageFromStream.pipe(Object(D.filter)(function(e){return e.serviceId===t.serviceId}),Object(D.map)(function(e){var n=e.channel,r=e.senderId,o=e.recipientId,i=e.content;return{channel:n,senderId:r,recipientId:o,msg:t.decode(i)}}),Object(D.filter)(function(e){var t=e.msg;return t&&t.type})),send:function(n,r){e.sendOverStream({senderId:e.myId,recipientId:r,serviceId:t.serviceId,content:n instanceof Uint8Array?n:t.encode(n)})}}},e.prototype.useSignalingStream=function(e){var t=this;return{id:e.STREAM_ID,message:e.messageFromStream.pipe(Object(D.filter)(function(e){return e.serviceId===t.serviceId}),Object(D.map)(function(e){var n=e.senderId,r=e.recipientId,o=e.content;return{senderId:n,recipientId:r,msg:t.decode(o)}}),Object(D.filter)(function(e){var t=e.msg;return t&&t.type})),send:function(n,r,o){e.sendOverStream({senderId:o,recipientId:r,serviceId:t.serviceId,content:n instanceof Uint8Array?n:t.encode(n)})}}},e.prototype.useAllStreams=function(e,t){var n=this.useWebChannelStream(e),r=this.useSignalingStream(t);return{message:Object(P.merge)(n.message.pipe(Object(D.map)(function(e){var t=e.senderId,r=e.recipientId,o=e.msg;return{streamId:n.id,senderId:t,recipientId:r,msg:o}})),r.message.pipe(Object(D.map)(function(e){var t=e.senderId,n=e.recipientId,o=e.msg;return{streamId:r.id,senderId:t,recipientId:n,msg:o}}))),sendOver:function(e,t,o,i){e===n.id?n.send(t,o):r.send(t,o,i)}}},e.prototype.encode=function(e){return this.proto.encode(this.proto.create(e)).finish()},e.prototype.decode=function(e){try{return this.proto.decode(e)}catch(e){v.warn("Decode service message error: ",e)}return{type:void 0}},e}(),A=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(e){e[e.FULL_MESH=0]="FULL_MESH"}(N||(N={})),function(e){e[e.CONSTRUCTING=0]="CONSTRUCTING",e[e.CONSTRUCTED=1]="CONSTRUCTED",e[e.IDLE=2]="IDLE"}(B||(B={}));var _=function(e){function t(t,n,r){var o=e.call(this,n,r)||this;return o.wc=t,o.wcStream=e.prototype.useWebChannelStream.call(o,t),o.stateSubject=new P.Subject,o._state=B.IDLE,o}return A(t,e),Object.defineProperty(t.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),t.prototype.setJoinedState=function(){this.setState(B.CONSTRUCTED)},t.prototype.setState=function(e){this.state!==e&&(v.topology("Topology state = "+B[e]),this._state=e,this.stateSubject.next(e))},t}(x),U="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function G(e,t){return e(t={exports:{}},t.exports),t.exports}var F=function(e,t){var n=new Array(arguments.length-1),r=0,o=2,i=!0;for(;o<arguments.length;)n[r++]=arguments[o++];return new Promise(function(o,s){n[r]=function(e){if(i)if(i=!1,e)s(e);else{for(var t=new Array(arguments.length-1),n=0;n<t.length;)t[n++]=arguments[n];o.apply(null,t)}};try{e.apply(t||null,n)}catch(e){i&&(i=!1,s(e))}})};var q=G(function(e,t){var n=t;n.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&"="===e.charAt(t);)++n;return Math.ceil(3*e.length)/4-n};for(var r=new Array(64),o=new Array(123),i=0;i<64;)o[r[i]=i<26?i+65:i<52?i+71:i<62?i-4:i-59|43]=i++;n.encode=function(e,t,n){for(var o,i=null,s=[],a=0,c=0;t<n;){var l=e[t++];switch(c){case 0:s[a++]=r[l>>2],o=(3&l)<<4,c=1;break;case 1:s[a++]=r[o|l>>4],o=(15&l)<<2,c=2;break;case 2:s[a++]=r[o|l>>6],s[a++]=r[63&l],c=0}a>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,s)),a=0)}return c&&(s[a++]=r[o],s[a++]=61,1===c&&(s[a++]=61)),i?(a&&i.push(String.fromCharCode.apply(String,s.slice(0,a))),i.join("")):String.fromCharCode.apply(String,s.slice(0,a))};n.decode=function(e,t,n){for(var r,i=n,s=0,a=0;a<e.length;){var c=e.charCodeAt(a++);if(61===c&&s>1)break;if(void 0===(c=o[c]))throw Error("invalid encoding");switch(s){case 0:r=c,s=1;break;case 1:t[n++]=r<<2|(48&c)>>4,r=c,s=2;break;case 2:t[n++]=(15&r)<<4|(60&c)>>2,r=c,s=3;break;case 3:t[n++]=(3&r)<<6|c,s=0}}if(1===s)throw Error("invalid encoding");return n-i},n.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}}),W=H;function H(){this._listeners={}}H.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this},H.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var n=this._listeners[e],r=0;r<n.length;)n[r].fn===t?n.splice(r,1):++r;return this},H.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],r=1;r<arguments.length;)n.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,n)}return this};var z=J(J);function J(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),n=new Uint8Array(t.buffer),r=128===n[3];function o(e,r,o){t[0]=e,r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2],r[o+3]=n[3]}function i(e,r,o){t[0]=e,r[o]=n[3],r[o+1]=n[2],r[o+2]=n[1],r[o+3]=n[0]}function s(e,r){return n[0]=e[r],n[1]=e[r+1],n[2]=e[r+2],n[3]=e[r+3],t[0]}function a(e,r){return n[3]=e[r],n[2]=e[r+1],n[1]=e[r+2],n[0]=e[r+3],t[0]}e.writeFloatLE=r?o:i,e.writeFloatBE=r?i:o,e.readFloatLE=r?s:a,e.readFloatBE=r?a:s}():function(){function t(e,t,n,r){var o=t<0?1:0;if(o&&(t=-t),0===t)e(1/t>0?0:2147483648,n,r);else if(isNaN(t))e(2143289344,n,r);else if(t>3.4028234663852886e38)e((o<<31|2139095040)>>>0,n,r);else if(t<1.1754943508222875e-38)e((o<<31|Math.round(t/1.401298464324817e-45))>>>0,n,r);else{var i=Math.floor(Math.log(t)/Math.LN2);e((o<<31|i+127<<23|8388607&Math.round(t*Math.pow(2,-i)*8388608))>>>0,n,r)}}function n(e,t,n){var r=e(t,n),o=2*(r>>31)+1,i=r>>>23&255,s=8388607&r;return 255===i?s?NaN:o*(1/0):0===i?1.401298464324817e-45*o*s:o*Math.pow(2,i-150)*(s+8388608)}e.writeFloatLE=t.bind(null,K),e.writeFloatBE=t.bind(null,Q),e.readFloatLE=n.bind(null,V),e.readFloatBE=n.bind(null,X)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),n=new Uint8Array(t.buffer),r=128===n[7];function o(e,r,o){t[0]=e,r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2],r[o+3]=n[3],r[o+4]=n[4],r[o+5]=n[5],r[o+6]=n[6],r[o+7]=n[7]}function i(e,r,o){t[0]=e,r[o]=n[7],r[o+1]=n[6],r[o+2]=n[5],r[o+3]=n[4],r[o+4]=n[3],r[o+5]=n[2],r[o+6]=n[1],r[o+7]=n[0]}function s(e,r){return n[0]=e[r],n[1]=e[r+1],n[2]=e[r+2],n[3]=e[r+3],n[4]=e[r+4],n[5]=e[r+5],n[6]=e[r+6],n[7]=e[r+7],t[0]}function a(e,r){return n[7]=e[r],n[6]=e[r+1],n[5]=e[r+2],n[4]=e[r+3],n[3]=e[r+4],n[2]=e[r+5],n[1]=e[r+6],n[0]=e[r+7],t[0]}e.writeDoubleLE=r?o:i,e.writeDoubleBE=r?i:o,e.readDoubleLE=r?s:a,e.readDoubleBE=r?a:s}():function(){function t(e,t,n,r,o,i){var s=r<0?1:0;if(s&&(r=-r),0===r)e(0,o,i+t),e(1/r>0?0:2147483648,o,i+n);else if(isNaN(r))e(0,o,i+t),e(2146959360,o,i+n);else if(r>1.7976931348623157e308)e(0,o,i+t),e((s<<31|2146435072)>>>0,o,i+n);else{var a;if(r<2.2250738585072014e-308)e((a=r/5e-324)>>>0,o,i+t),e((s<<31|a/4294967296)>>>0,o,i+n);else{var c=Math.floor(Math.log(r)/Math.LN2);1024===c&&(c=1023),e(4503599627370496*(a=r*Math.pow(2,-c))>>>0,o,i+t),e((s<<31|c+1023<<20|1048576*a&1048575)>>>0,o,i+n)}}}function n(e,t,n,r,o){var i=e(r,o+t),s=e(r,o+n),a=2*(s>>31)+1,c=s>>>20&2047,l=4294967296*(1048575&s)+i;return 2047===c?l?NaN:a*(1/0):0===c?5e-324*a*l:a*Math.pow(2,c-1075)*(l+4503599627370496)}e.writeDoubleLE=t.bind(null,K,0,4),e.writeDoubleBE=t.bind(null,Q,4,0),e.readDoubleLE=n.bind(null,V,0,4),e.readDoubleBE=n.bind(null,X,4,0)}(),e}function K(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}function Q(e,t,n){t[n]=e>>>24,t[n+1]=e>>>16&255,t[n+2]=e>>>8&255,t[n+3]=255&e}function V(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function X(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}var $=function(e){try{var t=void 0;if(t&&(t.length||Object.keys(t).length))return t}catch(e){}return null};var Y=G(function(e,t){var n=t;n.length=function(e){for(var t=0,n=0,r=0;r<e.length;++r)(n=e.charCodeAt(r))<128?t+=1:n<2048?t+=2:55296==(64512&n)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t},n.read=function(e,t,n){if(n-t<1)return"";for(var r,o=null,i=[],s=0;t<n;)(r=e[t++])<128?i[s++]=r:r>191&&r<224?i[s++]=(31&r)<<6|63&e[t++]:r>239&&r<365?(r=((7&r)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,i[s++]=55296+(r>>10),i[s++]=56320+(1023&r)):i[s++]=(15&r)<<12|(63&e[t++])<<6|63&e[t++],s>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,i)),s=0);return o?(s&&o.push(String.fromCharCode.apply(String,i.slice(0,s))),o.join("")):String.fromCharCode.apply(String,i.slice(0,s))},n.write=function(e,t,n){for(var r,o,i=n,s=0;s<e.length;++s)(r=e.charCodeAt(s))<128?t[n++]=r:r<2048?(t[n++]=r>>6|192,t[n++]=63&r|128):55296==(64512&r)&&56320==(64512&(o=e.charCodeAt(s+1)))?(r=65536+((1023&r)<<10)+(1023&o),++s,t[n++]=r>>18|240,t[n++]=r>>12&63|128,t[n++]=r>>6&63|128,t[n++]=63&r|128):(t[n++]=r>>12|224,t[n++]=r>>6&63|128,t[n++]=63&r|128);return n-i}}),Z=function(e,t,n){var r=n||8192,o=r>>>1,i=null,s=r;return function(n){if(n<1||n>o)return e(n);s+n>r&&(i=e(r),s=0);var a=t.call(i,s,s+=n);return 7&s&&(s=1+(7|s)),a}};var ee=te;function te(e,t){this.lo=e>>>0,this.hi=t>>>0}var ne=te.zero=new te(0,0);ne.toNumber=function(){return 0},ne.zzEncode=ne.zzDecode=function(){return this},ne.length=function(){return 1};var re=te.zeroHash="\0\0\0\0\0\0\0\0";te.fromNumber=function(e){if(0===e)return ne;var t=e<0;t&&(e=-e);var n=e>>>0,r=(e-n)/4294967296>>>0;return t&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new te(n,r)},te.from=function(e){if("number"==typeof e)return te.fromNumber(e);if(ae.isString(e)){if(!ae.Long)return te.fromNumber(parseInt(e,10));e=ae.Long.fromString(e)}return e.low||e.high?new te(e.low>>>0,e.high>>>0):ne},te.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+4294967296*n)}return this.lo+4294967296*this.hi},te.prototype.toLong=function(e){return ae.Long?new ae.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var oe=String.prototype.charCodeAt;te.fromHash=function(e){return e===re?ne:new te((oe.call(e,0)|oe.call(e,1)<<8|oe.call(e,2)<<16|oe.call(e,3)<<24)>>>0,(oe.call(e,4)|oe.call(e,5)<<8|oe.call(e,6)<<16|oe.call(e,7)<<24)>>>0)},te.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},te.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},te.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},te.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10};var ie,se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ae=G(function(e,t){var n=t;function r(e,t,n){for(var r=Object.keys(t),o=0;o<r.length;++o)void 0!==e[r[o]]&&n||(e[r[o]]=t[r[o]]);return e}function o(e){function t(e,n){if(!(this instanceof t))return new t(e,n);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}n.asPromise=F,n.base64=q,n.EventEmitter=W,n.float=z,n.inquire=$,n.utf8=Y,n.pool=Z,n.LongBits=ee,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=Boolean(U.process&&U.process.versions&&U.process.versions.node),n.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},n.isString=function(e){return"string"==typeof e||e instanceof String},n.isObject=function(e){return e&&"object"===(void 0===e?"undefined":se(e))},n.isset=n.isSet=function(e,t){var n=e[t];return!(null==n||!e.hasOwnProperty(t))&&("object"!==(void 0===n?"undefined":se(n))||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},n.Buffer=function(){try{var e=n.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(e){return"number"==typeof e?n.Buffer?n._Buffer_allocUnsafe(e):new n.Array(e):n.Buffer?n._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=U.dcodeIO&&U.dcodeIO.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(e){return e?n.LongBits.from(e).toHash():n.LongBits.zeroHash},n.longFromHash=function(e,t){var r=n.LongBits.fromHash(e);return n.Long?n.Long.fromBits(r.lo,r.hi,t):r.toNumber(Boolean(t))},n.merge=r,n.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},n.newError=o,n.ProtocolError=o("ProtocolError"),n.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var e=Object.keys(this),n=e.length-1;n>-1;--n)if(1===t[e[n]]&&void 0!==this[e[n]]&&null!==this[e[n]])return e[n]}},n.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var e=n.Buffer;e?(n._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,n){return new e(t,n)},n._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):n._Buffer_from=n._Buffer_allocUnsafe=null}}),ce=fe,le=ae.LongBits,ue=ae.base64,he=ae.utf8;function de(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}function pe(){}function fe(){this.len=0,this.head=new de(pe,0,0),this.tail=this.head,this.states=null}function ge(e,t,n){t[n]=255&e}function be(e,t){this.len=e,this.next=void 0,this.val=t}function ye(e,t,n){for(;e.hi;)t[n++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[n++]=127&e.lo|128,e.lo=e.lo>>>7;t[n++]=e.lo}function me(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}fe.create=ae.Buffer?function(){return(fe.create=function(){return new ie})()}:function(){return new fe},fe.alloc=function(e){return new ae.Array(e)},ae.Array!==Array&&(fe.alloc=ae.pool(fe.alloc,ae.Array.prototype.subarray)),fe.prototype._push=function(e,t,n){return this.tail=this.tail.next=new de(e,t,n),this.len+=t,this},be.prototype=Object.create(de.prototype),be.prototype.fn=function(e,t,n){for(;e>127;)t[n++]=127&e|128,e>>>=7;t[n]=e},fe.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new be((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},fe.prototype.int32=function(e){return e<0?this._push(ye,10,le.fromNumber(e)):this.uint32(e)},fe.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},fe.prototype.uint64=function(e){var t=le.from(e);return this._push(ye,t.length(),t)},fe.prototype.int64=fe.prototype.uint64,fe.prototype.sint64=function(e){var t=le.from(e).zzEncode();return this._push(ye,t.length(),t)},fe.prototype.bool=function(e){return this._push(ge,1,e?1:0)},fe.prototype.fixed32=function(e){return this._push(me,4,e>>>0)},fe.prototype.sfixed32=fe.prototype.fixed32,fe.prototype.fixed64=function(e){var t=le.from(e);return this._push(me,4,t.lo)._push(me,4,t.hi)},fe.prototype.sfixed64=fe.prototype.fixed64,fe.prototype.float=function(e){return this._push(ae.float.writeFloatLE,4,e)},fe.prototype.double=function(e){return this._push(ae.float.writeDoubleLE,8,e)};var ve=ae.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var r=0;r<e.length;++r)t[n+r]=e[r]};fe.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(ge,1,0);if(ae.isString(e)){var n=fe.alloc(t=ue.length(e));ue.decode(e,n,0),e=n}return this.uint32(t)._push(ve,t,e)},fe.prototype.string=function(e){var t=he.length(e);return t?this.uint32(t)._push(he.write,t,e):this._push(ge,1,0)},fe.prototype.fork=function(){return this.states=new function(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}(this),this.head=this.tail=new de(pe,0,0),this.len=0,this},fe.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new de(pe,0,0),this.len=0),this},fe.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this},fe.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t},fe._configure=function(e){ie=e};var Se=Ie;(Ie.prototype=Object.create(ce.prototype)).constructor=Ie;var we=ae.Buffer;function Ie(){ce.call(this)}Ie.alloc=function(e){return(Ie.alloc=ae._Buffer_allocUnsafe)(e)};var Oe=we&&we.prototype instanceof Uint8Array&&"set"===we.prototype.set.name?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var r=0;r<e.length;)t[n++]=e[r++]};function je(e,t,n){e.length<40?ae.utf8.write(e,t,n):t.utf8Write(e,n)}Ie.prototype.bytes=function(e){ae.isString(e)&&(e=ae._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(Oe,t,e),this},Ie.prototype.string=function(e){var t=we.byteLength(e);return this.uint32(t),t&&this._push(je,t,e),this};var ke,Me=Le,Te=ae.LongBits,Ee=ae.utf8;function Ce(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function Le(e){this.buf=e,this.pos=0,this.len=e.length}var Re="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new Le(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new Le(e);throw Error("illegal buffer")};function Ne(){var e=new Te(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw Ce(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Ce(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function Be(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function Pe(){if(this.pos+8>this.len)throw Ce(this,8);return new Te(Be(this.buf,this.pos+=4),Be(this.buf,this.pos+=4))}Le.create=ae.Buffer?function(e){return(Le.create=function(e){return ae.Buffer.isBuffer(e)?new ke(e):Re(e)})(e)}:Re,Le.prototype._slice=ae.Array.prototype.subarray||ae.Array.prototype.slice,Le.prototype.uint32=function(){var e=4294967295;return function(){if(e=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Ce(this,10);return e}}(),Le.prototype.int32=function(){return 0|this.uint32()},Le.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},Le.prototype.bool=function(){return 0!==this.uint32()},Le.prototype.fixed32=function(){if(this.pos+4>this.len)throw Ce(this,4);return Be(this.buf,this.pos+=4)},Le.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Ce(this,4);return 0|Be(this.buf,this.pos+=4)},Le.prototype.float=function(){if(this.pos+4>this.len)throw Ce(this,4);var e=ae.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},Le.prototype.double=function(){if(this.pos+8>this.len)throw Ce(this,4);var e=ae.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},Le.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Ce(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,n):t===n?new this.buf.constructor(0):this._slice.call(this.buf,t,n)},Le.prototype.string=function(){var e=this.bytes();return Ee.read(e,0,e.length)},Le.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw Ce(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw Ce(this)}while(128&this.buf[this.pos++]);return this},Le.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;;){if(4==(e=7&this.uint32()))break;this.skipType(e)}break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},Le._configure=function(e){ke=e;var t=ae.Long?"toLong":"toNumber";ae.merge(Le.prototype,{int64:function(){return Ne.call(this)[t](!1)},uint64:function(){return Ne.call(this)[t](!0)},sint64:function(){return Ne.call(this).zzDecode()[t](!1)},fixed64:function(){return Pe.call(this)[t](!0)},sfixed64:function(){return Pe.call(this)[t](!1)}})};var De=xe;function xe(e){Me.call(this,e)}(xe.prototype=Object.create(Me.prototype)).constructor=xe,ae.Buffer&&(xe.prototype._slice=ae.Buffer.prototype.slice),xe.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len))};var Ae=_e;function _e(e,t,n){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");ae.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(n)}(_e.prototype=Object.create(ae.EventEmitter.prototype)).constructor=_e,_e.prototype.rpcCall=function e(t,n,r,o,i){if(!o)throw TypeError("request must be specified");var s=this;if(!i)return ae.asPromise(e,s,t,n,r,o);if(s.rpcImpl)try{return s.rpcImpl(t,n[s.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(e,n){if(e)return s.emit("error",e,t),i(e);if(null!==n){if(!(n instanceof r))try{n=r[s.responseDelimited?"decodeDelimited":"decode"](n)}catch(e){return s.emit("error",e,t),i(e)}return s.emit("data",n,t),i(null,n)}s.end(!0)})}catch(e){return s.emit("error",e,t),void setTimeout(function(){i(e)},0)}else setTimeout(function(){i(Error("already ended"))},0)},_e.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};var Ue,Ge=G(function(e,t){t.Service=Ae}),Fe={},qe=G(function(e,t){var n=t;function r(){n.Reader._configure(n.BufferReader),n.util._configure()}n.build="minimal",n.Writer=ce,n.BufferWriter=Se,n.Reader=Me,n.BufferReader=De,n.util=ae,n.rpc=Ge,n.roots=Fe,n.configure=r,n.Writer._configure(n.BufferWriter),r()}),We=qe.Reader,He=qe.Writer,ze=qe.util,Je=qe.roots,Ke=We,Qe=He,Ve=ze,Xe=Je.default||(Je.default={}),$e=Xe.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.senderId=0,e.prototype.recipientId=0,e.prototype.serviceId=0,e.prototype.content=Ve.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.senderId&&e.hasOwnProperty("senderId")&&t.uint32(8).uint32(e.senderId),null!=e.recipientId&&e.hasOwnProperty("recipientId")&&t.uint32(16).uint32(e.recipientId),null!=e.serviceId&&e.hasOwnProperty("serviceId")&&t.uint32(24).uint32(e.serviceId),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(34).bytes(e.content),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.senderId=e.uint32();break;case 2:r.recipientId=e.uint32();break;case 3:r.serviceId=e.uint32();break;case 4:r.content=e.bytes();break;default:e.skipType(7&o)}}return r},e}(),Ye=Xe.userMessage=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.length=0,e.prototype.type=0,e.prototype.full=Ve.newBuffer([]),e.prototype.chunk=null;var t;return Object.defineProperty(e.prototype,"contentType",{get:Ve.oneOfGetter(t=["full","chunk"]),set:Ve.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.length&&e.hasOwnProperty("length")&&t.uint32(8).uint32(e.length),null!=e.type&&e.hasOwnProperty("type")&&t.uint32(16).int32(e.type),null!=e.full&&e.hasOwnProperty("full")&&t.uint32(26).bytes(e.full),null!=e.chunk&&e.hasOwnProperty("chunk")&&Xe.userMessage.Message.Chunk.encode(e.chunk,t.uint32(34).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.userMessage.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.length=e.uint32();break;case 2:r.type=e.int32();break;case 3:r.full=e.bytes();break;case 4:r.chunk=Xe.userMessage.Message.Chunk.decode(e,e.uint32());break;default:e.skipType(7&o)}}return r},e.Chunk=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.nb=0,e.prototype.content=Ve.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.nb&&e.hasOwnProperty("nb")&&t.uint32(16).uint32(e.nb),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(34).bytes(e.content),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.userMessage.Message.Chunk;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:r.nb=e.uint32();break;case 4:r.content=e.bytes();break;default:e.skipType(7&o)}}return r},e}(),e.Type=function(){var e={},t=Object.create(e);return t[e[0]="STRING"]=0,t[e[1]="U_INT_8_ARRAY"]=1,t}(),e}(),e}(),Ze=Xe.channelBuilder=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.negotiation=null,e.prototype.connectionRequest=Ve.newBuffer([]),e.prototype.connectionResponse=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ve.oneOfGetter(t=["negotiation","connectionRequest","connectionResponse"]),set:Ve.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.negotiation&&e.hasOwnProperty("negotiation")&&Xe.channelBuilder.Negotiation.encode(e.negotiation,t.uint32(10).fork()).ldelim(),null!=e.connectionRequest&&e.hasOwnProperty("connectionRequest")&&t.uint32(18).bytes(e.connectionRequest),null!=e.connectionResponse&&e.hasOwnProperty("connectionResponse")&&t.uint32(24).bool(e.connectionResponse),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channelBuilder.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.negotiation=Xe.channelBuilder.Negotiation.decode(e,e.uint32());break;case 2:r.connectionRequest=e.bytes();break;case 3:r.connectionResponse=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e.Negotiation=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.initiator=null,e.prototype.passive=null,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.initiator&&e.hasOwnProperty("initiator")&&Xe.channelBuilder.Info.encode(e.initiator,t.uint32(10).fork()).ldelim(),null!=e.passive&&e.hasOwnProperty("passive")&&Xe.channelBuilder.Info.encode(e.passive,t.uint32(18).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channelBuilder.Negotiation;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.initiator=Xe.channelBuilder.Info.decode(e,e.uint32());break;case 2:r.passive=Xe.channelBuilder.Info.decode(e,e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e.Info=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.wss="",e.prototype.wcId=0,e.prototype.wsSupported=!1,e.prototype.wsTried=!1,e.prototype.dcSupported=!1,e.prototype.dcTried=!1,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.wss&&e.hasOwnProperty("wss")&&t.uint32(18).string(e.wss),null!=e.wcId&&e.hasOwnProperty("wcId")&&t.uint32(24).uint32(e.wcId),null!=e.wsSupported&&e.hasOwnProperty("wsSupported")&&t.uint32(32).bool(e.wsSupported),null!=e.wsTried&&e.hasOwnProperty("wsTried")&&t.uint32(40).bool(e.wsTried),null!=e.dcSupported&&e.hasOwnProperty("dcSupported")&&t.uint32(48).bool(e.dcSupported),null!=e.dcTried&&e.hasOwnProperty("dcTried")&&t.uint32(56).bool(e.dcTried),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channelBuilder.Info;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:r.wss=e.string();break;case 3:r.wcId=e.uint32();break;case 4:r.wsSupported=e.bool();break;case 5:r.wsTried=e.bool();break;case 6:r.dcSupported=e.bool();break;case 7:r.dcTried=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e}(),et=Xe.fullMesh=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.members=null,e.prototype.adjacentMembers=null,e.prototype.heartbeat=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ve.oneOfGetter(t=["members","adjacentMembers","heartbeat"]),set:Ve.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.members&&e.hasOwnProperty("members")&&Xe.fullMesh.Peers.encode(e.members,t.uint32(10).fork()).ldelim(),null!=e.adjacentMembers&&e.hasOwnProperty("adjacentMembers")&&Xe.fullMesh.Peers.encode(e.adjacentMembers,t.uint32(26).fork()).ldelim(),null!=e.heartbeat&&e.hasOwnProperty("heartbeat")&&t.uint32(32).bool(e.heartbeat),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.fullMesh.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.members=Xe.fullMesh.Peers.decode(e,e.uint32());break;case 3:r.adjacentMembers=Xe.fullMesh.Peers.decode(e,e.uint32());break;case 4:r.heartbeat=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e.Peers=function(){function e(e){if(this.ids=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.ids=Ve.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Qe.create()),null!=e.ids&&e.ids.length){t.uint32(10).fork();for(var n=0;n<e.ids.length;++n)t.uint32(e.ids[n]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.fullMesh.Peers;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:if(r.ids&&r.ids.length||(r.ids=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.ids.push(e.uint32());else r.ids.push(e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e.ConnectionRequest=function(){function e(e){if(this.adjacentIds=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.adjacentIds=Ve.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Qe.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.adjacentIds&&e.adjacentIds.length){t.uint32(18).fork();for(var n=0;n<e.adjacentIds.length;++n)t.uint32(e.adjacentIds[n]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.fullMesh.ConnectionRequest;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:if(r.adjacentIds&&r.adjacentIds.length||(r.adjacentIds=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.adjacentIds.push(e.uint32());else r.adjacentIds.push(e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e}(),tt=Xe.dataChannelBuilder=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.offer="",e.prototype.answer="",e.prototype.candidate=null;var t;return Object.defineProperty(e.prototype,"type",{get:Ve.oneOfGetter(t=["offer","answer","candidate"]),set:Ve.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.offer&&e.hasOwnProperty("offer")&&t.uint32(10).string(e.offer),null!=e.answer&&e.hasOwnProperty("answer")&&t.uint32(18).string(e.answer),null!=e.candidate&&e.hasOwnProperty("candidate")&&Xe.dataChannelBuilder.IceCandidate.encode(e.candidate,t.uint32(26).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.dataChannelBuilder.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.offer=e.string();break;case 2:r.answer=e.string();break;case 3:r.candidate=Xe.dataChannelBuilder.IceCandidate.decode(e,e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e.IceCandidate=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.candidate="",e.prototype.sdpMid="",e.prototype.sdpMLineIndex=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.candidate&&e.hasOwnProperty("candidate")&&t.uint32(10).string(e.candidate),null!=e.sdpMid&&e.hasOwnProperty("sdpMid")&&t.uint32(18).string(e.sdpMid),null!=e.sdpMLineIndex&&e.hasOwnProperty("sdpMLineIndex")&&t.uint32(24).uint32(e.sdpMLineIndex),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.dataChannelBuilder.IceCandidate;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.candidate=e.string();break;case 2:r.sdpMid=e.string();break;case 3:r.sdpMLineIndex=e.uint32();break;default:e.skipType(7&o)}}return r},e}(),e}(),nt=Xe.channel=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.initPing=null,e.prototype.initPong=0;var t;return Object.defineProperty(e.prototype,"type",{get:Ve.oneOfGetter(t=["initPing","initPong"]),set:Ve.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.initPing&&e.hasOwnProperty("initPing")&&Xe.channel.Data.encode(e.initPing,t.uint32(10).fork()).ldelim(),null!=e.initPong&&e.hasOwnProperty("initPong")&&t.uint32(16).uint32(e.initPong),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channel.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.initPing=Xe.channel.Data.decode(e,e.uint32());break;case 2:r.initPong=e.uint32();break;default:e.skipType(7&o)}}return r},e}(),e.Data=function(){function e(e){if(this.members=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.topology=0,e.prototype.wcId=0,e.prototype.senderId=0,e.prototype.members=Ve.emptyArray,e.prototype.key="",e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Qe.create()),null!=e.topology&&e.hasOwnProperty("topology")&&t.uint32(8).uint32(e.topology),null!=e.wcId&&e.hasOwnProperty("wcId")&&t.uint32(16).uint32(e.wcId),null!=e.senderId&&e.hasOwnProperty("senderId")&&t.uint32(24).uint32(e.senderId),null!=e.members&&e.members.length){t.uint32(34).fork();for(var n=0;n<e.members.length;++n)t.uint32(e.members[n]);t.ldelim()}return null!=e.key&&e.hasOwnProperty("key")&&t.uint32(42).string(e.key),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channel.Data;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.topology=e.uint32();break;case 2:r.wcId=e.uint32();break;case 3:r.senderId=e.uint32();break;case 4:if(r.members&&r.members.length||(r.members=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.members.push(e.uint32());else r.members.push(e.uint32());break;case 5:r.key=e.string();break;default:e.skipType(7&o)}}return r},e}(),e}(),rt=Xe.signaling=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.heartbeat=!1,e.prototype.content=null,e.prototype.connect=null,e.prototype.connected=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ve.oneOfGetter(t=["heartbeat","content","connect","connected"]),set:Ve.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.heartbeat&&e.hasOwnProperty("heartbeat")&&t.uint32(8).bool(e.heartbeat),null!=e.content&&e.hasOwnProperty("content")&&Xe.signaling.Content.encode(e.content,t.uint32(18).fork()).ldelim(),null!=e.connect&&e.hasOwnProperty("connect")&&Xe.signaling.GroupData.encode(e.connect,t.uint32(26).fork()).ldelim(),null!=e.connected&&e.hasOwnProperty("connected")&&t.uint32(32).bool(e.connected),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.signaling.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.heartbeat=e.bool();break;case 2:r.content=Xe.signaling.Content.decode(e,e.uint32());break;case 3:r.connect=Xe.signaling.GroupData.decode(e,e.uint32());break;case 4:r.connected=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e.Content=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.senderId=0,e.prototype.recipientId=0,e.prototype.lastData=!1,e.prototype.data=Ve.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Qe.create()),null!=e.senderId&&e.hasOwnProperty("senderId")&&t.uint32(8).uint32(e.senderId),null!=e.recipientId&&e.hasOwnProperty("recipientId")&&t.uint32(16).uint32(e.recipientId),null!=e.lastData&&e.hasOwnProperty("lastData")&&t.uint32(24).bool(e.lastData),null!=e.data&&e.hasOwnProperty("data")&&t.uint32(34).bytes(e.data),t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.signaling.Content;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.senderId=e.uint32();break;case 2:r.recipientId=e.uint32();break;case 3:r.lastData=e.bool();break;case 4:r.data=e.bytes();break;default:e.skipType(7&o)}}return r},e}(),e.GroupData=function(){function e(e){if(this.members=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.members=Ve.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Qe.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.members&&e.members.length){t.uint32(18).fork();for(var n=0;n<e.members.length;++n)t.uint32(e.members[n]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Ke||(e=Ke.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.signaling.GroupData;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:if(r.members&&r.members.length||(r.members=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.members.push(e.uint32());else r.members.push(e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e}(),ot=rt.Message.encode(rt.Message.create({heartbeat:!0})).finish();!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CHECKING=2]="CHECKING",e[e.CHECKED=4]="CHECKED",e[e.CLOSED=3]="CLOSED"}(Ue||(Ue={}));var it,st=function(){function e(e,t){this.STREAM_ID=1,this.wc=e,this.url=t,this.state=Ue.CLOSED,this.connected=!1,this.missedHeartbeat=0,this.streamSubject=new P.Subject,this.stateSubject=new P.Subject}return Object.defineProperty(e.prototype,"messageFromStream",{get:function(){return this.streamSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.sendOverStream=function(e){v.signaling(this.wc.myId+" Forward message",e),this.send({content:{recipientId:e.recipientId,senderId:e.senderId,lastData:void 0===e.content,data:$e.encode($e.create(e)).finish()}})},Object.defineProperty(e.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.check=function(){var e=this;this.state!==Ue.CHECKED&&this.state!==Ue.OPEN||(this.setState(Ue.CHECKING),this.send({connect:{id:this.wc.myId,members:this.wc.members.filter(function(t){return t!==e.wc.myId})}}))},e.prototype.connect=function(e){var t=this;if(!R())throw new Error("Failed to join over Signaling: WebSocket is not supported by your environment");this.setState(Ue.CONNECTING),this.ws=new r.WebSocket(this.fullUrl(e)),this.ws.binaryType="arraybuffer",this.connectionTimeout=setTimeout(function(){t.ws&&t.ws.readyState!==t.ws.OPEN&&(v.signaling("Failed to connect to Signaling server "+t.url+": connection timeout"),t.close())},1e4),this.ws.onopen=function(){t.setState(Ue.OPEN),t.connectionTimeout&&clearTimeout(t.connectionTimeout),t.startHeartbeat()},this.ws.onerror=function(e){return v.signaling("WebSocket ERROR",e)},this.ws.onclose=function(e){t.clean(),t.setState(Ue.CLOSED)},this.ws.onmessage=function(e){var n=e.data;return t.handleMessage(n)}},e.prototype.close=function(){this.state!==Ue.CLOSED&&(this.ws&&(this.ws.onmessage=function(){},this.ws.onclose=function(){},this.ws.onerror=function(){},this.ws.close(1e3)),this.clean(),this.setState(Ue.CLOSED))},e.prototype.clean=function(){this.connectionTimeout&&clearTimeout(this.connectionTimeout),this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.ws=void 0},e.prototype.handleMessage=function(e){var t=this;try{var n=rt.Message.decode(new Uint8Array(e));switch(n.type){case"heartbeat":this.missedHeartbeat=0;break;case"connected":this.connected=n.connected,this.setState(Ue.CHECKED),n.connected||this.wc.channelBuilder.connectOverSignaling().catch(function(){return t.check()});break;case"content":var r=n.content,o=r.data,i=r.senderId,s=r.recipientId,a=$e.decode(o);a.senderId=i,a.recipientId=s,v.signaling("StreamMessage RECEIVED: ",a),this.streamSubject.next(a)}}catch(e){v.warn("Decode Signaling message error: ",e)}},e.prototype.setState=function(e){this.state!==e&&(this.state=e,this.stateSubject.next(e))},e.prototype.startHeartbeat=function(){var e=this;this.missedHeartbeat=0,this.heartbeatInterval=setInterval(function(){try{if(e.missedHeartbeat++,e.missedHeartbeat>=3)throw new Error("Too many missed heartbeats");e.heartbeat()}catch(t){e.close()}},5e3)},e.prototype.send=function(e){if(this.ws&&this.ws.readyState===r.WebSocket.OPEN)try{this.ws.send(rt.Message.encode(rt.Message.create(e)).finish())}catch(e){v.signaling("Failed send to Signaling",e)}},e.prototype.heartbeat=function(){if(this.ws&&this.ws.readyState===r.WebSocket.OPEN)try{this.ws.send(ot)}catch(e){v.signaling("Failed send to Signaling: "+e.message)}},e.prototype.fullUrl=function(e){var t=this.url.endsWith("/")?this.url+e:this.url+"/"+e;return O?t:t+"?favored"},e}();!function(e){e[e.JOINING=0]="JOINING",e[e.JOINED=1]="JOINED",e[e.LEFT=2]="LEFT"}(it||(it={}));var at,ct=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),lt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},ut=new r.TextEncoder,ht=new r.TextDecoder,dt=function(e){function t(){var n=e.call(this,t.SERVICE_ID,Ye.Message)||this;return n.buffers=new Map,n}return ct(t,e),t.prototype.clean=function(){this.buffers.clear()},t.prototype.encodeUserMessage=function(t){var n=this.userDataToType(t),r=n.type,o=n.bytes,i={length:o.length,type:r};if(o.length<=15e3)return i.full=o,[e.prototype.encode.call(this,i)];i.chunk={id:Math.ceil(65535*Math.random())};for(var s=Math.ceil(o.length/15e3),a=new Array(s),c=0;c<s;c++){var l=15e3*c,u=l+Math.min(15e3,o.length-15e3*c);i.chunk.nb=c,i.chunk.content=new Uint8Array(o.slice(l,u)),a[c]=e.prototype.encode.call(this,i)}return a},t.prototype.decodeUserMessage=function(t,n){try{var r=e.prototype.decode.call(this,t),o=r.length,i=r.type,s=r.contentType,a=r.full,c=r.chunk,l=void 0;switch(s){case"full":l=a;break;case"chunk":var u=this.getBuffer(n,c.id);void 0===u?(u=new pt(o,c.content,c.nb),this.setBuffer(n,c.id,u),l=void 0):l=u.append(c.content,c.nb);break;default:throw new Error("Unknown message integrity")}if(void 0!==l)switch(i){case Ye.Message.Type.U_INT_8_ARRAY:return l;case Ye.Message.Type.STRING:return ht.decode(l);default:throw new Error("Unknown message type")}return l}catch(e){return void v.warn("Decode user message error: ",e)}},t.prototype.userDataToType=function(e){if(e instanceof Uint8Array)return{type:Ye.Message.Type.U_INT_8_ARRAY,bytes:e};if("string"==typeof e)return{type:Ye.Message.Type.STRING,bytes:ut.encode(e)};if(e instanceof String)return{type:Ye.Message.Type.STRING,bytes:ut.encode(""+e)};throw new Error("Message neigther a string type or a Uint8Array type")},t.prototype.getBuffer=function(e,t){var n=this.buffers.get(e);if(void 0!==n)return n.get(t)},t.prototype.setBuffer=function(e,t,n){var r=this.buffers.get(e);void 0===r&&(r=new Map),r.set(t,n),this.buffers.set(e,r)},t.SERVICE_ID=743,t}(x),pt=function(){function e(e,t,n){this.fullData=new Uint8Array(e),this.currentLength=0,this.append(t,n)}return e.prototype.append=function(e,t){var n,r,o=15e3*t;this.currentLength+=e.length;try{for(var i=lt(e),s=i.next();!s.done;s=i.next()){var a=s.value;this.fullData[o++]=a}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return this.currentLength===this.fullData.length?this.fullData:void 0},e}(),ft=function(){function e(t,n,r,o,i){var s=this;v.channel("New Channel "+r+": Me: "+t.myId+" with "+o),this.wc=t,this.wsOrDc=n,this.type=r,this.pc=i,this.missedHeartbeat=0,this.heartbeatMsg=new Uint8Array(0),this.resolveInit=function(){},O?(n.binaryType="arraybuffer",this.send=this.sendInBrowser):this.pc?(n.binaryType="arraybuffer",this.send=this.sendInNodeOverDataChannel):this.send=this.sendInNodeOverWebSocket,r===e.WITH_INTERNAL?(this.id=o,this.heartbeatMsg=this.createHeartbeatMsg(),this.init=Promise.resolve(),this.initHandlers()):(this.id=I,r===e.WITH_JOINING&&this.sendInitPing(),this.init=new Promise(function(e,t){return s.resolveInit=function(){s.heartbeatMsg=s.createHeartbeatMsg(),e()}}),this.wsOrDc.onmessage=function(e){var t=e.data;try{var n=nt.Message.decode(new Uint8Array(t));s.handleInitMessage(n)}catch(e){v.warn("Decode inner Channel message error: ",e)}})}return e.remoteType=function(t){return t===e.WITH_INTERNAL?e.WITH_INTERNAL:t===e.WITH_JOINING?e.WITH_MEMBER:e.WITH_JOINING},Object.defineProperty(e.prototype,"url",{get:function(){return this.pc?"":this.wsOrDc.url},enumerable:!0,configurable:!0}),e.prototype.encodeAndSend=function(e){var t=void 0===e?{}:e,n=t.senderId,r=void 0===n?this.wc.myId:n,o=t.recipientId,i=void 0===o?0:o,s=t.serviceId,a=t.content;this.send($e.encode($e.create({senderId:r,recipientId:i,serviceId:s,content:a})).finish())},e.prototype.close=function(){this.wsOrDc.onmessage=void 0,this.wsOrDc.onclose=void 0,this.wsOrDc.onerror=void 0,this.pc?(this.pc.oniceconnectionstatechange=function(){},this.pc.close()):this.wsOrDc.close(1e3)},e.prototype.sendHeartbeat=function(){this.missedHeartbeat++,this.missedHeartbeat>=3?(v.channel(this.id+" channel closed: too many missed heartbeats"),this.wc.topology.onChannelClose(this),this.close()):this.send(this.heartbeatMsg)},e.prototype.sendInBrowser=function(e){try{this.wsOrDc.send(e)}catch(e){v.channel("Channel sendInBrowser ERROR",e)}},e.prototype.sendInNodeOverWebSocket=function(e){try{this.wsOrDc.send(e,{binary:!0})}catch(e){v.channel("Channel sendInNodeOverWebSocket ERROR",e)}},e.prototype.sendInNodeOverDataChannel=function(e){this.sendInBrowser(e.slice(0))},e.prototype.handleInitMessage=function(e){switch(e.type){case"initPing":v.channel(this.wc.myId+" received InitPing");var t=e.initPing,n=t.topology,r=t.wcId,o=t.senderId,i=t.members,s=t.key;this.wc.topologyEnum!==n?v.channel("Different topology. This message should never be shown: something is wrong"):i.includes(this.id)&&this.wc.id,this.wc.id=r,this.wc.key=s,this.id=o,v.channel(this.wc.myId+" send InitPong"),this.send(nt.Message.encode(nt.Message.create({initPong:this.wc.myId})).finish()),this.initData={members:i},this.initHandlers(),this.resolveInit();break;case"initPong":v.channel(this.wc.myId+" received InitPong"),this.id=e.initPong,this.initHandlers(),this.resolveInit();break;default:v.channel('Unknown message type: "'+e.type+'". This message should never be shown: something went wrong')}},e.prototype.initHandlers=function(){var e=this;this.wsOrDc.onmessage=function(t){var n=t.data;try{var r=$e.decode(new Uint8Array(n));if(0===r.recipientId||r.recipientId===e.wc.myId)if(r.serviceId===dt.SERVICE_ID){var o=e.wc.userMsg.decodeUserMessage(r.content,r.senderId);o&&e.wc.onMessage(r.senderId,o)}else 0===r.serviceId?e.missedHeartbeat=0:e.wc.streamSubject.next(Object.assign({channel:e},r));r.recipientId!==e.wc.myId&&e.wc.topology.forward(r)}catch(e){v.warn("Decode general Channel message error: ",e)}},this.wsOrDc.onclose=function(t){v.channel("Connection with "+e.id+" has closed",t),e.pc&&(e.pc.oniceconnectionstatechange=function(){}),e.wc.topology.onChannelClose(e)},this.pc&&(this.pc.oniceconnectionstatechange=function(){e.pc&&"failed"===e.pc.iceConnectionState&&(e.close(),e.wc.topology.onChannelClose(e))}),this.wsOrDc.onerror=function(e){return v.channel("Channel error: ",e)}},e.prototype.createHeartbeatMsg=function(){return $e.encode($e.create({serviceId:0,senderId:this.wc.myId,recipientId:this.id})).finish()},e.prototype.sendInitPing=function(){v.channel("initialize..."),this.send(nt.Message.encode(nt.Message.create({initPing:{topology:this.wc.topologyEnum,wcId:this.wc.id,senderId:this.wc.myId,members:this.wc.members,key:this.wc.key}})).finish())},e.WITH_INTERNAL=0,e.WITH_JOINING=1,e.WITH_MEMBER=2,e}(),gt=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}c((r=r.apply(e,t||[])).next())})},bt=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},yt=function(){function e(e){this.wc=e,this.channelsSubject=new P.Subject}return Object.defineProperty(e.prototype,"channels",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.newWebSocket=function(e,t,n){this.channelsSubject.next({id:t,channel:new ft(this.wc,e,n,t)})},e.prototype.connect=function(e,t,n,o,i){return gt(this,void 0,void 0,function(){var s,a,c,l=this;return bt(this,function(u){switch(u.label){case 0:return M(e),s=this.composeUrl(e,ft.remoteType(t),i,o),a=new r.WebSocket(s),[4,new Promise(function(r,o){var i=setTimeout(function(){a.readyState!==a.OPEN&&(a.close(),o(new Error("WebSocket 4000ms connection timeout with '"+e+"'")))},4e3);a.onopen=function(){clearTimeout(i),r(new ft(l.wc,a,t,n))},a.onerror=function(e){return o(e)},a.onclose=function(t){o(new Error("WebSocket with '"+e+"' closed "+t.code+": "+t.reason))}})];case 1:return c=u.sent(),this.channelsSubject.next({id:n,channel:c}),[2]}})})},e.prototype.composeUrl=function(e,t,n,r){var o=e+"/?type="+t+"&wcId="+n+"&senderId="+r;return t!==ft.WITH_INTERNAL&&(o+="&key="+this.wc.key),o},e.listenUrl=new P.BehaviorSubject(""),e}(),mt=function(){function e(e,t,n,r,o){var i=this;this.finalMessageReceived=!1,this.finalMessageSent=!1,this.id=e,this.pc=t,this.send=n,this._onError=function(){},this.candidates=new P.ReplaySubject,this.remotes=r,this.isSDPSent=!1,this.remotes.set(e,this),this.timer=setTimeout(function(){"connected"!==i.pc.iceConnectionState&&"completed"!==i.pc.iceConnectionState&&i._onError(new Error(o+"ms connection timeout"))},o),t.oniceconnectionstatechange=function(){v.webrtc("LOCAL ICE CONNECTION STATE",t.iceConnectionState),"failed"===t.iceConnectionState&&i._onError(new Error("Ice Connection State is FAILED"))},t.onicecandidate=function(e){null!==e.candidate?(v.webrtc("LOCAL ICE CANDIDATE",e.candidate.candidate),i.send({candidate:{candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex}})):(i.pc.onicecandidate=function(){},i.isSDPSent&&i.sendFinalMessage())}}return Object.defineProperty(e.prototype,"onError",{get:function(){return this._onError},set:function(e){var t=this;this._onError=function(n){v.webrtc("ERROR: ",n.message),t.clean("clean"!==n.message),e(n)}},enumerable:!0,configurable:!0}),e.prototype.sdpIsSent=function(){this.isSDPSent=!0,"complete"===this.pc.iceGatheringState&&this.sendFinalMessage()},e.prototype.clean=function(e){void 0===e&&(e=!0),v.webrtc("CLEAN REMOTE"),this.pc.oniceconnectionstatechange=function(){},this.pc.onicecandidate=function(){},this.pc.ondatachannel=function(){},this._onError=function(){},this.candidates.complete(),this.remotes.delete(this.id),clearTimeout(this.timer),this.pc.close(),e&&this.sendFinalMessage()},e.prototype.dataChannelOpen=function(e){v.webrtc("DATA CHANNEL with "+this.id+" OPEN"),this.finalMessageReceived&&this.finalMessageSent&&this.remotes.delete(this.id),this.pc.oniceconnectionstatechange=function(){},e.onopen=function(){},this.pc.ondatachannel=function(){},this._onError=function(){}},e.prototype.handleMessage=function(e){var t=this;if(e.type)switch(e.type){case"offer":v.webrtc("REMOTE OFFER",{offer:e.offer}),this.pc.setRemoteDescription({type:"offer",sdp:e.offer}).then(function(){return t.candidates.subscribe(function(e){return t.pc.addIceCandidate(e).catch(function(e){return v.webrtc("Failed to addIceCandidate",e)})})}).then(function(){return t.pc.createAnswer()}).then(function(e){return t.pc.setLocalDescription(e)}).then(function(){var e=t.pc.localDescription.sdp;v.webrtc("Send LOCAL ANSWER",{answer:e}),t.send({answer:e}),t.sdpIsSent()}).catch(function(e){return t._onError(e)});break;case"answer":v.webrtc("REMOTE ANSWER is received",{answer:e.answer}),this.pc.setRemoteDescription({type:"answer",sdp:e.answer}).then(function(){t.candidates.subscribe(function(e){return t.pc.addIceCandidate(e).catch(function(e){return v.webrtc(t.id+": Failed to add REMOTE Ice Candidate",e)})})}).catch(function(e){return t._onError(e)});break;case"candidate":v.webrtc("REMOTE ICE CANDIDATE is received",e.candidate),this.candidates.next(new r.RTCIceCandidate(e.candidate));break;default:this._onError(new Error("Buffer Protocol unknown message from the remote peer"))}else v.webrtc("REMOTE FINAL MESSAGE received"),this.finalMessageReceived=!0,this.candidates.complete(),this.finalMessageSent&&this.remotes.delete(this.id)},e.prototype.sendFinalMessage=function(){this.finalMessageSent||(this.finalMessageSent=!0,this.send({}),this.finalMessageReceived&&this.remotes.delete(this.id))},e}(),vt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),St=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}c((r=r.apply(e,t||[])).next())})},wt=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},It=function(e){function t(n,r){var o=e.call(this,t.SERVICE_ID,tt.Message)||this;return o.wc=n,o.allStreams=e.prototype.useAllStreams.call(o,n,n.signaling),o.rtcConfiguration=r,o.channelsSubject=new P.Subject,o.remotes=new Map,o.allStreams.message.subscribe(function(e){var t=e.streamId,n=e.senderId,r=e.recipientId,i=e.msg,s=o.remotes.get(n);if(s&&s.finalMessageReceived&&(s.clean(!1),s=void 0),!s){if(!i.type||"offer"!==i.type&&"candidate"!==i.type)return;try{s=o.createRemote(t,n,r,!0)}catch(e){return}}s.handleMessage(i)}),o}return vt(t,e),Object.defineProperty(t.prototype,"channels",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.connect=function(e,t,n){return St(this,void 0,void 0,function(){var r,o,i,s,a,c,l,u=this;return wt(this,function(h){switch(h.label){case 0:return v.webrtc("connectWith call",{targetId:e,myId:t,type:n}),r=n===ft.WITH_INTERNAL?this.wc.STREAM_ID:this.wc.signaling.STREAM_ID,(o=this.remotes.get(e))?o.clean():o=this.createRemote(r,e,t),i=ft.remoteType(n),s=o.pc.createDataChannel('{"id":'+this.wc.myId+',"type":'+i+"}"),[4,o.pc.createOffer()];case 1:return a=h.sent(),[4,o.pc.setLocalDescription(a)];case 2:return h.sent(),c=o.pc.localDescription.sdp,this.allStreams.sendOver(r,{offer:c},e,t),o.sdpIsSent(),[4,new Promise(function(t,r){o.onError=function(e){return r(e)},s.onopen=function(){o.dataChannelOpen(s),t(new ft(u.wc,s,n,e,o.pc))}})];case 3:return l=h.sent(),this.channelsSubject.next({id:e,channel:l}),[2]}})})},t.prototype.clean=function(e){if(e){var t=this.remotes.get(e);t&&t.clean(!1)}else this.remotes.forEach(function(e){return e.onError(new Error("clean"))})},t.prototype.createRemote=function(e,t,n,o){var i=this;void 0===o&&(o=!1);var s=new mt(t,new r.RTCPeerConnection(this.rtcConfiguration),function(r){return i.allStreams.sendOver(e,r,t,n)},this.remotes,9e3);o?(v.webrtc("create a new remote object with "+t+" - PASSIVE"),s.pc.ondatachannel=function(e){var n=e.channel,r=JSON.parse(n.label),o=r.id,a=r.type;n.onopen=function(){s.dataChannelOpen(n);var e=new ft(i.wc,n,a,o,s.pc);i.channelsSubject.next({id:t,channel:e})}}):v.webrtc("create a new remote object with "+t+" - INITIATOR");return s},t.SERVICE_ID=7431,t}(x);!function(e){e.RESPONSE_TIMEOUT="Response timeout: remote peer is not responding",e.CONNECTION_TIMEOUT="Connection timeout: unable to establish a channel within a specified time",e.DENIED="Connection denied: remote peer refused the connection request",e.CLEAN="Clean: all connections in progress must be stopped",e.IN_PROGRESS="Connection setup is already in progress",e.NEGOTIATION_ERROR="All connection possibilities have been tried and none of them worked"}(at||(at={}));var Ot=function(){function e(){this.connections=new Map}return e.prototype.create=function(e,t,n,r){var o=this,i={};return i.promise=new Promise(function(s,a){var c=setTimeout(function(){return i.reject(new Error(at.RESPONSE_TIMEOUT))},n);i.resolve=function(){clearTimeout(c),s(),i.promise=new Promise(function(n,s){var a=setTimeout(function(){v.channelBuilder("on Connection timeout callback"),r(),i.reject(new Error(at.CONNECTION_TIMEOUT))},t);i.resolve=function(){clearTimeout(a),o.connections.delete(e),n()},i.reject=function(t){i.promise.catch(function(){}),clearTimeout(a),o.connections.delete(e),s(t)}})},i.reject=function(t){i.promise.catch(function(){}),clearTimeout(c),o.connections.delete(e),a(t)},o.connections.set(e,i)}),i},e.prototype.get=function(e){return this.connections.get(e)},e.prototype.has=function(e,t){return this.connections.has(t)},e.prototype.clean=function(){this.connections.forEach(function(e){return e.reject(new Error(at.CLEAN))}),this.connections.clear()},e}(),jt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),kt=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}c((r=r.apply(e,t||[])).next())})},Mt=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},Tt=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s},Et=Math.max(9e3,4e3)+5e3,Ct=function(e){function t(n){var o=e.call(this,t.SERVICE_ID,Ze.Message)||this;return o.wc=n,o.allStreams=e.prototype.useAllStreams.call(o,n,n.signaling),o.connectsInProgress=new Ot,o.channelsSubject=new P.Subject,o.onConnectionRequest=function(){return!0},o.dataChannelBuilder=new It(o.wc,o.wc.rtcConfiguration),o.myInfo={wsTried:!1,wsSupported:R(),dcTried:!1,dcSupported:!!r.RTCPeerConnection&&"createDataChannel"in r.RTCPeerConnection.prototype},o.negotiationEncoded=e.prototype.encode.call(o,{negotiation:{initiator:o.myInfo}}),t.connectResTrueEncoded||t.connectResFalseEncoded||(t.connectResTrueEncoded=e.prototype.encode.call(o,{connectionResponse:!0}),t.connectResFalseEncoded=e.prototype.encode.call(o,{connectionResponse:!1})),o.allStreams.message.subscribe(function(e){var t=e.streamId,n=e.senderId,r=e.recipientId,i=e.msg;o.handleMessage(t,n,r,i)}),o.subscribeToChannels(),o.subscribeToURLandIDChange(),o}return jt(t,e),t.prototype.clean=function(){v.channelBuilder("CLEAN call"),this.dataChannelBuilder.clean(),this.connectsInProgress.clean()},Object.defineProperty(t.prototype,"onChannel",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.connectOverWebChannel=function(e,t,n){return void 0===t&&(t=function(){}),void 0===n&&(n=new Uint8Array),kt(this,void 0,void 0,function(){return Mt(this,function(r){return[2,this.connectOver(this.wc.STREAM_ID,e,t,n)]})})},t.prototype.connectOverSignaling=function(e,t){return void 0===e&&(e=function(){}),void 0===t&&(t=new Uint8Array),kt(this,void 0,void 0,function(){return Mt(this,function(n){return[2,this.connectOver(this.wc.signaling.STREAM_ID,0,e,t)]})})},t.prototype.connectOver=function(e,t,n,r){return kt(this,void 0,void 0,function(){var o,i=this;return Mt(this,function(s){switch(s.label){case 0:return(o=this.connectsInProgress.get(t))?[3,2]:(this.allStreams.sendOver(e,{connectionRequest:r},t,this.wc.myId),[4,(o=this.connectsInProgress.create(t,Et,2e3,function(){return i.dataChannelBuilder.clean(t)})).promise]);case 1:return s.sent(),n(),[2,o.promise];case 2:throw new Error(at.IN_PROGRESS)}})})},t.prototype.handleMessage=function(e,n,r,o){var i=this;switch(o.type){case"connectionRequest":if(v.channelBuilder("connection Request from ",n),s=this.connectsInProgress.get(n)){if(!(n<this.wc.myId))return;s.reject(new Error(at.IN_PROGRESS))}this.onConnectionRequest(e,o.connectionRequest)?((s=this.connectsInProgress.create(n,Et,2e3,function(){return i.dataChannelBuilder.clean(n)})).resolve(),v.channelBuilder("connection Response POSITIVE to ",n),this.allStreams.sendOver(e,t.connectResTrueEncoded,n,r)):(v.channelBuilder("connection Response NEGATIVE to ",n),this.allStreams.sendOver(e,t.connectResFalseEncoded,n,r));break;case"connectionResponse":var s;v.channelBuilder("connection Response from ",n),(s=this.connectsInProgress.get(n))&&(o.connectionResponse?(s.resolve(),v.channelBuilder("Send first negotiation message to ",n),this.allStreams.sendOver(e,this.negotiationEncoded,n,r)):s.reject(new Error(at.DENIED)));break;case"negotiation":if(this.connectsInProgress.has(e,n)){var a=o.negotiation,c=a.initiator,l=a.passive;l||(c.id=n,(l=Object.assign({},this.myInfo)).id=r),v.channelBuilder("NEGOTIATION message to proceed from "+n+": ",JSON.stringify({isIamInitiatore:l.id===n,passive:l,initiator:c,senderId:n,recipientId:r})),this.isNagotiable(c,l)?this.proceedNegotiation(e,c,l,l.id===n).catch(function(t){i.rejectConnection(e,n,t),v.channelBuilder("NEGOTIATION with "+n+" FIALED: ",{passive:l,initiator:c}),i.allStreams.sendOver(e,{negotiation:{initiator:c,passive:l}},n,r)}):this.rejectConnection(e,n,new Error(at.NEGOTIATION_ERROR))}}},t.prototype.proceedNegotiation=function(e,t,n,r){return kt(this,void 0,void 0,function(){var o,i,s,a,c;return Mt(this,function(l){switch(l.label){case 0:return o=Tt(r?[t,n]:[n,t],2),i=o[0],s=o[1],(a=s.wss&&!i.wsTried)?[4,this.tryWs(e,i,s,r)]:[3,2];case 1:a=l.sent(),l.label=2;case 2:return a?[2]:i.wss&&!s.wsTried?(v.channelBuilder("Prompt the other to connect over WebSocket"),this.allStreams.sendOver(e,{negotiation:{initiator:t,passive:n}},s.id,i.id),[2]):i.dcSupported&&s.dcSupported?(c=!i.dcTried)?[4,this.tryDc(e,i,s,r)]:[3,4]:[3,5];case 3:c=l.sent(),l.label=4;case 4:if(c)return[2];if(!s.dcTried)return v.channelBuilder("Prompt the other to connect over RTCDataChannel"),this.allStreams.sendOver(e,{negotiation:{initiator:t,passive:n}},s.id,i.id),[2];l.label=5;case 5:throw new Error(at.NEGOTIATION_ERROR)}})})},t.prototype.tryWs=function(e,t,n,r){return kt(this,void 0,void 0,function(){var o,i,s;return Mt(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),o=this.getType(e,r),i=o===ft.WITH_MEMBER?n.wcId:this.wc.myId,[4,this.wc.webSocketBuilder.connect(n.wss,o,n.id,t.id,i)];case 1:return a.sent(),v.channelBuilder("New WebSocket connection with "+n.id),[2,!0];case 2:return"clean"!==(s=a.sent()).message?(v.channelBuilder("WebSocket failed with "+n.id,s),t.wsTried=!0,[2,!1]):[2,!0];case 3:return[2]}})})},t.prototype.tryDc=function(e,t,n,r){return kt(this,void 0,void 0,function(){var o,i;return Mt(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),o=this.getType(e,r),[4,this.dataChannelBuilder.connect(n.id,t.id,o)];case 1:return s.sent(),v.channelBuilder("New RTCDataChannel with "+n.id),[2,!0];case 2:return"clean"!==(i=s.sent()).message?(v.channelBuilder("RTCDataChannel failed with "+n.id,i),t.dcTried=!0,[2,!1]):[2,!0];case 3:return[2]}})})},t.prototype.getType=function(e,t){return e===this.wc.STREAM_ID?ft.WITH_INTERNAL:t?ft.WITH_MEMBER:ft.WITH_JOINING},t.prototype.isNagotiable=function(e,t){return e.wss&&!t.wsTried||t.wss&&!e.wsTried||e.dcSupported&&t.dcSupported&&(!e.dcTried||!t.dcTried)},t.prototype.subscribeToChannels=function(){var e=this;Object(P.merge)(this.dataChannelBuilder.channels,this.wc.webSocketBuilder.channels).subscribe(function(t){var n=t.id,r=t.channel;r.init.then(function(){v.channelBuilder("NEW Channel from ",JSON.stringify({type:r.type,id:n}));var t=e.connectsInProgress.get(n);t?(v.channelBuilder("RESOLVE this NEW Channel"),t.resolve()):v.channelBuilder("this NEW Channel NOT FOUND"),e.channelsSubject.next(r)})})},t.prototype.subscribeToURLandIDChange=function(){var t=this;yt.listenUrl.subscribe(function(n){n&&(t.myInfo.wss=n,t.negotiationEncoded=e.prototype.encode.call(t,{negotiation:{initiator:t.myInfo}}))}),this.wc.onIdChange.subscribe(function(n){t.myInfo.wcId=t.wc.id,t.negotiationEncoded=e.prototype.encode.call(t,{negotiation:{initiator:t.myInfo}})})},t.prototype.rejectConnection=function(e,t,n){var r=this.connectsInProgress.get(t);r&&r.reject(n)},t.SERVICE_ID=74,t}(x),Lt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Rt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},Nt=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s},Bt=function(e){function t(n){var r=e.call(this,n,t.SERVICE_ID,et.Message)||this;return r.adjacentMembers=new Map,r.distantMembers=new Map,r.antecedentId=0,r.delayedMembers=new Set,r.delayedMembersTimers=new Set,r.adjacentBots=new Set,r.heartbeatMsg=e.prototype.encode.call(r,{heartbeat:!0}),r.wcStream.message.subscribe(function(e){var t=e.channel,n=e.senderId,o=e.msg;return r.handleServiceMessage(t,n,o)}),r.wc.channelBuilder.onConnectionRequest=function(e,t){try{var n=et.ConnectionRequest.decode(t),o=n.id,i=n.adjacentIds;return e!==r.wc.STREAM_ID||(v.topology("CONNECTION REQUEST from "+o+", where adjacent members are: ",i),r.createOrUpdateDistantMember(o,i))}catch(e){return v.warn("Decode Fullmesh onConnectionRequest message error: ",e),!1}},r.wc.channelBuilder.onChannel.subscribe(function(t){v.topology("New adjacent member: "+t.id),r.distantMembers.delete(t.id),r.delayedMembers.delete(t.id);var n=r.adjacentMembers.get(t.id);if(n&&(v.topology("Replacing the same channel"),n.close()),r.adjacentMembers.set(t.id,t),t.url&&r.adjacentBots.add(t),r.notifyDistantMembers(),r.heartbeatInterval||r.startHeartbeatInterval(),t.type===ft.WITH_MEMBER){e.prototype.setState.call(r,B.CONSTRUCTING);var o=t.initData.members;r.connectToMembers(o,t.id).then(function(){e.prototype.setState.call(r,B.CONSTRUCTED),r.startMembersCheckIntervals()})}else r.startMembersCheckIntervals();r.wc.onMemberJoinProxy(t.id),r.updateAntecedentId()}),O&&(window.fullmesh=function(){v.topology("Fullmesh info:",{myId:r.wc.myId,antecedentId:r.antecedentId,signalingState:r.wc.signaling.state,webGroupState:r.wc.state,topologyState:B[r.state],adjacentBots:Array.from(r.adjacentBots).map(function(e){return e.id}),adjacentMembers:Array.from(r.adjacentMembers.keys()).toString(),distantMembers:Array.from(r.distantMembers.keys()).toString(),distantMembersDETAILS:Array.from(r.distantMembers.keys()).map(function(e){var t=r.distantMembers.get(e);return{id:e,adjacentMembers:t?t.adjacentIds:[]}})})}),r}return Lt(t,e),t.prototype.send=function(e){var t=this;this.adjacentMembers.forEach(function(t){return t.encodeAndSend(e)}),this.distantMembers.forEach(function(n,r){t.sendToDistantPeer(n,Object.assign(e,{recipientId:r}))})},t.prototype.sendTo=function(e){var t=this.adjacentMembers.get(e.recipientId);t?t.encodeAndSend(e):this.sendToDistantPeer(this.distantMembers.get(e.recipientId),e)},t.prototype.forward=function(e){this.sendTo(e)},t.prototype.leave=function(){this.state!==B.IDLE&&(v.topology("LEAVE"),this.clean(),this.adjacentMembers.forEach(function(e){return e.close()}),this.wc.onAdjacentMembersLeaveProxy(Array.from(this.adjacentMembers.keys())),this.adjacentMembers.clear(),e.prototype.setState.call(this,B.IDLE))},t.prototype.onChannelClose=function(e){this.adjacentMembers.delete(e.id)&&(this.adjacentBots.delete(e),this.delayedMembers.delete(e.id),this.wc.onAdjacentMembersLeaveProxy([e.id]),0===this.adjacentMembers.size?this.clean():(this.notifyDistantMembers(),this.updateAntecedentId()),v.topology("Channel closed with "+e.id))},Object.defineProperty(t.prototype,"neighbors",{get:function(){return Array.from(this.adjacentMembers.values())},enumerable:!0,configurable:!0}),t.prototype.clean=function(){v.topology("CLEAN"),this.wc.onDistantMembersLeaveProxy(Array.from(this.distantMembers.keys())),this.distantMembers.clear(),this.antecedentId=0,clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0,clearInterval(this.membersCheckInterval),this.membersCheckInterval=void 0,this.delayedMembers.clear(),this.delayedMembersTimers.forEach(function(e){return clearTimeout(e)}),this.delayedMembersTimers.clear(),this.adjacentBots.clear()},t.prototype.handleServiceMessage=function(e,t,n){switch(n.type){case"members":this.connectToMembers(n.members.ids,t);break;case"adjacentMembers":v.topology("adjacent members received from "+t,n.adjacentMembers.ids);var r=n.adjacentMembers.ids;this.createOrUpdateDistantMember(t,r);break;case"heartbeat":var o=this.distantMembers.get(t);o&&(o.missedHeartbeat=0)}},t.prototype.connectToMembers=function(e,t){var n,r,o=this,i=e.filter(function(e){return!o.adjacentMembers.has(e)&&e!==o.wc.myId});if(0!==i.length){v.topology("TRY TO CONNECT to members",i);var s=[],a=et.ConnectionRequest.encode(et.ConnectionRequest.create({id:this.wc.myId,adjacentIds:Array.from(this.adjacentMembers.keys())})).finish(),c=function(e){l.distantMembers.has(e)||(l.distantMembers.set(e,{adjacentIds:[t],missedHeartbeat:0}),v.topology("NEW distant member = "+e+"; BIS",t),l.updateAntecedentId()),l.delayedMembers.has(e)||(s[s.length]=l.wc.channelBuilder.connectOverWebChannel(e,function(){o.wc.onMemberJoinProxy(e),o.updateAntecedentId()},a).catch(function(t){if(v.topology("FAILED to connect to "+e+", because: "+t.message),t.message===at.CONNECTION_TIMEOUT||t.message===at.NEGOTIATION_ERROR||t.message===at.IN_PROGRESS){o.delayedMembers.add(e);var n=setTimeout(function(){o.delayedMembers.delete(e),o.delayedMembersTimers.delete(n)},3e5);o.delayedMembersTimers.add(n)}}))},l=this;try{for(var u=Rt(i),h=u.next();!h.done;h=u.next()){c(h.value)}}catch(e){n={error:e}}finally{try{h&&!h.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}return Promise.all(s)}return Promise.resolve()},t.prototype.notifyDistantMembers=function(){var t=this;if(0!==this.distantMembers.size){var n=e.prototype.encode.call(this,{adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}});this.distantMembers.forEach(function(e,r){return t.wcStream.send(n,r)})}},t.prototype.startMembersCheckIntervals=function(){var e=this;this.membersCheckInterval||(this.membersCheckInterval=setInterval(function(){e.antecedentId&&e.wcStream.send({members:{ids:e.wc.members}},e.antecedentId)},2e4))},t.prototype.startHeartbeatInterval=function(){var e=this;this.heartbeatInterval=setInterval(function(){e.adjacentMembers.forEach(function(e){return e.sendHeartbeat()}),e.distantMembers.forEach(function(t,n){t.missedHeartbeat++,t.missedHeartbeat>=4&&(v.topology("Distant peer "+n+" stopped to responding: too many missed heartbeats"),e.distantMembers.delete(n)&&(e.delayedMembers.delete(n),e.wc.onDistantMembersLeaveProxy([n]),e.updateAntecedentId())),e.wcStream.send(e.heartbeatMsg,n)})},3e3)},t.prototype.sendToDistantPeer=function(e,t){for(var n=1;n<=3;n++){var r=this.findRoutedChannel(e,n);if(r)return void r.encodeAndSend(t)}},t.prototype.findRoutedChannel=function(e,t){var n,r,o,i,s,a;if(e){try{for(var c=Rt(this.adjacentBots),l=c.next();!l.done;l=c.next()){var u=l.value;if(e.adjacentIds.includes(u.id))return u}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=c.return)&&r.call(c)}finally{if(n)throw n.error}}try{for(var h=Rt(this.adjacentMembers),d=h.next();!d.done;d=h.next()){var p=Nt(d.value,2),f=p[0];u=p[1];if(e.adjacentIds.includes(f))return u}}catch(e){o={error:e}}finally{try{d&&!d.done&&(i=h.return)&&i.call(h)}finally{if(o)throw o.error}}if(0!==t)try{for(var g=Rt(e.adjacentIds),b=g.next();!b.done;b=g.next()){var y=b.value;if(u=this.findRoutedChannel(this.distantMembers.get(y),t-1))return u}}catch(e){s={error:e}}finally{try{b&&!b.done&&(a=g.return)&&a.call(g)}finally{if(s)throw s.error}}}},t.prototype.createOrUpdateDistantMember=function(e,t){if(!this.adjacentMembers.has(e)){var n=this.distantMembers.get(e);return n?(n.adjacentIds=t,v.topology("UPDATE distant member = "+e,n.adjacentIds)):(this.distantMembers.set(e,{adjacentIds:t,missedHeartbeat:0}),this.wc.onMemberJoinProxy(e),v.topology("NEW distant member = "+e,t),this.updateAntecedentId()),!0}return v.topology("ABNORMAL update or create a distant member "+e+", but he is also an adjacent member"),!1},t.prototype.updateAntecedentId=function(){var e,t;if(this.adjacentMembers.size>0){var n=-1,r=-1;try{for(var o=Rt(this.wc.members),i=o.next();!i.done;i=o.next()){var s=i.value;s!==this.wc.myId&&(s<this.wc.myId&&s>r&&(r=s),n<s&&(n=s))}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}this.antecedentId=-1!==r?r:n}else this.antecedentId=0;v.topology("UPDATE, antecedentId = "+this.antecedentId+", members = ",JSON.stringify(this.wc.members))},t.SERVICE_ID=74315,t}(_),Pt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},Dt={topology:N.FULL_MESH,signalingServer:"wss://signaling.netflux.coedit.re",rtcConfiguration:{iceServers:[{urls:"stun:stun3.l.google.com:19302"}]},autoRejoin:!0},xt=function(){function e(e){this.STREAM_ID=2;var t=Object.assign({},Dt,e);this.streamSubject=new P.Subject,this.idSubject=new P.Subject,this.topologyEnum=t.topology,this.autoRejoin=t.autoRejoin,this.rtcConfiguration=t.rtcConfiguration,this.members=[],this._id=0,this.key="",this.myId=0,this.state=it.LEFT,this.rejoinEnabled=!1,this.rejoinTimer=void 0,this.topology={},this._onAlone=function(){},this.onMemberJoin=function(){},this.onMemberLeave=function(){},this.onMessage=function(){},this.onStateChange=function(){},this.onSignalingStateChange=function(){},this.userMsg=new dt,this.signaling=new st(this,t.signalingServer),this.subscribeToSignalingState(),this.webSocketBuilder=new yt(this),this.channelBuilder=new Ct(this),this.setTopology(t.topology),O&&this.subscribeToBrowserEvents()}return Object.defineProperty(e.prototype,"onIdChange",{get:function(){return this.idSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e,this.idSubject.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageFromStream",{get:function(){return this.streamSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onAlone",{set:function(e){this._onAlone=e},enumerable:!0,configurable:!0}),e.prototype.sendOverStream=function(e){this.topology.sendTo(e)},e.prototype.join=function(e){void 0===e&&(e=function(){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t=L(42),n="",r=0;r<42;r++)n+=e[t[r]%e.length];return n}()),function(e){if("string"!=typeof e)throw new Error('The key type "'+typeof e+'" is not a "string"');if(""===e)throw new Error("The key is an empty string");if(e.length>E)throw new Error("The key length of "+e.length+" exceeds the maximum of "+E+" characters")}(e),this.state===it.LEFT&&this.startJoin(e)},e.prototype.invite=function(e){var t,n;M(e);var r=C(e);try{for(var o=Pt(this.topology.neighbors),i=o.next();!i.done;i=o.next()){if(r===C(i.value.url))return}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}this.webSocketBuilder.connect(e,ft.WITH_JOINING,-1,-1,this.id).catch(function(t){return v.webgroup("Failed to invite the bot "+e+": "+t.message)})},e.prototype.leave=function(){this.state!==it.LEFT&&(this.key="",this.internalLeave())},e.prototype.send=function(e){var t,n;if(1!==this.members.length)try{for(var r=Pt(this.userMsg.encodeUserMessage(e)),o=r.next();!o.done;o=r.next()){var i=o.value;this.topology.send({senderId:this.myId,recipientId:0,serviceId:dt.SERVICE_ID,content:i})}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}},e.prototype.sendTo=function(e,t){var n,r;if(1!==this.members.length)try{for(var o=Pt(this.userMsg.encodeUserMessage(t)),i=o.next();!i.done;i=o.next()){var s=i.value;this.topology.sendTo({senderId:this.myId,recipientId:e,serviceId:dt.SERVICE_ID,content:s})}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}},e.prototype.onMemberJoinProxy=function(e){this.members.includes(e)||(this.members[this.members.length]=e,this.onMemberJoin(e))},e.prototype.onAdjacentMembersLeaveProxy=function(e){this.onMemberLeaveProxy(e)&&(1===this.members.length?(this._onAlone(),this.topology.leave()):this.signaling.state===Ue.CHECKED&&this.topology.state===B.CONSTRUCTED&&this.signaling.check())},e.prototype.onDistantMembersLeaveProxy=function(e){this.onMemberLeaveProxy(e)},e.prototype.init=function(e,t){void 0===t&&(t=T()),v.webgroup("INIT"),this.id=t,this.myId=T(),this.members=[this.myId],this.key=e,this.rejoinEnabled=this.autoRejoin,this.rejoinTimer&&(clearTimeout(this.rejoinTimer),this.rejoinTimer=void 0),this.setState(it.JOINING)},e.prototype.clean=function(){v.webgroup("CLEAN"),this.rejoinTimer&&(clearTimeout(this.rejoinTimer),this.rejoinTimer=void 0),this.members=[],this.id=0,this.myId=0},e.prototype.setState=function(e){this.state!==e&&(v.webGroupState(it[e],this.myId),this.state=e,this.onStateChange(e))},e.prototype.setTopology=function(e){var t=this;this.topologyEnum=e,this.topology=new Bt(this),this.topology.onState.subscribe(function(e){switch(v.webgroup("Topology state: ",B[e]),e){case B.CONSTRUCTING:t.setState(it.JOINING);break;case B.CONSTRUCTED:t.signaling.state===Ue.OPEN?t.signaling.check():t.signaling.state===Ue.CHECKED?(t.setState(it.JOINED),t.signaling.check()):t.signaling.state===Ue.CLOSED&&t.signaling.connect(t.key);break;case B.IDLE:switch(t.channelBuilder.clean(),t.userMsg.clean(),t.signaling.state){case Ue.CLOSED:t.rejoinEnabled?t.rejoin():t.internalLeave();break;case Ue.CONNECTING:t.setState(it.JOINING);break;case Ue.OPEN:t.setState(it.JOINING),t.signaling.check();break;case Ue.CHECKING:t.setState(it.JOINING);break;case Ue.CHECKED:t.signaling.check()}}})},e.prototype.subscribeToSignalingState=function(){var e=this;this.signaling.onState.subscribe(function(t){switch(v.signalingState(Ue[t],e.myId),e.onSignalingStateChange(t),t){case Ue.CLOSED:e.topology.state===B.IDLE?e.rejoinEnabled?e.rejoin():e.internalLeave():e.topology.state===B.CONSTRUCTED&&(1===e.members.length?e.topology.leave():e.rejoinEnabled&&!e.rejoinTimer&&e.reconnectToSignaling());break;case Ue.OPEN:e.topology.state!==B.CONSTRUCTING&&e.signaling.check();break;case Ue.CHECKED:e.topology.state===B.IDLE?e.signaling.connected&&e.topology.setJoinedState():e.topology.state===B.CONSTRUCTED&&e.setState(it.JOINED)}})},e.prototype.subscribeToBrowserEvents=function(){var e=this;window.addEventListener("online",function(){return e.onBrowserBack()}),window.addEventListener("visibilitychange",function(){return e.onBrowserBack()}),window.addEventListener("beforeunload",function(){return e.leave()})},e.prototype.startJoin=function(e){void 0===e&&(e=this.key),v.webgroup("start join..."),this.init(e),this.signaling.connect(e)},e.prototype.rejoin=function(){var e=this;this.setState(it.JOINING),k()&&j()?(this.clean(),v.webgroup("rejoin in 3000ms"),this.rejoinTimer=setTimeout(function(){e.signaling.state===Ue.CLOSED&&k()&&j()&&e.rejoinEnabled?e.startJoin():(v.webgroup("abandon rejoin because: ",{isVisible:k(),isOnline:j(),signalingState:Ue[e.signaling.state],rejoinEnabled:e.rejoinEnabled}),e.internalLeave()),e.rejoinTimer=void 0},3e3)):this.internalLeave()},e.prototype.reconnectToSignaling=function(){var e=this;1!==this.members.length||k()&&j()?(v.webgroup("reconnect to Signaling server in 3000ms"),this.setState(it.JOINING),this.rejoinTimer=setTimeout(function(){e.signaling.state===Ue.CLOSED&&(k()&&j()?e.rejoinEnabled&&e.signaling.connect(e.key):1===e.members.length&&e.internalLeave()),e.rejoinTimer=void 0},3e3)):this.internalLeave()},e.prototype.onBrowserBack=function(){k()&&j()&&(v.webgroup("onBrowserBack",{isVisible:k(),isOnline:j()}),this.rejoinEnabled=this.autoRejoin,this.rejoinEnabled&&(this.state===it.LEFT?this.startJoin():this.signaling.state===Ue.CLOSED&&this.signaling.connect(this.key)))},e.prototype.onMemberLeaveProxy=function(e){var t=this,n=!1;return e.forEach(function(e){t.members.includes(e)&&(t.members.splice(t.members.indexOf(e),1),n=!0,t.onMemberLeave(e))}),n},e.prototype.internalLeave=function(){v.webgroup("internal leave"),this.rejoinEnabled=!1,this.signaling.close(),this.topology.leave(),this.clean(),this.setState(it.LEFT)},e}(),At=new WeakMap,_t=function(){function e(e){void 0===e&&(e={});var t=new xt(e);At.set(this,t),this.id=void 0,Reflect.defineProperty(this,"id",{configurable:!1,enumerable:!0,get:function(){return t.id}}),this.myId=void 0,Reflect.defineProperty(this,"myId",{configurable:!1,enumerable:!0,get:function(){return t.myId}}),this.key=void 0,Reflect.defineProperty(this,"key",{configurable:!1,enumerable:!0,get:function(){return t.key}}),this.members=void 0,Reflect.defineProperty(this,"members",{configurable:!1,enumerable:!0,get:function(){return t.members}}),this.neighbors=void 0,Reflect.defineProperty(this,"neighbors",{configurable:!1,enumerable:!0,get:function(){return t.topology.neighbors.map(function(e){return e.id})}}),this.topology=void 0,Reflect.defineProperty(this,"topology",{configurable:!1,enumerable:!0,get:function(){return t.topologyEnum}}),this.state=void 0,Reflect.defineProperty(this,"state",{configurable:!1,enumerable:!0,get:function(){return t.state}}),this.signalingState=void 0,Reflect.defineProperty(this,"signalingState",{configurable:!1,enumerable:!0,get:function(){return t.signaling.state}}),this.signalingServer=void 0,Reflect.defineProperty(this,"signalingServer",{configurable:!1,enumerable:!0,get:function(){return t.signaling.url}}),this.autoRejoin=void 0,Reflect.defineProperty(this,"autoRejoin",{configurable:!1,enumerable:!0,get:function(){return t.autoRejoin},set:function(e){return t.autoRejoin=e}}),this.onMessage=void 0,Reflect.defineProperty(this,"onMessage",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMessage.name?void 0:t.onMessage},set:function(e){t.onMessage="function"!=typeof e?function(){}:e}}),this.onMemberJoin=void 0,Reflect.defineProperty(this,"onMemberJoin",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMemberJoin.name?void 0:t.onMemberJoin},set:function(e){t.onMemberJoin="function"!=typeof e?function(){}:e}}),this.onMemberLeave=void 0,Reflect.defineProperty(this,"onMemberLeave",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMemberLeave.name?void 0:t.onMemberLeave},set:function(e){t.onMemberLeave="function"!=typeof e?function(){}:e}}),this.onStateChange=void 0,Reflect.defineProperty(this,"onStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onStateChange.name?void 0:t.onStateChange},set:function(e){t.onStateChange="function"!=typeof e?function(){}:e}}),this.onSignalingStateChange=void 0,Reflect.defineProperty(this,"onSignalingStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onSignalingStateChange.name?void 0:t.onSignalingStateChange},set:function(e){t.onSignalingStateChange="function"!=typeof e?function(){}:e}})}return e.prototype.join=function(e){var t=At.get(this);if(t)return t.join(e);throw new Error("WebChannel is undefined")},e.prototype.invite=function(e){var t=At.get(this);if(t)return t.invite(e);throw new Error("WebChannel is undefined")},e.prototype.leave=function(){var e=At.get(this);if(e)return e.leave();throw new Error("WebChannel is undefined")},e.prototype.send=function(e){var t=At.get(this);if(t)return t.send(e);throw new Error("WebChannel is undefined")},e.prototype.sendTo=function(e,t){var n=At.get(this);if(n)return n.sendTo(e,t);throw new Error("WebChannel is undefined")},e}();!function(){function e(){}Object.defineProperty(e,"CONNECTING",{get:function(){return Ue.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return Ue.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return Ue.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHECKING",{get:function(){return Ue.CHECKING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHECKED",{get:function(){return Ue.CHECKED},enumerable:!0,configurable:!0})}();var Ut,Gt=function(){function e(){}return Object.defineProperty(e,"JOINING",{get:function(){return it.JOINING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"JOINED",{get:function(){return it.JOINED},enumerable:!0,configurable:!0}),Object.defineProperty(e,"LEFT",{get:function(){return it.LEFT},enumerable:!0,configurable:!0}),e}(),Ft=(function(){function e(){}Object.defineProperty(e,"FULL_MESH",{get:function(){return N.FULL_MESH},enumerable:!0,configurable:!0})}(),function(){function e(){}Object.defineProperty(e,"DEBUG",{get:function(){return s.DEBUG},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WEB_GROUP",{get:function(){return s.WEB_GROUP},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WEBRTC",{get:function(){return s.WEBRTC},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHANNEL",{get:function(){return s.CHANNEL},enumerable:!0,configurable:!0}),Object.defineProperty(e,"TOPOLOGY",{get:function(){return s.TOPOLOGY},enumerable:!0,configurable:!0}),Object.defineProperty(e,"SIGNALING",{get:function(){return s.SIGNALING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHANNEL_BUILDER",{get:function(){return s.CHANNEL_BUILDER},enumerable:!0,configurable:!0})}(),n(35)),qt=n(18),Wt={url:"",perMessageDeflate:!1,leaveOnceAlone:!0,server:void 0,webGroupOptions:Dt},Ht=function(){function e(e){this.wcOptions=Object.assign({},Dt,e.webGroupOptions);var t=Object.assign({},Wt,e);t.webGroupOptions=this.wcOptions,this.leaveOnceAlone=t.leaveOnceAlone,this.server=t.server,this.listenUrl=t.url,this.perMessageDeflate=t.perMessageDeflate,this.webGroups=new Map,this.onWebGroup=function(){},this.onError=function(){},this.init()}return Object.defineProperty(e.prototype,"url",{get:function(){if(""!==this.listenUrl)return this.listenUrl;var e=this.server.address();return"ws://"+e.address+":"+e.port},enumerable:!0,configurable:!0}),e.prototype.init=function(){var e=this;this.webSocketServer=new qt.Server({perMessageDeflate:this.perMessageDeflate,verifyClient:function(t){return e.validateURLQuery(t)},server:this.server}),(this.server||this.webSocketServer).on("listening",function(){return yt.listenUrl.next(e.url)}),this.webSocketServer.on("error",function(t){yt.listenUrl.next(""),e.onError(t)}),this.webSocketServer.on("connection",function(t){var n,r=e.readURLQuery(t.upgradeReq.url),o=r.type,i=r.wcId,s=r.senderId,a=r.key;if(o===ft.WITH_MEMBER){var c=new _t(e.wcOptions);e.webGroups.set(i,c);var l=At.get(c);e.leaveOnceAlone&&(l.onAlone=function(){l.leave(),e.webGroups.delete(i)}),l.init(a,i),e.onWebGroup(c),n=l.webSocketBuilder}else{c=e.webGroups.get(i);n=At.get(c).webSocketBuilder}n.newWebSocket(t,s,o)})},e.prototype.validateURLQuery=function(e){try{var t=this.readURLQuery(e.req.url),n=t.type,r=t.wcId,o=t.key;switch(n){case ft.WITH_INTERNAL:return this.webGroups.has(r);case ft.WITH_MEMBER:var i=this.webGroups.get(r);return!!o&&(void 0===i||i.state===Gt.LEFT);case ft.WITH_JOINING:i=this.webGroups.get(r);return!!o&&void 0!==i&&i.key===o&&i.state!==Gt.LEFT;default:return!1}}catch(e){return v.warn(e.message),!1}},e.prototype.readURLQuery=function(e){var t=Ft.parse(e,!0).query,n=t.type,r=t.wcId,o=t.senderId,i=t.key;if(!n)throw new Error('Query parse error: "type" parameter is undefined');if(!r)throw new Error('Query parse error: "wcId" parameter is undefined');if(!o)throw new Error('Query parse error: "senderId" parameter is undefined');return{type:Number.parseInt(n,10),wcId:Number.parseInt(r,10),senderId:Number.parseInt(o,10),key:i}},e}(),zt=function(){return function(e){Ut=new Ht(e),this.server=void 0,Reflect.defineProperty(this,"server",{configurable:!1,enumerable:!0,get:function(){return Ut.server}}),this.perMessageDeflate=void 0,Reflect.defineProperty(this,"perMessageDeflate",{configurable:!1,enumerable:!0,get:function(){return Ut.perMessageDeflate}}),this.leaveOnceAlone=void 0,Reflect.defineProperty(this,"leaveOnceAlone",{configurable:!1,enumerable:!0,get:function(){return Ut.leaveOnceAlone}}),this.webGroups=void 0,Reflect.defineProperty(this,"webGroups",{configurable:!1,enumerable:!0,get:function(){return Ut.webGroups}}),this.url=void 0,Reflect.defineProperty(this,"url",{configurable:!1,enumerable:!0,get:function(){return Ut.url}}),this.onWebGroup=void 0,Reflect.defineProperty(this,"onWebGroup",{configurable:!0,enumerable:!0,get:function(){return"none"===Ut.onWebGroup.name?void 0:Ut.onWebGroup},set:function(e){Ut.onWebGroup="function"!=typeof e?function(){}:e}}),this.onError=void 0,Reflect.defineProperty(this,"onError",{configurable:!0,enumerable:!0,get:function(){return"none"===Ut.onError.name?void 0:Ut.onError},set:function(e){Ut.onError="function"!=typeof e?function(){}:e}})}}();n.d(t,"LogLevel",function(){return s}),n.d(t,"setLogLevel",function(){return w}),n.d(t,"Topology",function(){return N}),n.d(t,"SignalingState",function(){return Ue}),n.d(t,"WebGroupState",function(){return it}),n.d(t,"WebGroup",function(){return _t}),n.d(t,"Bot",function(){return zt})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(27);t.SymmetricCrypto=class{static async generateKey(){const e=await r.symmetricCrypto.generateEncryptionKey();return r.symmetricCrypto.toB64(await r.symmetricCrypto.exportKey(e))}async importKey(e){try{this.key=await r.symmetricCrypto.importKey(r.symmetricCrypto.fromB64(e))}catch(e){console.error("IMPORT KEY ERROR: ",e)}}async encrypt(e){try{return await r.symmetricCrypto.encrypt(e,this.key)}catch(e){return console.error("ENCRYPT ERROR: ",e),new Uint8Array}}async decrypt(e){try{return await r.symmetricCrypto.decrypt(e,this.key)}catch(e){return console.error("DECRYPT ERROR INSIDE: ",e.message),new Uint8Array}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.insert=function(e,t,n){console.assert(Number.isSafeInteger(t),"index ∈ safe integer");var r=Math.max(0,t);return e.slice(0,r)+n+e.slice(r)},t.del=function(e,t,n){return console.assert(Number.isSafeInteger(t),"begin ∈ safe integer"),console.assert(Number.isSafeInteger(n),"end ∈ safe integer"),e.slice(0,t)+e.slice(n+1)},t.occurrences=function(e,t){for(var n=0,r=t.length,o=e.indexOf(t);-1!==o;)n++,o=e.indexOf(t,o+r);return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=function(){function e(e,t){console.assert(r.isInt32(e),"offset ∈ int32"),this.offset=e,this.content=t}return e.prototype.equals=function(e){return this.offset===e.offset&&this.content===e.content},e.prototype.applyTo=function(e){return e.insertLocal(this.offset,this.content)},e}();t.TextInsert=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=function(){function e(e,t){console.assert(r.isInt32(e),"offset  ∈ int32"),console.assert(r.isInt32(t),"length  ∈ int32"),console.assert(t>0,"length > 0"),this.offset=e,this.length=t}return e.prototype.equals=function(e){return this.offset===e.offset&&this.length===e.length},e.prototype.applyTo=function(e){return e.delLocal(this.offset,this.offset+this.length-1)},e}();t.TextDelete=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5),o=n(3),i=n(7);function s(e){return null!==e?e.height:0}function a(e){return null!==e?e.sizeNodeAndChildren:0}var c=function(){function e(e,t,n,r,i){console.assert(o.isInt32(t),"actualBegin ∈ int32"),console.assert(e.idInterval.begin<=t,"actualBegin must be greater than or equal to idInterval.begin"),this.block=e,this.actualBegin=t,this.length=n,this.left=r,this.right=i,this.height=Math.max(s(r),s(i))+1,this.sizeNodeAndChildren=n+a(r)+a(i)}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.block,r=t.actualBegin,s=t.length,a=t.left,c=t.right;if(n instanceof Object&&"number"==typeof r&&o.isInt32(r)&&"number"==typeof s&&o.isInt32(s)&&s>=0){var l=i.LogootSBlock.fromPlain(n),u=e.fromPlain(c),h=e.fromPlain(a);if(null!==l&&l.idInterval.begin<=r&&l.idInterval.end-l.idInterval.begin>=s-1)return new e(l,r,s,h,u)}}return null},e.leaf=function(t,n,r){return console.assert(o.isInt32(n),"aOffset ∈ int32"),console.assert(o.isInt32(r),"lenth ∈ int32"),console.assert(r>0,"lenth > 0"),t.addBlock(n,r),new e(t,n,r,null,null)},Object.defineProperty(e.prototype,"actualEnd",{get:function(){return this.actualBegin+this.length-1},enumerable:!0,configurable:!0}),e.prototype.getIdBegin=function(){return this.block.idInterval.getBaseId(this.actualBegin)},e.prototype.getIdEnd=function(){return this.block.idInterval.getBaseId(this.actualEnd)},e.prototype.addString=function(e){console.assert(o.isInt32(e),"length  ∈ int32"),this.sizeNodeAndChildren+=e},e.prototype.appendEnd=function(e){console.assert(o.isInt32(e),"length  ∈ int32"),console.assert(e>0,""+e," > 0");var t=this.actualEnd+1;return this.length+=e,this.block.addBlock(t,e),this.block.idInterval.getBaseId(t)},e.prototype.appendBegin=function(e){return console.assert(o.isInt32(e),"length  ∈ int32"),console.assert(e>0,""+e," > 0"),this.actualBegin-=e,this.length+=e,this.block.addBlock(this.actualBegin,e),this.getIdBegin()},e.prototype.deleteOffsets=function(e,t){console.assert(o.isInt32(e),"begin  ∈ int32"),console.assert(o.isInt32(t),"end  ∈ int32"),console.assert(e<=t,"begin <= end: "+e," <= "+t),console.assert(this.block.idInterval.begin<=e,"this.block.idInterval.begin <= to begin: "+this.block.idInterval.begin," <= "+e),console.assert(t<=this.block.idInterval.end,"end <= this.block.idInterval.end: "+t," <= "+this.block.idInterval.end);var n=null,r=Math.max(this.actualBegin,e),i=Math.min(this.actualEnd,t);if(r<=i){var s=i-r+1;this.block.delBlock(s),s!==this.length&&(r===this.actualBegin?this.actualBegin=i+1:i!==this.actualEnd&&(n=this.split(i-this.actualBegin+1,null))),this.length=this.length-s}return n},e.prototype.split=function(t,n){var r=new e(this.block,this.actualBegin+t,this.length-t,n,this.right);return this.length=t,this.right=r,this.height=Math.max(this.height,r.height),r},e.prototype.leftSubtreeSize=function(){return a(this.left)},e.prototype.rightSubtreeSize=function(){return a(this.right)},e.prototype.sumDirectChildren=function(){this.height=Math.max(s(this.left),s(this.right))+1,this.sizeNodeAndChildren=this.leftSubtreeSize()+this.rightSubtreeSize()+this.length},e.prototype.replaceChildren=function(e,t){this.left===e?this.left=t:this.right===e&&(this.right=t)},e.prototype.balanceScore=function(){return s(this.right)-s(this.left)},e.prototype.become=function(e){this.sizeNodeAndChildren=-this.length+e.length,this.length=e.length,this.actualBegin=e.actualBegin,this.block=e.block},e.prototype.isAppendableAfter=function(e,t){return this.block.isMine(e)&&this.block.idInterval.end===this.actualEnd&&this.block.idInterval.idEnd.hasPlaceAfter(t)},e.prototype.isAppendableBefore=function(e,t){return this.block.isMine(e)&&this.block.idInterval.begin===this.actualBegin&&this.block.idInterval.idBegin.hasPlaceBefore(t)},e.prototype.toString=function(){var e=this.getIdentifierInterval().toString(),t=null!==this.left?this.left.toString():"\t#";return(null!==this.right?this.right.toString():"\t#").replace(/(\t+)/g,"\t$1")+"\n\t"+e+"\n"+t.replace(/(\t+)/g,"\t$1")},e.prototype.toList=function(){var e=this.getIdentifierInterval(),t=null!==this.left?this.left.toList():[],n=null!==this.right?this.right.toList():[];return t.concat(e,n)},e.prototype.getIdentifierInterval=function(){return new r.IdentifierInterval(this.getIdBegin(),this.actualEnd)},e.prototype.getBlocks=function(){var e=[this.block],t=this.left;null!==t&&(e=e.concat(t.getBlocks()));var n=this.right;return null!==n&&(e=e.concat(n.getBlocks())),e},e}();t.RopesNodes=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5),o=Array.prototype.concat,i=function(){function e(e){console.assert(e.length>0,"lid must not be empty"),this.lid=e}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.lid;if(n instanceof Array&&n.length>0){for(var o=!0,i=0,s=[];o&&i<n.length;){var a=r.IdentifierInterval.fromPlain(n[i]);null!==a?s.push(a):o=!1,i++}if(o)return new e(s)}}return null},e.prototype.equals=function(e){return this.lid.length===e.lid.length&&this.lid.every(function(t,n){var r=e.lid[n];return t.equals(r)})},e.prototype.execute=function(e){return o.apply([],this.lid.map(function(t){return e.delBlock(t)}))},e}();t.LogootSDel=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),o=function(){function e(){}return e.fromPlain=function(e){if("object"==typeof e&&null!==e){var t=e.l;if("string"==typeof t&&t.length>0){var n=e.id,o=r.Identifier.fromPlain(n);if(null!==o)return new i(o,t)}}return null},e}(),i=function(){function e(e,t){console.assert(t.length>0,"content must not be empty"),this.id=e,this.content=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.content;if(!("string"==typeof n&&n.length>0))return o.fromPlain(t);var i=t.id,s=r.Identifier.fromPlain(i);if(null!==s)return new e(s,n)}return null},e.prototype.equals=function(e){return this.id.equals(e.id)&&this.content===e.content},e.prototype.execute=function(e){return e.addBlock(this.content,this.id)},e}();t.LogootSAdd=i},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("uws")},function(e,t,n){"use strict";n.r(t);n(33);var r=n(0),o=n(1);class i{constructor(e,t){this.service=e,this.content=t}}class s extends i{}class a{constructor(e,t,n){this.id=e,this.key=t,this.created=n}}class c extends i{constructor(e,t,n,r){super(e,r),this.id=t,this.isBroadcast=n}}class l extends i{}class u extends i{constructor(e,t,n){super(e,n),this.id=t}}var h=n(4);const d=h.Reader,p=h.Writer,f=h.util,g=h.roots.default||(h.roots.default={}),b=g.sync=(()=>{const e={};return e.SyncMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.richLogootSOpMsg=null,e.prototype.querySync=null,e.prototype.replySync=null,Object.defineProperty(e.prototype,"type",{get:f.oneOfGetter(t=["richLogootSOpMsg","querySync","replySync"]),set:f.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.richLogootSOpMsg&&e.hasOwnProperty("richLogootSOpMsg")&&g.sync.RichLogootSOperationMsg.encode(e.richLogootSOpMsg,t.uint32(10).fork()).ldelim(),null!=e.querySync&&e.hasOwnProperty("querySync")&&g.sync.QuerySyncMsg.encode(e.querySync,t.uint32(18).fork()).ldelim(),null!=e.replySync&&e.hasOwnProperty("replySync")&&g.sync.ReplySyncMsg.encode(e.replySync,t.uint32(26).fork()).ldelim(),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.SyncMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.richLogootSOpMsg=g.sync.RichLogootSOperationMsg.decode(e,e.uint32());break;case 2:r.querySync=g.sync.QuerySyncMsg.decode(e,e.uint32());break;case 3:r.replySync=g.sync.ReplySyncMsg.decode(e,e.uint32());break;default:e.skipType(7&t)}}return r},e}(),e.RichLogootSOperationMsg=function(){function e(e){if(this.dependencies=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.id=0,e.prototype.clock=0,e.prototype.logootSAddMsg=null,e.prototype.logootSDelMsg=null,e.prototype.dependencies=f.emptyArray,Object.defineProperty(e.prototype,"type",{get:f.oneOfGetter(t=["logootSAddMsg","logootSDelMsg"]),set:f.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=p.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).int32(e.id),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(16).int32(e.clock),null!=e.logootSAddMsg&&e.hasOwnProperty("logootSAddMsg")&&g.sync.LogootSAddMsg.encode(e.logootSAddMsg,t.uint32(26).fork()).ldelim(),null!=e.logootSDelMsg&&e.hasOwnProperty("logootSDelMsg")&&g.sync.LogootSDelMsg.encode(e.logootSDelMsg,t.uint32(34).fork()).ldelim(),null!=e.dependencies&&e.dependencies.length)for(let n=0;n<e.dependencies.length;++n)g.sync.DotMsg.encode(e.dependencies[n],t.uint32(42).fork()).ldelim();return t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.RichLogootSOperationMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.int32();break;case 2:r.clock=e.int32();break;case 3:r.logootSAddMsg=g.sync.LogootSAddMsg.decode(e,e.uint32());break;case 4:r.logootSDelMsg=g.sync.LogootSDelMsg.decode(e,e.uint32());break;case 5:r.dependencies&&r.dependencies.length||(r.dependencies=[]),r.dependencies.push(g.sync.DotMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.LogootSAddMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=null,e.prototype.content="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.id&&e.hasOwnProperty("id")&&g.sync.IdentifierMsg.encode(e.id,t.uint32(10).fork()).ldelim(),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).string(e.content),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.LogootSAddMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=g.sync.IdentifierMsg.decode(e,e.uint32());break;case 2:r.content=e.string();break;default:e.skipType(7&t)}}return r},e}(),e.IdentifierMsg=function(){function e(e){if(this.tuples=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.tuples=f.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=p.create()),null!=e.tuples&&e.tuples.length)for(let n=0;n<e.tuples.length;++n)g.sync.IdentifierTupleMsg.encode(e.tuples[n],t.uint32(10).fork()).ldelim();return t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.IdentifierMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.tuples&&r.tuples.length||(r.tuples=[]),r.tuples.push(g.sync.IdentifierTupleMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.IdentifierTupleMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.random=0,e.prototype.replicaNumber=0,e.prototype.clock=0,e.prototype.offset=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.random&&e.hasOwnProperty("random")&&t.uint32(8).int32(e.random),null!=e.replicaNumber&&e.hasOwnProperty("replicaNumber")&&t.uint32(16).int32(e.replicaNumber),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(24).int32(e.clock),null!=e.offset&&e.hasOwnProperty("offset")&&t.uint32(32).int32(e.offset),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.IdentifierTupleMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.random=e.int32();break;case 2:r.replicaNumber=e.int32();break;case 3:r.clock=e.int32();break;case 4:r.offset=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.LogootSDelMsg=function(){function e(e){if(this.lid=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.lid=f.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=p.create()),null!=e.lid&&e.lid.length)for(let n=0;n<e.lid.length;++n)g.sync.IdentifierIntervalMsg.encode(e.lid[n],t.uint32(10).fork()).ldelim();return t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.LogootSDelMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.lid&&r.lid.length||(r.lid=[]),r.lid.push(g.sync.IdentifierIntervalMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.IdentifierIntervalMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.idBegin=null,e.prototype.end=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.idBegin&&e.hasOwnProperty("idBegin")&&g.sync.IdentifierMsg.encode(e.idBegin,t.uint32(10).fork()).ldelim(),null!=e.end&&e.hasOwnProperty("end")&&t.uint32(16).int32(e.end),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.IdentifierIntervalMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.idBegin=g.sync.IdentifierMsg.decode(e,e.uint32());break;case 2:r.end=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.QuerySyncMsg=function(){function e(e){if(this.vector={},e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.vector=f.emptyObject,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=p.create()),null!=e.vector&&e.hasOwnProperty("vector"))for(let n=Object.keys(e.vector),r=0;r<n.length;++r)t.uint32(10).fork().uint32(8).int32(n[r]).uint32(16).int32(e.vector[n[r]]).ldelim();return t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n,r=void 0===t?e.len:e.pos+t,o=new g.sync.QuerySyncMsg;for(;e.pos<r;){let t=e.uint32();switch(t>>>3){case 1:e.skip().pos++,o.vector===f.emptyObject&&(o.vector={}),n=e.int32(),e.pos++,o.vector[n]=e.int32();break;default:e.skipType(7&t)}}return o},e}(),e.ReplySyncMsg=function(){function e(e){if(this.richLogootSOpsMsg=[],this.intervals=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.richLogootSOpsMsg=f.emptyArray,e.prototype.intervals=f.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=p.create()),null!=e.richLogootSOpsMsg&&e.richLogootSOpsMsg.length)for(let n=0;n<e.richLogootSOpsMsg.length;++n)g.sync.RichLogootSOperationMsg.encode(e.richLogootSOpsMsg[n],t.uint32(10).fork()).ldelim();if(null!=e.intervals&&e.intervals.length)for(let n=0;n<e.intervals.length;++n)g.sync.IntervalMsg.encode(e.intervals[n],t.uint32(18).fork()).ldelim();return t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.ReplySyncMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.richLogootSOpsMsg&&r.richLogootSOpsMsg.length||(r.richLogootSOpsMsg=[]),r.richLogootSOpsMsg.push(g.sync.RichLogootSOperationMsg.decode(e,e.uint32()));break;case 2:r.intervals&&r.intervals.length||(r.intervals=[]),r.intervals.push(g.sync.IntervalMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.IntervalMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.begin=0,e.prototype.end=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).int32(e.id),null!=e.begin&&e.hasOwnProperty("begin")&&t.uint32(16).int32(e.begin),null!=e.end&&e.hasOwnProperty("end")&&t.uint32(24).int32(e.end),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.IntervalMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.int32();break;case 2:r.begin=e.int32();break;case 3:r.end=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.DotMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.replicaNumber=0,e.prototype.clock=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.replicaNumber&&e.hasOwnProperty("replicaNumber")&&t.uint32(8).int32(e.replicaNumber),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(16).int32(e.clock),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.sync.DotMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.replicaNumber=e.int32();break;case 2:r.clock=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e})(),y=g.collaborator=(()=>{const e={};return e.Collaborator=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.muteCoreId=0,e.prototype.displayName="",e.prototype.login="",e.prototype.email="",e.prototype.avatar="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.muteCoreId&&e.hasOwnProperty("muteCoreId")&&t.uint32(8).sint32(e.muteCoreId),null!=e.displayName&&e.hasOwnProperty("displayName")&&t.uint32(18).string(e.displayName),null!=e.login&&e.hasOwnProperty("login")&&t.uint32(26).string(e.login),null!=e.email&&e.hasOwnProperty("email")&&t.uint32(34).string(e.email),null!=e.avatar&&e.hasOwnProperty("avatar")&&t.uint32(42).string(e.avatar),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.collaborator.Collaborator;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.muteCoreId=e.sint32();break;case 2:r.displayName=e.string();break;case 3:r.login=e.string();break;case 4:r.email=e.string();break;case 5:r.avatar=e.string();break;default:e.skipType(7&t)}}return r},e}(),e})(),m=g.metadata=(()=>{const e={};return e.MetaData=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.type=0,e.prototype.data="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=p.create()),null!=e.type&&e.hasOwnProperty("type")&&t.uint32(0).int32(e.type),null!=e.data&&e.hasOwnProperty("data")&&t.uint32(10).string(e.data),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));let n=void 0===t?e.len:e.pos+t,r=new g.metadata.MetaData;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 0:r.type=e.int32();break;case 1:r.data=e.string();break;default:e.skipType(7&t)}}return r},e}(),e})();class v{constructor(e){this.me=e,this.updateSubject=new r.Subject,this.joinSubject=new r.Subject,this.leaveSubject=new r.Subject,this.disposeSubject=new r.Subject,this.msgToBroadcastSubject=new r.Subject,this.msgToSendRandomlySubject=new r.Subject,this.msgToSendToSubject=new r.Subject,this.collaborators=new Map}getCollaborator(e){for(const[t,n]of this.collaborators)if(n.muteCoreId===e)return n}get onUpdate(){return this.updateSubject.asObservable()}get onJoin(){return this.joinSubject.asObservable()}get onLeave(){return this.leaveSubject.asObservable()}get onMsgToBroadcast(){return this.msgToBroadcastSubject.asObservable()}get onMsgToSendRandomly(){return this.msgToSendRandomlySubject.asObservable()}get onMsgToSendTo(){return this.msgToSendToSubject.asObservable()}set messageSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject),Object(o.filter)(e=>e.service===v.ID)).subscribe(e=>{const t=Object.assign({id:e.id},y.Collaborator.decode(e.content)),n=this.collaborators.get(t.id);n?(n.muteCoreId=t.muteCoreId||n.muteCoreId,n.displayName=t.displayName||n.displayName,n.login=t.login||n.login,n.email=t.email||n.email,n.avatar=t.avatar||n.avatar,this.collaborators.set(n.id,n),this.updateSubject.next(n)):(this.collaborators.set(t.id,t),this.joinSubject.next(t))})}set joinSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>this.emitUpdate(e))}set leaveSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{this.collaborators.delete(e),this.leaveSubject.next(e)})}set updateSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{Object.assign(this.me,e),this.emitUpdate()})}dispose(){this.updateSubject.complete(),this.joinSubject.complete(),this.leaveSubject.complete(),this.disposeSubject.next(),this.disposeSubject.complete(),this.msgToBroadcastSubject.complete(),this.msgToSendRandomlySubject.complete(),this.msgToSendToSubject.complete()}emitUpdate(e){const t=Object.assign({},this.me);delete t.id;const n=y.Collaborator.create(t);if(e){const t=new u(v.ID,e,y.Collaborator.encode(n).finish());this.msgToSendToSubject.next(t)}else{const e=new s(v.ID,y.Collaborator.encode(n).finish());this.msgToBroadcastSubject.next(e)}}}v.ID=421;var S,w=n(2);class I{constructor(e){this.doc=new w.LogootSRopes(e),this.disposeSubject=new r.Subject,this.docDigestSubject=new r.Subject,this.docTreeSubject=new r.Subject,this.localLogootSOperationSubject=new r.Subject,this.remoteTextOperationsSubject=new r.Subject,this.updateSubject=new r.Subject,this.updateSubject.pipe(Object(o.takeUntil)(this.disposeSubject),Object(o.debounceTime)(1e3)).subscribe(()=>{this.docTreeSubject.next(JSON.stringify(this.doc)),this.docDigestSubject.next(this.doc.digest())})}set initSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{this.docID=e})}set localTextOperationsSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{this.handleTextOperations(e),this.updateSubject.next()})}set remoteLogootSOperationSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(({collaborator:e,operations:t})=>{const n=t.map(e=>this.handleRemoteOperation(e)).reduce((e,t)=>e.concat(t),[]);this.remoteTextOperationsSubject.next({collaborator:e,operations:n}),this.updateSubject.next()})}get onDocDigest(){return this.docDigestSubject.asObservable()}get onDocTree(){return this.docTreeSubject.asObservable()}get onLocalLogootSOperation(){return this.localLogootSOperationSubject.asObservable()}get onRemoteTextOperations(){return this.remoteTextOperationsSubject.asObservable()}dispose(){this.disposeSubject.next(),this.disposeSubject.complete(),this.localLogootSOperationSubject.complete(),this.remoteTextOperationsSubject.complete(),this.updateSubject.complete()}handleTextOperations(e){e.forEach(e=>{const t=e.applyTo(this.doc);this.localLogootSOperationSubject.next(t)})}handleRemoteOperation(e){return e.execute(this.doc)}positionFromIndex(e){const t=this.doc.searchNode(e);if(null!==t){const e=t.node.actualBegin+t.i;return{id:w.Identifier.fromBase(t.node.getIdBegin(),e),index:t.i}}}indexFromId(e){return this.doc.searchPos(w.Identifier.fromPlain(e),new Array)}}class O{static merge(e,t){const n=e.docCreated<t.docCreated?e:t;return{docCreated:n.docCreated,cryptoKey:n.cryptoKey}}constructor(e){this._state=e}handleRemoteFixDataState(e){return this._state=O.merge(this._state,e),this._state}get state(){return this._state}}class j{static merge(e,t){const n=e.titleModified>t.titleModified?e:t;return{title:n.title,titleModified:n.titleModified}}constructor(e){this._state=e}handleLocalState(e){this._state=j.merge(this._state,e)}handleRemoteState(e){return this._state=j.merge(this._state,e),this._state}get state(){return this._state}}!function(e){e[e.Title=0]="Title",e[e.FixData=1]="FixData"}(S||(S={}));class k{constructor(e,t,n){this.titleService=new j(t),this.fixDataService=new O(n),this.disposeSubject=new r.Subject,this.localChangeSubject=new r.Subject,this.remoteChangeSubject=new r.Subject,this.msgToBroadcastSubject=new r.Subject,this.msgToSendRandomlySubject=new r.Subject,this.msgToSendToSubject=new r.Subject}static mergeTitle(e,t){return j.merge(e,t)}static mergeFixData(e,t){return O.merge(e,t)}set messageSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject),Object(o.filter)(e=>e.service===k.ID)).subscribe(({content:e})=>{const t=Object.assign({},m.MetaData.decode(e)),n=t.type,r=JSON.parse(t.data);switch(n){case S.Title:this.remoteChangeSubject.next({type:S.Title,data:this.titleService.handleRemoteState(r)});break;case S.FixData:this.remoteChangeSubject.next({type:S.FixData,data:this.fixDataService.handleRemoteFixDataState(r)});break;default:console.error("No MetaDataType for type "+n)}})}set onLocalChange(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(({type:e,data:t})=>{switch(e){case S.Title:const{title:n,titleModified:r}=t;this.titleService.handleLocalState({title:n,titleModified:r}),this.emitMetaData(S.Title,JSON.stringify(this.titleService.state));break;case S.FixData:break;default:console.error("No MetaDataType for type "+e)}})}set joinSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>this.emitAll(e))}get onChange(){return this.remoteChangeSubject.asObservable()}get onMsgToBroadcast(){return this.msgToBroadcastSubject.asObservable()}get onMsgToSendRandomly(){return this.msgToSendRandomlySubject.asObservable()}get onMsgToSendTo(){return this.msgToSendToSubject.asObservable()}dispose(){this.disposeSubject.next(),this.disposeSubject.complete(),this.localChangeSubject.complete(),this.remoteChangeSubject.complete()}emitAll(e){this.emitMetaData(S.FixData,JSON.stringify(this.fixDataService.state),e),this.emitMetaData(S.Title,JSON.stringify(this.titleService.state),e)}emitMetaData(e,t,n){const r=m.MetaData.create({type:e,data:t});if(n){const e=new u(k.ID,n,m.MetaData.encode(r).finish());this.msgToSendToSubject.next(e)}else{const e=new s(k.ID,m.MetaData.encode(r).finish());this.msgToBroadcastSubject.next(e)}}}k.ID=430;class M{constructor(e,t,n){this.id=e,this.begin=t,this.end=n}equals(e){return this.id===e.id&&this.begin===e.begin&&this.end===e.end}}class T{constructor(e,t){this.richLogootSOps=e,this.intervals=t}equals(e){return this.richLogootSOps.length===e.richLogootSOps.length&&this.intervals.length===e.intervals.length&&this.richLogootSOps.every((t,n)=>{const r=e.richLogootSOps[n];return t.equals(r)})&&this.intervals.every((t,n)=>{const r=e.intervals[n];return t.equals(r)})}}class E{static fromPlain(e){if("object"==typeof e&&null!==e&&"number"==typeof e.id&&Number.isInteger(e.id)&&"number"==typeof e.clock&&Number.isInteger(e.clock)&&e.dependencies instanceof Array&&e.dependencies.every(w.isDot)){const t=w.LogootSAdd.fromPlain(e.logootSOp);if(t instanceof w.LogootSAdd)return new E(e.id,e.clock,t);const n=w.LogootSDel.fromPlain(e.logootSOp);if(n instanceof w.LogootSDel&&e.dependencies.length>0)return new E(e.id,e.clock,n,e.dependencies)}return null}constructor(e,t,n,r=[]){this.id=e,this.clock=t,this.logootSOp=n,this.dependencies=r}equals(e){const t=this.id===e.id&&this.clock===e.clock;return this.logootSOp instanceof w.LogootSAdd&&e.logootSOp instanceof w.LogootSAdd?t&&this.logootSOp.equals(e.logootSOp):this.logootSOp instanceof w.LogootSDel&&e.logootSOp instanceof w.LogootSDel&&(t&&this.logootSOp.equals(e.logootSOp)&&this.dependencies.every((t,n)=>{const r=e.dependencies[n];return t.replicaNumber===r.replicaNumber&&t.clock===r.clock}))}}class C{constructor(e,t){this.vector=e,this.richLogootSOps=t}}class L{constructor(e){e&&e.forEach(e=>{console.assert(e>=0,"Each value of a state vector must be positive")}),this.vector=new Map(e)}get(e){return this.vector.get(e)}set(e,t){console.assert(t>=0,"clock must be positive"),console.assert(this.isDeliverable(e,t)),this.vector.set(e,t)}clear(){this.vector.clear()}get size(){return this.vector.size}isAlreadyDelivered(e,t){const n=this.get(e);return void 0!==n&&n>=t}isDeliverable(e,t){if(this.isAlreadyDelivered(e,t))return!1;const n=this.get(e);return void 0===n?0===t:t===n+1}forEach(e){this.vector.forEach(e)}asMap(){return new Map(this.vector)}computeMissingIntervals(e){const t=[];return e.vector.forEach((e,n)=>{const r=this.get(n);if(void 0===r){const r=0,o=e;t.push(new M(n,r,o))}else if(r<e){const o=r+1,i=e;t.push(new M(n,o,i))}}),t}}class R{constructor(e,t){this.id=-1,this.clock=0,this.richLogootSOps=[],this.id=e,this.collabsService=t,this.vector=new L,this.appliedOperationsSubject=new r.Subject,this.disposeSubject=new r.Subject,this.isReadySubject=new r.Subject,this.localRichLogootSOperationSubject=new r.Subject,this.querySyncSubject=new r.Subject,this.remoteLogootSOperationSubject=new r.Subject,this.replySyncSubject=new r.Subject,this.stateSubject=new r.Subject,this.triggerQuerySyncSubject=new r.Subject,this.initPeriodicQuerySync()}get onLocalRichLogootSOperation(){return this.localRichLogootSOperationSubject.asObservable()}get onQuerySync(){return this.querySyncSubject.asObservable()}get onRemoteLogootSOperation(){return this.remoteLogootSOperationSubject.asObservable()}get onReplySync(){return this.replySyncSubject.asObservable()}get onState(){return this.stateSubject.asObservable()}get state(){return new C(this.vector.asMap(),this.richLogootSOps)}get getClock(){return this.clock}get getVector(){return this.vector.asMap()}set localLogootSOperationSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{let t=[];e instanceof w.LogootSDel&&(t=this.getDependencies(e));const n=new E(this.id,this.clock,e,t);this.updateState(n),this.stateSubject.next(this.state),this.localRichLogootSOperationSubject.next(n),this.clock++})}set remoteQuerySyncSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{const t=this.computeMissingOps(e),n=this.vector.computeMissingIntervals(e),r=new T(t,n);this.replySyncSubject.next(r)})}set remoteReplySyncSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{e.richLogootSOps.length>0&&(this.applyRichLogootSOperations(e.richLogootSOps),this.stateSubject.next(this.state)),e.intervals.forEach(e=>{this.richLogootSOps.filter(t=>{const n=t.id,r=t.clock;return e.id===n&&e.begin<=r&&r<=e.end}).forEach(e=>{this.localRichLogootSOperationSubject.next(e)})})})}set remoteRichLogootSOperationSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{this.applyRichLogootSOperations([e]),this.stateSubject.next(this.state)})}setJoinAndStateSources(e,t,n){let i;this.storedStateSource=n,(i=Object(r.zip)(this.isReadySubject,t,e,(e,t,n)=>n).pipe(Object(o.takeUntil)(this.disposeSubject))).pipe(Object(o.take)(1)).subscribe(e=>{e.created||this.querySyncSubject.next(this.vector)})}computeMissingOps(e){return this.richLogootSOps.filter(t=>{const n=t.id,r=t.clock,o=e.get(n);return void 0===o||o<r})}dispose(){this.appliedOperationsSubject.complete(),this.disposeSubject.next(),this.disposeSubject.complete(),this.isReadySubject.complete(),this.localRichLogootSOperationSubject.complete(),this.querySyncSubject.complete(),this.remoteLogootSOperationSubject.complete(),this.replySyncSubject.complete(),this.stateSubject.complete()}set storedStateSource(e){e.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(e=>{this.richLogootSOps=[],this.vector.clear(),this.applyRichLogootSOperations(e.richLogootSOps),this.isReadySubject.next()})}initPeriodicQuerySync(){this.triggerQuerySyncSubject.pipe(Object(o.takeUntil)(this.disposeSubject)).subscribe(()=>{this.querySyncSubject.next(this.vector),this.triggerPeriodicQuerySync()}),this.triggerPeriodicQuerySync()}triggerPeriodicQuerySync(){const e=Math.floor(2*Math.random()*5e3)+-5e3;setTimeout(()=>{this.triggerQuerySyncSubject.next()},1e4+e)}applyRichLogootSOperations(e){const t=e.filter(e=>{const t=e.id,n=e.clock;return!this.vector.isAlreadyDelivered(t,n)});if(t.length>0){const e=[];t.forEach(t=>{if(this.isDeliverable(t)){t.id,t.clock;const n=t.logootSOp;this.updateState(t),e.push(n)}else this.bufferOperation(t)}),e.length>0&&(this.remoteLogootSOperationSubject.next({collaborator:this.collabsService.getCollaborator(t[0].id),operations:e}),this.appliedOperationsSubject.next())}}bufferOperation(e){const t=e.id,n=e.clock,i=new r.Subject;this.appliedOperationsSubject.pipe(Object(o.takeUntil)(i),Object(o.filter)(()=>this.isDeliverable(e))).subscribe(()=>{i.next(),i.complete(),this.vector.isAlreadyDelivered(t,n)||this.applyRichLogootSOperations([e])})}updateState(e){console.assert(this.isDeliverable(e));const t=e.id,n=e.clock;this.vector.set(t,n),this.richLogootSOps.push(e)}isDeliverable(e){const t=e.id,n=e.clock,r=e.dependencies;return this.vector.isDeliverable(t,n)&&this.hasDeliveredDependencies(r)}hasDeliveredDependencies(e){return e.every(e=>{const t=this.vector.get(e.replicaNumber);return void 0!==t&&e.clock<=t})}getDependencies(e){return e.lid.map(e=>{const t=e.idBegin.replicaNumber;return{replicaNumber:t,clock:this.vector.get(t)}})}}class N{constructor(){this.disposeSubject=new r.Subject,this.msgToBroadcastSubject=new r.Subject,this.msgToSendRandomlySubject=new r.Subject,this.msgToSendToSubject=new r.Subject,this.remoteQuerySyncSubject=new r.Subject,this.remoteQuerySyncIdSubject=new r.Subject,this.remoteRichLogootSOperationSubject=new r.Subject,this.remoteReplySyncSubject=new r.Subject}set localRichLogootSOperationSource(e){e.pipe(Object(o.takeUntil)(this.onDispose)).subscribe(e=>{const t=this.generateRichLogootSOpMsg(e),n=new s(N.ID,t);this.msgToBroadcastSubject.next(n)})}set messageSource(e){this.msgSource&&this.msgSource.unsubscribe(),this.msgSource=e.pipe(Object(o.takeUntil)(this.onDispose),Object(o.filter)(e=>e.service===N.ID)).subscribe(e=>{const t=b.SyncMsg.decode(e.content);switch(t.type){case"richLogootSOpMsg":this.handleRichLogootSOpMsg(t.richLogootSOpMsg);break;case"querySync":this.remoteQuerySyncIdSubject.next(e.id),this.handleQuerySyncMsg(t.querySync);break;case"replySync":this.handleReplySyncMsg(t.replySync)}})}set querySyncSource(e){e.pipe(Object(o.takeUntil)(this.onDispose)).subscribe(e=>{const t=this.generateQuerySyncMsg(e),n=new l(N.ID,t);this.msgToSendRandomlySubject.next(n)})}set replySyncSource(e){Object(r.zip)(e,this.remoteQuerySyncIdSubject.asObservable(),(e,t)=>({id:t,replySyncEvent:e})).pipe(Object(o.takeUntil)(this.onDispose)).subscribe(({id:e,replySyncEvent:t})=>{const n=this.generateReplySyncMsg(t.richLogootSOps,t.intervals),r=new u(N.ID,e,n);this.msgToSendToSubject.next(r)})}get onDispose(){return this.disposeSubject.asObservable()}get onMsgToBroadcast(){return this.msgToBroadcastSubject.asObservable()}get onMsgToSendRandomly(){return this.msgToSendRandomlySubject.asObservable()}get onMsgToSendTo(){return this.msgToSendToSubject.asObservable()}get onRemoteRichLogootSOperation(){return this.remoteRichLogootSOperationSubject.asObservable()}get onRemoteQuerySync(){return this.remoteQuerySyncSubject.asObservable()}get onRemoteReplySync(){return this.remoteReplySyncSubject.asObservable()}dispose(){this.disposeSubject.next(),this.disposeSubject.complete(),this.msgToBroadcastSubject.complete(),this.msgToSendRandomlySubject.complete(),this.msgToSendToSubject.complete(),this.remoteQuerySyncSubject.complete(),this.remoteQuerySyncIdSubject.complete(),this.remoteRichLogootSOperationSubject.complete(),this.remoteReplySyncSubject.complete()}handleRichLogootSOpMsg(e){const t=this.deserializeRichLogootSOperation(e);this.remoteRichLogootSOperationSubject.next(t)}handleQuerySyncMsg(e){const t=new Map;Object.keys(e.vector).forEach(n=>{const r=parseInt(n,10);t.set(r,e.vector[n])});const n=new L(t);this.remoteQuerySyncSubject.next(n)}handleReplySyncMsg(e){const t=e.richLogootSOpsMsg.map(e=>this.deserializeRichLogootSOperation(e)),n=e.intervals.map(e=>new M(e.id,e.begin,e.end)),r=new T(t,n);this.remoteReplySyncSubject.next(r)}generateRichLogootSOpMsg(e){const t=this.serializeRichLogootSOperation(e),n=b.SyncMsg.create({richLogootSOpMsg:t});return b.SyncMsg.encode(n).finish()}serializeRichLogootSOperation(e){const t=b.RichLogootSOperationMsg.create({id:e.id,clock:e.clock,dependencies:e.dependencies}),n=e.logootSOp;return n instanceof w.LogootSDel?t.logootSDelMsg=b.LogootSDelMsg.create(n):n instanceof w.LogootSAdd&&(t.logootSAddMsg=b.LogootSAddMsg.create(n)),t}deserializeRichLogootSOperation(e){const t=e.id,n=e.clock,r=e.dependencies;let o;return e.logootSAddMsg?o=e.logootSAddMsg:e.logootSDelMsg&&(o=e.logootSDelMsg),E.fromPlain({id:t,clock:n,logootSOp:o,dependencies:r})}generateQuerySyncMsg(e){const t=b.QuerySyncMsg.create();e.forEach((e,n)=>{t.vector[n]=e});const n=b.SyncMsg.create({querySync:t});return b.SyncMsg.encode(n).finish()}generateReplySyncMsg(e,t){const n=b.ReplySyncMsg.create();n.richLogootSOpsMsg=e.map(e=>this.serializeRichLogootSOperation(e));const r=t.map(e=>{return b.IntervalMsg.create({id:e.id,begin:e.begin,end:e.end})});n.intervals=r;const o=b.SyncMsg.create({replySync:n});return b.SyncMsg.encode(o).finish()}}N.ID=423;const B="undefined"!=typeof window;class P{constructor({profile:e,metaTitle:t,metaFixData:n}){e.muteCoreId||(e.muteCoreId=B?global.crypto.getRandomValues(new Int32Array(1))[0]:global.cryptoNode.randomBytes(4).readInt32BE(0,!0)),this.initSubject=new r.Subject,this.localOperation=new r.Subject,this.remoteOperation=new r.Subject,this.collaboratorsService=new v(Object.assign({id:0},e)),this.docService=new I(e.muteCoreId),this.metaDataService=new k(e.muteCoreId,t,n),this.syncService=new R(e.muteCoreId,this.collaboratorsService),this.syncMessageService=new N,this.docService.initSource=this.initSubject,this.docService.remoteLogootSOperationSource=this.syncService.onRemoteLogootSOperation,this.syncService.localLogootSOperationSource=this.docService.onLocalLogootSOperation.pipe(Object(o.tap)(t=>{this.logLocalOperation(e.muteCoreId,t)})),this.syncService.remoteQuerySyncSource=this.syncMessageService.onRemoteQuerySync,this.syncService.remoteReplySyncSource=this.syncMessageService.onRemoteReplySync,this.syncService.remoteRichLogootSOperationSource=this.syncMessageService.onRemoteRichLogootSOperation.pipe(Object(o.tap)(t=>{this.logRemoteOperation(e.muteCoreId,t)})),this.syncMessageService.localRichLogootSOperationSource=this.syncService.onLocalRichLogootSOperation,this.syncMessageService.querySyncSource=this.syncService.onQuerySync,this.syncMessageService.replySyncSource=this.syncService.onReplySync}set messageSource(e){this.collaboratorsService.messageSource=e,this.syncMessageService.messageSource=e,this.metaDataService.messageSource=e}get onInit(){return this.initSubject.asObservable()}get onMsgToBroadcast(){return Object(r.merge)(this.collaboratorsService.onMsgToBroadcast,this.syncMessageService.onMsgToBroadcast,this.metaDataService.onMsgToBroadcast)}get onMsgToSendRandomly(){return Object(r.merge)(this.collaboratorsService.onMsgToSendRandomly,this.syncMessageService.onMsgToSendRandomly,this.metaDataService.onMsgToSendRandomly)}get onMsgToSendTo(){return Object(r.merge)(this.collaboratorsService.onMsgToSendTo,this.syncMessageService.onMsgToSendTo,this.metaDataService.onMsgToSendTo)}get onLocalOperation(){return this.localOperation.asObservable()}get onRemoteOperation(){return this.remoteOperation.asObservable()}init(e){this.initSubject.next(e)}dispose(){this.collaboratorsService.dispose(),this.docService.dispose(),this.metaDataService.dispose(),this.syncService.dispose(),this.syncMessageService.dispose()}logLocalOperation(e,t){if(t instanceof w.LogootSAdd){const n=t;this.localOperation.next({type:"localInsertion",siteId:e,clock:this.syncService.getClock,operation:n,context:this.syncService.getVector})}else if(t instanceof w.LogootSDel){const n=t;this.localOperation.next({type:"localDeletion",siteId:e,clock:this.syncService.getClock,operation:n,context:this.syncService.getVector})}}logRemoteOperation(e,t){const n=t.logootSOp;if(n instanceof w.LogootSAdd){const r=n;this.remoteOperation.next({type:"remoteInsertion",siteId:e,remoteSiteId:t.id,remoteClock:t.clock,operation:r,context:this.syncService.getVector})}else if(n instanceof w.LogootSDel){const r=n;this.remoteOperation.next({type:"remoteDeletion",siteId:e,remoteSiteId:t.id,remoteClock:t.clock,operation:r,context:this.syncService.getVector})}}}n.d(t,"CollaboratorsService",function(){return v}),n.d(t,"DocService",function(){return I}),n.d(t,"MetaDataType",function(){return S}),n.d(t,"MetaDataService",function(){return k}),n.d(t,"BroadcastMessage",function(){return s}),n.d(t,"JoinEvent",function(){return a}),n.d(t,"NetworkMessage",function(){return c}),n.d(t,"SendRandomlyMessage",function(){return l}),n.d(t,"SendToMessage",function(){return u}),n.d(t,"AbstractMessage",function(){return i}),n.d(t,"MuteCore",function(){return P}),n.d(t,"RichLogootSOperation",function(){return E}),n.d(t,"State",function(){return C}),n.d(t,"TextInsert",function(){return w.TextInsert}),n.d(t,"TextDelete",function(){return w.TextDelete}),global.cryptoNode=n(17)},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("fs")},function(e){e.exports={name:"mute-bot-storage",version:"1.2.2",description:"",main:"index.js",scripts:{start:"node server.js",dev:"nodemon --exec ts-node ./src/index.ts -- --cors --logLevel trace | bunyan",build:"webpack",lint:"tslint --fix -p tsconfig.json 'src/**/*.ts' -e 'src/**/*.proto' -e 'src/**/*.d.ts' && prettier --write --list-different 'src/**/*.ts' './*.{ts,js,json,md}'  && markdownlint ./*.md -i 'CHANGELOG.md'",proto:"pbjs -t static-module -w es6 --no-verify --no-delimited --no-convert src/proto/index.proto -o src/proto/index.es6.js && pbts src/proto/index.es6.js -o src/proto/index.d.ts",postproto:"babel --presets env -o src/proto/index.js src/proto/index.es6.js && rm src/proto/index.es6.js",cz:"git-cz",precommit:"lint-staged && npm run build && git add dist/*",commitmsg:"commitlint -e $GIT_PARAMS",prerelease:"npm run build && git add dist/*",release:"standard-version --no-verify"},files:["dist/server.js"],keywords:["bot","storage","peer-network"],author:"",engines:{node:">=8.1.4"},license:"AGPL-3.0",dependencies:{bunyan:"^1.8.12",commander:"^2.15.1","crypto-api-wrapper":"^0.4.2",kcors:"^2.2.1",koa:"^2.5.1","koa-bodyparser":"^4.2.1","koa-router":"^7.4.0",mongoose:"^5.1.7","mute-core":"^6.0.0",netflux:"^4.1.3","node-webcrypto-ossl":"^1.0.37",rxjs:"^6.2.1",uws:"^10.148.1"},devDependencies:{"@commitlint/cli":"^7.0.0","@commitlint/config-conventional":"^7.0.1","@types/bunyan":"^1.8.4","@types/commander":"^2.12.2","@types/kcors":"^2.2.3","@types/koa":"^2.0.46","@types/koa-bodyparser":"^5.0.0","@types/koa-router":"^7.0.30","@types/mongoose":"^5.0.18","@types/node":"^8.10.20","babel-cli":"^6.26.0","babel-preset-env":"^1.7.0",commitizen:"^2.10.1","cz-conventional-changelog":"^2.1.0",husky:"^0.14.3","lint-staged":"^7.2.0","markdownlint-cli":"^0.10.0",nodemon:"^1.17.5",prettier:"^1.13.6","standard-version":"^4.4.0","ts-loader":"^4.4.2","ts-node":"^7.0.0",tslint:"^5.10.0","tslint-config-prettier":"^1.13.0",typescript:"^2.9.2","validate-commit-msg":"^2.11.1",webpack:"^4.12.2","webpack-cli":"^3.0.8","webpack-node-externals":"^1.7.2"},commitlint:{extends:["@commitlint/config-conventional"]},config:{commitizen:{path:"node_modules/cz-conventional-changelog"}},"lint-staged":{linters:{"*.md":["prettier --write --list-different","git add","markdownlint -i 'CHANGELOG.md'"],"*.ts":["tslint --fix -p tsconfig.json -e src/proto/* -e 'src/**/*.d.ts'","git add"],"*.{ts,json,scss,css}":["prettier --write --list-different -e *proto*","git add"]},concurrent:!1}}},function(e,t){e.exports=require("mongoose")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(23),o=n(10),i="Untitled Document";t.MongooseAdapter=class{constructor(){this.DocModel=r.model("Doc",new r.Schema({key:String,signalingKey:{type:String,require:!0},cryptoKey:{type:String,default:""},title:{type:String,default:i},titleModified:{type:Number,default:0},created:Number,logins:[],operations:Array}))}connect(e,t){return r.connection.on("close",()=>log.warn("Connection to the database has been closed")),r.connect(`mongodb://${e}/${t}`)}async find(e){const t=await this.DocModel.findOne({signalingKey:e}).exec();if(t){const e=t.get("key");e&&(t.set({key:void 0,signalingKey:e,cryptoKey:await o.SymmetricCrypto.generateKey()}),await t.save())}return t}async lookupMetadataByLogin(e){const t=await this.DocModel.find({logins:e},"-operations -logins").exec(),n=[];for(const e of t){const t=e.get("key");t&&(e.set({key:void 0,signalingKey:t,cryptoKey:await o.SymmetricCrypto.generateKey()}),await e.save());const r=e.get("signalingKey"),i=e.get("cryptoKey"),s=e.get("title"),a=e.get("titleModified"),c=e.get("created");n.push({signalingKey:r,cryptoKey:i,title:s,titleModified:a,created:c})}return n}async removeLogin(e,t){const n=await this.find(e);if(n){const e=n.get("logins");for(let n=0;n<e.length;n++)if(e[n]===t){e.splice(n);break}n.set("logins",e),await n.save()}}async create(e){const t=await o.SymmetricCrypto.generateKey();return this.DocModel.create({signalingKey:e,created:Date.now(),cryptoKey:t})}}},function(e,t){e.exports=require("bunyan")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(25);t.createLogger=function(e,t){let n;const o={name:"mute-bot-storage"};switch(""!==e&&(o.streams=[{type:"rotating-file",period:"1d",count:3,path:`${e}/${o.name}.log`}]),n=r.createLogger(o),t){case"none":n.level(r.FATAL+1);break;case"trace":n.level(r.TRACE);break;case"debug":n.level(r.DEBUG);break;case"info":n.level(r.INFO);break;case"warn":n.level(r.WARN);break;case"error":n.level(r.ERROR);break;case"fatal":n.level(r.FATAL);break;default:n.level(r.INFO)}return n}},function(e,t){e.exports=require("crypto-api-wrapper")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.Message=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4));var o=r.Reader,i=r.Writer,s=r.util,a=r.roots.default||(r.roots.default={});t.Message=a.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.service=0,e.prototype.content=s.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=i.create()),null!=e.service&&e.hasOwnProperty("service")&&t.uint32(8).uint32(e.service),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).bytes(e.content),t},e.decode=function(e,t){e instanceof o||(e=o.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new a.Message;e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:r.service=e.uint32();break;case 2:r.content=e.bytes();break;default:e.skipType(7&i)}}return r},e}();t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compareBase=function(e,t){var n=e.idBegin,r=e.begin,o=e.end,i=t.idBegin,s=t.begin,a=t.end;return n.equalsBase(i)?r===s&&o===a?6:o+1===s?4:r===a+1?5:o<s?1:a<r?0:(console.warn("Trying to duplicate existing identifiers: ",e,t),6):function(e,t){var n=e.idBegin,r=t.idBegin;return console.assert(!n.equalsBase(r),"the bases of the ids must be different"),e.containsId(r)?3:t.containsId(n)?2:-1===n.compareTo(r)?1:0}(e,t)}},function(e,t,n){"use strict";var r=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),i=n(8),s=n(3),a=new i.IdentifierTuple(s.INT32_BOTTOM,0,0,0),c=new i.IdentifierTuple(s.INT32_TOP,0,0,0);function l(e,t){var n,o;return r(this,function(r){switch(r.label){case 0:n=0,o=e,r.label=1;case 1:return n<o.length?[4,o[n]]:[3,4];case 2:r.sent(),r.label=3;case 3:return n++,[3,1];case 4:return[4,t];case 5:return r.sent(),[3,4];case 6:return[2]}})}function u(e){return null!==e?e.tuples:[]}t.createBetweenPosition=function(e,t,n,r){console.assert(null===e||null===t||-1===e.compareTo(t),"id1 < id2"),console.assert(s.isInt32(n),"replicaNumber is an int32"),console.assert(s.isInt32(r),"clock is an int32");for(var h=l(u(e),a),d=l(u(t),c),p=[],f=h.next().value,g=d.next().value;g.random-f.random<2;)p.push(f),f=h.next().value,g=d.next().value;var b=s.randomInt32(f.random+1,g.random);return p.push(new i.IdentifierTuple(b,n,r,0)),new o.Identifier(p)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),o=n(5),i=n(30),s=n(3),a=n(29),c=n(16),l=n(7),u=n(15),h=n(14),d=n(13),p=n(12),f=n(11);function g(e){return e.left}function b(e){return e.right}var y=function(){function e(e,t,n,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),void 0===r&&(r=""),console.assert(s.isInt32(e),"replica ∈ int32"),console.assert(s.isInt32(t),"clock ∈ int32"),this.replicaNumber=e,this.clock=t,this.root=n,this.str=r;var o={};if(null!==n){console.assert(r.length===n.sizeNodeAndChildren,"str length must match the number of elements in the model");for(var i=0,a=n.getBlocks();i<a.length;i++){var c=a[i];o[c.idInterval.base.join(",")]=c}}else console.assert(0===r.length,"str must be empty when no root is provided");this.mapBaseToBlock=o}return e.empty=function(){return new e(0,0)},e.fromPlain=function(t,n,r){if(console.assert(s.isInt32(t),"replica ∈ int32"),console.assert(s.isInt32(n),"clock ∈ int32"),"object"==typeof r&&null!==r){var o=r.str,i=r.root;if("string"==typeof o){var a=h.RopesNodes.fromPlain(i);if(null!==a&&o.length===a.sizeNodeAndChildren)return new e(t,n,a,o)}}return null},e.prototype.getBlock=function(e){var t,n=this.mapBaseToBlock,r=e.base.join(",");return n.hasOwnProperty(r)?t=n[r]:(t=new l.LogootSBlock(e,0),this.mapBaseToBlock[r]=t),t},e.prototype.addBlockFrom=function(e,t,n,r){var o=this,i=this.addBlockFromRec(e,t,n,r);return i.forEach(function(e){o.applyTextInsert(e)}),i},e.prototype.addBlockFromRec=function(e,t,n,i){for(var s=[],c=[],l=!0,u=i;l;)switch(s.push(n),a.compareBase(t,n.getIdentifierInterval())){case 0:null===n.right?(n.right=h.RopesNodes.leaf(this.getBlock(t),t.begin,e.length),u=u+n.leftSubtreeSize()+n.length,c.push(new p.TextInsert(u,e)),l=!1):(u=u+n.leftSubtreeSize()+n.length,n=n.right);break;case 1:null===n.left?(n.left=h.RopesNodes.leaf(this.getBlock(t),t.begin,e.length),c.push(new p.TextInsert(u,e)),l=!1):n=n.left;break;case 2:var d=n.getIdBegin().length-1,f=t.idBegin.tuples[d].offset,g=h.RopesNodes.leaf(this.getBlock(t),t.begin,e.length);s.push(n.split(f-n.actualBegin+1,g)),u+=n.leftSubtreeSize(),c.push(new p.TextInsert(u+f-n.actualBegin+1,e)),l=!1;break;case 3:d=t.idBegin.length-1,f=n.getIdBegin().tuples[d].offset;var b=e.substr(0,f+1-t.begin),y=new o.IdentifierInterval(t.idBegin,f);null===n.left?(n.left=h.RopesNodes.leaf(this.getBlock(y),y.begin,b.length),c.push(new p.TextInsert(u,b))):Array.prototype.push.apply(c,this.addBlockFromRec(b,y,n.left,u)),b=e.substr(f+1-t.begin,e.length);var m=r.Identifier.fromBase(t.idBegin,f+1);y=new o.IdentifierInterval(m,t.end),u=u+n.leftSubtreeSize()+n.length,null===n.right?(n.right=h.RopesNodes.leaf(this.getBlock(y),y.begin,b.length),c.push(new p.TextInsert(u,b))):Array.prototype.push.apply(c,this.addBlockFromRec(b,y,n.right,u)),l=!1;break;case 4:if(null!==n.left){var v=n.getIdBegin().minOffsetAfterPrev(n.left.getIdEnd(),t.begin);(S=e.substr(v-t.begin,e.length)).length>0&&(n.appendBegin(S.length),c.push(new p.TextInsert(u+n.leftSubtreeSize(),S)),this.ascendentUpdate(s,S.length)),v-1>=t.begin?(e=e.substr(0,v-t.begin),t=new o.IdentifierInterval(t.idBegin,v-1),n=n.left):l=!1}else c.push(new p.TextInsert(u,e)),n.appendBegin(e.length),this.ascendentUpdate(s,e.length),l=!1;break;case 5:if(null!==n.right){v=n.getIdEnd().maxOffsetBeforeNext(n.right.getIdBegin(),t.end);var S=e.substr(0,v+1-t.begin);if(u=u+n.leftSubtreeSize()+n.length,S.length>0&&(n.appendEnd(S.length),c.push(new p.TextInsert(u,S)),this.ascendentUpdate(s,S.length)),t.end>=v+1){e=e.substr(v+1-t.begin,e.length);m=r.Identifier.fromBase(t.idBegin,v+1);t=new o.IdentifierInterval(m,t.end),n=n.right,u+=S.length}else l=!1}else u=u+n.leftSubtreeSize()+n.length,c.push(new p.TextInsert(u,e)),n.appendEnd(e.length),this.ascendentUpdate(s,e.length),l=!1;break;case 6:l=!1}return this.balance(s),c},e.prototype.applyTextInsert=function(e){this.str=f.insert(this.str,e.offset,e.content)},e.prototype.applyTextDelete=function(e){var t=e.offset+e.length-1;this.str=f.del(this.str,e.offset,t)},e.prototype.addBlock=function(e,t){var n=new o.IdentifierInterval(t,t.lastOffset+e.length-1);if(null===this.root){var r=new l.LogootSBlock(n,0);this.mapBaseToBlock[r.idInterval.base.join(",")]=r,this.root=h.RopesNodes.leaf(r,t.lastOffset,e.length);var i=new p.TextInsert(0,e);return this.applyTextInsert(i),[i]}return this.addBlockFrom(e,n,this.root,0)},e.prototype.mkNode=function(e,t,n){console.assert(s.isInt32(n)&&n>0,"length ∈ int32"),console.assert(n>0,"length > 0");var r=i.createBetweenPosition(e,t,this.replicaNumber,this.clock++),a=new o.IdentifierInterval(r,n-1),c=new l.LogootSBlock(a,0);return this.mapBaseToBlock[a.base.join(",")]=c,h.RopesNodes.leaf(c,0,n)},e.prototype.insertLocal=function(e,t){if(console.assert(s.isInt32(e),"pos ∈ int32"),null===this.root)return this.root=this.mkNode(null,null,t.length),this.str=f.insert(this.str,e,t),new c.LogootSAdd(this.root.getIdBegin(),t);var n=void 0,r=this.str.length;this.str=f.insert(this.str,e,t);var o=void 0;if(0===e){if((o=[]).push(this.root),(a=this.getXest(g,o)).isAppendableBefore(this.replicaNumber,t.length)){var i=a.appendBegin(t.length);return this.ascendentUpdate(o,t.length),new c.LogootSAdd(i,t)}n=this.mkNode(null,a.getIdBegin(),t.length),a.left=n}else if(e>=r){var a;if((o=[]).push(this.root),(a=this.getXest(b,o)).isAppendableAfter(this.replicaNumber,t.length)){var l=a.appendEnd(t.length);return this.ascendentUpdate(o,t.length),new c.LogootSAdd(l,t)}n=this.mkNode(a.getIdEnd(),null,t.length),a.right=n}else{var u=this.searchNode(e);if(u.i>0){var h=u.node.block.idInterval.getBaseId(u.node.actualBegin+u.i-1),d=u.node.block.idInterval.getBaseId(u.node.actualBegin+u.i);n=this.mkNode(h,d,t.length),(o=u.path).push(u.node.split(u.i,n))}else{var p=this.searchNode(e-1);if(u.node.isAppendableBefore(this.replicaNumber,t.length)){var y=u.node.appendBegin(t.length);return this.ascendentUpdate(u.path,t.length),new c.LogootSAdd(y,t)}if(p.node.isAppendableAfter(this.replicaNumber,t.length)){var m=p.node.appendEnd(t.length);return this.ascendentUpdate(p.path,t.length),new c.LogootSAdd(m,t)}(n=this.mkNode(p.node.getIdEnd(),u.node.getIdBegin(),t.length)).right=p.node.right,p.node.right=n,(o=p.path).push(n)}}return this.balance(o),new c.LogootSAdd(n.getIdBegin(),t)},e.prototype.getXest=function(e,t){for(var n=t[t.length-1],r=e(n);null!==r;)n=r,t[t.length]=r,r=e(r);return n},e.prototype.searchPos=function(e,t){for(var n=0,r=this.root;null!==r;)if(t.push(r),-1===e.compareTo(r.getIdBegin()))r=r.left;else if(1===e.compareTo(r.getIdEnd()))n=n+r.leftSubtreeSize()+r.length,r=r.right;else{if(e.equalsBase(r.getIdBegin()))return n+r.leftSubtreeSize();r=null}return-1},e.prototype.searchNode=function(e){console.assert(s.isInt32(e),"pos ∈ int32");for(var t=this.root,n=[];null!==t;){n.push(t);var r=t.leftSubtreeSize();if(e<r)t=t.left;else{if(e<r+t.length)return{i:e-r,node:t,path:n};e-=r+t.length,t=t.right}}return null},e.prototype.ascendentUpdate=function(e,t){console.assert(s.isInt32(t),"length ∈ int32");for(var n=0,r=e;n<r.length;n++){r[n].addString(t)}},e.prototype.delBlock=function(e){for(var t,n=this,i=[];;){var s=[];if(-1===(t=this.searchPos(e.idBegin,s))){if(!(e.begin<e.end))break;var a=r.Identifier.fromBase(e.idBegin,e.begin+1);e=new o.IdentifierInterval(a,e.end)}else{var c=s[s.length-1],l=Math.min(e.end,c.actualEnd),u=t+e.begin-c.actualBegin,h=l-e.begin+1;i.push(new d.TextDelete(u,h));var p=c.deleteOffsets(e.begin,l);if(0===c.length?this.delNode(s):null!==p?(s.push(p),this.balance(s)):this.ascendentUpdate(s,e.begin-l-1),l===e.end)break;a=r.Identifier.fromBase(e.idBegin,l);e=new o.IdentifierInterval(a,e.end)}}return i.forEach(function(e){n.applyTextDelete(e)}),i},e.prototype.delLocal=function(e,t){console.assert(s.isInt32(e),"begin ∈ int32"),console.assert(s.isInt32(t),"end ∈ int32"),console.assert(e<=t,""+e," <= "+t),this.str=f.del(this.str,e,t);var n=t-e+1,i=[];do{var a=this.searchNode(e);if(null!==a){var c=a.node.actualBegin+a.i,l=Math.min(c+n-1,a.node.actualEnd),h=a.node.getIdBegin(),d=r.Identifier.fromBase(h,c);i.push(new o.IdentifierInterval(d,l));var p=a.node.deleteOffsets(c,l);n-=l-c+1,0===a.node.length?this.delNode(a.path):null!==p?(a.path.push(p),this.balance(a.path)):this.ascendentUpdate(a.path,c-l-1)}else n=0}while(n>0);return new u.LogootSDel(i)},e.prototype.delNode=function(e){var t=e[e.length-1];if(0===t.block.nbElement&&delete this.mapBaseToBlock[t.block.idInterval.base.join(",")],null===t.right)t===this.root?this.root=t.left:(e.pop(),e[e.length-1].replaceChildren(t,t.left));else if(null===t.left)t===this.root?this.root=t.right:(e.pop(),e[e.length-1].replaceChildren(t,t.right));else{e.push(t.right);var n=this.getMinPath(e);t.become(n),e.pop(),e[e.length-1].replaceChildren(n,n.right)}this.balance(e)},e.prototype.getMinPath=function(e){console.assert(0!==e.length,"path has at least one item");for(var t=e[e.length-1];null!==t.left;)t=t.left,e.push(t);return t},e.prototype.balance=function(e){for(;e.length>0;){var t=e.pop(),n=0===e.length?null:e[e.length-1];t.sumDirectChildren();for(var r=t.balanceScore();Math.abs(r)>=2;)n=r>=2?null!==t.right&&t.right.balanceScore()<=-1?this.rotateRL(t,n):this.rotateLeft(t,n):null!==t.left&&t.left.balanceScore()>=1?this.rotateLR(t,n):this.rotateRight(t,n),e.push(n),r=t.balanceScore()}},e.prototype.rotateLeft=function(e,t){console.assert(null!==e.right,"There exists a right node"),console.assert(e===this.root==(null===t),"The father is null when we are rotating left the root");var n=e.right;return e===this.root?this.root=n:t.replaceChildren(e,n),e.right=n.left,n.left=e,e.sumDirectChildren(),n.sumDirectChildren(),n},e.prototype.rotateRight=function(e,t){console.assert(null!==e.left,"There exists a left node"),console.assert(e===this.root==(null===t),"The father is null when we are rotating right the root");var n=e.left;return e===this.root?this.root=n:t.replaceChildren(e,n),e.left=n.right,n.right=e,e.sumDirectChildren(),n.sumDirectChildren(),n},e.prototype.rotateRL=function(e,t){console.assert(null!==e.right,"There exists a right node");var n=e.right;return console.assert(null!==n.left,"There exists a left node of the right node"),this.rotateRight(n,e),this.rotateLeft(e,t)},e.prototype.rotateLR=function(e,t){console.assert(null!==e.left,"There exists a left node");var n=e.left;return console.assert(null!==n.right,"There exists a right node of the left node"),this.rotateLeft(n,e),this.rotateRight(e,t)},e.prototype.getNext=function(e){var t=e[e.length-1];if(null===t.right){if(e.length>1)if(e[e.length-2].left===t)return e.pop(),!0;return!1}return e.push(t.right),this.getXest(g,e),!0},e.prototype.digest=function(){var e=0,t=this.root;if(null!==t)for(var n=0,r=t.toList();n<r.length;n++){e=17*e+r[n].digest()|0}return e},e}();t.LogootSRopes=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDot=function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.replicaNumber&&Number.isInteger(e.replicaNumber)&&"number"==typeof e.clock&&Number.isInteger(e.clock)}},function(e,t){e.exports=require("core-js/es7/global")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(19),o=n(0),i=n(1),s=n(9),a=n(28),c=n(10),l=12e4;s.setLogLevel(s.LogLevel.DEBUG,s.LogLevel.TOPOLOGY);class u{constructor(e,t,n,u){this.displayName=e,this.login=t,this.wg=n,this.cryptoInitialized=!1,this.saveChain=Promise.resolve(),this.signalingKey=n.key,this.crypto=new c.SymmetricCrypto,this.mongooseAdapter=u,this.joinSubject=new o.Subject,this.messageSubject=new o.ReplaySubject,this.collabJoinSubject=new o.ReplaySubject,this.collabLeaveSubject=new o.ReplaySubject,this.cryptoReady=new o.Subject,this.saveInterval=setInterval(()=>{this.mongoDoc&&this.saveContent()},l),this.mongooseAdapter.find(this.signalingKey).then(e=>e||this.mongooseAdapter.create(this.signalingKey)).then(e=>{this.mongoDoc=e,this.operations=e.get("operations").map(e=>r.RichLogootSOperation.fromPlain(e)),this.muteCore=this.createMuteCore(e,this.signalingKey,this.operations),this.muteCore.metaDataService.onChange.subscribe(({type:e,data:t})=>{switch(e){case r.MetaDataType.Title:const{title:n,titleModified:o}=t;this.saveTitle(n,o);break;case r.MetaDataType.FixData:const{docCreated:s,cryptoKey:a}=t;this.saveFixData(s,a),this.crypto.importKey(a).then(()=>{if(!this.cryptoInitialized){const e=this.muteCore;e.syncMessageService.messageSource=this.messageSubject.pipe(i.filter(({service:e})=>423===e),i.flatMap(e=>this.crypto.decrypt(e.content).then(t=>Object.assign({},e,{content:t})))),e.syncMessageService.onMsgToBroadcast.pipe(i.flatMap(e=>this.crypto.encrypt(e.content).then(t=>Object.assign({},e,{content:t})))).subscribe(e=>this.wg.send(this.encode(e))),e.syncMessageService.onMsgToSendRandomly.pipe(i.flatMap(e=>this.crypto.encrypt(e.content).then(t=>Object.assign({},e,{content:t})))).subscribe(e=>{const t=this.wg.members.filter(e=>e!==this.wg.myId),n=Math.ceil(Math.random()*t.length)-1;this.wg.sendTo(t[n],this.encode(e))}),e.syncMessageService.onMsgToSendTo.pipe(i.flatMap(e=>this.crypto.encrypt(e.content).then(t=>Object.assign({},e,{content:t})))).subscribe(e=>this.wg.sendTo(e.id,this.encode(e))),this.cryptoReady.next(),this.cryptoInitialized=!0}}).catch(e=>{log.error("Import Key error: ",e.message)})}}),this.muteCore.collaboratorsService.joinSource=this.collabJoinSubject,this.muteCore.collaboratorsService.leaveSource=this.collabLeaveSubject,this.muteCore.collaboratorsService.messageSource=this.messageSubject,this.muteCore.metaDataService.joinSource=this.collabJoinSubject,this.muteCore.metaDataService.messageSource=this.messageSubject}).catch(e=>{log.error(`Error when searching for the document ${this.signalingKey}`,e)}),n.onMessage=((e,t)=>{try{const{service:n,content:o}=a.Message.decode(t);this.messageSubject.next(new r.NetworkMessage(n,e,!0,o))}catch(e){log.error("Failed to decode a message: ",e)}}),n.onStateChange=(e=>{e===s.WebGroupState.JOINED?this.joinSubject.next(new r.JoinEvent(this.wg.myId,this.signalingKey,!1)):e===s.WebGroupState.LEFT&&(this.saveContent(),global.clearInterval(this.saveInterval))}),n.onMemberJoin=(e=>this.collabJoinSubject.next(e)),n.onMemberLeave=(e=>{n.members.length<2&&this.saveContent(),this.collabLeaveSubject.next(e)})}saveContent(){try{this.mongoDoc&&this.lastReceivedState&&this.lastReceivedState!==this.lastSaveState&&(this.mongoDoc.set({operations:this.lastReceivedState.richLogootSOps}),this.saveDoc(),this.lastSaveState=this.lastReceivedState)}catch(e){log.error("Failed save the document content:",e)}}saveLogins(e){if(this.mongoDoc&&e&&"anonymous"!==e){const t=this.mongoDoc.get("logins");t.push(e),this.mongoDoc.set({logins:t}),this.saveDoc()}}saveTitle(e,t){this.mongoDoc&&(this.mongoDoc.set({title:e,titleModified:t}),this.saveDoc())}saveFixData(e,t){this.mongoDoc&&(this.mongoDoc.set({created:e,cryptoKey:t}),this.saveDoc())}async saveDoc(){this.saveChain=this.saveChain.then(async()=>{this.mongoDoc&&await this.mongoDoc.save()}).catch(e=>log.warn("Could not save the document: ",e))}createMuteCore(e,t,n){const i=new r.MuteCore({profile:{displayName:this.displayName,login:this.login,avatar:u.AVATAR},metaTitle:{title:e.get("title"),titleModified:e.get("titleModified")},metaFixData:{docCreated:e.get("created"),cryptoKey:e.get("cryptoKey")}});return o.merge(i.collaboratorsService.onMsgToBroadcast,i.metaDataService.onMsgToBroadcast).subscribe(e=>this.wg.send(this.encode(e))),o.merge(i.collaboratorsService.onMsgToSendRandomly,i.metaDataService.onMsgToSendRandomly).subscribe(e=>{const t=this.wg.members.filter(e=>e!==this.wg.myId),n=Math.ceil(Math.random()*t.length)-1;this.wg.sendTo(t[n],this.encode(e))}),o.merge(i.collaboratorsService.onMsgToSendTo,i.metaDataService.onMsgToSendTo).subscribe(e=>this.wg.sendTo(e.id,this.encode(e))),i.collaboratorsService.onUpdate.subscribe(e=>this.saveLogins(e.login)),i.collaboratorsService.onJoin.subscribe(e=>{this.saveLogins(e.login)}),i.syncService.onState.subscribe(e=>this.lastReceivedState=e),i.init(t),i.syncService.setJoinAndStateSources(this.joinSubject,this.cryptoReady,o.from([new r.State(new Map,n)])),i}encode(e){return a.Message.encode(a.Message.create(e)).finish()}}u.AVATAR="https://www.shareicon.net/data/256x256/2016/01/01/228083_bot_256x256.png",u.ID=9137,t.BotStorage=u},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("text-encoding")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("kcors")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("commander")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(42),o=n(41),i=n(40),s=n(39),a=n(38),c=n(37),l=n(9),u=n(34),h=n(26),d=n(24);let p;try{p=n(22).version}catch(e){try{p=n(!function(){var e=new Error("Cannot find module './package.json'");throw e.code="MODULE_NOT_FOUND",e}()).version}catch(t){log.error(e),p=""}}const f="Repono",g="0.0.0.0",b=2e4,y="ws://localhost:20000",m="ws://localhost:8010",v="mutedocs",S=!1,w="info",I="";r.version(p).option("-h, --host <ip or host name>","Host address to bind to.",g).option("-p, --port <number>","Port to use for the server.",b).option("-b, --botURL <number>","Bot public URL.",y).option("-s, --signalingURL <url>","Signaling server url.",m).option("","\n").option("--cors","Enable Cross-origin Resource Sharing.",S).option("-n, --name <bot name>","Bot name.",f).option("-d, --database <name>","Database name.",v).option("","\n").option("--key <file path>","Private key for the certificate").option("--cert <file path>","The server certificate").option("--ca <file path>","The additional intermediate certificate or certificates that web browsers will need in order to validate the server certificate.").option("","\n").option("-l, --logLevel <none|trace|debug|info|warn|error|fatal>","Logging level.",/^(none|trace|debug|info|warn|error|fatal)$/i,w).option("-f, --logFolder <path>","Path to where log files would be stored.\n                              If not specified stdout will used.",I).parse(process.argv);const{name:O,host:j,port:k,botURL:M,signalingURL:T,database:E,cors:C,key:L,cert:R,ca:N,logLevel:B,logFolder:P}=r;global.log=h.createLogger(P,B),"none"!==B&&l.setLogLevel(l.LogLevel.DEBUG),process.on("uncaughtException",e=>{console.error("uncaughtException -> ",e)});const D=new d.MongooseAdapter;function x(e){const t=e.split("/");return`bot.storage@${e.indexOf("://")>-1?t[2]:t[0]}`}D.connect("localhost",E).then(()=>{log.info("Connected to the database  ✓");let e=new s;const t=new c;return t.get("/info",e=>{e.body={displayName:O,login:x(M),avatar:u.BotStorage.AVATAR,version:p}}).get("/docs/:login",async e=>{await D.lookupMetadataByLogin(e.params.login).then(t=>e.body=t).catch(t=>{log.error("Could not retreive the document list stored in database",t),e.status=500})}).post("/remove",e=>{const{key:t,login:n}=e.request.body;e.request.body&&t&&n?D.removeLogin(t,n).then(()=>{e.body=!0}).catch(t=>{log.error(`Failed to remove login ${n}`,t),e.status=500}):e.status=404}),C&&(e=e.use(i())),e.use(a()).use(t.routes()).use(t.allowedMethods())}).then(e=>{if(log.info("Configured routes  ✓"),L&&R&&N){const t=n(21);return n(20).createServer({key:t.readFileSync(L),cert:t.readFileSync(R),ca:t.readFileSync(N)},e.callback())}return o.createServer(e.callback())}).then(e=>{return log.info("Configured server  ✓"),e.on("clientError",e=>{log.error("Client Error",e)}),new l.Bot({url:M,server:e,leaveOnceAlone:!1,webGroupOptions:{signalingServer:T}}).onWebGroup=(e=>{const t=new u.BotStorage(O,x(M),e,D);log.info("New peer to peer network invitation received for ",t.signalingKey)}),new Promise(t=>e.listen(k,j,t))}).then(()=>{log.info(`Successfully started the storage bot server at ${j}:${k} with the following settings`,{name:O,host:j,port:k,botURL:M,signalingURL:T,logLevel:B,logFolder:P})}).catch(e=>log.fatal(e))}]);