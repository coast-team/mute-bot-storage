!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=44)}([function(e,t){e.exports=require("rxjs")},function(e,t){e.exports=require("rxjs/operators")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(32);t.isDot=r.isDot;var o=n(8);t.IdentifierTuple=o.IdentifierTuple;var i=n(6);t.Identifier=i.Identifier;var s=n(5);t.IdentifierInterval=s.IdentifierInterval;var c=n(7);t.LogootSBlock=c.LogootSBlock;var a=n(31);t.LogootSRopes=a.LogootSRopes;var u=n(13);t.RopesNodes=u.RopesNodes;var l=n(15);t.LogootSAdd=l.LogootSAdd;var p=n(14);t.LogootSDel=p.LogootSDel;var h=n(12);t.TextDelete=h.TextDelete;var f=n(11);t.TextInsert=f.TextInsert;var d=n(10);t.insert=d.insert,t.del=d.del,t.occurrences=d.occurrences},function(e,t,n){"use strict";function r(e){return Number.isSafeInteger(e)&&t.INT32_BOTTOM<=e&&e<=t.INT32_TOP}Object.defineProperty(t,"__esModule",{value:!0}),t.INT32_BOTTOM=-2147483648,t.INT32_TOP=2147483647,t.isInt32=r,t.randomInt32=function(e,t){console.assert(r(e),"l must be an int32"),console.assert(r(t),"u must be an int32"),console.assert(e<t,"u is greater than l");var n=Math.random()*(t-e)+e,o=Math.floor(n);return console.assert(r(o)&&e<=o&&o<t,"result is an integer 32 in [l, u["),o}},function(e,t){e.exports=require("protobufjs/minimal")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),o=n(3),i=function(){function e(e,t){console.assert(o.isInt32(t),"end ∈ int32"),console.assert(e.lastOffset<=t,"idBegin must be less than or equal to idEnd"),this.idBegin=e,this.end=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=r.Identifier.fromPlain(t.idBegin);if(null!==n&&"number"==typeof t.end&&o.isInt32(t.end)&&n.lastOffset<=t.end)return new e(n,t.end)}return null},Object.defineProperty(e.prototype,"begin",{get:function(){return this.idBegin.lastOffset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"idEnd",{get:function(){return this.getBaseId(this.end)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.end-this.begin+1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){return this.idBegin.base},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dot",{get:function(){return this.idBegin.dot},enumerable:!0,configurable:!0}),e.prototype.equals=function(e){return this.idBegin.equals(e.idBegin)&&this.begin===e.begin&&this.end===e.end},e.prototype.union=function(t,n){console.assert(o.isInt32(t),"aBegin ∈ int32"),console.assert(o.isInt32(n),"aEnd ∈ int32");var i=Math.min(this.begin,t),s=Math.max(this.end,n);return new e(r.Identifier.fromBase(this.idBegin,i),s)},e.prototype.containsId=function(e){return-1===this.idBegin.compareTo(e)&&1===this.idEnd.compareTo(e)},e.prototype.getBaseId=function(e){return console.assert(o.isInt32(e),"offset ∈ int32"),console.assert(this.begin<=e&&e<=this.end,"offset must be included in the interval"),r.Identifier.fromBase(this.idBegin,e)},e.prototype.digest=function(){return 17*this.idBegin.digest()+this.end|0},e.prototype.toString=function(){return"IdInterval["+this.idBegin.tuples.join(",")+" .. "+this.end+"]"},e}();t.IdentifierInterval=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(8),o=n(3),i=function(){function e(e){console.assert(e.length>0,"tuples must not be empty");var t=e[e.length-1].random;console.assert(t>o.INT32_BOTTOM),this.tuples=e}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.tuples;if(n instanceof Array&&n.length>0){for(var i=!0,s=0,c=[];i&&s<n.length;){var a=r.IdentifierTuple.fromPlain(n[s]);null!==a?c.push(a):i=!1,s++}if(i&&c[c.length-1].random>o.INT32_BOTTOM)return new e(c)}}return null},e.fromBase=function(t,n){return console.assert(o.isInt32(n),"offset ∈ int32"),new e(t.tuples.map(function(e,o){return o===t.length-1?r.IdentifierTuple.fromBase(e,n):e}))},Object.defineProperty(e.prototype,"generator",{get:function(){return this.tuples[this.tuples.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.tuples.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"replicaNumber",{get:function(){return this.tuples[this.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clock",{get:function(){return this.tuples[this.length-1].clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dot",{get:function(){return{replicaNumber:this.replicaNumber,clock:this.clock}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastOffset",{get:function(){return this.tuples[this.length-1].offset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){var e=this.tuples.reduce(function(e,t){return e.concat(t.asArray())},[]);return e.pop(),e},enumerable:!0,configurable:!0}),e.prototype.longestCommonPrefix=function(e){for(var t=[],n=Math.min(this.tuples.length,e.tuples.length),r=0;r<n&&this.tuples[r].equals(e.tuples[r]);)t.push(this.tuples[r]),r++;return t},e.prototype.longestCommonBase=function(e){for(var t=[],n=Math.min(this.tuples.length,e.tuples.length),r=0,o=!1;!o&&r<n;){var i=this.tuples[r],s=e.tuples[r];i.equals(s)?t.push(i):(o=!0,i.equalsBase(s)&&t.push(i)),r++}return t},e.prototype.isPrefix=function(e){return this.isBasePrefix(e)&&this.lastOffset===e.tuples[this.length-1].offset},e.prototype.isBasePrefix=function(e){var t=this;return this.length<=e.length&&this.tuples.every(function(n,r){var o=e.tuples[r];return r===t.tuples.length-1?n.equalsBase(o):n.equals(o)})},e.prototype.commonPrefixLength=function(e){for(var t=Math.min(this.tuples.length,e.tuples.length),n=0;n<t&&this.tuples[n].equals(e.tuples[n]);)n++;return n},e.prototype.equals=function(e){return this.equalsBase(e)&&this.lastOffset===e.lastOffset},e.prototype.equalsBase=function(e){var t=this;return this.length===e.length&&this.tuples.every(function(n,r){var o=e.tuples[r];return r<t.length-1?n.equals(o):n.equalsBase(o)})},e.prototype.compareTo=function(e){if(this.equals(e))return 0;if(this.isPrefix(e))return-1;if(e.isPrefix(this))return 1;var t=this.commonPrefixLength(e);return this.tuples[t].compareTo(e.tuples[t])},e.prototype.hasPlaceAfter=function(e){return console.assert(o.isInt32(e),"length ∈ int32"),console.assert(e>0,"length > 0 "),this.lastOffset<=o.INT32_TOP-e},e.prototype.hasPlaceBefore=function(e){return console.assert(o.isInt32(e),"length ∈ int32"),console.assert(e>0,"length > 0 "),this.lastOffset>=o.INT32_BOTTOM+e},e.prototype.maxOffsetBeforeNext=function(e,t){if(console.assert(o.isInt32(t),"max ∈ int32"),console.assert(-1===this.compareTo(e),"this must be less than next"),this.equalsBase(e))return console.assert(t<e.lastOffset,"max must be less than next.lastOffset"),t;if(this.isBasePrefix(e)){var n=e.tuples[this.length-1].offset;return Math.min(n,t)}return t},e.prototype.minOffsetAfterPrev=function(e,t){if(console.assert(o.isInt32(t),"min ∈ int32"),this.equalsBase(e))return console.assert(t>e.lastOffset,"min must be greater than prev.lastOffset"),t;if(this.isBasePrefix(e)){var n=e.tuples[this.length-1].offset;return Math.max(n+1,t)}return t},e.prototype.digest=function(){return this.tuples.reduce(function(e,t){return 17*e+t.digest()|0},0)},e.prototype.toString=function(){return"Id["+this.tuples.join(",")+"]"},e}();t.Identifier=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5),o=n(3),i=function(){function e(e,t){console.assert(o.isInt32(t)&&t>=0,"nbElt must be a non-negative integer"),this.idInterval=e,this.nbElement=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.idInterval,i=t.nbElement;if(n instanceof Object&&"number"==typeof i&&o.isInt32(i)&&i>=0){var s=r.IdentifierInterval.fromPlain(n);if(null!==s)return new e(s,i)}}return null},e.prototype.isMine=function(e){return this.idInterval.idBegin.generator===e},e.prototype.addBlock=function(e,t){console.assert(o.isInt32(t)&&t>0,"length must be a positive int32"),this.nbElement+=t,this.idInterval=this.idInterval.union(e,e+t-1)},e.prototype.delBlock=function(e){console.assert(o.isInt32(e)&&e>0,"nbElt must be a positive int32"),this.nbElement-=e},e.prototype.toString=function(){return"{"+this.nbElement+","+this.idInterval.toString()+"}"},e}();t.LogootSBlock=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=function(){function e(e,t,n,o){console.assert([e,t,n,o].every(r.isInt32),"each value ∈ int32"),this.random=e,this.replicaNumber=t,this.clock=n,this.offset=o}return e.fromPlain=function(t){return"object"==typeof t&&null!==t&&"number"==typeof t.random&&r.isInt32(t.random)&&"number"==typeof t.replicaNumber&&r.isInt32(t.replicaNumber)&&"number"==typeof t.clock&&r.isInt32(t.clock)&&"number"==typeof t.offset&&r.isInt32(t.offset)?new e(t.random,t.replicaNumber,t.clock,t.offset):null},e.fromBase=function(t,n){return console.assert(r.isInt32(n),"offset ∈ int32"),new e(t.random,t.replicaNumber,t.clock,n)},e.prototype.compareTo=function(e){for(var t=this.asArray(),n=e.asArray(),r=0;r<t.length&&t[r]===n[r];)r++;return r===t.length?0:t[r]<n[r]?-1:1},e.prototype.equals=function(e){return this.equalsBase(e)&&this.offset===e.offset},e.prototype.equalsBase=function(e){return this.random===e.random&&this.replicaNumber===e.replicaNumber&&this.clock===e.clock},e.prototype.asArray=function(){return[this.random,this.replicaNumber,this.clock,this.offset]},e.prototype.digest=function(){return this.asArray().reduce(function(e,t){return 17*e+t|0},0)},e.prototype.toString=function(){return this.random+","+this.replicaNumber+","+this.clock+","+this.offset},e}();t.IdentifierTuple=o},function(e,t,n){"use strict";n.r(t);n(37);var r,o,i=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s},s=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e},c="background-color: #FFCA28; padding: 0 3px",a="background-color: #b3ba2e; padding: 0 3px",u="background-color: #CE93D8; padding: 0 3px",l="background-color: #90CAF9; padding: 0 3px",p="background-color: #26A69A; padding: 0 3px",h="background-color: #66BB6A; padding: 0 3px",f="background-color: #F57C00; padding: 0 3px",d="background-color: #9FA8DA; padding: 0 2px",g="background-color: #EF9A9A; padding: 0 2px",b={webgroup:function(){},signalingState:function(){},webGroupState:function(){},webrtc:function(){},channel:function(){},topology:function(){},signaling:function(){},channelBuilder:function(){},debug:function(){}};(o=r||(r={}))[o.DEBUG=0]="DEBUG",o[o.WEB_GROUP=1]="WEB_GROUP",o[o.WEBRTC=2]="WEBRTC",o[o.CHANNEL=3]="CHANNEL",o[o.TOPOLOGY=4]="TOPOLOGY",o[o.SIGNALING=5]="SIGNALING",o[o.CHANNEL_BUILDER=6]="CHANNEL_BUILDER";var y=[];function v(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];(y=e).includes(r.WEB_GROUP)?(b.webgroup=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WebGroup%c: "+e,c,""):console.info.apply(console,s(["%cNETFLUX WebGroup%c: "+e,c,""],t))},b.signalingState=function(e,t){console.info("%cNETFLUX "+t+" WebGroup%c: Signaling: %c"+e+"%c",c,"",d,"")},b.webGroupState=function(e,t){console.info("%cNETFLUX "+t+" WebGroup%c: WebGroup: %c"+e+"%c",c,"",g,"")}):(b.webgroup=function(){},b.signalingState=function(){},b.webGroupState=function(){}),y.includes(r.WEBRTC)?b.webrtc=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WebRTC%c: "+e,u,""):console.info.apply(console,s(["%cNETFLUX WebRTC%c: "+e,u,""],t))}:b.webrtc=function(){},y.includes(r.CHANNEL)?b.channel=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Channel%c: "+e,l,""):console.info.apply(console,s(["%cNETFLUX Channel%c: "+e,l,""],t))}:b.channel=function(){},y.includes(r.TOPOLOGY)?b.topology=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Topology%c: "+e,p,""):console.info.apply(console,s(["%cNETFLUX Topology%c: "+e,p,""],t))}:b.topology=function(){},y.includes(r.SIGNALING)?b.signaling=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Signaling%c: "+e,h,""):console.info.apply(console,s(["%cNETFLUX Signaling%c: "+e,h,""],t))}:b.signaling=function(){},y.includes(r.CHANNEL_BUILDER)?b.channelBuilder=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX ChannelBuilder%c: "+e,f,""):console.info.apply(console,s(["%cNETFLUX ChannelBuilder%c: "+e,f,""],t))}:b.channelBuilder=function(){},y.includes(r.DEBUG)?b.debug=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Debug%c: "+e,a,""):console.info.apply(console,s(["%cNETFLUX Debug%c: "+e,a,""],t))}:b.debug=function(){}}var m=void 0!==global.window;function S(){return!m||global.navigator.onLine}function w(){return!m||"visible"===global.document.visibilityState}function I(e){return new RegExp("^(?:wss|ws)://[^\\s]+(?::\\d{2,5})?$","i").test(e)}function O(e){void 0===e&&(e=[]);var t=M()[0];return e.includes(t)?O(e):t}var j=512;function k(e){return e.split("/")[2]}function M(e){var t;if(void 0===e&&(e=1),m)t=new Uint32Array(e),global.crypto.getRandomValues(t);else{t=[];for(var n=global.cryptoNode.randomBytes(4*e),r=0;r<n.length;r+=4)t[t.length]=n.readUInt32BE(r,!0)}return t}function T(){return!!global.WebSocket}var E,P,L,R=n(0),N=n(1),B=function(){function e(e,t){this.serviceId=e,this.proto=t}return e.prototype.useWebChannelStream=function(e){var t=this;return{id:e.STREAM_ID,message:e.messageFromStream.pipe(Object(N.filter)(function(e){return e.serviceId===t.serviceId}),Object(N.map)(function(e){var n=e.channel,r=e.senderId,o=e.recipientId,i=e.content;return{channel:n,senderId:r,recipientId:o,msg:t.decode(i)}})),send:function(n,r){e.sendOverStream({senderId:e.myId,recipientId:r,serviceId:t.serviceId,content:n instanceof Uint8Array?n:t.encode(n)})}}},e.prototype.useSignalingStream=function(e){var t=this;return{id:e.STREAM_ID,message:e.messageFromStream.pipe(Object(N.filter)(function(e){return e.serviceId===t.serviceId}),Object(N.map)(function(e){var n=e.senderId,r=e.content;return{senderId:n,msg:t.decode(r)}})),send:function(n,r){e.sendOverStream({recipientId:r,serviceId:t.serviceId,content:n instanceof Uint8Array?n:t.encode(n)})}}},e.prototype.useAllStreams=function(e,t){var n=this.useWebChannelStream(e),r=this.useSignalingStream(t);return{message:Object(R.merge)(n.message.pipe(Object(N.map)(function(e){var t=e.senderId,r=e.msg;return{streamId:n.id,senderId:t,msg:r}})),r.message.pipe(Object(N.map)(function(e){var t=e.senderId,n=e.msg;return{streamId:r.id,senderId:t,msg:n}}))),sendOver:function(e,t,o){e===n.id?n.send(t,o):r.send(t,o)}}},e.prototype.encode=function(e){return this.proto.encode(this.proto.create(e)).finish()},e.prototype.decode=function(e){return this.proto.decode(e)},e}(),C=(E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}E(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});!function(e){e[e.FULL_MESH=0]="FULL_MESH"}(P||(P={})),function(e){e[e.JOINING=0]="JOINING",e[e.JOINED=1]="JOINED",e[e.LEFT=2]="LEFT"}(L||(L={}));var D=function(e){function t(t,n,r){var o=e.call(this,n,r)||this;return o.wc=t,o.wcStream=e.prototype.useWebChannelStream.call(o,t),o.stateSubject=new R.Subject,o._state=L.LEFT,o}return C(t,e),Object.defineProperty(t.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),t.prototype.setJoinedState=function(){this.setState(L.JOINED)},t.prototype.setLeftState=function(){this.setState(L.LEFT)},t.prototype.setState=function(e){this.state!==e&&(this._state=e,this.stateSubject.next(e))},t}(B),A="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function x(e,t){return e(t={exports:{}},t.exports),t.exports}var _=function(e,t){var n=new Array(arguments.length-1),r=0,o=2,i=!0;for(;o<arguments.length;)n[r++]=arguments[o++];return new Promise(function(o,s){n[r]=function(e){if(i)if(i=!1,e)s(e);else{for(var t=new Array(arguments.length-1),n=0;n<t.length;)t[n++]=arguments[n];o.apply(null,t)}};try{e.apply(t||null,n)}catch(e){i&&(i=!1,s(e))}})};var q=x(function(e,t){var n=t;n.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&"="===e.charAt(t);)++n;return Math.ceil(3*e.length)/4-n};for(var r=new Array(64),o=new Array(123),i=0;i<64;)o[r[i]=i<26?i+65:i<52?i+71:i<62?i-4:i-59|43]=i++;n.encode=function(e,t,n){for(var o,i=null,s=[],c=0,a=0;t<n;){var u=e[t++];switch(a){case 0:s[c++]=r[u>>2],o=(3&u)<<4,a=1;break;case 1:s[c++]=r[o|u>>4],o=(15&u)<<2,a=2;break;case 2:s[c++]=r[o|u>>6],s[c++]=r[63&u],a=0}c>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,s)),c=0)}return a&&(s[c++]=r[o],s[c++]=61,1===a&&(s[c++]=61)),i?(c&&i.push(String.fromCharCode.apply(String,s.slice(0,c))),i.join("")):String.fromCharCode.apply(String,s.slice(0,c))};n.decode=function(e,t,n){for(var r,i=n,s=0,c=0;c<e.length;){var a=e.charCodeAt(c++);if(61===a&&s>1)break;if(void 0===(a=o[a]))throw Error("invalid encoding");switch(s){case 0:r=a,s=1;break;case 1:t[n++]=r<<2|(48&a)>>4,r=a,s=2;break;case 2:t[n++]=(15&r)<<4|(60&a)>>2,r=a,s=3;break;case 3:t[n++]=(3&r)<<6|a,s=0}}if(1===s)throw Error("invalid encoding");return n-i},n.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}}),U=G;function G(){this._listeners={}}G.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this},G.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var n=this._listeners[e],r=0;r<n.length;)n[r].fn===t?n.splice(r,1):++r;return this},G.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],r=1;r<arguments.length;)n.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,n)}return this};var F=W(W);function W(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),n=new Uint8Array(t.buffer),r=128===n[3];function o(e,r,o){t[0]=e,r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2],r[o+3]=n[3]}function i(e,r,o){t[0]=e,r[o]=n[3],r[o+1]=n[2],r[o+2]=n[1],r[o+3]=n[0]}function s(e,r){return n[0]=e[r],n[1]=e[r+1],n[2]=e[r+2],n[3]=e[r+3],t[0]}function c(e,r){return n[3]=e[r],n[2]=e[r+1],n[1]=e[r+2],n[0]=e[r+3],t[0]}e.writeFloatLE=r?o:i,e.writeFloatBE=r?i:o,e.readFloatLE=r?s:c,e.readFloatBE=r?c:s}():function(){function t(e,t,n,r){var o=t<0?1:0;if(o&&(t=-t),0===t)e(1/t>0?0:2147483648,n,r);else if(isNaN(t))e(2143289344,n,r);else if(t>3.4028234663852886e38)e((o<<31|2139095040)>>>0,n,r);else if(t<1.1754943508222875e-38)e((o<<31|Math.round(t/1.401298464324817e-45))>>>0,n,r);else{var i=Math.floor(Math.log(t)/Math.LN2);e((o<<31|i+127<<23|8388607&Math.round(t*Math.pow(2,-i)*8388608))>>>0,n,r)}}function n(e,t,n){var r=e(t,n),o=2*(r>>31)+1,i=r>>>23&255,s=8388607&r;return 255===i?s?NaN:o*(1/0):0===i?1.401298464324817e-45*o*s:o*Math.pow(2,i-150)*(s+8388608)}e.writeFloatLE=t.bind(null,J),e.writeFloatBE=t.bind(null,H),e.readFloatLE=n.bind(null,z),e.readFloatBE=n.bind(null,Q)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),n=new Uint8Array(t.buffer),r=128===n[7];function o(e,r,o){t[0]=e,r[o]=n[0],r[o+1]=n[1],r[o+2]=n[2],r[o+3]=n[3],r[o+4]=n[4],r[o+5]=n[5],r[o+6]=n[6],r[o+7]=n[7]}function i(e,r,o){t[0]=e,r[o]=n[7],r[o+1]=n[6],r[o+2]=n[5],r[o+3]=n[4],r[o+4]=n[3],r[o+5]=n[2],r[o+6]=n[1],r[o+7]=n[0]}function s(e,r){return n[0]=e[r],n[1]=e[r+1],n[2]=e[r+2],n[3]=e[r+3],n[4]=e[r+4],n[5]=e[r+5],n[6]=e[r+6],n[7]=e[r+7],t[0]}function c(e,r){return n[7]=e[r],n[6]=e[r+1],n[5]=e[r+2],n[4]=e[r+3],n[3]=e[r+4],n[2]=e[r+5],n[1]=e[r+6],n[0]=e[r+7],t[0]}e.writeDoubleLE=r?o:i,e.writeDoubleBE=r?i:o,e.readDoubleLE=r?s:c,e.readDoubleBE=r?c:s}():function(){function t(e,t,n,r,o,i){var s=r<0?1:0;if(s&&(r=-r),0===r)e(0,o,i+t),e(1/r>0?0:2147483648,o,i+n);else if(isNaN(r))e(0,o,i+t),e(2146959360,o,i+n);else if(r>1.7976931348623157e308)e(0,o,i+t),e((s<<31|2146435072)>>>0,o,i+n);else{var c;if(r<2.2250738585072014e-308)e((c=r/5e-324)>>>0,o,i+t),e((s<<31|c/4294967296)>>>0,o,i+n);else{var a=Math.floor(Math.log(r)/Math.LN2);1024===a&&(a=1023),e(4503599627370496*(c=r*Math.pow(2,-a))>>>0,o,i+t),e((s<<31|a+1023<<20|1048576*c&1048575)>>>0,o,i+n)}}}function n(e,t,n,r,o){var i=e(r,o+t),s=e(r,o+n),c=2*(s>>31)+1,a=s>>>20&2047,u=4294967296*(1048575&s)+i;return 2047===a?u?NaN:c*(1/0):0===a?5e-324*c*u:c*Math.pow(2,a-1075)*(u+4503599627370496)}e.writeDoubleLE=t.bind(null,J,0,4),e.writeDoubleBE=t.bind(null,H,4,0),e.readDoubleLE=n.bind(null,z,0,4),e.readDoubleBE=n.bind(null,Q,4,0)}(),e}function J(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}function H(e,t,n){t[n]=e>>>24,t[n+1]=e>>>16&255,t[n+2]=e>>>8&255,t[n+3]=255&e}function z(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function Q(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}var V=function(e){try{var t=void 0;if(t&&(t.length||Object.keys(t).length))return t}catch(e){}return null};var K=x(function(e,t){var n=t;n.length=function(e){for(var t=0,n=0,r=0;r<e.length;++r)(n=e.charCodeAt(r))<128?t+=1:n<2048?t+=2:55296==(64512&n)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t},n.read=function(e,t,n){if(n-t<1)return"";for(var r,o=null,i=[],s=0;t<n;)(r=e[t++])<128?i[s++]=r:r>191&&r<224?i[s++]=(31&r)<<6|63&e[t++]:r>239&&r<365?(r=((7&r)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,i[s++]=55296+(r>>10),i[s++]=56320+(1023&r)):i[s++]=(15&r)<<12|(63&e[t++])<<6|63&e[t++],s>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,i)),s=0);return o?(s&&o.push(String.fromCharCode.apply(String,i.slice(0,s))),o.join("")):String.fromCharCode.apply(String,i.slice(0,s))},n.write=function(e,t,n){for(var r,o,i=n,s=0;s<e.length;++s)(r=e.charCodeAt(s))<128?t[n++]=r:r<2048?(t[n++]=r>>6|192,t[n++]=63&r|128):55296==(64512&r)&&56320==(64512&(o=e.charCodeAt(s+1)))?(r=65536+((1023&r)<<10)+(1023&o),++s,t[n++]=r>>18|240,t[n++]=r>>12&63|128,t[n++]=r>>6&63|128,t[n++]=63&r|128):(t[n++]=r>>12|224,t[n++]=r>>6&63|128,t[n++]=63&r|128);return n-i}}),X=function(e,t,n){var r=n||8192,o=r>>>1,i=null,s=r;return function(n){if(n<1||n>o)return e(n);s+n>r&&(i=e(r),s=0);var c=t.call(i,s,s+=n);return 7&s&&(s=1+(7|s)),c}};var $=Y;function Y(e,t){this.lo=e>>>0,this.hi=t>>>0}var Z=Y.zero=new Y(0,0);Z.toNumber=function(){return 0},Z.zzEncode=Z.zzDecode=function(){return this},Z.length=function(){return 1};var ee=Y.zeroHash="\0\0\0\0\0\0\0\0";Y.fromNumber=function(e){if(0===e)return Z;var t=e<0;t&&(e=-e);var n=e>>>0,r=(e-n)/4294967296>>>0;return t&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new Y(n,r)},Y.from=function(e){if("number"==typeof e)return Y.fromNumber(e);if(oe.isString(e)){if(!oe.Long)return Y.fromNumber(parseInt(e,10));e=oe.Long.fromString(e)}return e.low||e.high?new Y(e.low>>>0,e.high>>>0):Z},Y.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+4294967296*n)}return this.lo+4294967296*this.hi},Y.prototype.toLong=function(e){return oe.Long?new oe.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var te=String.prototype.charCodeAt;Y.fromHash=function(e){return e===ee?Z:new Y((te.call(e,0)|te.call(e,1)<<8|te.call(e,2)<<16|te.call(e,3)<<24)>>>0,(te.call(e,4)|te.call(e,5)<<8|te.call(e,6)<<16|te.call(e,7)<<24)>>>0)},Y.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},Y.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},Y.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},Y.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10};var ne,re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},oe=x(function(e,t){var n=t;function r(e,t,n){for(var r=Object.keys(t),o=0;o<r.length;++o)void 0!==e[r[o]]&&n||(e[r[o]]=t[r[o]]);return e}function o(e){function t(e,n){if(!(this instanceof t))return new t(e,n);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}n.asPromise=_,n.base64=q,n.EventEmitter=U,n.float=F,n.inquire=V,n.utf8=K,n.pool=X,n.LongBits=$,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=Boolean(A.process&&A.process.versions&&A.process.versions.node),n.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},n.isString=function(e){return"string"==typeof e||e instanceof String},n.isObject=function(e){return e&&"object"===(void 0===e?"undefined":re(e))},n.isset=n.isSet=function(e,t){var n=e[t];return!(null==n||!e.hasOwnProperty(t))&&("object"!==(void 0===n?"undefined":re(n))||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},n.Buffer=function(){try{var e=n.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(e){return"number"==typeof e?n.Buffer?n._Buffer_allocUnsafe(e):new n.Array(e):n.Buffer?n._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=A.dcodeIO&&A.dcodeIO.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(e){return e?n.LongBits.from(e).toHash():n.LongBits.zeroHash},n.longFromHash=function(e,t){var r=n.LongBits.fromHash(e);return n.Long?n.Long.fromBits(r.lo,r.hi,t):r.toNumber(Boolean(t))},n.merge=r,n.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},n.newError=o,n.ProtocolError=o("ProtocolError"),n.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var e=Object.keys(this),n=e.length-1;n>-1;--n)if(1===t[e[n]]&&void 0!==this[e[n]]&&null!==this[e[n]])return e[n]}},n.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var e=n.Buffer;e?(n._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,n){return new e(t,n)},n._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):n._Buffer_from=n._Buffer_allocUnsafe=null}}),ie=pe,se=oe.LongBits,ce=oe.base64,ae=oe.utf8;function ue(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}function le(){}function pe(){this.len=0,this.head=new ue(le,0,0),this.tail=this.head,this.states=null}function he(e,t,n){t[n]=255&e}function fe(e,t){this.len=e,this.next=void 0,this.val=t}function de(e,t,n){for(;e.hi;)t[n++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[n++]=127&e.lo|128,e.lo=e.lo>>>7;t[n++]=e.lo}function ge(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}pe.create=oe.Buffer?function(){return(pe.create=function(){return new ne})()}:function(){return new pe},pe.alloc=function(e){return new oe.Array(e)},oe.Array!==Array&&(pe.alloc=oe.pool(pe.alloc,oe.Array.prototype.subarray)),pe.prototype._push=function(e,t,n){return this.tail=this.tail.next=new ue(e,t,n),this.len+=t,this},fe.prototype=Object.create(ue.prototype),fe.prototype.fn=function(e,t,n){for(;e>127;)t[n++]=127&e|128,e>>>=7;t[n]=e},pe.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new fe((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},pe.prototype.int32=function(e){return e<0?this._push(de,10,se.fromNumber(e)):this.uint32(e)},pe.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},pe.prototype.uint64=function(e){var t=se.from(e);return this._push(de,t.length(),t)},pe.prototype.int64=pe.prototype.uint64,pe.prototype.sint64=function(e){var t=se.from(e).zzEncode();return this._push(de,t.length(),t)},pe.prototype.bool=function(e){return this._push(he,1,e?1:0)},pe.prototype.fixed32=function(e){return this._push(ge,4,e>>>0)},pe.prototype.sfixed32=pe.prototype.fixed32,pe.prototype.fixed64=function(e){var t=se.from(e);return this._push(ge,4,t.lo)._push(ge,4,t.hi)},pe.prototype.sfixed64=pe.prototype.fixed64,pe.prototype.float=function(e){return this._push(oe.float.writeFloatLE,4,e)},pe.prototype.double=function(e){return this._push(oe.float.writeDoubleLE,8,e)};var be=oe.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var r=0;r<e.length;++r)t[n+r]=e[r]};pe.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(he,1,0);if(oe.isString(e)){var n=pe.alloc(t=ce.length(e));ce.decode(e,n,0),e=n}return this.uint32(t)._push(be,t,e)},pe.prototype.string=function(e){var t=ae.length(e);return t?this.uint32(t)._push(ae.write,t,e):this._push(he,1,0)},pe.prototype.fork=function(){return this.states=new function(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}(this),this.head=this.tail=new ue(le,0,0),this.len=0,this},pe.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new ue(le,0,0),this.len=0),this},pe.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this},pe.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t},pe._configure=function(e){ne=e};var ye=me;(me.prototype=Object.create(ie.prototype)).constructor=me;var ve=oe.Buffer;function me(){ie.call(this)}me.alloc=function(e){return(me.alloc=oe._Buffer_allocUnsafe)(e)};var Se=ve&&ve.prototype instanceof Uint8Array&&"set"===ve.prototype.set.name?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var r=0;r<e.length;)t[n++]=e[r++]};function we(e,t,n){e.length<40?oe.utf8.write(e,t,n):t.utf8Write(e,n)}me.prototype.bytes=function(e){oe.isString(e)&&(e=oe._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(Se,t,e),this},me.prototype.string=function(e){var t=ve.byteLength(e);return this.uint32(t),t&&this._push(we,t,e),this};var Ie,Oe=Te,je=oe.LongBits,ke=oe.utf8;function Me(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function Te(e){this.buf=e,this.pos=0,this.len=e.length}var Ee,Pe="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new Te(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new Te(e);throw Error("illegal buffer")};function Le(){var e=new je(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw Me(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Me(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function Re(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function Ne(){if(this.pos+8>this.len)throw Me(this,8);return new je(Re(this.buf,this.pos+=4),Re(this.buf,this.pos+=4))}Te.create=oe.Buffer?function(e){return(Te.create=function(e){return oe.Buffer.isBuffer(e)?new Ie(e):Pe(e)})(e)}:Pe,Te.prototype._slice=oe.Array.prototype.subarray||oe.Array.prototype.slice,Te.prototype.uint32=(Ee=4294967295,function(){if(Ee=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return Ee;if(Ee=(Ee|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return Ee;if(Ee=(Ee|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return Ee;if(Ee=(Ee|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return Ee;if(Ee=(Ee|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return Ee;if((this.pos+=5)>this.len)throw this.pos=this.len,Me(this,10);return Ee}),Te.prototype.int32=function(){return 0|this.uint32()},Te.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},Te.prototype.bool=function(){return 0!==this.uint32()},Te.prototype.fixed32=function(){if(this.pos+4>this.len)throw Me(this,4);return Re(this.buf,this.pos+=4)},Te.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Me(this,4);return 0|Re(this.buf,this.pos+=4)},Te.prototype.float=function(){if(this.pos+4>this.len)throw Me(this,4);var e=oe.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},Te.prototype.double=function(){if(this.pos+8>this.len)throw Me(this,4);var e=oe.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},Te.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Me(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,n):t===n?new this.buf.constructor(0):this._slice.call(this.buf,t,n)},Te.prototype.string=function(){var e=this.bytes();return ke.read(e,0,e.length)},Te.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw Me(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw Me(this)}while(128&this.buf[this.pos++]);return this},Te.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;;){if(4==(e=7&this.uint32()))break;this.skipType(e)}break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},Te._configure=function(e){Ie=e;var t=oe.Long?"toLong":"toNumber";oe.merge(Te.prototype,{int64:function(){return Le.call(this)[t](!1)},uint64:function(){return Le.call(this)[t](!0)},sint64:function(){return Le.call(this).zzDecode()[t](!1)},fixed64:function(){return Ne.call(this)[t](!0)},sfixed64:function(){return Ne.call(this)[t](!1)}})};var Be=Ce;function Ce(e){Oe.call(this,e)}(Ce.prototype=Object.create(Oe.prototype)).constructor=Ce,oe.Buffer&&(Ce.prototype._slice=oe.Buffer.prototype.slice),Ce.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len))};var De=Ae;function Ae(e,t,n){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");oe.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(n)}(Ae.prototype=Object.create(oe.EventEmitter.prototype)).constructor=Ae,Ae.prototype.rpcCall=function e(t,n,r,o,i){if(!o)throw TypeError("request must be specified");var s=this;if(!i)return oe.asPromise(e,s,t,n,r,o);if(s.rpcImpl)try{return s.rpcImpl(t,n[s.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(e,n){if(e)return s.emit("error",e,t),i(e);if(null!==n){if(!(n instanceof r))try{n=r[s.responseDelimited?"decodeDelimited":"decode"](n)}catch(e){return s.emit("error",e,t),i(e)}return s.emit("data",n,t),i(null,n)}s.end(!0)})}catch(e){return s.emit("error",e,t),void setTimeout(function(){i(e)},0)}else setTimeout(function(){i(Error("already ended"))},0)},Ae.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};var xe,_e,qe,Ue=x(function(e,t){t.Service=De}),Ge={},Fe=x(function(e,t){var n=t;function r(){n.Reader._configure(n.BufferReader),n.util._configure()}n.build="minimal",n.Writer=ie,n.BufferWriter=ye,n.Reader=Oe,n.BufferReader=Be,n.util=oe,n.rpc=Ue,n.roots=Ge,n.configure=r,n.Writer._configure(n.BufferWriter),r()}),We=Fe.Reader,Je=Fe.Writer,He=Fe.util,ze=Fe.roots,Qe=We,Ve=Je,Ke=He,Xe=ze.default||(ze.default={}),$e=Xe.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.senderId=0,e.prototype.recipientId=0,e.prototype.serviceId=0,e.prototype.content=Ke.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.senderId&&e.hasOwnProperty("senderId")&&t.uint32(8).uint32(e.senderId),null!=e.recipientId&&e.hasOwnProperty("recipientId")&&t.uint32(16).uint32(e.recipientId),null!=e.serviceId&&e.hasOwnProperty("serviceId")&&t.uint32(24).uint32(e.serviceId),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(34).bytes(e.content),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.senderId=e.uint32();break;case 2:r.recipientId=e.uint32();break;case 3:r.serviceId=e.uint32();break;case 4:r.content=e.bytes();break;default:e.skipType(7&o)}}return r},e}(),Ye=Xe.userMessage=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.length=0,e.prototype.type=0,e.prototype.full=Ke.newBuffer([]),e.prototype.chunk=null;var t,n,r;return Object.defineProperty(e.prototype,"contentType",{get:Ke.oneOfGetter(t=["full","chunk"]),set:Ke.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.length&&e.hasOwnProperty("length")&&t.uint32(8).uint32(e.length),null!=e.type&&e.hasOwnProperty("type")&&t.uint32(16).int32(e.type),null!=e.full&&e.hasOwnProperty("full")&&t.uint32(26).bytes(e.full),null!=e.chunk&&e.hasOwnProperty("chunk")&&Xe.userMessage.Message.Chunk.encode(e.chunk,t.uint32(34).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.userMessage.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.length=e.uint32();break;case 2:r.type=e.int32();break;case 3:r.full=e.bytes();break;case 4:r.chunk=Xe.userMessage.Message.Chunk.decode(e,e.uint32());break;default:e.skipType(7&o)}}return r},e.Chunk=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.nb=0,e.prototype.content=Ke.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.nb&&e.hasOwnProperty("nb")&&t.uint32(16).uint32(e.nb),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(34).bytes(e.content),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.userMessage.Message.Chunk;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:r.nb=e.uint32();break;case 4:r.content=e.bytes();break;default:e.skipType(7&o)}}return r},e}(),e.Type=(n={},(r=Object.create(n))[n[0]="STRING"]=0,r[n[1]="U_INT_8_ARRAY"]=1,r),e}(),e}(),Ze=Xe.channelBuilder=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.pair=null,e.prototype.ping=!1,e.prototype.pong=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ke.oneOfGetter(t=["pair","ping","pong"]),set:Ke.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.pair&&e.hasOwnProperty("pair")&&Xe.channelBuilder.PeerPair.encode(e.pair,t.uint32(10).fork()).ldelim(),null!=e.ping&&e.hasOwnProperty("ping")&&t.uint32(16).bool(e.ping),null!=e.pong&&e.hasOwnProperty("pong")&&t.uint32(24).bool(e.pong),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channelBuilder.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.pair=Xe.channelBuilder.PeerPair.decode(e,e.uint32());break;case 2:r.ping=e.bool();break;case 3:r.pong=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e.PeerPair=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.initiator=null,e.prototype.passive=null,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.initiator&&e.hasOwnProperty("initiator")&&Xe.channelBuilder.PeerInfo.encode(e.initiator,t.uint32(10).fork()).ldelim(),null!=e.passive&&e.hasOwnProperty("passive")&&Xe.channelBuilder.PeerInfo.encode(e.passive,t.uint32(18).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channelBuilder.PeerPair;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.initiator=Xe.channelBuilder.PeerInfo.decode(e,e.uint32());break;case 2:r.passive=Xe.channelBuilder.PeerInfo.decode(e,e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e.PeerInfo=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.wss="",e.prototype.wcId=0,e.prototype.wsSupported=!1,e.prototype.wsTried=!1,e.prototype.dcSupported=!1,e.prototype.dcTried=!1,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.wss&&e.hasOwnProperty("wss")&&t.uint32(18).string(e.wss),null!=e.wcId&&e.hasOwnProperty("wcId")&&t.uint32(24).uint32(e.wcId),null!=e.wsSupported&&e.hasOwnProperty("wsSupported")&&t.uint32(32).bool(e.wsSupported),null!=e.wsTried&&e.hasOwnProperty("wsTried")&&t.uint32(40).bool(e.wsTried),null!=e.dcSupported&&e.hasOwnProperty("dcSupported")&&t.uint32(48).bool(e.dcSupported),null!=e.dcTried&&e.hasOwnProperty("dcTried")&&t.uint32(56).bool(e.dcTried),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channelBuilder.PeerInfo;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:r.wss=e.string();break;case 3:r.wcId=e.uint32();break;case 4:r.wsSupported=e.bool();break;case 5:r.wsTried=e.bool();break;case 6:r.dcSupported=e.bool();break;case 7:r.dcTried=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e}(),et=Xe.fullMesh=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.membersResponse=null,e.prototype.membersRequest=!1,e.prototype.adjacentMembers=null,e.prototype.heartbeat=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ke.oneOfGetter(t=["membersResponse","membersRequest","adjacentMembers","heartbeat"]),set:Ke.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.membersResponse&&e.hasOwnProperty("membersResponse")&&Xe.fullMesh.Peers.encode(e.membersResponse,t.uint32(10).fork()).ldelim(),null!=e.membersRequest&&e.hasOwnProperty("membersRequest")&&t.uint32(16).bool(e.membersRequest),null!=e.adjacentMembers&&e.hasOwnProperty("adjacentMembers")&&Xe.fullMesh.Peers.encode(e.adjacentMembers,t.uint32(26).fork()).ldelim(),null!=e.heartbeat&&e.hasOwnProperty("heartbeat")&&t.uint32(32).bool(e.heartbeat),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.fullMesh.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.membersResponse=Xe.fullMesh.Peers.decode(e,e.uint32());break;case 2:r.membersRequest=e.bool();break;case 3:r.adjacentMembers=Xe.fullMesh.Peers.decode(e,e.uint32());break;case 4:r.heartbeat=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e.Peers=function(){function e(e){if(this.ids=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.ids=Ke.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Ve.create()),null!=e.ids&&e.ids.length){t.uint32(10).fork();for(var n=0;n<e.ids.length;++n)t.uint32(e.ids[n]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.fullMesh.Peers;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:if(r.ids&&r.ids.length||(r.ids=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.ids.push(e.uint32());else r.ids.push(e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e}(),tt=Xe.dataChannelBuilder=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.offer="",e.prototype.answer="",e.prototype.candidate=null;var t;return Object.defineProperty(e.prototype,"type",{get:Ke.oneOfGetter(t=["offer","answer","candidate"]),set:Ke.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.offer&&e.hasOwnProperty("offer")&&t.uint32(10).string(e.offer),null!=e.answer&&e.hasOwnProperty("answer")&&t.uint32(18).string(e.answer),null!=e.candidate&&e.hasOwnProperty("candidate")&&Xe.dataChannelBuilder.IceCandidate.encode(e.candidate,t.uint32(26).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.dataChannelBuilder.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.offer=e.string();break;case 2:r.answer=e.string();break;case 3:r.candidate=Xe.dataChannelBuilder.IceCandidate.decode(e,e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e.IceCandidate=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.candidate="",e.prototype.sdpMid="",e.prototype.sdpMLineIndex=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.candidate&&e.hasOwnProperty("candidate")&&t.uint32(10).string(e.candidate),null!=e.sdpMid&&e.hasOwnProperty("sdpMid")&&t.uint32(18).string(e.sdpMid),null!=e.sdpMLineIndex&&e.hasOwnProperty("sdpMLineIndex")&&t.uint32(24).uint32(e.sdpMLineIndex),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.dataChannelBuilder.IceCandidate;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.candidate=e.string();break;case 2:r.sdpMid=e.string();break;case 3:r.sdpMLineIndex=e.uint32();break;default:e.skipType(7&o)}}return r},e}(),e}(),nt=Xe.channel=((xe={}).Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var t;return e.prototype.initPing=null,e.prototype.initPong=0,Object.defineProperty(e.prototype,"type",{get:Ke.oneOfGetter(t=["initPing","initPong"]),set:Ke.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.initPing&&e.hasOwnProperty("initPing")&&Xe.channel.Data.encode(e.initPing,t.uint32(10).fork()).ldelim(),null!=e.initPong&&e.hasOwnProperty("initPong")&&t.uint32(16).uint32(e.initPong),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channel.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.initPing=Xe.channel.Data.decode(e,e.uint32());break;case 2:r.initPong=e.uint32();break;default:e.skipType(7&o)}}return r},e}(),xe.Data=function(){function e(e){if(this.members=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.topology=0,e.prototype.wcId=0,e.prototype.senderId=0,e.prototype.members=Ke.emptyArray,e.prototype.key="",e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Ve.create()),null!=e.topology&&e.hasOwnProperty("topology")&&t.uint32(8).uint32(e.topology),null!=e.wcId&&e.hasOwnProperty("wcId")&&t.uint32(16).uint32(e.wcId),null!=e.senderId&&e.hasOwnProperty("senderId")&&t.uint32(24).uint32(e.senderId),null!=e.members&&e.members.length){t.uint32(34).fork();for(var n=0;n<e.members.length;++n)t.uint32(e.members[n]);t.ldelim()}return null!=e.key&&e.hasOwnProperty("key")&&t.uint32(42).string(e.key),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.channel.Data;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.topology=e.uint32();break;case 2:r.wcId=e.uint32();break;case 3:r.senderId=e.uint32();break;case 4:if(r.members&&r.members.length||(r.members=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.members.push(e.uint32());else r.members.push(e.uint32());break;case 5:r.key=e.string();break;default:e.skipType(7&o)}}return r},e}(),xe),rt=Xe.signaling=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.heartbeat=!1,e.prototype.content=null,e.prototype.connect=null,e.prototype.connected=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ke.oneOfGetter(t=["heartbeat","content","connect","connected"]),set:Ke.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.heartbeat&&e.hasOwnProperty("heartbeat")&&t.uint32(8).bool(e.heartbeat),null!=e.content&&e.hasOwnProperty("content")&&Xe.signaling.Content.encode(e.content,t.uint32(18).fork()).ldelim(),null!=e.connect&&e.hasOwnProperty("connect")&&Xe.signaling.GroupData.encode(e.connect,t.uint32(26).fork()).ldelim(),null!=e.connected&&e.hasOwnProperty("connected")&&t.uint32(32).bool(e.connected),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.signaling.Message;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.heartbeat=e.bool();break;case 2:r.content=Xe.signaling.Content.decode(e,e.uint32());break;case 3:r.connect=Xe.signaling.GroupData.decode(e,e.uint32());break;case 4:r.connected=e.bool();break;default:e.skipType(7&o)}}return r},e}(),e.Content=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.lastData=!1,e.prototype.data=Ke.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Ve.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.lastData&&e.hasOwnProperty("lastData")&&t.uint32(16).bool(e.lastData),null!=e.data&&e.hasOwnProperty("data")&&t.uint32(26).bytes(e.data),t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.signaling.Content;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:r.lastData=e.bool();break;case 3:r.data=e.bytes();break;default:e.skipType(7&o)}}return r},e}(),e.GroupData=function(){function e(e){if(this.members=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.members=Ke.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Ve.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.members&&e.members.length){t.uint32(18).fork();for(var n=0;n<e.members.length;++n)t.uint32(e.members[n]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Qe||(e=Qe.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new Xe.signaling.GroupData;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:r.id=e.uint32();break;case 2:if(r.members&&r.members.length||(r.members=[]),2==(7&o))for(var i=e.uint32()+e.pos;e.pos<i;)r.members.push(e.uint32());else r.members.push(e.uint32());break;default:e.skipType(7&o)}}return r},e}(),e}(),ot=rt.Message.encode(rt.Message.create({heartbeat:!0})).finish();(qe=_e||(_e={}))[qe.CONNECTING=0]="CONNECTING",qe[qe.OPEN=1]="OPEN",qe[qe.CHECKING=2]="CHECKING",qe[qe.CHECKED=4]="CHECKED",qe[qe.CLOSED=3]="CLOSED";var it,st=function(){function e(e,t){this.STREAM_ID=1,this.wc=e,this.url=t,this.state=_e.CLOSED,this.connected=!1,this.missedHeartbeat=0,this.streamSubject=new R.Subject,this.stateSubject=new R.Subject}return Object.defineProperty(e.prototype,"messageFromStream",{get:function(){return this.streamSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.sendOverStream=function(e){b.signaling(this.wc.myId+" Forward message",e),this.send({content:{id:e.recipientId,lastData:void 0===e.content,data:$e.encode($e.create(e)).finish()}})},Object.defineProperty(e.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.check=function(){var e=this;this.setState(_e.CHECKING),this.send({connect:{id:this.wc.myId,members:this.wc.members.filter(function(t){return t!==e.wc.myId})}})},e.prototype.connect=function(e){var t=this;if(!T())throw new Error("Failed to join over Signaling: WebSocket is not supported by your environment");this.setState(_e.CONNECTING),this.ws=new global.WebSocket(this.fullUrl(e)),this.ws.binaryType="arraybuffer",this.connectionTimeout=setTimeout(function(){t.ws&&t.ws.readyState!==t.ws.OPEN&&(b.signaling("Failed to connect to Signaling server "+t.url+": connection timeout"),t.close())},1e4),this.ws.onopen=function(){t.setState(_e.OPEN),t.connectionTimeout&&clearTimeout(t.connectionTimeout),t.startHeartbeat()},this.ws.onerror=function(e){return b.signaling("WebSocket ERROR",e)},this.ws.onclose=function(e){t.clean(),t.setState(_e.CLOSED)},this.ws.onmessage=function(e){var n=e.data;return t.handleMessage(n)}},e.prototype.close=function(){this.state!==_e.CLOSED&&(this.ws&&(this.ws.onmessage=function(){},this.ws.onclose=function(){},this.ws.onerror=function(){},this.ws.close(1e3)),this.clean(),this.setState(_e.CLOSED))},e.prototype.clean=function(){this.connectionTimeout&&global.clearTimeout(this.connectionTimeout),this.heartbeatInterval&&global.clearInterval(this.heartbeatInterval),this.ws=void 0},e.prototype.handleMessage=function(e){var t=this,n=rt.Message.decode(new Uint8Array(e));switch(n.type){case"heartbeat":this.missedHeartbeat=0;break;case"connected":this.connected=n.connected,this.setState(_e.CHECKED),n.connected||this.wc.channelBuilder.connectOverSignaling().catch(function(){return t.check()});break;case"content":var r=n.content,o=r.data,i=r.id,s=$e.decode(o);s.senderId=i,b.signaling("StreamMessage RECEIVED: ",s),this.streamSubject.next(s)}},e.prototype.setState=function(e){this.state!==e&&(this.state=e,this.stateSubject.next(e))},e.prototype.startHeartbeat=function(){var e=this;this.missedHeartbeat=0,this.heartbeatInterval=global.setInterval(function(){try{if(e.missedHeartbeat++,e.missedHeartbeat>=3)throw new Error("Too many missed heartbeats");e.heartbeat()}catch(t){e.close()}},5e3)},e.prototype.send=function(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(rt.Message.encode(rt.Message.create(e)).finish())}catch(e){b.signaling("Failed send to Signaling",e)}},e.prototype.heartbeat=function(){if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(ot)}catch(e){b.signaling("Failed send to Signaling: "+e.message)}},e.prototype.fullUrl=function(e){var t=this.url.endsWith("/")?this.url+e:this.url+"/"+e;return m?t:t+"?favored"},e}();!function(e){e[e.JOINING=0]="JOINING",e[e.JOINED=1]="JOINED",e[e.LEFT=2]="LEFT"}(it||(it={}));var ct,at=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ut=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},lt=new global.TextEncoder,pt=new global.TextDecoder,ht=function(e){function t(){var n=e.call(this,t.SERVICE_ID,Ye.Message)||this;return n.buffers=new Map,n}return at(t,e),t.prototype.clean=function(){this.buffers.clear()},t.prototype.encodeUserMessage=function(t){var n=this.userDataToType(t),r=n.type,o=n.bytes,i={length:o.length,type:r};if(o.length<=15e3)return i.full=o,[e.prototype.encode.call(this,i)];i.chunk={id:Math.ceil(65535*Math.random())};for(var s=Math.ceil(o.length/15e3),c=new Array(s),a=0;a<s;a++){var u=15e3*a,l=u+Math.min(15e3,o.length-15e3*a);i.chunk.number=a,i.chunk.content=new Uint8Array(o.slice(u,l)),c[a]=e.prototype.encode.call(this,i)}return c},t.prototype.decodeUserMessage=function(t,n){var r,o=e.prototype.decode.call(this,t),i=o.length,s=o.type,c=o.contentType,a=o.full,u=o.chunk;switch(c){case"full":r=a;break;case"chunk":var l=this.getBuffer(n,u.id);void 0===l?(l=new ft(i,u.content,u.nb),this.setBuffer(n,u.id,l),r=void 0):r=l.append(u.content,u.nb);break;default:throw new Error("Unknown message integrity")}if(void 0!==r)switch(s){case Ye.Message.Type.U_INT_8_ARRAY:return r;case Ye.Message.Type.STRING:return pt.decode(r);default:throw new Error("Unknown message type")}return r},t.prototype.userDataToType=function(e){if(e instanceof Uint8Array)return{type:Ye.Message.Type.U_INT_8_ARRAY,bytes:e};if("string"==typeof e)return{type:Ye.Message.Type.STRING,bytes:lt.encode(e)};if(e instanceof String)return{type:Ye.Message.Type.STRING,bytes:lt.encode(""+e)};throw new Error("Message neigther a string type or a Uint8Array type")},t.prototype.getBuffer=function(e,t){var n=this.buffers.get(e);if(void 0!==n)return n.get(t)},t.prototype.setBuffer=function(e,t,n){var r=this.buffers.get(e);void 0===r&&(r=new Map),r.set(t,n),this.buffers.set(e,r)},t.SERVICE_ID=743,t}(B),ft=function(){function e(e,t,n){this.fullData=new Uint8Array(e),this.currentLength=0,this.append(t,n)}return e.prototype.append=function(e,t){var n,r,o=15e3*t;this.currentLength+=e.length;try{for(var i=ut(e),s=i.next();!s.done;s=i.next()){var c=s.value;this.fullData[o++]=c}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return this.currentLength===this.fullData.length?this.fullData:void 0},e}();!function(e){e[e.INTERNAL=0]="INTERNAL",e[e.INVITED=1]="INVITED",e[e.JOINING=2]="JOINING"}(ct||(ct={}));var dt,gt=function(){function e(e,t,n,r,o){void 0===r&&(r=1);var i=this;b.channel("New Channel "+ct[n]+": Me: "+e.myId+" with "+r),this.wc=e,this.wsOrDc=t,this.type=n,this.id=r,this.rtcPeerConnection=o,this.missedHeartbeat=0,this.heartbeatMsg=new Uint8Array(0),this.resolveInit=function(){},m?(t.binaryType="arraybuffer",this.send=this.sendInBrowser):this.rtcPeerConnection?(t.binaryType="arraybuffer",this.send=this.sendInNodeOverDataChannel):this.send=this.sendInNodeOverWebSocket,n===ct.INTERNAL?(this.heartbeatMsg=this.createHeartbeatMsg(),this.init=Promise.resolve(),this.initHandlers()):(n===ct.INVITED&&this.sendInitPing(),this.init=new Promise(function(e,t){return i.resolveInit=function(){i.heartbeatMsg=i.createHeartbeatMsg(),e()}}),this.wsOrDc.onmessage=function(e){var t=e.data;i.handleInitMessage(nt.Message.decode(new Uint8Array(t)))})}return Object.defineProperty(e.prototype,"url",{get:function(){return this.rtcPeerConnection?"":this.wsOrDc.url},enumerable:!0,configurable:!0}),e.prototype.encodeAndSend=function(e){var t=void 0===e?{}:e,n=t.senderId,r=void 0===n?this.wc.myId:n,o=t.recipientId,i=void 0===o?0:o,s=t.serviceId,c=t.content;this.send($e.encode($e.create({senderId:r,recipientId:i,serviceId:s,content:c})).finish())},e.prototype.close=function(){this.wsOrDc.onmessage=void 0,this.wsOrDc.onclose=void 0,this.wsOrDc.onerror=void 0,this.rtcPeerConnection?this.rtcPeerConnection.close():this.wsOrDc.close(1e3)},e.prototype.sendHeartbeat=function(){this.missedHeartbeat++,this.missedHeartbeat>=3?(b.channel(this.id+" channel closed: too many missed heartbeats"),this.wc.topology.onChannelClose(this),this.close()):this.send(this.heartbeatMsg)},e.prototype.sendInBrowser=function(e){try{this.wsOrDc.send(e)}catch(e){b.channel("Channel sendInBrowser ERROR",e)}},e.prototype.sendInNodeOverWebSocket=function(e){try{this.wsOrDc.send(e,{binary:!0})}catch(e){b.channel("Channel sendInNodeOverWebSocket ERROR",e)}},e.prototype.sendInNodeOverDataChannel=function(e){this.sendInBrowser(e.slice(0))},e.prototype.handleInitMessage=function(e){switch(e.type){case"initPing":b.channel(this.wc.myId+" received InitPing");var t=e.initPing,n=t.topology,r=t.wcId,o=t.senderId,i=t.members,s=t.key;this.wc.topologyEnum!==n?b.channel("Different topology. This message should never be shown: something is wrong"):i.includes(this.id)&&this.wc.id,this.wc.id=r,this.wc.key=s,this.id=o,b.channel(this.wc.myId+" send InitPong"),this.send(nt.Message.encode(nt.Message.create({initPong:this.wc.myId})).finish()),this.initData={members:i},this.initHandlers(),this.resolveInit();break;case"initPong":b.channel(this.wc.myId+" received InitPong"),this.id=e.initPong,this.initHandlers(),this.resolveInit();break;default:b.channel('Unknown message type: "'+e.type+'". This message should never be shown: something went wrong')}},e.prototype.initHandlers=function(){var e=this;this.wsOrDc.onmessage=function(t){var n=t.data,r=$e.decode(new Uint8Array(n));if(0===r.recipientId||r.recipientId===e.wc.myId)if(r.serviceId===ht.SERVICE_ID){var o=e.wc.userMsg.decodeUserMessage(r.content,r.senderId);o&&e.wc.onMessage(r.senderId,o)}else 0===r.serviceId?e.missedHeartbeat=0:e.wc.streamSubject.next(Object.assign({channel:e},r));r.recipientId!==e.wc.myId&&e.wc.topology.forward(r)},this.wsOrDc.onclose=function(t){b.channel("Connection with "+e.id+" has closed",t),e.wc.topology.onChannelClose(e)},this.wsOrDc.onerror=function(e){return b.channel("Channel error: ",e)}},e.prototype.createHeartbeatMsg=function(){return $e.encode($e.create({serviceId:0,senderId:this.wc.myId,recipientId:this.id})).finish()},e.prototype.sendInitPing=function(){b.channel("initialize..."),this.send(nt.Message.encode(nt.Message.create({initPing:{topology:this.wc.topologyEnum,wcId:this.wc.id,senderId:this.wc.myId,members:this.wc.members,key:this.wc.key}})).finish())},e}(),bt=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}a((r=r.apply(e,t||[])).next())})},yt=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};!function(e){e.JOIN="join",e.INVITE="invite",e.INTERNAL="internal"}(dt||(dt={}));var vt=function(){function e(e){this.wc=e,this.channelsSubject=new R.Subject}return e.prototype.onChannel=function(){return this.channelsSubject.asObservable()},e.prototype.connectToInvite=function(e){return bt(this,void 0,void 0,function(){var t,n,r;return yt(this,function(o){switch(o.label){case 0:return I(e)&&-1!==e.search(/^wss?/)?(t=this.composeUrl(e,dt.INVITE),r=(n=this.channelsSubject).next,[4,this.connect(t,ct.INVITED)]):[3,2];case 1:return r.apply(n,[o.sent()]),[3,3];case 2:throw new Error("Invalid URL format: "+e);case 3:return[2]}})})},e.prototype.newInviteWebSocket=function(e){this.channelsSubject.next(new gt(this.wc,e,ct.JOINING))},e.prototype.connectToJoin=function(e,t){return bt(this,void 0,void 0,function(){var n,r,o;return yt(this,function(i){switch(i.label){case 0:return I(e)&&-1!==e.search(/^wss?/)?(n=this.composeUrl(e,dt.JOIN,t),o=(r=this.channelsSubject).next,[4,this.connect(n,ct.JOINING)]):[3,2];case 1:return o.apply(r,[i.sent()]),[3,3];case 2:throw new Error("Invalid URL format: "+e);case 3:return[2]}})})},e.prototype.newJoinWebSocket=function(e){this.channelsSubject.next(new gt(this.wc,e,ct.INVITED))},e.prototype.connectInternal=function(e,t){return bt(this,void 0,void 0,function(){var n,r,o;return yt(this,function(i){switch(i.label){case 0:return I(e)&&-1!==e.search(/^wss?/)?(n=this.composeUrl(e,dt.INTERNAL),o=(r=this.channelsSubject).next,[4,this.connect(n,ct.INTERNAL,t)]):[3,2];case 1:return o.apply(r,[i.sent()]),[3,3];case 2:throw new Error("Invalid URL format: "+e);case 3:return[2]}})})},e.prototype.newInternalWebSocket=function(e,t){this.channelsSubject.next(new gt(this.wc,e,ct.INTERNAL,t))},e.prototype.connect=function(e,t,n){return bt(this,void 0,void 0,function(){var r,o=this;return yt(this,function(i){if(!I(e)||-1===e.search(/^wss?/))throw new Error(e+" is not a valid URL");return r=new global.WebSocket(e),[2,new Promise(function(i,s){var c=setTimeout(function(){r.readyState!==r.OPEN&&(r.close(),s(new Error("WebSocket 4000ms connection timeout with '"+e+"'")))},4e3);r.onopen=function(){var e=new gt(o.wc,r,t,n);clearTimeout(c),i(e)},r.onerror=function(e){return s(e)},r.onclose=function(t){s(new Error("WebSocket connection to '"+e+"' failed with code "+t.code+": "+t.reason))}})]})})},e.prototype.composeUrl=function(e,t,n){return void 0===n&&(n=this.wc.id),t===dt.INTERNAL?e+"/"+t+"?wcId="+n+"&senderId="+this.wc.myId:e+"/"+t+"?wcId="+n+"&key="+this.wc.key},e.listenUrl=new R.BehaviorSubject(""),e}(),mt=function(){function e(e,t,n,r){var o=this;this.peerToLog="INITIATOR",this.id=e,this.pc=t,this.send=n,this._onError=function(){},this.candidates=new R.ReplaySubject,this.remotes=r,this.isSDPSent=!1,this.remotes.set(e,this),t.oniceconnectionstatechange=function(){o.log("ICE CONNECTION STATE",t.iceConnectionState),"failed"===t.iceConnectionState&&o._onError(new Error("Ice Connection State is FAILED"))},t.onicecandidate=function(e){null!==e.candidate?(o.log("LOCAL ICE CANDIDATE",e.candidate.candidate),o.send({candidate:{candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex}})):o.isSDPSent&&(o.pc.onicecandidate=function(){},o.log("FINISHED (onicecandidate) with: "+o.id),o.send({}))}}return Object.defineProperty(e.prototype,"onError",{get:function(){return this._onError},set:function(e){this._onError=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDataChannel",{set:function(e){var t=this;this.pc.ondatachannel=function(n){var r=n.channel;t.pc.oniceconnectionstatechange=function(){},e(r)}},enumerable:!0,configurable:!0}),e.prototype.sdpIsSent=function(){this.isSDPSent=!0,"complete"===this.pc.iceGatheringState&&(this.pc.onicecandidate=function(){},this.log("FINISHED (sdpIsSent) with: "+this.id),this.send({}))},e.prototype.clean=function(){this.pc.oniceconnectionstatechange=function(){},this.pc.onicecandidate=function(){},this.candidates.complete(),this.remotes.delete(this.id),this.log("DELETE Remote: "+this.id),"connected"!==this.pc.iceConnectionState&&"completed"!==this.pc.iceConnectionState&&(this.log("Failed to establish RTCDataChannel"),this.pc.close(),this.log("FINISHED (clean) with: "+this.id),this.send({}))},e.prototype.handleMessage=function(e){var t=this;if(e.type)switch(e.type){case"offer":this.log("REMOTE OFFER",{offer:e.offer}),this.pc.setRemoteDescription({type:"offer",sdp:e.offer}).then(function(){return t.candidates.subscribe(function(e){return t.pc.addIceCandidate(e).catch(function(e){return t.log("Failed to addIceCandidate",e)})})}).then(function(){return t.pc.createAnswer()}).then(function(e){return t.pc.setLocalDescription(e)}).then(function(){var e=t.pc.localDescription.sdp;t.log("Send LOCAL ANSWER",{answer:e}),t.send({answer:e}),t.sdpIsSent()}).catch(function(e){return t._onError(e)});break;case"answer":this.log("REMOTE ANSWER is received",{answer:e.answer}),this.pc.setRemoteDescription({type:"answer",sdp:e.answer}).then(function(){t.candidates.subscribe(function(e){return t.pc.addIceCandidate(e).catch(function(e){return t.log(t.id+": Failed to add REMOTE Ice Candidate",e)})})}).catch(function(e){return t._onError(e)});break;case"candidate":this.log("REMOTE ICE CANDIDATE is received",e.candidate),this.candidates.next(new global.RTCIceCandidate(e.candidate));break;default:this._onError(new Error("Buffer Protocol unknown message from the remote peer"))}else this.log("REMOTE peer FINISHED"),this.candidates.complete(),this.remotes.delete(this.id)},e.prototype.log=function(e,t){t?b.webrtc(this.peerToLog+": "+e,t):b.webrtc(this.peerToLog+": "+e)},e}(),St=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),wt=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}a((r=r.apply(e,t||[])).next())})},It=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},Ot=function(e){function t(n,r){var o=e.call(this,t.SERVICE_ID,tt.Message)||this;return o.wc=n,o.allStreams=e.prototype.useAllStreams.call(o,n,n.signaling),o.rtcConfiguration=r,o.channelsSubject=new R.Subject,o.remotes=new Map,o.remotes.set(o.wc.STREAM_ID,new Map),o.remotes.set(o.wc.signaling.STREAM_ID,new Map),o.allStreams.message.subscribe(function(e){var t=e.streamId,n=e.senderId,r=e.msg;(o.getRemotes(t).get(n)||o.createRemote(t,n,!0)).handleMessage(r)}),o}return St(t,e),t.prototype.onChannel=function(){return this.channelsSubject.asObservable()},t.prototype.connectInternal=function(e){return wt(this,void 0,void 0,function(){var t,n;return It(this,function(r){switch(r.label){case 0:return b.webrtc(this.wc.myId+"connectInternal"),n=(t=this.channelsSubject).next,[4,this.connect(this.wc.STREAM_ID,ct.INTERNAL,e)];case 1:return n.apply(t,[r.sent()]),[2]}})})},t.prototype.connectToJoin=function(e){return wt(this,void 0,void 0,function(){var t,n;return It(this,function(r){switch(r.label){case 0:return b.webrtc(this.wc.myId+" connectToJoin"),n=(t=this.channelsSubject).next,[4,this.connect(this.wc.signaling.STREAM_ID,ct.JOINING,e)];case 1:return n.apply(t,[r.sent()]),[2]}})})},t.prototype.connectToInvite=function(e){return wt(this,void 0,void 0,function(){var t,n;return It(this,function(r){switch(r.label){case 0:return b.webrtc(this.wc.myId+"connectToInvite"),n=(t=this.channelsSubject).next,[4,this.connect(this.wc.signaling.STREAM_ID,ct.INVITED,e)];case 1:return n.apply(t,[r.sent()]),[2]}})})},t.prototype.clean=function(){this.remotes.forEach(function(e){return e.forEach(function(e){e.onError(new Error("clean")),e.clean()})})},t.prototype.connect=function(e,t,n){return wt(this,void 0,void 0,function(){var r,o,i,s,c=this;return It(this,function(a){switch(a.label){case 0:r=this.createRemote(e,n),a.label=1;case 1:return a.trys.push([1,5,,6]),o=r.pc.createDataChannel(this.wc.myId.toString()),[4,r.pc.createOffer()];case 2:return i=a.sent(),[4,r.pc.setLocalDescription(i)];case 3:return a.sent(),this.allStreams.sendOver(e,{offer:r.pc.localDescription.sdp},n),r.sdpIsSent(),[4,new Promise(function(e,i){r.onError=function(e){return i(e)};var s=setTimeout(function(){"open"!==o.readyState&&i(new Error("RTCDataChannel 7000ms connection timeout with '"+n+"'"))},7e3);o.onopen=function(){var i=new gt(c.wc,o,t,n,r.pc);r.pc.oniceconnectionstatechange=function(){},clearTimeout(s),b.webrtc(r.peerToLog+": RTCDataChannel with "+n+" has opened"),o.onopen=function(){},e(i)}})];case 4:return[2,a.sent()];case 5:throw s=a.sent(),b.webrtc("Error on initiator: ",s),r.clean(),s;case 6:return[2]}})})},t.prototype.createRemote=function(e,t,n){var r=this;void 0===n&&(n=!1),b.webrtc(this.wc.myId+" New Remote object: ",t);var o=new mt(t,new global.RTCPeerConnection(this.rtcConfiguration),function(n){return r.allStreams.sendOver(e,n,t)},this.getRemotes(e));if(n){var i;o.peerToLog="----------- PASSIVE",o.onError=function(e){b.webrtc("Error on passive: ",e),o.clean()};var s=setTimeout(function(){void 0!==i&&"open"===i.readyState||(void 0!==i&&i.close(),o.onError(new Error("7000ms connection timeout")))},7e3);o.onDataChannel=function(t){i=t;var n,c=Number.parseInt(i.label,10);n=e===r.wc.STREAM_ID?ct.INTERNAL:r.wc.state===it.JOINED?ct.INVITED:ct.JOINING,i.onopen=function(){var e=new gt(r.wc,i,n,c,o.pc);clearTimeout(s),b.webrtc(o.peerToLog+": RTCDataChannel with "+e.id+" has opened"),r.channelsSubject.next(e),i.onopen=function(){}}}}return o},t.prototype.getRemotes=function(e){return this.remotes.get(e)},t.SERVICE_ID=7431,t}(B),jt=function(){function e(e){this.wcStreamId=e,this.wcReqs={connectReqs:new Map,pingReqs:new Map},this.sigReqs={connectReqs:new Map,pingReqs:new Map}}return e.prototype.add=function(e,t,n){var r=this.getReqsByStreamId(e);return this.addRequest(r.connectReqs,t,n)},e.prototype.addPing=function(e,t,n){var r=this.getReqsByStreamId(e);return this.addRequest(r.pingReqs,t,n)},e.prototype.get=function(e,t){var n=this.getReqsByStreamId(e).connectReqs.get(t);return n&&n.promise?n:void 0},e.prototype.getPing=function(e,t){var n=this.getReqsByStreamId(e).pingReqs.get(t);return n&&n.promise?n:void 0},e.prototype.getCreatedDate=function(e,t){var n=this.getReqsByStreamId(e).pingReqs.get(t);return n?n.created:void 0},e.prototype.clean=function(){this.cleanAll(this.wcReqs.connectReqs),this.cleanAll(this.wcReqs.pingReqs),this.cleanAll(this.sigReqs.connectReqs),this.cleanAll(this.sigReqs.pingReqs)},e.prototype.cleanAll=function(e){e.forEach(function(e){return e.reject(new Error("clean"))}),e.clear()},e.prototype.getReqsByStreamId=function(e){return e===this.wcStreamId?this.wcReqs:this.sigReqs},e.prototype.addRequest=function(e,t,n){var r={created:Date.now()};return r.promise=new Promise(function(o,i){var s=setTimeout(function(){return r.reject(new Error("Request "+n+"ms timeout"))},n),c=function(){clearTimeout(s),r.promise=void 0};r.resolve=function(){c(),o()},r.reject=function(e){r.promise&&r.promise.catch(function(){}),c(),i(e)},e.set(t,r)}),r},e}(),kt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Mt=function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}a((r=r.apply(e,t||[])).next())})},Tt=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},Et=Math.max(7e3,4e3)+5e3,Pt=700,Lt=function(e){function t(n){var r=e.call(this,t.SERVICE_ID,Ze.Message)||this;return r.wc=n,r.allStreams=e.prototype.useAllStreams.call(r,n,n.signaling),r.pendingReqs=new jt(r.wc.STREAM_ID),r.channelsSubject=new R.Subject,r.dataChannelBuilder=new Ot(r.wc,r.wc.rtcConfiguration),r.pingTimeout=Pt,r.myInfo={wsTried:!1,wsSupported:T(),dcTried:!1,dcSupported:!!global.RTCPeerConnection&&"createDataChannel"in global.RTCPeerConnection.prototype},r.pairEncoded=e.prototype.encode.call(r,{pair:{initiator:r.myInfo}}),r.encodePingPong(),r.allStreams.message.subscribe(function(e){var t=e.streamId,n=e.senderId,o=e.msg;r.handleMessage(t,n,o)}),r.subscribeToChannels(),r.subscribeToURLandIDChange(),r}return kt(t,e),t.prototype.clean=function(){this.dataChannelBuilder.clean(),this.pendingReqs.clean()},Object.defineProperty(t.prototype,"onChannel",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.connectOverWebChannel=function(e){return Mt(this,void 0,void 0,function(){var t;return Tt(this,function(n){switch(n.label){case 0:return(t=this.pendingReqs.get(this.wc.STREAM_ID,e))?[3,2]:[4,this.ping(e)];case 1:n.sent(),t=this.pendingReqs.add(this.wc.STREAM_ID,e,Et),this.allStreams.sendOver(this.wc.STREAM_ID,this.pairEncoded,e),n.label=2;case 2:return[2,t.promise]}})})},t.prototype.connectOverSignaling=function(){return Mt(this,void 0,void 0,function(){var e;return Tt(this,function(t){switch(t.label){case 0:return(e=this.pendingReqs.get(this.wc.signaling.STREAM_ID,1))?[3,2]:[4,this.ping(1,this.wc.signaling.STREAM_ID)];case 1:t.sent(),e=this.pendingReqs.add(this.wc.signaling.STREAM_ID,1,Et),this.allStreams.sendOver(this.wc.signaling.STREAM_ID,this.pairEncoded,1),t.label=2;case 2:return[2,e.promise]}})})},t.prototype.ping=function(e,n){return void 0===n&&(n=this.wc.STREAM_ID),Mt(this,void 0,void 0,function(){var r;return Tt(this,function(o){switch(o.label){case 0:(r=this.pendingReqs.getPing(n,e))||(r=this.pendingReqs.addPing(n,e,this.pingTimeout),this.allStreams.sendOver(n,t.pingEncoded,e)),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,r.promise];case 2:return o.sent(),[3,4];case 3:throw o.sent(),new Error("ping");case 4:return[2]}})})},t.prototype.handleMessage=function(e,n,r){var o=this;switch(r.type){case"ping":this.allStreams.sendOver(e,t.pongEncoded,n);break;case"pong":this.handlePong(e,n);break;case"pair":var i=r.pair,s=i.initiator,c=i.passive;if(!c){if(this.pendingReqs.get(e,n)){if(n<this.wc.myId)return}else this.pendingReqs.add(e,n,Et);s.id=n,(c=Object.assign({},this.myInfo)).id=e===this.wc.STREAM_ID?this.wc.myId:1}this.proceedAlgo(e,s,c,c.id===n).catch(function(t){var r=o.pendingReqs.get(e,n);r&&r.reject(t),o.allStreams.sendOver(e,{pair:{initiator:s,passive:c}},n)})}},t.prototype.proceedAlgo=function(e,t,n,r){return Mt(this,void 0,void 0,function(){var o,i;return Tt(this,function(s){if(r?(o=t,i=n):(o=n,i=t),i.wss&&!o.wsTried&&this.tryWs(e,o,i,r))return[2];if(o.wss&&!i.wsTried)return b.channelBuilder("Prompt the other to connect over WebSocket"),this.allStreams.sendOver(e,{pair:{initiator:t,passive:n}},i.id),[2];if(o.dcSupported&&i.dcSupported){if(!o.dcTried&&this.tryDc(e,o,i,r))return[2];if(!i.dcTried)return b.channelBuilder("Prompt the other to connect over RTCDataChannel"),this.allStreams.sendOver(e,{pair:{initiator:t,passive:n}},i.id),[2]}throw b.channelBuilder("ChannelBuilder FAILED"),new Error("Failed to establish a connection between "+o.id+" and "+i.id)})})},t.prototype.tryWs=function(e,t,n,r){return Mt(this,void 0,void 0,function(){var o;return Tt(this,function(i){switch(i.label){case 0:return i.trys.push([0,7,,8]),e!==this.wc.STREAM_ID?[3,2]:[4,this.wc.webSocketBuilder.connectInternal(n.wss,n.id)];case 1:return i.sent(),[3,6];case 2:return r?[4,this.wc.webSocketBuilder.connectToJoin(n.wss,n.wcId)]:[3,4];case 3:return i.sent(),[3,6];case 4:return[4,this.wc.webSocketBuilder.connectToInvite(n.wss)];case 5:i.sent(),i.label=6;case 6:return b.channelBuilder("New WebSocket connection with "+n.id),[2,!0];case 7:return"clean"!==(o=i.sent()).message?(b.channelBuilder("WebSocket failed with "+n.id,o),t.wsTried=!0,[2,!1]):[2,!0];case 8:return[2]}})})},t.prototype.tryDc=function(e,t,n,r){return Mt(this,void 0,void 0,function(){var o;return Tt(this,function(i){switch(i.label){case 0:return i.trys.push([0,7,,8]),e!==this.wc.STREAM_ID?[3,2]:[4,this.dataChannelBuilder.connectInternal(n.id)];case 1:return i.sent(),[3,6];case 2:return r?[4,this.dataChannelBuilder.connectToJoin(n.id)]:[3,4];case 3:return i.sent(),[3,6];case 4:return[4,this.dataChannelBuilder.connectToInvite(n.id)];case 5:i.sent(),i.label=6;case 6:return b.channelBuilder("New RTCDataChannel with "+n.id),[2,!0];case 7:return"clean"!==(o=i.sent()).message?(b.channelBuilder("RTCDataChannel failed with "+n.id,o),t.dcTried=!0,[2,!1]):[2,!0];case 8:return[2]}})})},t.prototype.handlePong=function(e,t){var n=this.pendingReqs.getPing(e,t);if(n)n.resolve();else{var r=this.pendingReqs.getCreatedDate(e,t);r?(b.channelBuilder("INCREASING Ping/Pong timeout up to: "+this.pingTimeout),this.pingTimeout=Math.min(Date.now()-r+500,3e3)):b.channelBuilder("Could not find timeout request date. This message should never be shown: something is wrong.")}},t.prototype.encodePingPong=function(){t.pingEncoded||t.pongEncoded||(t.pingEncoded=e.prototype.encode.call(this,{ping:!0}),t.pongEncoded=e.prototype.encode.call(this,{pong:!0}))},t.prototype.subscribeToChannels=function(){var e=this;Object(R.merge)(this.dataChannelBuilder.onChannel(),this.wc.webSocketBuilder.onChannel()).subscribe(function(t){t.init.then(function(){var n;t.type===ct.INTERNAL?n=e.pendingReqs.get(e.wc.STREAM_ID,t.id):t.type===ct.INVITED?n=e.pendingReqs.get(e.wc.signaling.STREAM_ID,t.id):t.type===ct.JOINING&&(n=e.pendingReqs.get(e.wc.signaling.STREAM_ID,1)),n&&n.resolve(),e.channelsSubject.next(t)})})},t.prototype.subscribeToURLandIDChange=function(){var t=this;vt.listenUrl.subscribe(function(n){n&&(t.myInfo.wss=n,t.pairEncoded=e.prototype.encode.call(t,{pair:{initiator:t.myInfo}}))}),this.wc.onIdChange.subscribe(function(n){b.channelBuilder("Web CHANNEL ID CHANGED TO ",t.wc.id),t.myInfo.wcId=t.wc.id,t.pairEncoded=e.prototype.encode.call(t,{pair:{initiator:t.myInfo}})})},t.SERVICE_ID=74,t}(B),Rt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Nt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},Bt=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s},Ct=function(e){function t(n){var r=e.call(this,n,t.SERVICE_ID,et.Message)||this;return r.adjacentMembers=new Map,r.distantMembers=new Map,r.membersRequestEncoded=e.prototype.encode.call(r,{membersRequest:!0}),r.heartbeatMsg=e.prototype.encode.call(r,{heartbeat:!0}),r.wcStream.message.subscribe(function(e){var t=e.channel,n=e.senderId,o=e.msg;return r.handleServiceMessage(t,n,o)}),r.wc.channelBuilder.onChannel.subscribe(function(t){b.topology("Adding new adjacent member: ",t.id),r.distantMembers.delete(t.id);var n=r.adjacentMembers.get(t.id);if(n&&(b.topology("Replacing the same channel"),n.close()),r.adjacentMembers.set(t.id,t),r.wc.onMemberJoinProxy(t.id),1===r.adjacentMembers.size&&void 0===r.membersRequestInterval&&r.startIntervals(),t.type===ct.JOINING){e.prototype.setState.call(r,L.JOINING);var o=t.initData.members;r.connectToMany(o,t.id).then(function(){r.membersRequest(),e.prototype.setState.call(r,L.JOINED)})}else r.notifyDistantMembers()}),global.fullmesh=function(){b.topology("Fullmesh info:",{myId:r.wc.myId,signalingState:r.wc.signaling.state,webGroupState:r.wc.state,topologyState:L[r.state],adjacentMembers:Array.from(r.adjacentMembers.keys()).toString(),distantMembers:Array.from(r.distantMembers.keys()).toString(),distantMembersDETAILS:Array.from(r.distantMembers.keys()).map(function(e){var t=r.distantMembers.get(e);return{id:e,adjacentMembers:t?t.adjacentIds:[]}})})},r}return Rt(t,e),t.prototype.send=function(e){var t=this;this.adjacentMembers.forEach(function(t){return t.encodeAndSend(e)}),this.distantMembers.forEach(function(n,r){t.sendToDistantPeer(n,Object.assign(e,{recipientId:r}))})},t.prototype.sendTo=function(e){var t=this.adjacentMembers.get(e.recipientId);t?t.encodeAndSend(e):this.sendToDistantPeer(this.distantMembers.get(e.recipientId),e)},t.prototype.forward=function(e){this.sendTo(e)},t.prototype.leave=function(){this.state!==L.LEFT&&(this.clean(),this.adjacentMembers.forEach(function(e){return e.close()}),b.topology("onAdjacentMembersLeaveProxy: leave "),this.wc.onAdjacentMembersLeaveProxy(Array.from(this.adjacentMembers.keys())),e.prototype.setState.call(this,L.LEFT))},t.prototype.onChannelClose=function(e){this.adjacentMembers.delete(e.id),0===this.adjacentMembers.size?this.clean():this.notifyDistantMembers(),b.topology("onAdjacentMembersLeaveProxy: onChannelClose "),this.wc.onAdjacentMembersLeaveProxy([e.id])},Object.defineProperty(t.prototype,"neighbors",{get:function(){return Array.from(this.adjacentMembers.values())},enumerable:!0,configurable:!0}),t.prototype.clean=function(){b.topology("onAdjacentMembersLeaveProxy: clean "),this.wc.onDistantMembersLeaveProxy(Array.from(this.distantMembers.keys())),this.distantMembers.clear(),global.clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0,global.clearInterval(this.membersRequestInterval),this.membersRequestInterval=void 0},t.prototype.handleServiceMessage=function(n,r,o){switch(o.type){case"membersResponse":this.connectToMany(o.membersResponse.ids,r);break;case"membersRequest":n.encodeAndSend({recipientId:n.id,serviceId:t.SERVICE_ID,content:e.prototype.encode.call(this,{membersResponse:{ids:this.wc.members}})});break;case"adjacentMembers":var i=o.adjacentMembers.ids;if(!this.adjacentMembers.has(r))(s=this.distantMembers.get(r))?s.adjacentIds=i:(this.distantMembers.set(r,{adjacentIds:i,missedHeartbeat:0}),this.wcStream.send({adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}},r));break;case"heartbeat":var s;(s=this.distantMembers.get(r))&&(s.missedHeartbeat=0)}},t.prototype.connectToMany=function(t,n){var r=this,o=t.filter(function(e){return!r.adjacentMembers.has(e)&&e!==r.wc.myId});if(0!==o.length){var i=e.prototype.encode.call(this,{adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}}),s=[];return o.forEach(function(e){r.distantMembers.has(e)||r.distantMembers.set(e,{adjacentIds:[n],missedHeartbeat:0}),r.wcStream.send(i,e),s[s.length]=r.wc.channelBuilder.connectOverWebChannel(e).catch(function(t){"ping"!==t.message&&r.wc.onMemberJoinProxy(e)})}),Promise.all(s)}return Promise.resolve()},t.prototype.membersRequest=function(){if(0!==this.adjacentMembers.size){for(var e=Math.floor(Math.random()*this.adjacentMembers.size),n=this.adjacentMembers.values(),r=0;r<e;r++)n.next();var o=n.next().value;o.encodeAndSend({recipientId:o.id,serviceId:t.SERVICE_ID,content:this.membersRequestEncoded})}},t.prototype.notifyDistantMembers=function(){var t=this;if(0!==this.distantMembers.size){var n=e.prototype.encode.call(this,{adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}});this.distantMembers.forEach(function(e,r){return t.wcStream.send(n,r)})}},t.prototype.startIntervals=function(){var e=this;this.membersRequestInterval=global.setInterval(function(){return e.membersRequest()},6e3),this.heartbeatInterval=global.setInterval(function(){e.adjacentMembers.forEach(function(e){return e.sendHeartbeat()}),e.distantMembers.forEach(function(t,n){t.missedHeartbeat++,t.missedHeartbeat>=4&&(b.topology("Distant peer "+n+" has left: too many missed heartbeats"),e.distantMembers.delete(n),e.wc.onDistantMembersLeaveProxy([n])),e.wcStream.send(e.heartbeatMsg,n)})},3e3)},t.prototype.sendToDistantPeer=function(e,t){for(var n=1;n<=3;n++){var r=this.findRoutedChannel(e,n);if(r)return void r.encodeAndSend(t)}},t.prototype.findRoutedChannel=function(e,t){if(e){try{for(var n=Nt(this.adjacentMembers),r=n.next();!r.done;r=n.next()){var o=Bt(r.value,2),i=o[0],s=o[1];if(e.adjacentIds.includes(i))return s}}catch(e){l={error:e}}finally{try{r&&!r.done&&(p=n.return)&&p.call(n)}finally{if(l)throw l.error}}if(0!==t)try{for(var c=Nt(e.adjacentIds),a=c.next();!a.done;a=c.next()){var u=a.value;if(s=this.findRoutedChannel(this.distantMembers.get(u),t-1))return s}}catch(e){h={error:e}}finally{try{a&&!a.done&&(f=c.return)&&f.call(c)}finally{if(h)throw h.error}}}var l,p,h,f},t.SERVICE_ID=74315,t}(D),Dt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},At={topology:P.FULL_MESH,signalingServer:"wss://signaling.netflux.coedit.re",rtcConfiguration:{iceServers:[{urls:"stun:stun3.l.google.com:19302"}]},autoRejoin:!0},xt=function(){function e(e){this.STREAM_ID=2;var t=Object.assign({},At,e);this.streamSubject=new R.Subject,this.idSubject=new R.Subject,this.topologyEnum=t.topology,this.autoRejoin=t.autoRejoin,this.rtcConfiguration=t.rtcConfiguration,this.members=[],this._id=0,this.key="",this.myId=0,this.state=it.LEFT,this.rejoinEnabled=!1,this.rejoinTimer=void 0,this.topology={},this._onAlone=function(){},this.onMemberJoin=function(){},this.onMemberLeave=function(){},this.onMessage=function(){},this.onStateChange=function(){},this.onSignalingStateChange=function(){},this.userMsg=new ht,this.signaling=new st(this,t.signalingServer),this.subscribeToSignalingState(),this.webSocketBuilder=new vt(this),this.channelBuilder=new Lt(this),this.setTopology(t.topology),m&&this.subscribeToBrowserEvents()}return Object.defineProperty(e.prototype,"onIdChange",{get:function(){return this.idSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e,this.idSubject.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageFromStream",{get:function(){return this.streamSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onAlone",{set:function(e){this._onAlone=e},enumerable:!0,configurable:!0}),e.prototype.sendOverStream=function(e){this.topology.sendTo(e)},e.prototype.join=function(e){void 0===e&&(e=function(){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t=M(42),n="",r=0;r<42;r++)n+=e[t[r]%e.length];return n}()),function(e){if("string"!=typeof e)throw new Error('The key type "'+typeof e+'" is not a "string"');if(""===e)throw new Error("The key is an empty string");if(e.length>j)throw new Error("The key length of "+e.length+" exceeds the maximum of "+j+" characters")}(e),this.state===it.LEFT&&this.startJoin(e)},e.prototype.invite=function(e){if(!I(e))throw new Error("Failed to invite a bot: "+e+" is not a valid URL");var t,n,r=k(e);try{for(var o=Dt(this.topology.neighbors),i=o.next();!i.done;i=o.next()){if(r===k(i.value.url))return}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}this.webSocketBuilder.connectToInvite(e).catch(function(t){return b.webgroup("Failed to invite the bot "+e+": "+t.message)})},e.prototype.leave=function(){this.state!==it.LEFT&&(this.rejoinEnabled=!1,this.key="",this.signaling.close(),this.topology.leave(),this.clean())},e.prototype.send=function(e){if(1!==this.members.length)try{for(var t=Dt(this.userMsg.encodeUserMessage(e)),n=t.next();!n.done;n=t.next()){var r=n.value;this.topology.send({senderId:this.myId,recipientId:0,serviceId:ht.SERVICE_ID,content:r})}}catch(e){o={error:e}}finally{try{n&&!n.done&&(i=t.return)&&i.call(t)}finally{if(o)throw o.error}}var o,i},e.prototype.sendTo=function(e,t){if(1!==this.members.length)try{for(var n=Dt(this.userMsg.encodeUserMessage(t)),r=n.next();!r.done;r=n.next()){var o=r.value;this.topology.sendTo({senderId:this.myId,recipientId:e,serviceId:ht.SERVICE_ID,content:o})}}catch(e){i={error:e}}finally{try{r&&!r.done&&(s=n.return)&&s.call(n)}finally{if(i)throw i.error}}var i,s},e.prototype.onMemberJoinProxy=function(e){this.members.includes(e)||(this.members[this.members.length]=e,this.onMemberJoin(e))},e.prototype.onAdjacentMembersLeaveProxy=function(e){0!==e.length&&(this.onMemberLeaveProxy(e),1===this.members.length?(this._onAlone(),this.topology.setLeftState()):this.signaling.state===_e.CHECKED&&this.topology.state===L.JOINED&&this.signaling.check())},e.prototype.onDistantMembersLeaveProxy=function(e){this.onMemberLeaveProxy(e)},e.prototype.init=function(e,t){void 0===t&&(t=O()),b.webgroup("INIT"),this.id=t,this.myId=O(),this.members=[this.myId],this.key=e,this.rejoinEnabled=this.autoRejoin,this.rejoinTimer&&(global.clearTimeout(this.rejoinTimer),this.rejoinTimer=void 0),this.setState(it.JOINING)},e.prototype.clean=function(){b.webgroup("CLEAN"),this.rejoinTimer&&(global.clearTimeout(this.rejoinTimer),this.rejoinTimer=void 0),this.channelBuilder.clean(),this.userMsg.clean(),this.members=[],this.id=0,this.myId=0,this.setState(it.LEFT)},e.prototype.setState=function(e){this.state!==e&&(b.webGroupState(it[e],this.myId),this.state=e,this.onStateChange(e))},e.prototype.setTopology=function(e){var t=this;this.topologyEnum=e,this.topology=new Ct(this),this.topology.onState.subscribe(function(e){switch(e){case L.JOINING:t.setState(it.JOINING),t.signaling.state===_e.CLOSED&&t.signaling.connect(t.key);break;case L.JOINED:t.setState(it.JOINED),t.signaling.state!==_e.OPEN&&t.signaling.state!==_e.CHECKED||t.signaling.check();break;case L.LEFT:switch(t.signaling.state){case _e.CLOSED:t.rejoin();break;case _e.CONNECTING:t.setState(it.JOINING);break;case _e.OPEN:t.setState(it.JOINING),t.signaling.check();break;case _e.CHECKING:t.setState(it.JOINING);break;case _e.CHECKED:t.signaling.check()}}})},e.prototype.subscribeToSignalingState=function(){var e=this;this.signaling.onState.subscribe(function(t){switch(b.signalingState(_e[t],e.myId),e.onSignalingStateChange(t),t){case _e.CLOSED:e.topology.state===L.LEFT?e.rejoin():e.reconnectToSignaling();break;case _e.OPEN:e.topology.state!==L.JOINING&&e.signaling.check();break;case _e.CHECKED:e.state===it.JOINING&&e.topology.state===L.LEFT&&e.signaling.connected&&e.topology.setJoinedState()}})},e.prototype.subscribeToBrowserEvents=function(){var e=this;global.addEventListener("online",function(){e.state===it.LEFT&&w()&&!e.rejoinTimer&&e.rejoinEnabled&&e.startJoin()}),global.addEventListener("visibilitychange",function(){w()&&e.state===it.LEFT&&S()&&!e.rejoinTimer&&e.rejoinEnabled&&e.startJoin()}),global.addEventListener("beforeunload",function(){return e.leave()})},e.prototype.startJoin=function(e){void 0===e&&(e=this.key),this.init(e),this.signaling.connect(e)},e.prototype.rejoin=function(){var e=this;b.webgroup("rejoinOrLeave"),this.rejoinEnabled&&(this.clean(),b.webgroup("rejoinOrLeave: set rejoinTimer "),this.rejoinTimer=global.setTimeout(function(){e.state===it.LEFT&&w()&&S()&&e.rejoinEnabled?(b.webgroup("rejoinOrLeave: startJoin "),e.startJoin()):b.webgroup("rejoinOrLeave: NOT startJoin "),e.rejoinTimer=void 0},3e3))},e.prototype.reconnectToSignaling=function(){var e=this;b.webgroup("reconnect: "),this.rejoinEnabled&&!this.rejoinTimer&&(this.rejoinTimer=global.setTimeout(function(){w()&&S()&&e.rejoinEnabled&&e.signaling.connect(e.key),e.rejoinTimer=void 0},3e3))},e.prototype.onMemberLeaveProxy=function(e){var t=this;e.forEach(function(e){t.members.includes(e)&&(t.members.splice(t.members.indexOf(e),1),t.onMemberLeave(e))})},e}(),_t=new WeakMap,qt=function(){function e(e){void 0===e&&(e={});var t=new xt(e);_t.set(this,t),this.id=void 0,Reflect.defineProperty(this,"id",{configurable:!1,enumerable:!0,get:function(){return t.id}}),this.myId=void 0,Reflect.defineProperty(this,"myId",{configurable:!1,enumerable:!0,get:function(){return t.myId}}),this.key=void 0,Reflect.defineProperty(this,"key",{configurable:!1,enumerable:!0,get:function(){return t.key}}),this.members=void 0,Reflect.defineProperty(this,"members",{configurable:!1,enumerable:!0,get:function(){return t.members}}),this.topology=void 0,Reflect.defineProperty(this,"topology",{configurable:!1,enumerable:!0,get:function(){return t.topologyEnum}}),this.state=void 0,Reflect.defineProperty(this,"state",{configurable:!1,enumerable:!0,get:function(){return t.state}}),this.signalingState=void 0,Reflect.defineProperty(this,"signalingState",{configurable:!1,enumerable:!0,get:function(){return t.signaling.state}}),this.signalingServer=void 0,Reflect.defineProperty(this,"signalingServer",{configurable:!1,enumerable:!0,get:function(){return t.signaling.url}}),this.autoRejoin=void 0,Reflect.defineProperty(this,"autoRejoin",{configurable:!1,enumerable:!0,get:function(){return t.autoRejoin},set:function(e){return t.autoRejoin=e}}),this.onMessage=void 0,Reflect.defineProperty(this,"onMessage",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMessage.name?void 0:t.onMessage},set:function(e){t.onMessage="function"!=typeof e?function(){}:e}}),this.onMemberJoin=void 0,Reflect.defineProperty(this,"onMemberJoin",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMemberJoin.name?void 0:t.onMemberJoin},set:function(e){t.onMemberJoin="function"!=typeof e?function(){}:e}}),this.onMemberLeave=void 0,Reflect.defineProperty(this,"onMemberLeave",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMemberLeave.name?void 0:t.onMemberLeave},set:function(e){t.onMemberLeave="function"!=typeof e?function(){}:e}}),this.onStateChange=void 0,Reflect.defineProperty(this,"onStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onStateChange.name?void 0:t.onStateChange},set:function(e){t.onStateChange="function"!=typeof e?function(){}:e}}),this.onSignalingStateChange=void 0,Reflect.defineProperty(this,"onSignalingStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onSignalingStateChange.name?void 0:t.onSignalingStateChange},set:function(e){t.onSignalingStateChange="function"!=typeof e?function(){}:e}})}return e.prototype.join=function(e){var t=_t.get(this);if(t)return t.join(e);throw new Error("WebChannel is undefined")},e.prototype.invite=function(e){var t=_t.get(this);if(t)return t.invite(e);throw new Error("WebChannel is undefined")},e.prototype.leave=function(){var e=_t.get(this);if(e)return e.leave();throw new Error("WebChannel is undefined")},e.prototype.send=function(e){var t=_t.get(this);if(t)return t.send(e);throw new Error("WebChannel is undefined")},e.prototype.sendTo=function(e,t){var n=_t.get(this);if(n)return n.sendTo(e,t);throw new Error("WebChannel is undefined")},e}();!function(){function e(){}Object.defineProperty(e,"CONNECTING",{get:function(){return _e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return _e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return _e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHECKING",{get:function(){return _e.CHECKING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHECKED",{get:function(){return _e.CHECKED},enumerable:!0,configurable:!0})}();var Ut,Gt=function(){function e(){}return Object.defineProperty(e,"JOINING",{get:function(){return it.JOINING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"JOINED",{get:function(){return it.JOINED},enumerable:!0,configurable:!0}),Object.defineProperty(e,"LEFT",{get:function(){return it.LEFT},enumerable:!0,configurable:!0}),e}(),Ft=(function(){function e(){}Object.defineProperty(e,"FULL_MESH",{get:function(){return P.FULL_MESH},enumerable:!0,configurable:!0})}(),function(){function e(){}Object.defineProperty(e,"DEBUG",{get:function(){return r.DEBUG},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WEB_GROUP",{get:function(){return r.WEB_GROUP},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WEBRTC",{get:function(){return r.WEBRTC},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHANNEL",{get:function(){return r.CHANNEL},enumerable:!0,configurable:!0}),Object.defineProperty(e,"TOPOLOGY",{get:function(){return r.TOPOLOGY},enumerable:!0,configurable:!0}),Object.defineProperty(e,"SIGNALING",{get:function(){return r.SIGNALING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHANNEL_BUILDER",{get:function(){return r.CHANNEL_BUILDER},enumerable:!0,configurable:!0})}(),n(35)),Wt=n(17),Jt={url:"",perMessageDeflate:!1,leaveOnceAlone:!0,server:void 0,webGroupOptions:At},Ht=function(){function e(e){this.wcOptions=Object.assign({},At,e.webGroupOptions);var t=Object.assign({},Jt,e);t.webGroupOptions=this.wcOptions,this.leaveOnceAlone=t.leaveOnceAlone,this.server=t.server,this.listenUrl=t.url,this.perMessageDeflate=t.perMessageDeflate,this.webGroups=new Map,this.onWebGroup=function(){},this.onError=function(){},this.init()}return Object.defineProperty(e.prototype,"url",{get:function(){if(""!==this.listenUrl)return this.listenUrl;var e=this.server.address();return"ws://"+e.address+":"+e.port},enumerable:!0,configurable:!0}),e.prototype.init=function(){var e=this;this.webSocketServer=new Wt.Server({perMessageDeflate:this.perMessageDeflate,verifyClient:function(t){return e.validateConnection(t)},server:this.server}),(this.server||this.webSocketServer).on("listening",function(){return vt.listenUrl.next(e.url)}),this.webSocketServer.on("error",function(t){vt.listenUrl.next(""),e.onError(t)}),this.webSocketServer.on("connection",function(t){var n=e.readUrl(t.upgradeReq.url),r=n.route,o=n.wcId,i=n.senderId,s=n.key;switch(r){case dt.INTERNAL:var c=e.webGroups.get(o);_t.get(c).webSocketBuilder.newInternalWebSocket(t,i);break;case dt.JOIN:c=e.webGroups.get(o);_t.get(c).webSocketBuilder.newJoinWebSocket(t);break;case dt.INVITE:c=new qt(e.wcOptions);e.webGroups.set(o,c);var a=_t.get(c);e.leaveOnceAlone&&(a.onAlone=function(){a.leave(),e.webGroups.delete(o)}),a.init(s,o),e.onWebGroup(c),a.webSocketBuilder.newInviteWebSocket(t)}})},e.prototype.validateConnection=function(e){var t=this.readUrl(e.req.url),n=t.route,r=t.wcId,o=t.senderId,i=t.key;if(void 0===r)return!1;switch(n){case dt.INTERNAL:return this.webGroups.has(r)&&!!o;case dt.INVITE:var s=this.webGroups.get(r);return!!i&&(void 0===s||s.state===Gt.LEFT);case dt.JOIN:s=this.webGroups.get(r);return!!i&&void 0!==s&&s.key===i&&s.state!==Gt.LEFT;default:return!1}},e.prototype.readUrl=function(e){var t=Ft.parse(e,!0),n=t.pathname,r=t.query,o=r.senderId,i=r.wcId,s=r.key,c=n;return n.endsWith("/")&&(c=n.substr(0,n.length-1)),{route:c=c.split("/").pop(),wcId:i?Number(i):void 0,senderId:o?Number(o):void 0,key:s}},e}(),zt=function(){return function(e){Ut=new Ht(e),this.server=void 0,Reflect.defineProperty(this,"server",{configurable:!1,enumerable:!0,get:function(){return Ut.server}}),this.perMessageDeflate=void 0,Reflect.defineProperty(this,"perMessageDeflate",{configurable:!1,enumerable:!0,get:function(){return Ut.perMessageDeflate}}),this.leaveOnceAlone=void 0,Reflect.defineProperty(this,"leaveOnceAlone",{configurable:!1,enumerable:!0,get:function(){return Ut.leaveOnceAlone}}),this.webGroups=void 0,Reflect.defineProperty(this,"webGroups",{configurable:!1,enumerable:!0,get:function(){return Ut.webGroups}}),this.url=void 0,Reflect.defineProperty(this,"url",{configurable:!1,enumerable:!0,get:function(){return Ut.url}}),this.onWebGroup=void 0,Reflect.defineProperty(this,"onWebGroup",{configurable:!0,enumerable:!0,get:function(){return"none"===Ut.onWebGroup.name?void 0:Ut.onWebGroup},set:function(e){Ut.onWebGroup="function"!=typeof e?function(){}:e}}),this.onError=void 0,Reflect.defineProperty(this,"onError",{configurable:!0,enumerable:!0,get:function(){return"none"===Ut.onError.name?void 0:Ut.onError},set:function(e){Ut.onError="function"!=typeof e?function(){}:e}})}}();n.d(t,"LogLevel",function(){return r}),n.d(t,"setLogLevel",function(){return v}),n.d(t,"Topology",function(){return P}),n.d(t,"SignalingState",function(){return _e}),n.d(t,"WebGroupState",function(){return it}),n.d(t,"WebGroup",function(){return qt}),n.d(t,"Bot",function(){return zt})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.insert=function(e,t,n){console.assert(Number.isSafeInteger(t),"index ∈ safe integer");var r=Math.max(0,t);return e.slice(0,r)+n+e.slice(r)},t.del=function(e,t,n){return console.assert(Number.isSafeInteger(t),"begin ∈ safe integer"),console.assert(Number.isSafeInteger(n),"end ∈ safe integer"),e.slice(0,t)+e.slice(n+1)},t.occurrences=function(e,t){for(var n=0,r=t.length,o=e.indexOf(t);-1!==o;)n++,o=e.indexOf(t,o+r);return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=function(){function e(e,t){console.assert(r.isInt32(e),"offset ∈ int32"),this.offset=e,this.content=t}return e.prototype.equals=function(e){return this.offset===e.offset&&this.content===e.content},e.prototype.applyTo=function(e){return e.insertLocal(this.offset,this.content)},e}();t.TextInsert=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),o=function(){function e(e,t){console.assert(r.isInt32(e),"offset  ∈ int32"),console.assert(r.isInt32(t),"length  ∈ int32"),console.assert(t>0,"length > 0"),this.offset=e,this.length=t}return e.prototype.equals=function(e){return this.offset===e.offset&&this.length===e.length},e.prototype.applyTo=function(e){return e.delLocal(this.offset,this.offset+this.length-1)},e}();t.TextDelete=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5),o=n(3),i=n(7);function s(e){return null!==e?e.height:0}function c(e){return null!==e?e.sizeNodeAndChildren:0}var a=function(){function e(e,t,n,r,i){console.assert(o.isInt32(t),"actualBegin ∈ int32"),console.assert(e.idInterval.begin<=t,"actualBegin must be greater than or equal to idInterval.begin"),this.block=e,this.actualBegin=t,this.length=n,this.left=r,this.right=i,this.height=Math.max(s(r),s(i))+1,this.sizeNodeAndChildren=n+c(r)+c(i)}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.block,r=t.actualBegin,s=t.length,c=t.left,a=t.right;if(n instanceof Object&&"number"==typeof r&&o.isInt32(r)&&"number"==typeof s&&o.isInt32(s)&&s>=0){var u=i.LogootSBlock.fromPlain(n),l=e.fromPlain(a),p=e.fromPlain(c);if(null!==u&&u.idInterval.begin<=r&&u.idInterval.end-u.idInterval.begin>=s-1)return new e(u,r,s,p,l)}}return null},e.leaf=function(t,n,r){return console.assert(o.isInt32(n),"aOffset ∈ int32"),console.assert(o.isInt32(r),"lenth ∈ int32"),console.assert(r>0,"lenth > 0"),t.addBlock(n,r),new e(t,n,r,null,null)},Object.defineProperty(e.prototype,"actualEnd",{get:function(){return this.actualBegin+this.length-1},enumerable:!0,configurable:!0}),e.prototype.getIdBegin=function(){return this.block.idInterval.getBaseId(this.actualBegin)},e.prototype.getIdEnd=function(){return this.block.idInterval.getBaseId(this.actualEnd)},e.prototype.addString=function(e){console.assert(o.isInt32(e),"length  ∈ int32"),this.sizeNodeAndChildren+=e},e.prototype.appendEnd=function(e){console.assert(o.isInt32(e),"length  ∈ int32"),console.assert(e>0,""+e," > 0");var t=this.actualEnd+1;return this.length+=e,this.block.addBlock(t,e),this.block.idInterval.getBaseId(t)},e.prototype.appendBegin=function(e){return console.assert(o.isInt32(e),"length  ∈ int32"),console.assert(e>0,""+e," > 0"),this.actualBegin-=e,this.length+=e,this.block.addBlock(this.actualBegin,e),this.getIdBegin()},e.prototype.deleteOffsets=function(e,t){console.assert(o.isInt32(e),"begin  ∈ int32"),console.assert(o.isInt32(t),"end  ∈ int32"),console.assert(e<=t,"begin <= end: "+e," <= "+t),console.assert(this.block.idInterval.begin<=e,"this.block.idInterval.begin <= to begin: "+this.block.idInterval.begin," <= "+e),console.assert(t<=this.block.idInterval.end,"end <= this.block.idInterval.end: "+t," <= "+this.block.idInterval.end);var n=null,r=Math.max(this.actualBegin,e),i=Math.min(this.actualEnd,t);if(r<=i){var s=i-r+1;this.block.delBlock(s),s!==this.length&&(r===this.actualBegin?this.actualBegin=i+1:i!==this.actualEnd&&(n=this.split(i-this.actualBegin+1,null))),this.length=this.length-s}return n},e.prototype.split=function(t,n){var r=new e(this.block,this.actualBegin+t,this.length-t,n,this.right);return this.length=t,this.right=r,this.height=Math.max(this.height,r.height),r},e.prototype.leftSubtreeSize=function(){return c(this.left)},e.prototype.rightSubtreeSize=function(){return c(this.right)},e.prototype.sumDirectChildren=function(){this.height=Math.max(s(this.left),s(this.right))+1,this.sizeNodeAndChildren=this.leftSubtreeSize()+this.rightSubtreeSize()+this.length},e.prototype.replaceChildren=function(e,t){this.left===e?this.left=t:this.right===e&&(this.right=t)},e.prototype.balanceScore=function(){return s(this.right)-s(this.left)},e.prototype.become=function(e){this.sizeNodeAndChildren=-this.length+e.length,this.length=e.length,this.actualBegin=e.actualBegin,this.block=e.block},e.prototype.isAppendableAfter=function(e,t){return this.block.isMine(e)&&this.block.idInterval.end===this.actualEnd&&this.block.idInterval.idEnd.hasPlaceAfter(t)},e.prototype.isAppendableBefore=function(e,t){return this.block.isMine(e)&&this.block.idInterval.begin===this.actualBegin&&this.block.idInterval.idBegin.hasPlaceBefore(t)},e.prototype.toString=function(){var e=this.getIdentifierInterval().toString(),t=null!==this.left?this.left.toString():"\t#";return(null!==this.right?this.right.toString():"\t#").replace(/(\t+)/g,"\t$1")+"\n\t"+e+"\n"+t.replace(/(\t+)/g,"\t$1")},e.prototype.toList=function(){var e=this.getIdentifierInterval(),t=null!==this.left?this.left.toList():[],n=null!==this.right?this.right.toList():[];return t.concat(e,n)},e.prototype.getIdentifierInterval=function(){return new r.IdentifierInterval(this.getIdBegin(),this.actualEnd)},e.prototype.getBlocks=function(){var e=[this.block],t=this.left;null!==t&&(e=e.concat(t.getBlocks()));var n=this.right;return null!==n&&(e=e.concat(n.getBlocks())),e},e}();t.RopesNodes=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5),o=Array.prototype.concat,i=function(){function e(e){console.assert(e.length>0,"lid must not be empty"),this.lid=e}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.lid;if(n instanceof Array&&n.length>0){for(var o=!0,i=0,s=[];o&&i<n.length;){var c=r.IdentifierInterval.fromPlain(n[i]);null!==c?s.push(c):o=!1,i++}if(o)return new e(s)}}return null},e.prototype.equals=function(e){return this.lid.length===e.lid.length&&this.lid.every(function(t,n){var r=e.lid[n];return t.equals(r)})},e.prototype.execute=function(e){return o.apply([],this.lid.map(function(t){return e.delBlock(t)}))},e}();t.LogootSDel=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),o=function(){function e(){}return e.fromPlain=function(e){if("object"==typeof e&&null!==e){var t=e.l;if("string"==typeof t&&t.length>0){var n=e.id,o=r.Identifier.fromPlain(n);if(null!==o)return new i(o,t)}}return null},e}(),i=function(){function e(e,t){console.assert(t.length>0,"content must not be empty"),this.id=e,this.content=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.content;if(!("string"==typeof n&&n.length>0))return o.fromPlain(t);var i=t.id,s=r.Identifier.fromPlain(i);if(null!==s)return new e(s,n)}return null},e.prototype.equals=function(e){return this.id.equals(e.id)&&this.content===e.content},e.prototype.execute=function(e){return e.addBlock(this.content,this.id)},e}();t.LogootSAdd=i},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("uws")},function(e,t,n){"use strict";n.r(t);n(33);var r,o=n(0),i=n(1),s=function(){return function(e,t){this.service=e,this.content=t}}(),c=(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t}(s),u=function(){return function(e,t,n){this.id=e,this.key=t,this.created=n}}(),l=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),p=function(e){function t(t,n,r,o){var i=e.call(this,t,o)||this;return i.id=n,i.isBroadcast=r,i}return l(t,e),t}(s),h=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(s),d=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),g=function(e){function t(t,n,r){var o=e.call(this,t,r)||this;return o.id=n,o}return d(t,e),t}(s),b=n(4);const y=b.Reader,v=b.Writer,m=b.util,S=b.roots.default||(b.roots.default={}),w=S.sync=(()=>{const e={};return e.SyncMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.richLogootSOpMsg=null,e.prototype.querySync=null,e.prototype.replySync=null,Object.defineProperty(e.prototype,"type",{get:m.oneOfGetter(t=["richLogootSOpMsg","querySync","replySync"]),set:m.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),null!=e.richLogootSOpMsg&&e.hasOwnProperty("richLogootSOpMsg")&&S.sync.RichLogootSOperationMsg.encode(e.richLogootSOpMsg,t.uint32(10).fork()).ldelim(),null!=e.querySync&&e.hasOwnProperty("querySync")&&S.sync.QuerySyncMsg.encode(e.querySync,t.uint32(18).fork()).ldelim(),null!=e.replySync&&e.hasOwnProperty("replySync")&&S.sync.ReplySyncMsg.encode(e.replySync,t.uint32(26).fork()).ldelim(),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.SyncMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.richLogootSOpMsg=S.sync.RichLogootSOperationMsg.decode(e,e.uint32());break;case 2:r.querySync=S.sync.QuerySyncMsg.decode(e,e.uint32());break;case 3:r.replySync=S.sync.ReplySyncMsg.decode(e,e.uint32());break;default:e.skipType(7&t)}}return r},e}(),e.RichLogootSOperationMsg=function(){function e(e){if(this.dependencies=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.id=0,e.prototype.clock=0,e.prototype.logootSAddMsg=null,e.prototype.logootSDelMsg=null,e.prototype.dependencies=m.emptyArray,Object.defineProperty(e.prototype,"type",{get:m.oneOfGetter(t=["logootSAddMsg","logootSDelMsg"]),set:m.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=v.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).int32(e.id),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(16).int32(e.clock),null!=e.logootSAddMsg&&e.hasOwnProperty("logootSAddMsg")&&S.sync.LogootSAddMsg.encode(e.logootSAddMsg,t.uint32(26).fork()).ldelim(),null!=e.logootSDelMsg&&e.hasOwnProperty("logootSDelMsg")&&S.sync.LogootSDelMsg.encode(e.logootSDelMsg,t.uint32(34).fork()).ldelim(),null!=e.dependencies&&e.dependencies.length)for(let n=0;n<e.dependencies.length;++n)S.sync.DotMsg.encode(e.dependencies[n],t.uint32(42).fork()).ldelim();return t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.RichLogootSOperationMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.int32();break;case 2:r.clock=e.int32();break;case 3:r.logootSAddMsg=S.sync.LogootSAddMsg.decode(e,e.uint32());break;case 4:r.logootSDelMsg=S.sync.LogootSDelMsg.decode(e,e.uint32());break;case 5:r.dependencies&&r.dependencies.length||(r.dependencies=[]),r.dependencies.push(S.sync.DotMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.LogootSAddMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=null,e.prototype.content="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),null!=e.id&&e.hasOwnProperty("id")&&S.sync.IdentifierMsg.encode(e.id,t.uint32(10).fork()).ldelim(),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).string(e.content),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.LogootSAddMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=S.sync.IdentifierMsg.decode(e,e.uint32());break;case 2:r.content=e.string();break;default:e.skipType(7&t)}}return r},e}(),e.IdentifierMsg=function(){function e(e){if(this.tuples=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.tuples=m.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=v.create()),null!=e.tuples&&e.tuples.length)for(let n=0;n<e.tuples.length;++n)S.sync.IdentifierTupleMsg.encode(e.tuples[n],t.uint32(10).fork()).ldelim();return t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.IdentifierMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.tuples&&r.tuples.length||(r.tuples=[]),r.tuples.push(S.sync.IdentifierTupleMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.IdentifierTupleMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.random=0,e.prototype.replicaNumber=0,e.prototype.clock=0,e.prototype.offset=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),null!=e.random&&e.hasOwnProperty("random")&&t.uint32(8).int32(e.random),null!=e.replicaNumber&&e.hasOwnProperty("replicaNumber")&&t.uint32(16).int32(e.replicaNumber),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(24).int32(e.clock),null!=e.offset&&e.hasOwnProperty("offset")&&t.uint32(32).int32(e.offset),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.IdentifierTupleMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.random=e.int32();break;case 2:r.replicaNumber=e.int32();break;case 3:r.clock=e.int32();break;case 4:r.offset=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.LogootSDelMsg=function(){function e(e){if(this.lid=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.lid=m.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=v.create()),null!=e.lid&&e.lid.length)for(let n=0;n<e.lid.length;++n)S.sync.IdentifierIntervalMsg.encode(e.lid[n],t.uint32(10).fork()).ldelim();return t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.LogootSDelMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.lid&&r.lid.length||(r.lid=[]),r.lid.push(S.sync.IdentifierIntervalMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.IdentifierIntervalMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.idBegin=null,e.prototype.end=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),null!=e.idBegin&&e.hasOwnProperty("idBegin")&&S.sync.IdentifierMsg.encode(e.idBegin,t.uint32(10).fork()).ldelim(),null!=e.end&&e.hasOwnProperty("end")&&t.uint32(16).int32(e.end),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.IdentifierIntervalMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.idBegin=S.sync.IdentifierMsg.decode(e,e.uint32());break;case 2:r.end=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.QuerySyncMsg=function(){function e(e){if(this.vector={},e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.vector=m.emptyObject,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=v.create()),null!=e.vector&&e.hasOwnProperty("vector"))for(let n=Object.keys(e.vector),r=0;r<n.length;++r)t.uint32(10).fork().uint32(8).int32(n[r]).uint32(16).int32(e.vector[n[r]]).ldelim();return t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n,r=void 0===t?e.len:e.pos+t,o=new S.sync.QuerySyncMsg;for(;e.pos<r;){let t=e.uint32();switch(t>>>3){case 1:e.skip().pos++,o.vector===m.emptyObject&&(o.vector={}),n=e.int32(),e.pos++,o.vector[n]=e.int32();break;default:e.skipType(7&t)}}return o},e}(),e.ReplySyncMsg=function(){function e(e){if(this.richLogootSOpsMsg=[],this.intervals=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.richLogootSOpsMsg=m.emptyArray,e.prototype.intervals=m.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=v.create()),null!=e.richLogootSOpsMsg&&e.richLogootSOpsMsg.length)for(let n=0;n<e.richLogootSOpsMsg.length;++n)S.sync.RichLogootSOperationMsg.encode(e.richLogootSOpsMsg[n],t.uint32(10).fork()).ldelim();if(null!=e.intervals&&e.intervals.length)for(let n=0;n<e.intervals.length;++n)S.sync.IntervalMsg.encode(e.intervals[n],t.uint32(18).fork()).ldelim();return t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.ReplySyncMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.richLogootSOpsMsg&&r.richLogootSOpsMsg.length||(r.richLogootSOpsMsg=[]),r.richLogootSOpsMsg.push(S.sync.RichLogootSOperationMsg.decode(e,e.uint32()));break;case 2:r.intervals&&r.intervals.length||(r.intervals=[]),r.intervals.push(S.sync.IntervalMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e}(),e.IntervalMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.begin=0,e.prototype.end=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).int32(e.id),null!=e.begin&&e.hasOwnProperty("begin")&&t.uint32(16).int32(e.begin),null!=e.end&&e.hasOwnProperty("end")&&t.uint32(24).int32(e.end),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.IntervalMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.int32();break;case 2:r.begin=e.int32();break;case 3:r.end=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.DotMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.replicaNumber=0,e.prototype.clock=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),t.uint32(8).int32(e.replicaNumber),t.uint32(16).int32(e.clock),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.sync.DotMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.replicaNumber=e.int32();break;case 2:r.clock=e.int32();break;default:e.skipType(7&t)}}if(!r.hasOwnProperty("replicaNumber"))throw m.ProtocolError("missing required 'replicaNumber'",{instance:r});if(!r.hasOwnProperty("clock"))throw m.ProtocolError("missing required 'clock'",{instance:r});return r},e}(),e})(),I=S.collaborator=(()=>{const e={};return e.Collaborator=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.muteCoreId=0,e.prototype.displayName="",e.prototype.login="",e.prototype.email="",e.prototype.avatar="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=v.create()),null!=e.muteCoreId&&e.hasOwnProperty("muteCoreId")&&t.uint32(8).uint32(e.muteCoreId),null!=e.displayName&&e.hasOwnProperty("displayName")&&t.uint32(18).string(e.displayName),null!=e.login&&e.hasOwnProperty("login")&&t.uint32(26).string(e.login),null!=e.email&&e.hasOwnProperty("email")&&t.uint32(34).string(e.email),null!=e.avatar&&e.hasOwnProperty("avatar")&&t.uint32(42).string(e.avatar),t},e.decode=function(e,t){e instanceof y||(e=y.create(e));let n=void 0===t?e.len:e.pos+t,r=new S.collaborator.Collaborator;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.muteCoreId=e.uint32();break;case 2:r.displayName=e.string();break;case 3:r.login=e.string();break;case 4:r.email=e.string();break;case 5:r.avatar=e.string();break;default:e.skipType(7&t)}}return r},e}(),e})();var O=function(){function e(e){this.me=e,this.updateSubject=new o.Subject,this.joinSubject=new o.Subject,this.leaveSubject=new o.Subject,this.disposeSubject=new o.Subject,this.msgToBroadcastSubject=new o.Subject,this.msgToSendRandomlySubject=new o.Subject,this.msgToSendToSubject=new o.Subject,this.collaborators=new Map}return Object.defineProperty(e.prototype,"onUpdate",{get:function(){return this.updateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onJoin",{get:function(){return this.joinSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onLeave",{get:function(){return this.leaveSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToBroadcast",{get:function(){return this.msgToBroadcastSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendRandomly",{get:function(){return this.msgToSendRandomlySubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendTo",{get:function(){return this.msgToSendToSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.disposeSubject),Object(i.filter)(function(t){return t.service===e.ID})).subscribe(function(e){var t=Object.assign({id:e.id},I.Collaborator.decode(e.content)),r=n.collaborators.get(t.id);r?(r.muteCoreId=t.muteCoreId||r.muteCoreId,r.displayName=t.displayName||r.displayName,r.login=t.login||r.login,r.email=t.email||r.email,r.avatar=t.avatar||r.avatar,n.collaborators.set(r.id,r),n.updateSubject.next(r)):(n.collaborators.set(t.id,t),n.joinSubject.next(t))})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"joinSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){return t.emitUpdate(e)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leaveSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.collaborators.delete(e),t.leaveSubject.next(e)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updateSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){Object.assign(t.me,e),t.emitUpdate()})},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.updateSubject.complete(),this.joinSubject.complete(),this.leaveSubject.complete(),this.disposeSubject.next(),this.disposeSubject.complete(),this.msgToBroadcastSubject.complete(),this.msgToSendRandomlySubject.complete(),this.msgToSendToSubject.complete()},e.prototype.emitUpdate=function(t){var n=Object.assign({},this.me);delete n.id;var r=I.Collaborator.create(n);if(console.log("I emit my profile ",r),t){var o=new g(e.ID,t,I.Collaborator.encode(r).finish());this.msgToSendToSubject.next(o)}else{o=new a(e.ID,I.Collaborator.encode(r).finish());this.msgToBroadcastSubject.next(o)}},e.ID=421,e}(),j=n(2),k=function(){function e(e){var t=this;this.doc=new j.LogootSRopes(e),this.disposeSubject=new o.Subject,this.docDigestSubject=new o.Subject,this.docTreeSubject=new o.Subject,this.localLogootSOperationSubject=new o.Subject,this.remoteTextOperationsSubject=new o.Subject,this.updateSubject=new o.Subject,this.updateSubject.pipe(Object(i.takeUntil)(this.disposeSubject),Object(i.debounceTime)(1e3)).subscribe(function(){t.docTreeSubject.next(JSON.stringify(t.doc)),t.docDigestSubject.next(t.doc.digest())})}return Object.defineProperty(e.prototype,"initSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.docID=e})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localTextOperationsSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.handleTextOperations(e),t.updateSubject.next()})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteLogootSOperationSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){var n=e.map(function(e){return t.handleRemoteOperation(e)}).reduce(function(e,t){return e.concat(t)},[]);t.remoteTextOperationsSubject.next(n),t.updateSubject.next()})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDocDigest",{get:function(){return this.docDigestSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDocTree",{get:function(){return this.docTreeSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onLocalLogootSOperation",{get:function(){return this.localLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteTextOperations",{get:function(){return this.remoteTextOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.disposeSubject.next(),this.disposeSubject.complete(),this.localLogootSOperationSubject.complete(),this.remoteTextOperationsSubject.complete(),this.updateSubject.complete()},e.prototype.handleTextOperations=function(e){var t=this;e.forEach(function(e){var n=e.applyTo(t.doc);t.localLogootSOperationSubject.next(n)})},e.prototype.handleRemoteOperation=function(e){return e.execute(this.doc)},e.prototype.positionFromIndex=function(e){var t=this.doc.searchNode(e);if(null!==t){var n=t.node.actualBegin+t.i;return{id:j.Identifier.fromBase(t.node.getIdBegin(),n),index:t.i}}return null},e.prototype.indexFromId=function(e){return this.doc.searchPos(e,new Array)},e.prototype.setTitle=function(e){},e}(),M=function(){function e(e,t,n){this.id=e,this.begin=t,this.end=n}return e.prototype.equals=function(e){return this.id===e.id&&this.begin===e.begin&&this.end===e.end},e}(),T=function(){function e(e,t){this.richLogootSOps=e,this.intervals=t}return e.prototype.equals=function(e){return this.richLogootSOps.length===e.richLogootSOps.length&&this.intervals.length===e.intervals.length&&this.richLogootSOps.every(function(t,n){var r=e.richLogootSOps[n];return t.equals(r)})&&this.intervals.every(function(t,n){var r=e.intervals[n];return t.equals(r)})},e}(),E=function(){function e(e,t,n,r){void 0===r&&(r=[]),this.id=e,this.clock=t,this.logootSOp=n,this.dependencies=r}return e.fromPlain=function(t){if("object"==typeof t&&null!==t&&"number"==typeof t.id&&Number.isInteger(t.id)&&"number"==typeof t.clock&&Number.isInteger(t.clock)&&t.dependencies instanceof Array&&t.dependencies.every(j.isDot)){var n=j.LogootSAdd.fromPlain(t.logootSOp);if(n instanceof j.LogootSAdd)return new e(t.id,t.clock,n);var r=j.LogootSDel.fromPlain(t.logootSOp);if(r instanceof j.LogootSDel&&t.dependencies.length>0)return new e(t.id,t.clock,r,t.dependencies)}return null},e.prototype.equals=function(e){var t=this.id===e.id&&this.clock===e.clock;return this.logootSOp instanceof j.LogootSAdd&&e.logootSOp instanceof j.LogootSAdd?t&&this.logootSOp.equals(e.logootSOp):this.logootSOp instanceof j.LogootSDel&&e.logootSOp instanceof j.LogootSDel&&(t&&this.logootSOp.equals(e.logootSOp)&&this.dependencies.every(function(t,n){var r=e.dependencies[n];return t.replicaNumber===r.replicaNumber&&t.clock===r.clock}))},e}(),P=function(){return function(e,t){this.vector=e,this.richLogootSOps=t}}(),L=function(){function e(e){e&&e.forEach(function(e){console.assert(e>=0,"Each value of a state vector must be positive")}),this.vector=new Map(e)}return e.prototype.get=function(e){return this.vector.get(e)},e.prototype.set=function(e,t){console.assert(t>=0,"clock must be positive"),console.assert(this.isDeliverable(e,t)),this.vector.set(e,t)},e.prototype.clear=function(){this.vector.clear()},Object.defineProperty(e.prototype,"size",{get:function(){return this.vector.size},enumerable:!0,configurable:!0}),e.prototype.isAlreadyDelivered=function(e,t){var n=this.get(e);return void 0!==n&&n>=t},e.prototype.isDeliverable=function(e,t){if(this.isAlreadyDelivered(e,t))return!1;var n=this.get(e);return void 0===n?0===t:t===n+1},e.prototype.forEach=function(e){this.vector.forEach(e)},e.prototype.asMap=function(){return new Map(this.vector)},e.prototype.computeMissingIntervals=function(e){var t=this,n=[];return e.vector.forEach(function(e,r){var o=t.get(r);if(void 0===o){var i=0,s=e;n.push(new M(r,i,s))}else if(o<e){i=o+1,s=e;n.push(new M(r,i,s))}}),n},e}(),R=function(){function e(e){this.id=-1,this.clock=0,this.richLogootSOps=[],this.id=e,this.vector=new L,this.appliedOperationsSubject=new o.Subject,this.disposeSubject=new o.Subject,this.isReadySubject=new o.Subject,this.localRichLogootSOperationSubject=new o.Subject,this.querySyncSubject=new o.Subject,this.remoteLogootSOperationSubject=new o.Subject,this.replySyncSubject=new o.Subject,this.stateSubject=new o.Subject,this.triggerQuerySyncSubject=new o.Subject,this.initPeriodicQuerySync()}return Object.defineProperty(e.prototype,"onLocalRichLogootSOperation",{get:function(){return this.localRichLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onQuerySync",{get:function(){return this.querySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteLogootSOperation",{get:function(){return this.remoteLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onReplySync",{get:function(){return this.replySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return new P(this.vector.asMap(),this.richLogootSOps)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localLogootSOperationSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){var n=[];e instanceof j.LogootSDel&&(n=t.getDependencies(e));var r=new E(t.id,t.clock,e,n);t.updateState(r),t.stateSubject.next(t.state),t.localRichLogootSOperationSubject.next(r),t.clock++})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteQuerySyncSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){var n=t.computeMissingOps(e),r=t.vector.computeMissingIntervals(e),o=new T(n,r);t.replySyncSubject.next(o)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteReplySyncSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){e.richLogootSOps.length>0&&(t.applyRichLogootSOperations(e.richLogootSOps),t.stateSubject.next(t.state)),e.intervals.forEach(function(e){t.richLogootSOps.filter(function(t){var n=t.id,r=t.clock;return e.id===n&&e.begin<=r&&r<=e.end}).forEach(function(e){t.localRichLogootSOperationSubject.next(e)})})})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteRichLogootSOperationSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.applyRichLogootSOperations([e]),t.stateSubject.next(t.state)})},enumerable:!0,configurable:!0}),e.prototype.setJoinAndStateSources=function(e,t){var n=this,r=e;t&&(this.storedStateSource=t,r=e.pipe(Object(i.takeUntil)(this.disposeSubject),Object(i.zip)(this.isReadySubject,function(e){return e}))),r.pipe(Object(i.take)(1)).subscribe(function(e){e.created||n.querySyncSubject.next(n.vector)})},e.prototype.computeMissingOps=function(e){return this.richLogootSOps.filter(function(t){var n=t.id,r=t.clock,o=e.get(n);return void 0===o||o<r})},e.prototype.dispose=function(){this.appliedOperationsSubject.complete(),this.disposeSubject.next(),this.disposeSubject.complete(),this.isReadySubject.complete(),this.localRichLogootSOperationSubject.complete(),this.querySyncSubject.complete(),this.remoteLogootSOperationSubject.complete(),this.replySyncSubject.complete(),this.stateSubject.complete()},Object.defineProperty(e.prototype,"storedStateSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.richLogootSOps=[],t.vector.clear(),t.applyRichLogootSOperations(e.richLogootSOps),t.isReadySubject.next()})},enumerable:!0,configurable:!0}),e.prototype.initPeriodicQuerySync=function(){var e=this;this.triggerQuerySyncSubject.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(){e.querySyncSubject.next(e.vector),e.triggerPeriodicQuerySync()}),this.triggerPeriodicQuerySync()},e.prototype.triggerPeriodicQuerySync=function(){var e=this,t=Math.floor(2*Math.random()*5e3)+-5e3;setTimeout(function(){e.triggerQuerySyncSubject.next()},1e4+t)},e.prototype.applyRichLogootSOperations=function(e){var t=this,n=e.filter(function(e){var n=e.id,r=e.clock;return!t.vector.isAlreadyDelivered(n,r)});if(n.length>0){var r=[];n.forEach(function(e){if(t.isDeliverable(e)){e.id,e.clock;var n=e.logootSOp;t.updateState(e),r.push(n)}else t.bufferOperation(e)}),r.length>0&&(this.remoteLogootSOperationSubject.next(r),this.appliedOperationsSubject.next())}},e.prototype.bufferOperation=function(e){var t=this,n=e.id,r=e.clock;console.log("SyncService: Buffering operation: ",{id:n,clock:r});var s=new o.Subject;this.appliedOperationsSubject.pipe(Object(i.takeUntil)(s),Object(i.filter)(function(){return t.isDeliverable(e)})).subscribe(function(){s.next(),s.complete(),console.log("SyncService: Delivering operation: ",{id:n,clock:r}),t.vector.isAlreadyDelivered(n,r)||t.applyRichLogootSOperations([e])})},e.prototype.updateState=function(e){console.assert(this.isDeliverable(e));var t=e.id,n=e.clock;this.vector.set(t,n),this.richLogootSOps.push(e)},e.prototype.isDeliverable=function(e){var t=e.id,n=e.clock,r=e.dependencies;return this.vector.isDeliverable(t,n)&&this.hasDeliveredDependencies(r)},e.prototype.hasDeliveredDependencies=function(e){var t=this;return e.every(function(e){var n=t.vector.get(e.replicaNumber);return void 0!==n&&e.clock<=n})},e.prototype.getDependencies=function(e){var t=this;return e.lid.map(function(e){var n=e.idBegin.replicaNumber;return{replicaNumber:n,clock:t.vector.get(n)}})},e}(),N=function(){function e(){this.disposeSubject=new o.Subject,this.msgToBroadcastSubject=new o.Subject,this.msgToSendRandomlySubject=new o.Subject,this.msgToSendToSubject=new o.Subject,this.remoteQuerySyncSubject=new o.Subject,this.remoteQuerySyncIdSubject=new o.Subject,this.remoteRichLogootSOperationSubject=new o.Subject,this.remoteReplySyncSubject=new o.Subject}return Object.defineProperty(e.prototype,"localRichLogootSOperationSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.onDispose)).subscribe(function(t){var r=n.generateRichLogootSOpMsg(t),o=new a(e.ID,r);n.msgToBroadcastSubject.next(o)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.onDispose),Object(i.filter)(function(t){return t.service===e.ID})).subscribe(function(e){var t=w.SyncMsg.decode(e.content);switch(t.type){case"richLogootSOpMsg":n.handleRichLogootSOpMsg(t.richLogootSOpMsg);break;case"querySync":n.remoteQuerySyncIdSubject.next(e.id),n.handleQuerySyncMsg(t.querySync);break;case"replySync":n.handleReplySyncMsg(t.replySync)}})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"querySyncSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.onDispose)).subscribe(function(t){var r=n.generateQuerySyncMsg(t),o=new f(e.ID,r);n.msgToSendRandomlySubject.next(o)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"replySyncSource",{set:function(t){var n=this;Object(o.zip)(t,this.remoteQuerySyncIdSubject.asObservable(),function(e,t){return{id:t,replySyncEvent:e}}).pipe(Object(i.takeUntil)(this.onDispose)).subscribe(function(t){var r=t.id,o=t.replySyncEvent,i=n.generateReplySyncMsg(o.richLogootSOps,o.intervals),s=new g(e.ID,r,i);n.msgToSendToSubject.next(s)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{get:function(){return this.disposeSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToBroadcast",{get:function(){return this.msgToBroadcastSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendRandomly",{get:function(){return this.msgToSendRandomlySubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendTo",{get:function(){return this.msgToSendToSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteRichLogootSOperation",{get:function(){return this.remoteRichLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteQuerySync",{get:function(){return this.remoteQuerySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteReplySync",{get:function(){return this.remoteReplySyncSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.disposeSubject.next(),this.disposeSubject.complete(),this.msgToBroadcastSubject.complete(),this.msgToSendRandomlySubject.complete(),this.msgToSendToSubject.complete(),this.remoteQuerySyncSubject.complete(),this.remoteQuerySyncIdSubject.complete(),this.remoteRichLogootSOperationSubject.complete(),this.remoteReplySyncSubject.complete()},e.prototype.handleRichLogootSOpMsg=function(e){var t=this.deserializeRichLogootSOperation(e);this.remoteRichLogootSOperationSubject.next(t)},e.prototype.handleQuerySyncMsg=function(e){var t=new Map;Object.keys(e.vector).forEach(function(n){var r=parseInt(n,10);t.set(r,e.vector[n])});var n=new L(t);this.remoteQuerySyncSubject.next(n)},e.prototype.handleReplySyncMsg=function(e){var t=this,n=e.richLogootSOpsMsg.map(function(e){return t.deserializeRichLogootSOperation(e)}),r=e.intervals.map(function(e){return new M(e.id,e.begin,e.end)}),o=new T(n,r);this.remoteReplySyncSubject.next(o)},e.prototype.generateRichLogootSOpMsg=function(e){var t=this.serializeRichLogootSOperation(e),n=w.SyncMsg.create({richLogootSOpMsg:t});return w.SyncMsg.encode(n).finish()},e.prototype.serializeRichLogootSOperation=function(e){var t=w.RichLogootSOperationMsg.create({id:e.id,clock:e.clock,dependencies:e.dependencies}),n=e.logootSOp;return n instanceof j.LogootSDel?t.logootSDelMsg=w.LogootSDelMsg.create(n):n instanceof j.LogootSAdd&&(t.logootSAddMsg=w.LogootSAddMsg.create(n)),t},e.prototype.deserializeRichLogootSOperation=function(e){var t,n=e.id,r=e.clock,o=e.dependencies;return e.logootSAddMsg?t=e.logootSAddMsg:e.logootSDelMsg&&(t=e.logootSDelMsg),E.fromPlain({id:n,clock:r,logootSOp:t,dependencies:o})},e.prototype.generateQuerySyncMsg=function(e){var t=w.QuerySyncMsg.create();e.forEach(function(e,n){t.vector[n]=e});var n=w.SyncMsg.create({querySync:t});return w.SyncMsg.encode(n).finish()},e.prototype.generateReplySyncMsg=function(e,t){var n=this,r=w.ReplySyncMsg.create();r.richLogootSOpsMsg=e.map(function(e){return n.serializeRichLogootSOperation(e)});var o=t.map(function(e){return w.IntervalMsg.create({id:e.id,begin:e.begin,end:e.end})});r.intervals=o;var i=w.SyncMsg.create({replySync:r});return w.SyncMsg.encode(i).finish()},e.ID=423,e}(),B="undefined"!=typeof window;var C=function(){function e(e){e.muteCoreId||(e.muteCoreId=B?global.crypto.getRandomValues(new Int32Array(1))[0]:global.cryptoNode.randomBytes(4).readInt32BE(0,!0)),this.initSubject=new o.Subject,this.collaboratorsService=new O(Object.assign({id:0},e)),this.docService=new k(e.muteCoreId),this.syncService=new R(e.muteCoreId),this.syncMessageService=new N,this.docService.initSource=this.initSubject,this.docService.remoteLogootSOperationSource=this.syncService.onRemoteLogootSOperation,this.syncService.localLogootSOperationSource=this.docService.onLocalLogootSOperation,this.syncService.remoteQuerySyncSource=this.syncMessageService.onRemoteQuerySync,this.syncService.remoteReplySyncSource=this.syncMessageService.onRemoteReplySync,this.syncService.remoteRichLogootSOperationSource=this.syncMessageService.onRemoteRichLogootSOperation,this.syncMessageService.localRichLogootSOperationSource=this.syncService.onLocalRichLogootSOperation,this.syncMessageService.querySyncSource=this.syncService.onQuerySync,this.syncMessageService.replySyncSource=this.syncService.onReplySync}return Object.defineProperty(e.prototype,"messageSource",{set:function(e){this.collaboratorsService.messageSource=e,this.syncMessageService.messageSource=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onInit",{get:function(){return this.initSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToBroadcast",{get:function(){return Object(o.merge)(this.collaboratorsService.onMsgToBroadcast,this.syncMessageService.onMsgToBroadcast)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendRandomly",{get:function(){return Object(o.merge)(this.collaboratorsService.onMsgToSendRandomly,this.syncMessageService.onMsgToSendRandomly)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendTo",{get:function(){return Object(o.merge)(this.collaboratorsService.onMsgToSendTo,this.syncMessageService.onMsgToSendTo)},enumerable:!0,configurable:!0}),e.prototype.init=function(e){this.initSubject.next(e)},e.prototype.dispose=function(){this.collaboratorsService.dispose(),this.docService.dispose(),this.syncService.dispose(),this.syncMessageService.dispose()},e}();n.d(t,"CollaboratorsService",function(){return O}),n.d(t,"DocService",function(){return k}),n.d(t,"BroadcastMessage",function(){return a}),n.d(t,"JoinEvent",function(){return u}),n.d(t,"NetworkMessage",function(){return p}),n.d(t,"SendRandomlyMessage",function(){return f}),n.d(t,"SendToMessage",function(){return g}),n.d(t,"AbstractMessage",function(){return s}),n.d(t,"MuteCore",function(){return C}),n.d(t,"RichLogootSOperation",function(){return E}),n.d(t,"State",function(){return P}),global.cryptoNode=n(16)},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("longjohn")},function(e,t){e.exports=require("mongoose")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(22);t.MongooseAdapter=class{constructor(){this.DocModel=r.model("Doc",new r.Schema({key:{type:String,require:!0},logins:[],operations:Array}))}connect(e,t){return r.connection.on("close",()=>log.warn("Connection to the database has been closed")),r.connect(`mongodb://${e}/${t}`)}find(e){return this.DocModel.findOne({key:e}).exec()}findKeysByLogin(e){return this.DocModel.find({logins:e},"key").exec().then(e=>e.map(e=>e.get("key")))}async removeLogin(e,t){const n=await this.find(e);if(n){const e=n.get("logins");for(let n=0;n<e.length;n++)if(e[n]===t){e.splice(n);break}n.set("logins",e),n.save()}}create(e){return this.DocModel.create({key:e})}}},function(e,t){e.exports=require("bunyan")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(24);t.createLogger=function(e,t){let n;const o={name:"mute-bot-storage"};switch(""!==e&&(o.streams=[{type:"rotating-file",period:"1d",count:3,path:`${e}/${o.name}.log`}]),n=r.createLogger(o),t){case"none":n.level(r.FATAL+1);break;case"trace":n.level(r.TRACE);break;case"debug":n.level(r.DEBUG);break;case"info":n.level(r.INFO);break;case"warn":n.level(r.WARN);break;case"error":n.level(r.ERROR);break;case"fatal":n.level(r.FATAL);break;default:n.level(r.INFO)}return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.Message=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4));var o=r.Reader,i=r.Writer,s=r.util,c=r.roots.default||(r.roots.default={});t.Message=c.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.service=0,e.prototype.content=s.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=i.create()),null!=e.service&&e.hasOwnProperty("service")&&t.uint32(8).uint32(e.service),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).bytes(e.content),t},e.decode=function(e,t){e instanceof o||(e=o.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new c.Message;e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:r.service=e.uint32();break;case 2:r.content=e.bytes();break;default:e.skipType(7&i)}}return r},e}();t.default=c},function(e,t){e.exports=require("crypto-api-wrapper")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(27);t.SymmetricCrypto=class{async importKey(e){try{this.key=await r.symmetricCrypto.importKey(r.symmetricCrypto.fromB64(e))}catch(e){console.error("IMPORT KEY ERROR: ",e)}}async encrypt(e){try{return await r.symmetricCrypto.encrypt(e,this.key)}catch(e){return console.error("ENCRYPT ERROR: ",e),new Uint8Array}}async decrypt(e){try{return await r.symmetricCrypto.decrypt(e,this.key)}catch(e){return console.error("DECRYPT ERROR INSIDE: ",e.stack),new Uint8Array}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compareBase=function(e,t){var n=e.idBegin,r=e.begin,o=e.end,i=t.idBegin,s=t.begin,c=t.end;return n.equalsBase(i)?r===s&&o===c?6:o+1===s?4:r===c+1?5:o<s?1:c<r?0:(console.warn("Trying to duplicate existing identifiers: ",e,t),6):function(e,t){var n=e.idBegin,r=t.idBegin;return console.assert(!n.equalsBase(r),"the bases of the ids must be different"),e.containsId(r)?3:t.containsId(n)?2:-1===n.compareTo(r)?1:0}(e,t)}},function(e,t,n){"use strict";var r=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),i=n(8),s=n(3),c=new i.IdentifierTuple(s.INT32_BOTTOM,0,0,0),a=new i.IdentifierTuple(s.INT32_TOP,0,0,0);function u(e,t){var n,o;return r(this,function(r){switch(r.label){case 0:n=0,o=e,r.label=1;case 1:return n<o.length?[4,o[n]]:[3,4];case 2:r.sent(),r.label=3;case 3:return n++,[3,1];case 4:return[4,t];case 5:return r.sent(),[3,4];case 6:return[2]}})}function l(e){return null!==e?e.tuples:[]}t.createBetweenPosition=function(e,t,n,r){console.assert(null===e||null===t||-1===e.compareTo(t),"id1 < id2"),console.assert(s.isInt32(n),"replicaNumber is an int32"),console.assert(s.isInt32(r),"clock is an int32");for(var p=u(l(e),c),h=u(l(t),a),f=[],d=p.next().value,g=h.next().value;g.random-d.random<2;)f.push(d),d=p.next().value,g=h.next().value;var b=s.randomInt32(d.random+1,g.random);return f.push(new i.IdentifierTuple(b,n,r,0)),new o.Identifier(f)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),o=n(5),i=n(30),s=n(3),c=n(29),a=n(15),u=n(7),l=n(14),p=n(13),h=n(12),f=n(11),d=n(10);function g(e){return e.left}function b(e){return e.right}var y=function(){function e(e,t,n,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),void 0===r&&(r=""),console.assert(s.isInt32(e),"replica ∈ int32"),console.assert(s.isInt32(t),"clock ∈ int32"),this.replicaNumber=e,this.clock=t,this.root=n,this.str=r;var o={};if(null!==n){console.assert(r.length===n.sizeNodeAndChildren,"str length must match the number of elements in the model");for(var i=0,c=n.getBlocks();i<c.length;i++){var a=c[i];o[a.idInterval.base.join(",")]=a}}else console.assert(0===r.length,"str must be empty when no root is provided");this.mapBaseToBlock=o}return e.empty=function(){return new e(0,0)},e.fromPlain=function(t,n,r){if(console.assert(s.isInt32(t),"replica ∈ int32"),console.assert(s.isInt32(n),"clock ∈ int32"),"object"==typeof r&&null!==r){var o=r.str,i=r.root;if("string"==typeof o){var c=p.RopesNodes.fromPlain(i);if(null!==c&&o.length===c.sizeNodeAndChildren)return new e(t,n,c,o)}}return null},e.prototype.getBlock=function(e){var t,n=this.mapBaseToBlock,r=e.base.join(",");return n.hasOwnProperty(r)?t=n[r]:(t=new u.LogootSBlock(e,0),this.mapBaseToBlock[r]=t),t},e.prototype.addBlockFrom=function(e,t,n,r){var o=this,i=this.addBlockFromRec(e,t,n,r);return i.forEach(function(e){o.applyTextInsert(e)}),i},e.prototype.addBlockFromRec=function(e,t,n,i){for(var s=[],a=[],u=!0,l=i;u;)switch(s.push(n),c.compareBase(t,n.getIdentifierInterval())){case 0:null===n.right?(n.right=p.RopesNodes.leaf(this.getBlock(t),t.begin,e.length),l=l+n.leftSubtreeSize()+n.length,a.push(new f.TextInsert(l,e)),u=!1):(l=l+n.leftSubtreeSize()+n.length,n=n.right);break;case 1:null===n.left?(n.left=p.RopesNodes.leaf(this.getBlock(t),t.begin,e.length),a.push(new f.TextInsert(l,e)),u=!1):n=n.left;break;case 2:var h=n.getIdBegin().length-1,d=t.idBegin.tuples[h].offset,g=p.RopesNodes.leaf(this.getBlock(t),t.begin,e.length);s.push(n.split(d-n.actualBegin+1,g)),l+=n.leftSubtreeSize(),a.push(new f.TextInsert(l+d-n.actualBegin+1,e)),u=!1;break;case 3:h=t.idBegin.length-1,d=n.getIdBegin().tuples[h].offset;var b=e.substr(0,d+1-t.begin),y=new o.IdentifierInterval(t.idBegin,d);null===n.left?(n.left=p.RopesNodes.leaf(this.getBlock(y),y.begin,b.length),a.push(new f.TextInsert(l,b))):Array.prototype.push.apply(a,this.addBlockFromRec(b,y,n.left,l)),b=e.substr(d+1-t.begin,e.length);var v=r.Identifier.fromBase(t.idBegin,d+1);y=new o.IdentifierInterval(v,t.end),l=l+n.leftSubtreeSize()+n.length,null===n.right?(n.right=p.RopesNodes.leaf(this.getBlock(y),y.begin,b.length),a.push(new f.TextInsert(l,b))):Array.prototype.push.apply(a,this.addBlockFromRec(b,y,n.right,l)),u=!1;break;case 4:if(null!==n.left){var m=n.getIdBegin().minOffsetAfterPrev(n.left.getIdEnd(),t.begin);(S=e.substr(m-t.begin,e.length)).length>0&&(n.appendBegin(S.length),a.push(new f.TextInsert(l+n.leftSubtreeSize(),S)),this.ascendentUpdate(s,S.length)),m-1>=t.begin?(e=e.substr(0,m-t.begin),t=new o.IdentifierInterval(t.idBegin,m-1),n=n.left):u=!1}else a.push(new f.TextInsert(l,e)),n.appendBegin(e.length),this.ascendentUpdate(s,e.length),u=!1;break;case 5:if(null!==n.right){m=n.getIdEnd().maxOffsetBeforeNext(n.right.getIdBegin(),t.end);var S=e.substr(0,m+1-t.begin);if(l=l+n.leftSubtreeSize()+n.length,S.length>0&&(n.appendEnd(S.length),a.push(new f.TextInsert(l,S)),this.ascendentUpdate(s,S.length)),t.end>=m+1){e=e.substr(m+1-t.begin,e.length);v=r.Identifier.fromBase(t.idBegin,m+1);t=new o.IdentifierInterval(v,t.end),n=n.right,l+=S.length}else u=!1}else l=l+n.leftSubtreeSize()+n.length,a.push(new f.TextInsert(l,e)),n.appendEnd(e.length),this.ascendentUpdate(s,e.length),u=!1;break;case 6:u=!1}return this.balance(s),a},e.prototype.applyTextInsert=function(e){this.str=d.insert(this.str,e.offset,e.content)},e.prototype.applyTextDelete=function(e){var t=e.offset+e.length-1;this.str=d.del(this.str,e.offset,t)},e.prototype.addBlock=function(e,t){var n=new o.IdentifierInterval(t,t.lastOffset+e.length-1);if(null===this.root){var r=new u.LogootSBlock(n,0);this.mapBaseToBlock[r.idInterval.base.join(",")]=r,this.root=p.RopesNodes.leaf(r,t.lastOffset,e.length);var i=new f.TextInsert(0,e);return this.applyTextInsert(i),[i]}return this.addBlockFrom(e,n,this.root,0)},e.prototype.mkNode=function(e,t,n){console.assert(s.isInt32(n)&&n>0,"length ∈ int32"),console.assert(n>0,"length > 0");var r=i.createBetweenPosition(e,t,this.replicaNumber,this.clock++),c=new o.IdentifierInterval(r,n-1),a=new u.LogootSBlock(c,0);return this.mapBaseToBlock[c.base.join(",")]=a,p.RopesNodes.leaf(a,0,n)},e.prototype.insertLocal=function(e,t){if(console.assert(s.isInt32(e),"pos ∈ int32"),null===this.root)return this.root=this.mkNode(null,null,t.length),this.str=d.insert(this.str,e,t),new a.LogootSAdd(this.root.getIdBegin(),t);var n=void 0,r=this.str.length;this.str=d.insert(this.str,e,t);var o=void 0;if(0===e){if((o=[]).push(this.root),(c=this.getXest(g,o)).isAppendableBefore(this.replicaNumber,t.length)){var i=c.appendBegin(t.length);return this.ascendentUpdate(o,t.length),new a.LogootSAdd(i,t)}n=this.mkNode(null,c.getIdBegin(),t.length),c.left=n}else if(e>=r){var c;if((o=[]).push(this.root),(c=this.getXest(b,o)).isAppendableAfter(this.replicaNumber,t.length)){var u=c.appendEnd(t.length);return this.ascendentUpdate(o,t.length),new a.LogootSAdd(u,t)}n=this.mkNode(c.getIdEnd(),null,t.length),c.right=n}else{var l=this.searchNode(e);if(l.i>0){var p=l.node.block.idInterval.getBaseId(l.node.actualBegin+l.i-1),h=l.node.block.idInterval.getBaseId(l.node.actualBegin+l.i);n=this.mkNode(p,h,t.length),(o=l.path).push(l.node.split(l.i,n))}else{var f=this.searchNode(e-1);if(l.node.isAppendableBefore(this.replicaNumber,t.length)){var y=l.node.appendBegin(t.length);return this.ascendentUpdate(l.path,t.length),new a.LogootSAdd(y,t)}if(f.node.isAppendableAfter(this.replicaNumber,t.length)){var v=f.node.appendEnd(t.length);return this.ascendentUpdate(f.path,t.length),new a.LogootSAdd(v,t)}(n=this.mkNode(f.node.getIdEnd(),l.node.getIdBegin(),t.length)).right=f.node.right,f.node.right=n,(o=f.path).push(n)}}return this.balance(o),new a.LogootSAdd(n.getIdBegin(),t)},e.prototype.getXest=function(e,t){for(var n=t[t.length-1],r=e(n);null!==r;)n=r,t[t.length]=r,r=e(r);return n},e.prototype.searchPos=function(e,t){for(var n=0,r=this.root;null!==r;)if(t.push(r),-1===e.compareTo(r.getIdBegin()))r=r.left;else if(1===e.compareTo(r.getIdEnd()))n=n+r.leftSubtreeSize()+r.length,r=r.right;else{if(e.equalsBase(r.getIdBegin()))return n+r.leftSubtreeSize();r=null}return-1},e.prototype.searchNode=function(e){console.assert(s.isInt32(e),"pos ∈ int32");for(var t=this.root,n=[];null!==t;){n.push(t);var r=t.leftSubtreeSize();if(e<r)t=t.left;else{if(e<r+t.length)return{i:e-r,node:t,path:n};e-=r+t.length,t=t.right}}return null},e.prototype.ascendentUpdate=function(e,t){console.assert(s.isInt32(t),"length ∈ int32");for(var n=0,r=e;n<r.length;n++){r[n].addString(t)}},e.prototype.delBlock=function(e){for(var t,n=this,i=[];;){var s=[];if(-1===(t=this.searchPos(e.idBegin,s))){if(!(e.begin<e.end))break;var c=r.Identifier.fromBase(e.idBegin,e.begin+1);e=new o.IdentifierInterval(c,e.end)}else{var a=s[s.length-1],u=Math.min(e.end,a.actualEnd),l=t+e.begin-a.actualBegin,p=u-e.begin+1;i.push(new h.TextDelete(l,p));var f=a.deleteOffsets(e.begin,u);if(0===a.length?this.delNode(s):null!==f?(s.push(f),this.balance(s)):this.ascendentUpdate(s,e.begin-u-1),u===e.end)break;c=r.Identifier.fromBase(e.idBegin,u);e=new o.IdentifierInterval(c,e.end)}}return i.forEach(function(e){n.applyTextDelete(e)}),i},e.prototype.delLocal=function(e,t){console.assert(s.isInt32(e),"begin ∈ int32"),console.assert(s.isInt32(t),"end ∈ int32"),console.assert(e<=t,""+e," <= "+t),this.str=d.del(this.str,e,t);var n=t-e+1,i=[];do{var c=this.searchNode(e);if(null!==c){var a=c.node.actualBegin+c.i,u=Math.min(a+n-1,c.node.actualEnd),p=c.node.getIdBegin(),h=r.Identifier.fromBase(p,a);i.push(new o.IdentifierInterval(h,u));var f=c.node.deleteOffsets(a,u);n-=u-a+1,0===c.node.length?this.delNode(c.path):null!==f?(c.path.push(f),this.balance(c.path)):this.ascendentUpdate(c.path,a-u-1)}else n=0}while(n>0);return new l.LogootSDel(i)},e.prototype.delNode=function(e){var t=e[e.length-1];if(0===t.block.nbElement&&delete this.mapBaseToBlock[t.block.idInterval.base.join(",")],null===t.right)t===this.root?this.root=t.left:(e.pop(),e[e.length-1].replaceChildren(t,t.left));else if(null===t.left)t===this.root?this.root=t.right:(e.pop(),e[e.length-1].replaceChildren(t,t.right));else{e.push(t.right);var n=this.getMinPath(e);t.become(n),e.pop(),e[e.length-1].replaceChildren(n,n.right)}this.balance(e)},e.prototype.getMinPath=function(e){console.assert(0!==e.length,"path has at least one item");for(var t=e[e.length-1];null!==t.left;)t=t.left,e.push(t);return t},e.prototype.balance=function(e){for(;e.length>0;){var t=e.pop(),n=0===e.length?null:e[e.length-1];t.sumDirectChildren();for(var r=t.balanceScore();Math.abs(r)>=2;)n=r>=2?null!==t.right&&t.right.balanceScore()<=-1?this.rotateRL(t,n):this.rotateLeft(t,n):null!==t.left&&t.left.balanceScore()>=1?this.rotateLR(t,n):this.rotateRight(t,n),e.push(n),r=t.balanceScore()}},e.prototype.rotateLeft=function(e,t){console.assert(null!==e.right,"There exists a right node"),console.assert(e===this.root==(null===t),"The father is null when we are rotating left the root");var n=e.right;return e===this.root?this.root=n:t.replaceChildren(e,n),e.right=n.left,n.left=e,e.sumDirectChildren(),n.sumDirectChildren(),n},e.prototype.rotateRight=function(e,t){console.assert(null!==e.left,"There exists a left node"),console.assert(e===this.root==(null===t),"The father is null when we are rotating right the root");var n=e.left;return e===this.root?this.root=n:t.replaceChildren(e,n),e.left=n.right,n.right=e,e.sumDirectChildren(),n.sumDirectChildren(),n},e.prototype.rotateRL=function(e,t){console.assert(null!==e.right,"There exists a right node");var n=e.right;return console.assert(null!==n.left,"There exists a left node of the right node"),this.rotateRight(n,e),this.rotateLeft(e,t)},e.prototype.rotateLR=function(e,t){console.assert(null!==e.left,"There exists a left node");var n=e.left;return console.assert(null!==n.right,"There exists a right node of the left node"),this.rotateLeft(n,e),this.rotateRight(e,t)},e.prototype.getNext=function(e){var t=e[e.length-1];if(null===t.right){if(e.length>1)if(e[e.length-2].left===t)return e.pop(),!0;return!1}return e.push(t.right),this.getXest(g,e),!0},e.prototype.digest=function(){var e=0,t=this.root;if(null!==t)for(var n=0,r=t.toList();n<r.length;n++){e=17*e+r[n].digest()|0}return e},e}();t.LogootSRopes=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDot=function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.replicaNumber&&Number.isInteger(e.replicaNumber)&&"number"==typeof e.clock&&Number.isInteger(e.clock)}},function(e,t){e.exports=require("core-js/es7/global")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),o=n(0),i=n(1),s=n(9),c=n(28),a=n(26),u=12e4;s.setLogLevel(s.LogLevel.DEBUG,s.LogLevel.CHANNEL);class l{constructor(e,t,n,i){this.pseudonym=e,this.login=t,this.savedLogins=[],this.wg=n,this.key=n.key,this.crypto=new c.SymmetricCrypto,this.mongooseAdapter=i,this.joinSubject=new o.ReplaySubject,this.messageSubject=new o.ReplaySubject,this.peerJoinSubject=new o.ReplaySubject,this.peerLeaveSubject=new o.ReplaySubject,this.saveInterval=setInterval(()=>{this.mongoDoc&&this.save()},u),this.mongooseAdapter.find(this.key).then(e=>e||this.mongooseAdapter.create(this.key)).then(e=>{this.mongoDoc=e,this.operations=e.get("operations").map(e=>r.RichLogootSOperation.fromPlain(e))}).then(()=>this.crypto.importKey(this.key)).then(()=>{this.muteCore=this.createMuteCore(this.key,this.operations),this.muteCore.collaboratorsService.joinSource=this.peerJoinSubject,this.muteCore.collaboratorsService.leaveSource=this.peerLeaveSubject,this.muteCore.messageSource=this.messageSubject,this.mergeSavedLogins()}).catch(e=>{log.error(`Error when searching for the document ${this.key}`,e)}),n.onMessage=((e,t)=>{const n=a.Message.decode(t);423===n.service?this.crypto.decrypt(n.content).then(t=>{this.messageSubject.next(new r.NetworkMessage(n.service,e,!0,t))}):this.messageSubject.next(new r.NetworkMessage(n.service,e,!0,n.content))}),n.onStateChange=(e=>{e===s.WebGroupState.JOINED?this.joinSubject.next(new r.JoinEvent(this.wg.myId,this.key,!1)):e===s.WebGroupState.LEFT&&(this.save(),global.clearInterval(this.saveInterval))}),n.onMemberJoin=(e=>this.peerJoinSubject.next(e)),n.onMemberLeave=(e=>this.peerLeaveSubject.next(e))}save(){this.mongoDoc&&this.lastReceivedState&&this.lastReceivedState!==this.lastSaveState&&(log.info("Saving document: "+this.key),this.mongoDoc.set({operations:this.lastReceivedState.richLogootSOps}),this.mongoDoc.save().catch(e=>log.error("Could not save the document "+this.key,e)),this.lastSaveState=this.lastReceivedState)}updateLogins(e){if(e&&"anonymous"!==e)if(this.mongoDoc){const t=this.mongoDoc.get("logins");t.push(e),this.mongoDoc.set({logins:t}),this.mongoDoc.save()}else this.savedLogins.push(e)}mergeSavedLogins(){this.mongoDoc&&0!==this.savedLogins.length&&(this.mongoDoc.set({logins:this.mongoDoc.get("logins").concat(this.savedLogins)}),this.mongoDoc.save(),this.savedLogins=[])}createMuteCore(e,t){const n=new r.MuteCore({displayName:this.pseudonym,login:this.login});return o.merge(n.collaboratorsService.onMsgToBroadcast,n.syncMessageService.onMsgToBroadcast.pipe(i.flatMap(e=>this.crypto.encrypt(e.content).then(t=>Object.assign({},e,{content:t}))))).subscribe(e=>this.wg.send(this.encode(e))),o.merge(n.collaboratorsService.onMsgToSendRandomly,n.syncMessageService.onMsgToSendRandomly.pipe(i.flatMap(e=>this.crypto.encrypt(e.content).then(t=>Object.assign({},e,{content:t}))))).subscribe(e=>{const t=this.wg.members.filter(e=>e!==this.wg.myId),n=Math.ceil(Math.random()*t.length)-1;this.wg.sendTo(t[n],this.encode(e))}),o.merge(n.collaboratorsService.onMsgToSendTo,n.syncMessageService.onMsgToSendTo.pipe(i.flatMap(e=>this.crypto.encrypt(e.content).then(t=>Object.assign({},e,{content:t}))))).subscribe(e=>this.wg.sendTo(e.id,this.encode(e))),n.collaboratorsService.onUpdate.subscribe(e=>{this.updateLogins(e.login)}),n.syncService.onState.subscribe(e=>this.lastReceivedState=e),n.init(e),n.syncService.setJoinAndStateSources(this.joinSubject.asObservable(),o.from([new r.State(new Map,t)])),n}encode(e){return a.Message.encode(a.Message.create(e)).finish()}}l.ID=9137,t.BotStorage=l},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("text-encoding")},function(e,t,n){"use strict";try{var r=n(!function(){var e=new Error("Cannot find module 'wrtc'");throw e.code="MODULE_NOT_FOUND",e}());global.RTCPeerConnection=r.RTCPeerConnection,global.RTCDataChannel=r.RTCDataChannel,global.RTCIceCandidate=r.RTCIceCandidate}catch(e){console.warn(e.message)}global.WebSocket=n(17);var o=n(36);global.TextEncoder=o.TextEncoder,global.TextDecoder=o.TextDecoder,global.cryptoNode=n(16)},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("kcors")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("commander")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(43),o=n(42),i=n(41),s=n(40),c=n(39),a=n(38),u=n(9),l=n(34),p=n(25),h=n(23),f="Repono",d="0.0.0.0",g=2e4,b="ws://localhost:20000",y="ws://localhost:8010",v="mutedocs",m=!1,S="info",w="";r.option("-h, --host <ip or host name>","Host address to bind to.",d).option("-p, --port <number>","Port to use for the server.",g).option("-b, --botURL <number>","Bot public URL.",b).option("-s, --signalingURL <url>","Signaling server url.",y).option("","\n").option("--cors","Enable Cross-origin Resource Sharing.",m).option("-n, --name <bot name>","Bot name.",f).option("-d, --database <name>","Database name.",v).option("","\n").option("--key <file path>","Private key for the certificate").option("--cert <file path>","The server certificate").option("--ca <file path>","The additional intermediate certificate or certificates that web browsers will need in order to validate the server certificate.").option("","\n").option("-l, --logLevel <none|trace|debug|info|warn|error|fatal>","Logging level.",/^(none|trace|debug|info|warn|error|fatal)$/i,S).option("-f, --logFolder <path>","Path to where log files would be stored.\n                              If not specified stdout will used.",w).parse(process.argv);const{name:I,host:O,port:j,botURL:k,signalingURL:M,database:T,cors:E,key:P,cert:L,ca:R,logLevel:N,logFolder:B}=r;global.log=p.createLogger(B,N),"none"!==N&&u.setLogLevel(u.LogLevel.DEBUG),n(21),process.on("uncaughtException",e=>{console.error("uncaughtException -> #####################",e)});const C=new h.MongooseAdapter;C.connect("localhost",T).then(()=>{log.info("Connected to the database  ✓");let e=new s;const t=new a;return t.get("/name",e=>{e.body=I}).get("/docs/:login",async e=>{await C.findKeysByLogin(e.params.login).then(t=>e.body=t).catch(t=>{log.error("Could not retreive the document list stored in database",t),e.status=500})}).post("/remove",e=>{C.removeLogin(e.request.body.key,e.request.body.login),e.body=!0}),E&&(e=e.use(i())),e.use(c()).use(t.routes()).use(t.allowedMethods())}).then(e=>{if(log.info("Configured routes  ✓"),P&&L&&R){const t=n(20);return n(19).createServer({key:t.readFileSync(P),cert:t.readFileSync(L),ca:t.readFileSync(R)},e.callback())}return o.createServer(e.callback())}).then(e=>{return log.info("Configured server  ✓"),e.on("clientError",e=>{log.error("Client Error",e)}),new u.Bot({url:k,server:e,leaveOnceAlone:!1,webGroupOptions:{signalingServer:M}}).onWebGroup=(e=>{const t=new l.BotStorage(I,function(e){let t;t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0];return t=(t=t.split(":")[0]).split("?")[0]}(k),e,C);log.info("New peer to peer network invitation received for ",t.key)}),new Promise(t=>e.listen(j,O,t))}).then(()=>{log.info(`Successfully started the storage bot server at ${O}:${j} with the following settings`,{name:I,host:O,port:j,botURL:k,signalingURL:M,logLevel:N,logFolder:B})}).catch(e=>{log.fatal(e)})}]);