!function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=12)}([function(t,e){t.exports=require("@coast-team/mute-crypto-helper")},function(t,e){t.exports=require("rxjs")},function(t,e){t.exports=require("rxjs/operators")},function(t,e){t.exports=require("uws")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const r=n(21);e.createLogger=function(t,n){const i={name:"mute-bot-storage"};switch(""!==t&&(i.streams=[{type:"rotating-file",period:"1d",count:3,path:`${t}/${i.name}.log`}]),e.log=r.createLogger(i),n){case"none":e.log.level(r.FATAL+1);break;case"trace":e.log.level(r.TRACE);break;case"debug":e.log.level(r.DEBUG);break;case"info":e.log.level(r.INFO);break;case"warn":e.log.level(r.WARN);break;case"error":e.log.level(r.ERROR);break;case"fatal":e.log.level(r.FATAL);break;default:e.log.level(r.INFO)}}},function(t,e){t.exports=require("crypto")},function(t,e){t.exports=require("text-encoding")},function(t,e,n){"use strict";n.r(e),n.d(e,"Bot",function(){return Le}),n.d(e,"LogLevel",function(){return v}),n.d(e,"setLogLevel",function(){return j}),n.d(e,"Topology",function(){return G}),n.d(e,"SignalingState",function(){return $t}),n.d(e,"WebGroupState",function(){return he}),n.d(e,"WebGroup",function(){return Me});var r=n(5),i=n(6),o=n(3),s=n(1),c=n(2),a=n(10),u={};u.WebSocket=o,u.TextEncoder=i.TextEncoder,u.TextDecoder=i.TextDecoder,u.cryptoNode=r;
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function h(t,e){function n(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var f=function(){return(f=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function p(t,e,n,r){return new(n||(n=Promise))(function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(s,c)}a((r=r.apply(t,e||[])).next())})}function d(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}function y(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function b(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function g(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(b(arguments[e]));return t}var v,m="background-color: #FFCA28; padding: 0 3px",w="background-color: #b3ba2e; padding: 0 3px",S="background-color: #CE93D8; padding: 0 3px",I="background-color: #90CAF9; padding: 0 3px",O="background-color: #26A69A; padding: 0 3px",x="background-color: #66BB6A; padding: 0 3px",_="background-color: #F57C00; padding: 0 3px",E="background-color: #9FA8DA; padding: 0 2px",k="background-color: #EF9A9A; padding: 0 2px",T="background-color: #FF5252; padding: 0 2px",C={webgroup:function(){},signalingState:function(){},webGroupState:function(){},webrtc:function(){},channel:function(){},topology:function(){},signaling:function(){},channelBuilder:function(){},debug:function(){},warn:function(){}};!function(t){t[t.DEBUG=0]="DEBUG",t[t.WEB_GROUP=1]="WEB_GROUP",t[t.WEBRTC=2]="WEBRTC",t[t.CHANNEL=3]="CHANNEL",t[t.TOPOLOGY=4]="TOPOLOGY",t[t.SIGNALING=5]="SIGNALING",t[t.CHANNEL_BUILDER=6]="CHANNEL_BUILDER"}(v||(v={}));var M=[];function j(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];(M=t).includes(v.WEB_GROUP)?(C.webgroup=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX WebGroup%c: "+t,m,""):console.info.apply(console,g(["%cNETFLUX WebGroup%c: "+t,m,""],e))},C.signalingState=function(t,e){console.info("%cNETFLUX "+e+" WebGroup%c: Signaling: %c"+t+"%c",m,"",E,"")},C.webGroupState=function(t,e){console.info("%cNETFLUX "+e+" WebGroup%c: WebGroup: %c"+t+"%c",m,"",k,"")}):(C.webgroup=function(){},C.signalingState=function(){},C.webGroupState=function(){}),M.includes(v.WEBRTC)?C.webrtc=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX WebRTC%c: "+t,S,""):console.info.apply(console,g(["%cNETFLUX WebRTC%c: "+t,S,""],e))}:C.webrtc=function(){},M.includes(v.CHANNEL)?C.channel=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX Channel%c: "+t,I,""):console.info.apply(console,g(["%cNETFLUX Channel%c: "+t,I,""],e))}:C.channel=function(){},M.includes(v.TOPOLOGY)?C.topology=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX Topology%c: "+t,O,""):console.info.apply(console,g(["%cNETFLUX Topology%c: "+t,O,""],e))}:C.topology=function(){},M.includes(v.SIGNALING)?C.signaling=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX Signaling%c: "+t,x,""):console.info.apply(console,g(["%cNETFLUX Signaling%c: "+t,x,""],e))}:C.signaling=function(){},M.includes(v.CHANNEL_BUILDER)?C.channelBuilder=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX ChannelBuilder%c: "+t,_,""):console.info.apply(console,g(["%cNETFLUX ChannelBuilder%c: "+t,_,""],e))}:C.channelBuilder=function(){},M.includes(v.DEBUG)?C.debug=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX Debug%c: "+t,w,""):console.info.apply(console,g(["%cNETFLUX Debug%c: "+t,w,""],e))}:C.debug=function(){},C.warn=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];0===e.length?console.info("%cNETFLUX WARNING%c: "+t,T,""):console.info.apply(console,g(["%cNETFLUX WARNING%c: "+t,T,""],e))}}var N=2147483648,A="undefined"!=typeof window;function L(){return!A||navigator.onLine}function P(){return!A||"visible"===document.visibilityState}function B(t){if(!new RegExp(/^(wss|ws):\/\/((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])|(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]))(:[0-9]{1,5})?(\/.*)?$/,"i").test(t))throw new Error("Invalid URL: "+t)}function R(t){void 0===t&&(t=[]);var e=F()[0];return e<N&&(e+=N),t.includes(e)?R(t):e}var D=512;function U(t){return t.split("/")[2]}function F(t){var e;if(void 0===t&&(t=1),A)e=new Uint32Array(t),u.crypto.getRandomValues(e);else{e=[];for(var n=u.cryptoNode.randomBytes(4*t),r=0;r<n.length;r+=4)e[e.length]=n.readUInt32BE(r,!0)}return e}function z(){return!!u.WebSocket}var G,V,W=function(){function t(t,e){this.serviceId=t,this.proto=e}return t.prototype.useWebChannelStream=function(t){var e=this;return{id:t.STREAM_ID,message:t.messageFromStream.pipe(Object(c.filter)(function(t){return t.serviceId===e.serviceId}),Object(c.map)(function(t){var n=t.channel,r=t.senderId,i=t.recipientId,o=t.content;return{channel:n,senderId:r,recipientId:i,msg:e.decode(o)}}),Object(c.filter)(function(t){var e=t.msg;return e&&e.type})),send:function(n,r){t.sendOverStream({senderId:t.myId,recipientId:r,serviceId:e.serviceId,content:n instanceof Uint8Array?n:e.encode(n)})}}},t.prototype.useSignalingStream=function(t){var e=this;return{id:t.STREAM_ID,message:t.messageFromStream.pipe(Object(c.filter)(function(t){return t.serviceId===e.serviceId}),Object(c.map)(function(t){var n=t.senderId,r=t.recipientId,i=t.content;return{senderId:n,recipientId:r,msg:e.decode(i)}}),Object(c.filter)(function(t){var e=t.msg;return e&&e.type})),send:function(n,r,i){t.sendOverStream({senderId:i,recipientId:r,serviceId:e.serviceId,content:n instanceof Uint8Array?n:e.encode(n)})}}},t.prototype.useAllStreams=function(t,e){var n=this.useWebChannelStream(t),r=this.useSignalingStream(e);return{message:Object(s.merge)(n.message.pipe(Object(c.map)(function(t){var e=t.senderId,r=t.recipientId,i=t.msg;return{streamId:n.id,senderId:e,recipientId:r,msg:i}})),r.message.pipe(Object(c.map)(function(t){var e=t.senderId,n=t.recipientId,i=t.msg;return{streamId:r.id,senderId:e,recipientId:n,msg:i}}))),sendOver:function(t,e,i,o){t===n.id?n.send(e,i):r.send(e,i,o)}}},t.prototype.encode=function(t){return this.proto.encode(this.proto.create(t)).finish()},t.prototype.decode=function(t){try{return this.proto.decode(t)}catch(t){C.warn("Decode service message error: ",t)}return{type:void 0}},t}();!function(t){t[t.FULL_MESH=0]="FULL_MESH"}(G||(G={})),function(t){t[t.CONSTRUCTING=0]="CONSTRUCTING",t[t.CONSTRUCTED=1]="CONSTRUCTED",t[t.IDLE=2]="IDLE"}(V||(V={}));var $=function(t){function e(e,n,r){var i=t.call(this,n,r)||this;return i.wc=e,i.wcStream=t.prototype.useWebChannelStream.call(i,e),i.stateSubject=new s.Subject,i._state=V.IDLE,i}return h(e,t),Object.defineProperty(e.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),e.prototype.setJoinedState=function(){this.setState(V.CONSTRUCTED)},e.prototype.setState=function(t){this.state!==t&&(C.topology("Topology state = "+V[t]),this._state=t,this.stateSubject.next(t))},e}(W),q="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function H(t,e){return t(e={exports:{}},e.exports),e.exports}var K=function(t,e){var n=new Array(arguments.length-1),r=0,i=2,o=!0;for(;i<arguments.length;)n[r++]=arguments[i++];return new Promise(function(i,s){n[r]=function(t){if(o)if(o=!1,t)s(t);else{for(var e=new Array(arguments.length-1),n=0;n<e.length;)e[n++]=arguments[n];i.apply(null,e)}};try{t.apply(e||null,n)}catch(t){o&&(o=!1,s(t))}})};var J=H(function(t,e){var n=e;n.length=function(t){var e=t.length;if(!e)return 0;for(var n=0;--e%4>1&&"="===t.charAt(e);)++n;return Math.ceil(3*t.length)/4-n};for(var r=new Array(64),i=new Array(123),o=0;o<64;)i[r[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;n.encode=function(t,e,n){for(var i,o=null,s=[],c=0,a=0;e<n;){var u=t[e++];switch(a){case 0:s[c++]=r[u>>2],i=(3&u)<<4,a=1;break;case 1:s[c++]=r[i|u>>4],i=(15&u)<<2,a=2;break;case 2:s[c++]=r[i|u>>6],s[c++]=r[63&u],a=0}c>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,s)),c=0)}return a&&(s[c++]=r[i],s[c++]=61,1===a&&(s[c++]=61)),o?(c&&o.push(String.fromCharCode.apply(String,s.slice(0,c))),o.join("")):String.fromCharCode.apply(String,s.slice(0,c))};n.decode=function(t,e,n){for(var r,o=n,s=0,c=0;c<t.length;){var a=t.charCodeAt(c++);if(61===a&&s>1)break;if(void 0===(a=i[a]))throw Error("invalid encoding");switch(s){case 0:r=a,s=1;break;case 1:e[n++]=r<<2|(48&a)>>4,r=a,s=2;break;case 2:e[n++]=(15&r)<<4|(60&a)>>2,r=a,s=3;break;case 3:e[n++]=(3&r)<<6|a,s=0}}if(1===s)throw Error("invalid encoding");return n-o},n.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}}),X=Z;function Z(){this._listeners={}}Z.prototype.on=function(t,e,n){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:n||this}),this},Z.prototype.off=function(t,e){if(void 0===t)this._listeners={};else if(void 0===e)this._listeners[t]=[];else for(var n=this._listeners[t],r=0;r<n.length;)n[r].fn===e?n.splice(r,1):++r;return this},Z.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var n=[],r=1;r<arguments.length;)n.push(arguments[r++]);for(r=0;r<e.length;)e[r].fn.apply(e[r++].ctx,n)}return this};var Y=Q(Q);function Q(t){return"undefined"!=typeof Float32Array?function(){var e=new Float32Array([-0]),n=new Uint8Array(e.buffer),r=128===n[3];function i(t,r,i){e[0]=t,r[i]=n[0],r[i+1]=n[1],r[i+2]=n[2],r[i+3]=n[3]}function o(t,r,i){e[0]=t,r[i]=n[3],r[i+1]=n[2],r[i+2]=n[1],r[i+3]=n[0]}function s(t,r){return n[0]=t[r],n[1]=t[r+1],n[2]=t[r+2],n[3]=t[r+3],e[0]}function c(t,r){return n[3]=t[r],n[2]=t[r+1],n[1]=t[r+2],n[0]=t[r+3],e[0]}t.writeFloatLE=r?i:o,t.writeFloatBE=r?o:i,t.readFloatLE=r?s:c,t.readFloatBE=r?c:s}():function(){function e(t,e,n,r){var i=e<0?1:0;if(i&&(e=-e),0===e)t(1/e>0?0:2147483648,n,r);else if(isNaN(e))t(2143289344,n,r);else if(e>3.4028234663852886e38)t((i<<31|2139095040)>>>0,n,r);else if(e<1.1754943508222875e-38)t((i<<31|Math.round(e/1.401298464324817e-45))>>>0,n,r);else{var o=Math.floor(Math.log(e)/Math.LN2);t((i<<31|o+127<<23|8388607&Math.round(e*Math.pow(2,-o)*8388608))>>>0,n,r)}}function n(t,e,n){var r=t(e,n),i=2*(r>>31)+1,o=r>>>23&255,s=8388607&r;return 255===o?s?NaN:i*(1/0):0===o?1.401298464324817e-45*i*s:i*Math.pow(2,o-150)*(s+8388608)}t.writeFloatLE=e.bind(null,tt),t.writeFloatBE=e.bind(null,et),t.readFloatLE=n.bind(null,nt),t.readFloatBE=n.bind(null,rt)}(),"undefined"!=typeof Float64Array?function(){var e=new Float64Array([-0]),n=new Uint8Array(e.buffer),r=128===n[7];function i(t,r,i){e[0]=t,r[i]=n[0],r[i+1]=n[1],r[i+2]=n[2],r[i+3]=n[3],r[i+4]=n[4],r[i+5]=n[5],r[i+6]=n[6],r[i+7]=n[7]}function o(t,r,i){e[0]=t,r[i]=n[7],r[i+1]=n[6],r[i+2]=n[5],r[i+3]=n[4],r[i+4]=n[3],r[i+5]=n[2],r[i+6]=n[1],r[i+7]=n[0]}function s(t,r){return n[0]=t[r],n[1]=t[r+1],n[2]=t[r+2],n[3]=t[r+3],n[4]=t[r+4],n[5]=t[r+5],n[6]=t[r+6],n[7]=t[r+7],e[0]}function c(t,r){return n[7]=t[r],n[6]=t[r+1],n[5]=t[r+2],n[4]=t[r+3],n[3]=t[r+4],n[2]=t[r+5],n[1]=t[r+6],n[0]=t[r+7],e[0]}t.writeDoubleLE=r?i:o,t.writeDoubleBE=r?o:i,t.readDoubleLE=r?s:c,t.readDoubleBE=r?c:s}():function(){function e(t,e,n,r,i,o){var s=r<0?1:0;if(s&&(r=-r),0===r)t(0,i,o+e),t(1/r>0?0:2147483648,i,o+n);else if(isNaN(r))t(0,i,o+e),t(2146959360,i,o+n);else if(r>1.7976931348623157e308)t(0,i,o+e),t((s<<31|2146435072)>>>0,i,o+n);else{var c;if(r<2.2250738585072014e-308)t((c=r/5e-324)>>>0,i,o+e),t((s<<31|c/4294967296)>>>0,i,o+n);else{var a=Math.floor(Math.log(r)/Math.LN2);1024===a&&(a=1023),t(4503599627370496*(c=r*Math.pow(2,-a))>>>0,i,o+e),t((s<<31|a+1023<<20|1048576*c&1048575)>>>0,i,o+n)}}}function n(t,e,n,r,i){var o=t(r,i+e),s=t(r,i+n),c=2*(s>>31)+1,a=s>>>20&2047,u=4294967296*(1048575&s)+o;return 2047===a?u?NaN:c*(1/0):0===a?5e-324*c*u:c*Math.pow(2,a-1075)*(u+4503599627370496)}t.writeDoubleLE=e.bind(null,tt,0,4),t.writeDoubleBE=e.bind(null,et,4,0),t.readDoubleLE=n.bind(null,nt,0,4),t.readDoubleBE=n.bind(null,rt,4,0)}(),t}function tt(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}function et(t,e,n){e[n]=t>>>24,e[n+1]=t>>>16&255,e[n+2]=t>>>8&255,e[n+3]=255&t}function nt(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function rt(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}var it=function(t){return null};var ot=H(function(t,e){var n=e;n.length=function(t){for(var e=0,n=0,r=0;r<t.length;++r)(n=t.charCodeAt(r))<128?e+=1:n<2048?e+=2:55296==(64512&n)&&56320==(64512&t.charCodeAt(r+1))?(++r,e+=4):e+=3;return e},n.read=function(t,e,n){if(n-e<1)return"";for(var r,i=null,o=[],s=0;e<n;)(r=t[e++])<128?o[s++]=r:r>191&&r<224?o[s++]=(31&r)<<6|63&t[e++]:r>239&&r<365?(r=((7&r)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,o[s++]=55296+(r>>10),o[s++]=56320+(1023&r)):o[s++]=(15&r)<<12|(63&t[e++])<<6|63&t[e++],s>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),s=0);return i?(s&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))},n.write=function(t,e,n){for(var r,i,o=n,s=0;s<t.length;++s)(r=t.charCodeAt(s))<128?e[n++]=r:r<2048?(e[n++]=r>>6|192,e[n++]=63&r|128):55296==(64512&r)&&56320==(64512&(i=t.charCodeAt(s+1)))?(r=65536+((1023&r)<<10)+(1023&i),++s,e[n++]=r>>18|240,e[n++]=r>>12&63|128,e[n++]=r>>6&63|128,e[n++]=63&r|128):(e[n++]=r>>12|224,e[n++]=r>>6&63|128,e[n++]=63&r|128);return n-o}}),st=function(t,e,n){var r=n||8192,i=r>>>1,o=null,s=r;return function(n){if(n<1||n>i)return t(n);s+n>r&&(o=t(r),s=0);var c=e.call(o,s,s+=n);return 7&s&&(s=1+(7|s)),c}};var ct=at;function at(t,e){this.lo=t>>>0,this.hi=e>>>0}var ut=at.zero=new at(0,0);ut.toNumber=function(){return 0},ut.zzEncode=ut.zzDecode=function(){return this},ut.length=function(){return 1};var lt=at.zeroHash="\0\0\0\0\0\0\0\0";at.fromNumber=function(t){if(0===t)return ut;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new at(n,r)},at.from=function(t){if("number"==typeof t)return at.fromNumber(t);if(pt.isString(t)){if(!pt.Long)return at.fromNumber(parseInt(t,10));t=pt.Long.fromString(t)}return t.low||t.high?new at(t.low>>>0,t.high>>>0):ut},at.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},at.prototype.toLong=function(t){return pt.Long?new pt.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var ht=String.prototype.charCodeAt;at.fromHash=function(t){return t===lt?ut:new at((ht.call(t,0)|ht.call(t,1)<<8|ht.call(t,2)<<16|ht.call(t,3)<<24)>>>0,(ht.call(t,4)|ht.call(t,5)<<8|ht.call(t,6)<<16|ht.call(t,7)<<24)>>>0)},at.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},at.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},at.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},at.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10};var ft,pt=H(function(t,e){var n=e;function r(t,e,n){for(var r=Object.keys(e),i=0;i<r.length;++i)void 0!==t[r[i]]&&n||(t[r[i]]=e[r[i]]);return t}function i(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(e.prototype=Object.create(Error.prototype)).constructor=e,Object.defineProperty(e.prototype,"name",{get:function(){return t}}),e.prototype.toString=function(){return this.name+": "+this.message},e}n.asPromise=K,n.base64=J,n.EventEmitter=X,n.float=Y,n.inquire=it,n.utf8=ot,n.pool=st,n.LongBits=ct,n.global="undefined"!=typeof window&&window||void 0!==q&&q||"undefined"!=typeof self&&self||q,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=Boolean(n.global.process&&n.global.process.versions&&n.global.process.versions.node),n.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},n.isString=function(t){return"string"==typeof t||t instanceof String},n.isObject=function(t){return t&&"object"==typeof t},n.isset=n.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},n.Buffer=function(){try{var t=n.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(t){return"number"==typeof t?n.Buffer?n._Buffer_allocUnsafe(t):new n.Array(t):n.Buffer?n._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=n.global.dcodeIO&&n.global.dcodeIO.Long||n.global.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(t){return t?n.LongBits.from(t).toHash():n.LongBits.zeroHash},n.longFromHash=function(t,e){var r=n.LongBits.fromHash(t);return n.Long?n.Long.fromBits(r.lo,r.hi,e):r.toNumber(Boolean(e))},n.merge=r,n.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},n.newError=i,n.ProtocolError=i("ProtocolError"),n.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},n.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var t=n.Buffer;t?(n._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},n._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):n._Buffer_from=n._Buffer_allocUnsafe=null}}),dt=wt,yt=pt.LongBits,bt=pt.base64,gt=pt.utf8;function vt(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function mt(){}function wt(){this.len=0,this.head=new vt(mt,0,0),this.tail=this.head,this.states=null}function St(t,e,n){e[n]=255&t}function It(t,e){this.len=t,this.next=void 0,this.val=e}function Ot(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function xt(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}wt.create=pt.Buffer?function(){return(wt.create=function(){return new ft})()}:function(){return new wt},wt.alloc=function(t){return new pt.Array(t)},pt.Array!==Array&&(wt.alloc=pt.pool(wt.alloc,pt.Array.prototype.subarray)),wt.prototype._push=function(t,e,n){return this.tail=this.tail.next=new vt(t,e,n),this.len+=e,this},It.prototype=Object.create(vt.prototype),It.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},wt.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new It((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},wt.prototype.int32=function(t){return t<0?this._push(Ot,10,yt.fromNumber(t)):this.uint32(t)},wt.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},wt.prototype.uint64=function(t){var e=yt.from(t);return this._push(Ot,e.length(),e)},wt.prototype.int64=wt.prototype.uint64,wt.prototype.sint64=function(t){var e=yt.from(t).zzEncode();return this._push(Ot,e.length(),e)},wt.prototype.bool=function(t){return this._push(St,1,t?1:0)},wt.prototype.fixed32=function(t){return this._push(xt,4,t>>>0)},wt.prototype.sfixed32=wt.prototype.fixed32,wt.prototype.fixed64=function(t){var e=yt.from(t);return this._push(xt,4,e.lo)._push(xt,4,e.hi)},wt.prototype.sfixed64=wt.prototype.fixed64,wt.prototype.float=function(t){return this._push(pt.float.writeFloatLE,4,t)},wt.prototype.double=function(t){return this._push(pt.float.writeDoubleLE,8,t)};var _t=pt.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};wt.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(St,1,0);if(pt.isString(t)){var n=wt.alloc(e=bt.length(t));bt.decode(t,n,0),t=n}return this.uint32(e)._push(_t,e,t)},wt.prototype.string=function(t){var e=gt.length(t);return e?this.uint32(e)._push(gt.write,e,t):this._push(St,1,0)},wt.prototype.fork=function(){return this.states=new function(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}(this),this.head=this.tail=new vt(mt,0,0),this.len=0,this},wt.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new vt(mt,0,0),this.len=0),this},wt.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},wt.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},wt._configure=function(t){ft=t};var Et=Tt;(Tt.prototype=Object.create(dt.prototype)).constructor=Tt;var kt=pt.Buffer;function Tt(){dt.call(this)}Tt.alloc=function(t){return(Tt.alloc=pt._Buffer_allocUnsafe)(t)};var Ct=kt&&kt.prototype instanceof Uint8Array&&"set"===kt.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]};function Mt(t,e,n){t.length<40?pt.utf8.write(t,e,n):e.utf8Write(t,n)}Tt.prototype.bytes=function(t){pt.isString(t)&&(t=pt._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(Ct,e,t),this},Tt.prototype.string=function(t){var e=kt.byteLength(t);return this.uint32(e),e&&this._push(Mt,e,t),this};var jt,Nt=Bt,At=pt.LongBits,Lt=pt.utf8;function Pt(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function Bt(t){this.buf=t,this.pos=0,this.len=t.length}var Rt="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new Bt(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new Bt(t);throw Error("illegal buffer")};function Dt(){var t=new At(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw Pt(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw Pt(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function Ut(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function Ft(){if(this.pos+8>this.len)throw Pt(this,8);return new At(Ut(this.buf,this.pos+=4),Ut(this.buf,this.pos+=4))}Bt.create=pt.Buffer?function(t){return(Bt.create=function(t){return pt.Buffer.isBuffer(t)?new jt(t):Rt(t)})(t)}:Rt,Bt.prototype._slice=pt.Array.prototype.subarray||pt.Array.prototype.slice,Bt.prototype.uint32=function(){var t=4294967295;return function(){if(t=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return t;if((this.pos+=5)>this.len)throw this.pos=this.len,Pt(this,10);return t}}(),Bt.prototype.int32=function(){return 0|this.uint32()},Bt.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},Bt.prototype.bool=function(){return 0!==this.uint32()},Bt.prototype.fixed32=function(){if(this.pos+4>this.len)throw Pt(this,4);return Ut(this.buf,this.pos+=4)},Bt.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Pt(this,4);return 0|Ut(this.buf,this.pos+=4)},Bt.prototype.float=function(){if(this.pos+4>this.len)throw Pt(this,4);var t=pt.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},Bt.prototype.double=function(){if(this.pos+8>this.len)throw Pt(this,4);var t=pt.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},Bt.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw Pt(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},Bt.prototype.string=function(){var t=this.bytes();return Lt.read(t,0,t.length)},Bt.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw Pt(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw Pt(this)}while(128&this.buf[this.pos++]);return this},Bt.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},Bt._configure=function(t){jt=t;var e=pt.Long?"toLong":"toNumber";pt.merge(Bt.prototype,{int64:function(){return Dt.call(this)[e](!1)},uint64:function(){return Dt.call(this)[e](!0)},sint64:function(){return Dt.call(this).zzDecode()[e](!1)},fixed64:function(){return Ft.call(this)[e](!0)},sfixed64:function(){return Ft.call(this)[e](!1)}})};var zt=Gt;function Gt(t){Nt.call(this,t)}(Gt.prototype=Object.create(Nt.prototype)).constructor=Gt,pt.Buffer&&(Gt.prototype._slice=pt.Buffer.prototype.slice),Gt.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len))};var Vt=Wt;function Wt(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");pt.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(Wt.prototype=Object.create(pt.EventEmitter.prototype)).constructor=Wt,Wt.prototype.rpcCall=function t(e,n,r,i,o){if(!i)throw TypeError("request must be specified");var s=this;if(!o)return pt.asPromise(t,s,e,n,r,i);if(s.rpcImpl)try{return s.rpcImpl(e,n[s.requestDelimited?"encodeDelimited":"encode"](i).finish(),function(t,n){if(t)return s.emit("error",t,e),o(t);if(null!==n){if(!(n instanceof r))try{n=r[s.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return s.emit("error",t,e),o(t)}return s.emit("data",n,e),o(null,n)}s.end(!0)})}catch(t){return s.emit("error",t,e),void setTimeout(function(){o(t)},0)}else setTimeout(function(){o(Error("already ended"))},0)},Wt.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};var $t,qt=H(function(t,e){e.Service=Vt}),Ht={},Kt=H(function(t,e){var n=e;function r(){n.Reader._configure(n.BufferReader),n.util._configure()}n.build="minimal",n.Writer=dt,n.BufferWriter=Et,n.Reader=Nt,n.BufferReader=zt,n.util=pt,n.rpc=qt,n.roots=Ht,n.configure=r,n.Writer._configure(n.BufferWriter),r()}),Jt=Kt.Reader,Xt=Kt.Writer,Zt=Kt.util,Yt=Kt.roots,Qt=Jt,te=Xt,ee=Zt,ne=Yt.default||(Yt.default={}),re=ne.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.senderId=0,t.prototype.recipientId=0,t.prototype.serviceId=0,t.prototype.content=ee.newBuffer([]),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.senderId&&t.hasOwnProperty("senderId")&&e.uint32(8).uint32(t.senderId),null!=t.recipientId&&t.hasOwnProperty("recipientId")&&e.uint32(16).uint32(t.recipientId),null!=t.serviceId&&t.hasOwnProperty("serviceId")&&e.uint32(24).uint32(t.serviceId),null!=t.content&&t.hasOwnProperty("content")&&e.uint32(34).bytes(t.content),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.senderId=t.uint32();break;case 2:r.recipientId=t.uint32();break;case 3:r.serviceId=t.uint32();break;case 4:r.content=t.bytes();break;default:t.skipType(7&i)}}return r},t}(),ie=ne.userMessage=function(){var t={};return t.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.length=0,t.prototype.type=0,t.prototype.full=ee.newBuffer([]),t.prototype.chunk=null,Object.defineProperty(t.prototype,"contentType",{get:ee.oneOfGetter(e=["full","chunk"]),set:ee.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.length&&t.hasOwnProperty("length")&&e.uint32(8).uint32(t.length),null!=t.type&&t.hasOwnProperty("type")&&e.uint32(16).int32(t.type),null!=t.full&&t.hasOwnProperty("full")&&e.uint32(26).bytes(t.full),null!=t.chunk&&t.hasOwnProperty("chunk")&&ne.userMessage.Message.Chunk.encode(t.chunk,e.uint32(34).fork()).ldelim(),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.userMessage.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.length=t.uint32();break;case 2:r.type=t.int32();break;case 3:r.full=t.bytes();break;case 4:r.chunk=ne.userMessage.Message.Chunk.decode(t,t.uint32());break;default:t.skipType(7&i)}}return r},t.Chunk=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.nb=0,t.prototype.content=ee.newBuffer([]),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).uint32(t.id),null!=t.nb&&t.hasOwnProperty("nb")&&e.uint32(16).uint32(t.nb),null!=t.content&&t.hasOwnProperty("content")&&e.uint32(34).bytes(t.content),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.userMessage.Message.Chunk;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=t.uint32();break;case 2:r.nb=t.uint32();break;case 4:r.content=t.bytes();break;default:t.skipType(7&i)}}return r},t}(),t.Type=function(){var t={},e=Object.create(t);return e[t[0]="STRING"]=0,e[t[1]="U_INT_8_ARRAY"]=1,e}(),t}(),t}(),oe=ne.channelBuilder=function(){var t={};return t.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.negotiation=null,t.prototype.connectionRequest=ee.newBuffer([]),t.prototype.connectionResponse=!1,Object.defineProperty(t.prototype,"type",{get:ee.oneOfGetter(e=["negotiation","connectionRequest","connectionResponse"]),set:ee.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.negotiation&&t.hasOwnProperty("negotiation")&&ne.channelBuilder.Negotiation.encode(t.negotiation,e.uint32(10).fork()).ldelim(),null!=t.connectionRequest&&t.hasOwnProperty("connectionRequest")&&e.uint32(18).bytes(t.connectionRequest),null!=t.connectionResponse&&t.hasOwnProperty("connectionResponse")&&e.uint32(24).bool(t.connectionResponse),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.channelBuilder.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.negotiation=ne.channelBuilder.Negotiation.decode(t,t.uint32());break;case 2:r.connectionRequest=t.bytes();break;case 3:r.connectionResponse=t.bool();break;default:t.skipType(7&i)}}return r},t}(),t.Negotiation=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.initiator=null,t.prototype.passive=null,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.initiator&&t.hasOwnProperty("initiator")&&ne.channelBuilder.Info.encode(t.initiator,e.uint32(10).fork()).ldelim(),null!=t.passive&&t.hasOwnProperty("passive")&&ne.channelBuilder.Info.encode(t.passive,e.uint32(18).fork()).ldelim(),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.channelBuilder.Negotiation;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.initiator=ne.channelBuilder.Info.decode(t,t.uint32());break;case 2:r.passive=ne.channelBuilder.Info.decode(t,t.uint32());break;default:t.skipType(7&i)}}return r},t}(),t.Info=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.wss="",t.prototype.wcId=0,t.prototype.wsSupported=!1,t.prototype.wsTried=!1,t.prototype.dcSupported=!1,t.prototype.dcTried=!1,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).uint32(t.id),null!=t.wss&&t.hasOwnProperty("wss")&&e.uint32(18).string(t.wss),null!=t.wcId&&t.hasOwnProperty("wcId")&&e.uint32(24).uint32(t.wcId),null!=t.wsSupported&&t.hasOwnProperty("wsSupported")&&e.uint32(32).bool(t.wsSupported),null!=t.wsTried&&t.hasOwnProperty("wsTried")&&e.uint32(40).bool(t.wsTried),null!=t.dcSupported&&t.hasOwnProperty("dcSupported")&&e.uint32(48).bool(t.dcSupported),null!=t.dcTried&&t.hasOwnProperty("dcTried")&&e.uint32(56).bool(t.dcTried),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.channelBuilder.Info;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=t.uint32();break;case 2:r.wss=t.string();break;case 3:r.wcId=t.uint32();break;case 4:r.wsSupported=t.bool();break;case 5:r.wsTried=t.bool();break;case 6:r.dcSupported=t.bool();break;case 7:r.dcTried=t.bool();break;default:t.skipType(7&i)}}return r},t}(),t}(),se=ne.fullMesh=function(){var t={};return t.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.members=null,t.prototype.adjacentMembers=null,t.prototype.heartbeat=!1,Object.defineProperty(t.prototype,"type",{get:ee.oneOfGetter(e=["members","adjacentMembers","heartbeat"]),set:ee.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.members&&t.hasOwnProperty("members")&&ne.fullMesh.Peers.encode(t.members,e.uint32(10).fork()).ldelim(),null!=t.adjacentMembers&&t.hasOwnProperty("adjacentMembers")&&ne.fullMesh.Peers.encode(t.adjacentMembers,e.uint32(26).fork()).ldelim(),null!=t.heartbeat&&t.hasOwnProperty("heartbeat")&&e.uint32(32).bool(t.heartbeat),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.fullMesh.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.members=ne.fullMesh.Peers.decode(t,t.uint32());break;case 3:r.adjacentMembers=ne.fullMesh.Peers.decode(t,t.uint32());break;case 4:r.heartbeat=t.bool();break;default:t.skipType(7&i)}}return r},t}(),t.Peers=function(){function t(t){if(this.ids=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.ids=ee.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=te.create()),null!=t.ids&&t.ids.length){e.uint32(10).fork();for(var n=0;n<t.ids.length;++n)e.uint32(t.ids[n]);e.ldelim()}return e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.fullMesh.Peers;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:if(r.ids&&r.ids.length||(r.ids=[]),2==(7&i))for(var o=t.uint32()+t.pos;t.pos<o;)r.ids.push(t.uint32());else r.ids.push(t.uint32());break;default:t.skipType(7&i)}}return r},t}(),t.ConnectionRequest=function(){function t(t){if(this.adjacentIds=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.adjacentIds=ee.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=te.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).uint32(t.id),null!=t.adjacentIds&&t.adjacentIds.length){e.uint32(18).fork();for(var n=0;n<t.adjacentIds.length;++n)e.uint32(t.adjacentIds[n]);e.ldelim()}return e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.fullMesh.ConnectionRequest;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=t.uint32();break;case 2:if(r.adjacentIds&&r.adjacentIds.length||(r.adjacentIds=[]),2==(7&i))for(var o=t.uint32()+t.pos;t.pos<o;)r.adjacentIds.push(t.uint32());else r.adjacentIds.push(t.uint32());break;default:t.skipType(7&i)}}return r},t}(),t}(),ce=ne.dataChannelBuilder=function(){var t={};return t.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.offer="",t.prototype.answer="",t.prototype.candidate=null,Object.defineProperty(t.prototype,"type",{get:ee.oneOfGetter(e=["offer","answer","candidate"]),set:ee.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.offer&&t.hasOwnProperty("offer")&&e.uint32(10).string(t.offer),null!=t.answer&&t.hasOwnProperty("answer")&&e.uint32(18).string(t.answer),null!=t.candidate&&t.hasOwnProperty("candidate")&&ne.dataChannelBuilder.IceCandidate.encode(t.candidate,e.uint32(26).fork()).ldelim(),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.dataChannelBuilder.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.offer=t.string();break;case 2:r.answer=t.string();break;case 3:r.candidate=ne.dataChannelBuilder.IceCandidate.decode(t,t.uint32());break;default:t.skipType(7&i)}}return r},t}(),t.IceCandidate=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.candidate="",t.prototype.sdpMid="",t.prototype.sdpMLineIndex=0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.candidate&&t.hasOwnProperty("candidate")&&e.uint32(10).string(t.candidate),null!=t.sdpMid&&t.hasOwnProperty("sdpMid")&&e.uint32(18).string(t.sdpMid),null!=t.sdpMLineIndex&&t.hasOwnProperty("sdpMLineIndex")&&e.uint32(24).uint32(t.sdpMLineIndex),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.dataChannelBuilder.IceCandidate;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.candidate=t.string();break;case 2:r.sdpMid=t.string();break;case 3:r.sdpMLineIndex=t.uint32();break;default:t.skipType(7&i)}}return r},t}(),t}(),ae=ne.channel=function(){var t={};return t.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.initPing=null,t.prototype.initPong=0,Object.defineProperty(t.prototype,"type",{get:ee.oneOfGetter(e=["initPing","initPong"]),set:ee.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.initPing&&t.hasOwnProperty("initPing")&&ne.channel.Data.encode(t.initPing,e.uint32(10).fork()).ldelim(),null!=t.initPong&&t.hasOwnProperty("initPong")&&e.uint32(16).uint32(t.initPong),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.channel.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.initPing=ne.channel.Data.decode(t,t.uint32());break;case 2:r.initPong=t.uint32();break;default:t.skipType(7&i)}}return r},t}(),t.Data=function(){function t(t){if(this.members=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.topology=0,t.prototype.wcId=0,t.prototype.senderId=0,t.prototype.members=ee.emptyArray,t.prototype.key="",t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=te.create()),null!=t.topology&&t.hasOwnProperty("topology")&&e.uint32(8).uint32(t.topology),null!=t.wcId&&t.hasOwnProperty("wcId")&&e.uint32(16).uint32(t.wcId),null!=t.senderId&&t.hasOwnProperty("senderId")&&e.uint32(24).uint32(t.senderId),null!=t.members&&t.members.length){e.uint32(34).fork();for(var n=0;n<t.members.length;++n)e.uint32(t.members[n]);e.ldelim()}return null!=t.key&&t.hasOwnProperty("key")&&e.uint32(42).string(t.key),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.channel.Data;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.topology=t.uint32();break;case 2:r.wcId=t.uint32();break;case 3:r.senderId=t.uint32();break;case 4:if(r.members&&r.members.length||(r.members=[]),2==(7&i))for(var o=t.uint32()+t.pos;t.pos<o;)r.members.push(t.uint32());else r.members.push(t.uint32());break;case 5:r.key=t.string();break;default:t.skipType(7&i)}}return r},t}(),t}(),ue=ne.signaling=function(){var t={};return t.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.heartbeat=!1,t.prototype.content=null,t.prototype.connect=null,t.prototype.connected=!1,Object.defineProperty(t.prototype,"type",{get:ee.oneOfGetter(e=["heartbeat","content","connect","connected"]),set:ee.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.heartbeat&&t.hasOwnProperty("heartbeat")&&e.uint32(8).bool(t.heartbeat),null!=t.content&&t.hasOwnProperty("content")&&ne.signaling.Content.encode(t.content,e.uint32(18).fork()).ldelim(),null!=t.connect&&t.hasOwnProperty("connect")&&ne.signaling.GroupData.encode(t.connect,e.uint32(26).fork()).ldelim(),null!=t.connected&&t.hasOwnProperty("connected")&&e.uint32(32).bool(t.connected),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.signaling.Message;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.heartbeat=t.bool();break;case 2:r.content=ne.signaling.Content.decode(t,t.uint32());break;case 3:r.connect=ne.signaling.GroupData.decode(t,t.uint32());break;case 4:r.connected=t.bool();break;default:t.skipType(7&i)}}return r},t}(),t.Content=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.senderId=0,t.prototype.recipientId=0,t.prototype.lastData=!1,t.prototype.data=ee.newBuffer([]),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=te.create()),null!=t.senderId&&t.hasOwnProperty("senderId")&&e.uint32(8).uint32(t.senderId),null!=t.recipientId&&t.hasOwnProperty("recipientId")&&e.uint32(16).uint32(t.recipientId),null!=t.lastData&&t.hasOwnProperty("lastData")&&e.uint32(24).bool(t.lastData),null!=t.data&&t.hasOwnProperty("data")&&e.uint32(34).bytes(t.data),e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.signaling.Content;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.senderId=t.uint32();break;case 2:r.recipientId=t.uint32();break;case 3:r.lastData=t.bool();break;case 4:r.data=t.bytes();break;default:t.skipType(7&i)}}return r},t}(),t.GroupData=function(){function t(t){if(this.members=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.members=ee.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=te.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).uint32(t.id),null!=t.members&&t.members.length){e.uint32(18).fork();for(var n=0;n<t.members.length;++n)e.uint32(t.members[n]);e.ldelim()}return e},t.decode=function(t,e){t instanceof Qt||(t=Qt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ne.signaling.GroupData;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=t.uint32();break;case 2:if(r.members&&r.members.length||(r.members=[]),2==(7&i))for(var o=t.uint32()+t.pos;t.pos<o;)r.members.push(t.uint32());else r.members.push(t.uint32());break;default:t.skipType(7&i)}}return r},t}(),t}(),le=ue.Message.encode(ue.Message.create({heartbeat:!0})).finish();!function(t){t[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CHECKING=2]="CHECKING",t[t.CHECKED=4]="CHECKED",t[t.CLOSED=3]="CLOSED"}($t||($t={}));var he,fe=function(){function t(t,e){this.STREAM_ID=1,this.wc=t,this.url=e,this.state=$t.CLOSED,this.connected=!1,this.missedHeartbeat=0,this.streamSubject=new s.Subject,this.stateSubject=new s.Subject}return Object.defineProperty(t.prototype,"messageFromStream",{get:function(){return this.streamSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.sendOverStream=function(t){C.signaling(this.wc.myId+" Forward message",t),this.send({content:{recipientId:t.recipientId,senderId:t.senderId,lastData:void 0===t.content,data:re.encode(re.create(t)).finish()}})},Object.defineProperty(t.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.check=function(){var t=this;this.state!==$t.CHECKED&&this.state!==$t.OPEN||(this.setState($t.CHECKING),this.send({connect:{id:this.wc.myId,members:this.wc.members.filter(function(e){return e!==t.wc.myId})}}))},t.prototype.connect=function(t){var e=this;if(!z())throw new Error("Failed to join over Signaling: WebSocket is not supported by your environment");this.setState($t.CONNECTING),this.ws=new u.WebSocket(this.fullUrl(t)),this.ws.binaryType="arraybuffer",this.connectionTimeout=setTimeout(function(){e.ws&&e.ws.readyState!==e.ws.OPEN&&(C.signaling("Failed to connect to Signaling server "+e.url+": connection timeout"),e.close())},1e4),this.ws.onopen=function(){e.setState($t.OPEN),e.connectionTimeout&&clearTimeout(e.connectionTimeout),e.startHeartbeat()},this.ws.onerror=function(t){return C.signaling("WebSocket ERROR",t)},this.ws.onclose=function(t){e.clean(),e.setState($t.CLOSED)},this.ws.onmessage=function(t){var n=t.data;return e.handleMessage(n)}},t.prototype.close=function(){this.state!==$t.CLOSED&&(this.ws&&(this.ws.onmessage=function(){},this.ws.onclose=function(){},this.ws.onerror=function(){},this.ws.close(1e3)),this.clean(),this.setState($t.CLOSED))},t.prototype.clean=function(){this.connectionTimeout&&clearTimeout(this.connectionTimeout),this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.ws=void 0},t.prototype.handleMessage=function(t){var e=this;try{var n=ue.Message.decode(new Uint8Array(t));switch(n.type){case"heartbeat":this.missedHeartbeat=0;break;case"connected":this.connected=n.connected,this.setState($t.CHECKED),n.connected||this.wc.channelBuilder.connectOverSignaling().catch(function(){return e.check()});break;case"content":var r=n.content,i=r.data,o=r.senderId,s=r.recipientId,c=re.decode(i);c.senderId=o,c.recipientId=s,C.signaling("StreamMessage RECEIVED: ",c),this.streamSubject.next(c)}}catch(t){C.warn("Decode Signaling message error: ",t)}},t.prototype.setState=function(t){this.state!==t&&(this.state=t,this.stateSubject.next(t))},t.prototype.startHeartbeat=function(){var t=this;this.missedHeartbeat=0,this.heartbeatInterval=setInterval(function(){try{if(t.missedHeartbeat++,t.missedHeartbeat>=3)throw new Error("Too many missed heartbeats");t.heartbeat()}catch(e){t.close()}},5e3)},t.prototype.send=function(t){if(this.ws&&this.ws.readyState===u.WebSocket.OPEN)try{this.ws.send(ue.Message.encode(ue.Message.create(t)).finish())}catch(t){C.signaling("Failed send to Signaling",t)}},t.prototype.heartbeat=function(){if(this.ws&&this.ws.readyState===u.WebSocket.OPEN)try{this.ws.send(le)}catch(t){C.signaling("Failed send to Signaling: "+t.message)}},t.prototype.fullUrl=function(t){var e=this.url.endsWith("/")?this.url+t:this.url+"/"+t;return A?e:e+"?favored"},t}();!function(t){t[t.JOINING=0]="JOINING",t[t.JOINED=1]="JOINED",t[t.LEFT=2]="LEFT"}(he||(he={}));var pe,de=new u.TextEncoder,ye=new u.TextDecoder,be=function(t){function e(){var n=t.call(this,e.SERVICE_ID,ie.Message)||this;return n.buffers=new Map,n}return h(e,t),e.prototype.clean=function(){this.buffers.clear()},e.prototype.encodeUserMessage=function(e){var n=this.userDataToType(e),r=n.type,i=n.bytes,o={length:i.length,type:r};if(i.length<=15e3)return o.full=i,[t.prototype.encode.call(this,o)];o.chunk={id:Math.ceil(65535*Math.random())};for(var s=Math.ceil(i.length/15e3),c=new Array(s),a=0;a<s;a++){var u=15e3*a,l=u+Math.min(15e3,i.length-15e3*a);o.chunk.nb=a,o.chunk.content=new Uint8Array(i.slice(u,l)),c[a]=t.prototype.encode.call(this,o)}return c},e.prototype.decodeUserMessage=function(e,n){try{var r=t.prototype.decode.call(this,e),i=r.length,o=r.type,s=r.contentType,c=r.full,a=r.chunk,u=void 0;switch(s){case"full":u=c;break;case"chunk":var l=this.getBuffer(n,a.id);void 0===l?(l=new ge(i,a.content,a.nb),this.setBuffer(n,a.id,l),u=void 0):u=l.append(a.content,a.nb);break;default:throw new Error("Unknown message integrity")}if(void 0!==u)switch(o){case ie.Message.Type.U_INT_8_ARRAY:return u;case ie.Message.Type.STRING:return ye.decode(u);default:throw new Error("Unknown message type")}return u}catch(t){return void C.warn("Decode user message error: ",t)}},e.prototype.userDataToType=function(t){if(t instanceof Uint8Array)return{type:ie.Message.Type.U_INT_8_ARRAY,bytes:t};if("string"==typeof t)return{type:ie.Message.Type.STRING,bytes:de.encode(t)};if(t instanceof String)return{type:ie.Message.Type.STRING,bytes:de.encode(""+t)};throw new Error("Message neigther a string type or a Uint8Array type")},e.prototype.getBuffer=function(t,e){var n=this.buffers.get(t);if(void 0!==n)return n.get(e)},e.prototype.setBuffer=function(t,e,n){var r=this.buffers.get(t);void 0===r&&(r=new Map),r.set(e,n),this.buffers.set(t,r)},e.SERVICE_ID=743,e}(W),ge=function(){function t(t,e,n){this.fullData=new Uint8Array(t),this.currentLength=0,this.append(e,n)}return t.prototype.append=function(t,e){var n,r,i=15e3*e;this.currentLength+=t.length;try{for(var o=y(t),s=o.next();!s.done;s=o.next()){var c=s.value;this.fullData[i++]=c}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return this.currentLength===this.fullData.length?this.fullData:void 0},t}(),ve=function(){function t(e,n,r,i,o){var s=this;C.channel("New Channel "+r+": Me: "+e.myId+" with "+i),this.wc=e,this.wsOrDc=n,this.type=r,this.pc=o,this.missedHeartbeat=0,this.heartbeatMsg=new Uint8Array(0),this.resolveInit=function(){},A?(n.binaryType="arraybuffer",this.send=this.sendInBrowser):this.pc?(n.binaryType="arraybuffer",this.send=this.sendInNodeOverDataChannel):this.send=this.sendInNodeOverWebSocket,r===t.WITH_INTERNAL?(this.id=i,this.heartbeatMsg=this.createHeartbeatMsg(),this.init=Promise.resolve(),this.initHandlers()):(this.id=N,r===t.WITH_JOINING&&this.sendInitPing(),this.init=new Promise(function(t,e){return s.resolveInit=function(){s.heartbeatMsg=s.createHeartbeatMsg(),t()}}),this.wsOrDc.onmessage=function(t){var e=t.data;try{var n=ae.Message.decode(new Uint8Array(e));s.handleInitMessage(n)}catch(t){C.warn("Decode inner Channel message error: ",t)}})}return t.remoteType=function(e){return e===t.WITH_INTERNAL?t.WITH_INTERNAL:e===t.WITH_JOINING?t.WITH_MEMBER:t.WITH_JOINING},Object.defineProperty(t.prototype,"url",{get:function(){return this.pc?"":this.wsOrDc.url},enumerable:!0,configurable:!0}),t.prototype.encodeAndSend=function(t){var e=void 0===t?{}:t,n=e.senderId,r=void 0===n?this.wc.myId:n,i=e.recipientId,o=void 0===i?0:i,s=e.serviceId,c=e.content;this.send(re.encode(re.create({senderId:r,recipientId:o,serviceId:s,content:c})).finish())},t.prototype.close=function(){this.wsOrDc.onmessage=void 0,this.wsOrDc.onclose=void 0,this.wsOrDc.onerror=void 0,this.pc?(this.pc.oniceconnectionstatechange=function(){},this.pc.close()):this.wsOrDc.close(1e3)},t.prototype.sendHeartbeat=function(){this.missedHeartbeat++,this.missedHeartbeat>=3?(C.channel(this.id+" channel closed: too many missed heartbeats"),this.wc.topology.onChannelClose(this),this.close()):this.send(this.heartbeatMsg)},t.prototype.sendInBrowser=function(t){try{this.wsOrDc.send(t)}catch(t){C.channel("Channel sendInBrowser ERROR",t)}},t.prototype.sendInNodeOverWebSocket=function(t){try{this.wsOrDc.send(t,{binary:!0})}catch(t){C.channel("Channel sendInNodeOverWebSocket ERROR",t)}},t.prototype.sendInNodeOverDataChannel=function(t){this.sendInBrowser(t.slice(0))},t.prototype.handleInitMessage=function(t){switch(t.type){case"initPing":C.channel(this.wc.myId+" received InitPing");var e=t.initPing,n=e.topology,r=e.wcId,i=e.senderId,o=e.members,s=e.key;this.wc.topologyEnum!==n?C.channel("Different topology. This message should never be shown: something is wrong"):o.includes(this.id)&&this.wc.id,this.wc.id=r,this.wc.key=s,this.id=i,C.channel(this.wc.myId+" send InitPong"),this.send(ae.Message.encode(ae.Message.create({initPong:this.wc.myId})).finish()),this.initData={members:o},this.initHandlers(),this.resolveInit();break;case"initPong":C.channel(this.wc.myId+" received InitPong"),this.id=t.initPong,this.initHandlers(),this.resolveInit();break;default:C.channel('Unknown message type: "'+t.type+'". This message should never be shown: something went wrong')}},t.prototype.initHandlers=function(){var t=this;this.wsOrDc.onmessage=function(e){var n=e.data;try{var r=re.decode(new Uint8Array(n));if(0===r.recipientId||r.recipientId===t.wc.myId)if(r.serviceId===be.SERVICE_ID){var i=t.wc.userMsg.decodeUserMessage(r.content,r.senderId);i&&t.wc.onMessage(r.senderId,i)}else 0===r.serviceId?t.missedHeartbeat=0:t.wc.streamSubject.next(f({channel:t},r));r.recipientId!==t.wc.myId&&t.wc.topology.forward(r)}catch(t){C.warn("Decode general Channel message error: ",t)}},this.wsOrDc.onclose=function(e){C.channel("Connection with "+t.id+" has closed",e),t.pc&&(t.pc.oniceconnectionstatechange=function(){}),t.wc.topology.onChannelClose(t)},this.pc&&(this.pc.oniceconnectionstatechange=function(){t.pc&&"failed"===t.pc.iceConnectionState&&(t.close(),t.wc.topology.onChannelClose(t))}),this.wsOrDc.onerror=function(t){return C.channel("Channel error: ",t)}},t.prototype.createHeartbeatMsg=function(){return re.encode(re.create({serviceId:0,senderId:this.wc.myId,recipientId:this.id})).finish()},t.prototype.sendInitPing=function(){C.channel("initialize..."),this.send(ae.Message.encode(ae.Message.create({initPing:{topology:this.wc.topologyEnum,wcId:this.wc.id,senderId:this.wc.myId,members:this.wc.members,key:this.wc.key}})).finish())},t.WITH_INTERNAL=0,t.WITH_JOINING=1,t.WITH_MEMBER=2,t}(),me=function(){function t(t){this.wc=t,this.channelsSubject=new s.Subject}return Object.defineProperty(t.prototype,"channels",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.newWebSocket=function(t,e,n){this.channelsSubject.next({id:e,channel:new ve(this.wc,t,n,e)})},t.prototype.connect=function(t,e,n,r,i){return p(this,void 0,void 0,function(){var o,s,c,a=this;return d(this,function(l){switch(l.label){case 0:return B(t),o=this.composeUrl(t,ve.remoteType(e),i,r),s=new u.WebSocket(o),[4,new Promise(function(r,i){var o=setTimeout(function(){s.readyState!==s.OPEN&&(s.close(),i(new Error("WebSocket 4000ms connection timeout with '"+t+"'")))},4e3);s.onopen=function(){clearTimeout(o),r(new ve(a.wc,s,e,n))},s.onerror=function(t){return i(t)},s.onclose=function(e){i(new Error("WebSocket with '"+t+"' closed "+e.code+": "+e.reason))}})];case 1:return c=l.sent(),this.channelsSubject.next({id:n,channel:c}),[2]}})})},t.prototype.composeUrl=function(t,e,n,r){var i=t+"/?type="+e+"&wcId="+n+"&senderId="+r;return e!==ve.WITH_INTERNAL&&(i+="&key="+this.wc.key),i},t.listenUrl=new s.BehaviorSubject(""),t}(),we=function(){function t(t,e,n,r,i){var o=this;this.finalMessageReceived=!1,this.finalMessageSent=!1,this.id=t,this.pc=e,this.send=n,this._onError=function(){},this.candidates=new s.ReplaySubject,this.remotes=r,this.isSDPSent=!1,this.remotes.set(t,this),this.timer=setTimeout(function(){"connected"!==o.pc.iceConnectionState&&"completed"!==o.pc.iceConnectionState&&o._onError(new Error(i+"ms connection timeout"))},i),e.oniceconnectionstatechange=function(){C.webrtc("LOCAL ICE CONNECTION STATE",e.iceConnectionState),"failed"===e.iceConnectionState&&o._onError(new Error("Ice Connection State is FAILED"))},e.onicecandidate=function(t){null!==t.candidate?(C.webrtc("LOCAL ICE CANDIDATE",t.candidate.candidate),o.send({candidate:{candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex}})):(o.pc.onicecandidate=function(){},o.isSDPSent&&o.sendFinalMessage())}}return Object.defineProperty(t.prototype,"onError",{get:function(){return this._onError},set:function(t){var e=this;this._onError=function(n){C.webrtc("ERROR: ",n.message),e.clean("clean"!==n.message),t(n)}},enumerable:!0,configurable:!0}),t.prototype.sdpIsSent=function(){this.isSDPSent=!0,"complete"===this.pc.iceGatheringState&&this.sendFinalMessage()},t.prototype.clean=function(t){void 0===t&&(t=!0),C.webrtc("CLEAN REMOTE"),this.pc.oniceconnectionstatechange=function(){},this.pc.onicecandidate=function(){},this.pc.ondatachannel=function(){},this._onError=function(){},this.candidates.complete(),this.remotes.delete(this.id),clearTimeout(this.timer),this.pc.close(),t&&this.sendFinalMessage()},t.prototype.dataChannelOpen=function(t){C.webrtc("DATA CHANNEL with "+this.id+" OPEN"),this.finalMessageReceived&&this.finalMessageSent&&this.remotes.delete(this.id),this.pc.oniceconnectionstatechange=function(){},t.onopen=function(){},this.pc.ondatachannel=function(){},this._onError=function(){}},t.prototype.handleMessage=function(t){var e=this;if(t.type)switch(t.type){case"offer":C.webrtc("REMOTE OFFER",{offer:t.offer}),this.pc.setRemoteDescription({type:"offer",sdp:t.offer}).then(function(){return e.candidates.subscribe(function(t){return e.pc.addIceCandidate(t).catch(function(t){return C.webrtc("Failed to addIceCandidate",t)})})}).then(function(){return e.pc.createAnswer()}).then(function(t){return e.pc.setLocalDescription(t)}).then(function(){var t=e.pc.localDescription.sdp;C.webrtc("Send LOCAL ANSWER",{answer:t}),e.send({answer:t}),e.sdpIsSent()}).catch(function(t){return e._onError(t)});break;case"answer":C.webrtc("REMOTE ANSWER is received",{answer:t.answer}),this.pc.setRemoteDescription({type:"answer",sdp:t.answer}).then(function(){e.candidates.subscribe(function(t){return e.pc.addIceCandidate(t).catch(function(t){return C.webrtc(e.id+": Failed to add REMOTE Ice Candidate",t)})})}).catch(function(t){return e._onError(t)});break;case"candidate":C.webrtc("REMOTE ICE CANDIDATE is received",t.candidate),this.candidates.next(new u.RTCIceCandidate(t.candidate));break;default:this._onError(new Error("Buffer Protocol unknown message from the remote peer"))}else C.webrtc("REMOTE FINAL MESSAGE received"),this.finalMessageReceived=!0,this.candidates.complete(),this.finalMessageSent&&this.remotes.delete(this.id)},t.prototype.sendFinalMessage=function(){this.finalMessageSent||(this.finalMessageSent=!0,this.send({}),this.finalMessageReceived&&this.remotes.delete(this.id))},t}(),Se=function(t){function e(n,r){var i=t.call(this,e.SERVICE_ID,ce.Message)||this;return i.wc=n,i.allStreams=t.prototype.useAllStreams.call(i,n,n.signaling),i.rtcConfiguration=r,i.channelsSubject=new s.Subject,i.remotes=new Map,i.allStreams.message.subscribe(function(t){var e=t.streamId,n=t.senderId,r=t.recipientId,o=t.msg,s=i.remotes.get(n);if(s&&s.finalMessageReceived&&(s.clean(!1),s=void 0),!s){if(!o.type||"offer"!==o.type&&"candidate"!==o.type)return;try{s=i.createRemote(e,n,r,!0)}catch(t){return}}s.handleMessage(o)}),i}return h(e,t),Object.defineProperty(e.prototype,"channels",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.connect=function(t,e,n){return p(this,void 0,void 0,function(){var r,i,o,s,c,a,u,l=this;return d(this,function(h){switch(h.label){case 0:return C.webrtc("connectWith call",{targetId:t,myId:e,type:n}),r=n===ve.WITH_INTERNAL?this.wc.STREAM_ID:this.wc.signaling.STREAM_ID,(i=this.remotes.get(t))?i.clean():i=this.createRemote(r,t,e),o=ve.remoteType(n),s=i.pc.createDataChannel('{"id":'+this.wc.myId+',"type":'+o+"}"),[4,i.pc.createOffer()];case 1:return c=h.sent(),[4,i.pc.setLocalDescription(c)];case 2:return h.sent(),a=i.pc.localDescription.sdp,this.allStreams.sendOver(r,{offer:a},t,e),i.sdpIsSent(),[4,new Promise(function(e,r){i.onError=function(t){return r(t)},s.onopen=function(){i.dataChannelOpen(s),e(new ve(l.wc,s,n,t,i.pc))}})];case 3:return u=h.sent(),this.channelsSubject.next({id:t,channel:u}),[2]}})})},e.prototype.clean=function(t){if(t){var e=this.remotes.get(t);e&&e.clean(!1)}else this.remotes.forEach(function(t){return t.onError(new Error("clean"))})},e.prototype.createRemote=function(t,e,n,r){var i=this;void 0===r&&(r=!1);var o=new we(e,new u.RTCPeerConnection(this.rtcConfiguration),function(r){return i.allStreams.sendOver(t,r,e,n)},this.remotes,9e3);r?(C.webrtc("create a new remote object with "+e+" - PASSIVE"),o.pc.ondatachannel=function(t){var n=t.channel,r=JSON.parse(n.label),s=r.id,c=r.type;n.onopen=function(){o.dataChannelOpen(n);var t=new ve(i.wc,n,c,s,o.pc);i.channelsSubject.next({id:e,channel:t})}}):C.webrtc("create a new remote object with "+e+" - INITIATOR");return o},e.SERVICE_ID=7431,e}(W);!function(t){t.RESPONSE_TIMEOUT="Response timeout: remote peer is not responding",t.CONNECTION_TIMEOUT="Connection timeout: unable to establish a channel within a specified time",t.DENIED="Connection denied: remote peer refused the connection request",t.CLEAN="Clean: all connections in progress must be stopped",t.IN_PROGRESS="Connection setup is already in progress",t.NEGOTIATION_ERROR="All connection possibilities have been tried and none of them worked"}(pe||(pe={}));var Ie,Oe=function(){function t(){this.connections=new Map}return t.prototype.create=function(t,e,n,r){var i=this,o={};return o.promise=new Promise(function(s,c){var a=setTimeout(function(){return o.reject(new Error(pe.RESPONSE_TIMEOUT))},n);o.resolve=function(){clearTimeout(a),s(),o.promise=new Promise(function(n,s){var c=setTimeout(function(){C.channelBuilder("on Connection timeout callback"),r(),o.reject(new Error(pe.CONNECTION_TIMEOUT))},e);o.resolve=function(){clearTimeout(c),i.connections.delete(t),n()},o.reject=function(e){o.promise.catch(function(){}),clearTimeout(c),i.connections.delete(t),s(e)}})},o.reject=function(e){o.promise.catch(function(){}),clearTimeout(a),i.connections.delete(t),c(e)},i.connections.set(t,o)}),o},t.prototype.get=function(t){return this.connections.get(t)},t.prototype.has=function(t,e){return this.connections.has(e)},t.prototype.clean=function(){this.connections.forEach(function(t){return t.reject(new Error(pe.CLEAN))}),this.connections.clear()},t}(),xe=Math.max(9e3,4e3)+5e3,_e=function(t){function e(n){var r=t.call(this,e.SERVICE_ID,oe.Message)||this;return r.wc=n,r.allStreams=t.prototype.useAllStreams.call(r,n,n.signaling),r.connectsInProgress=new Oe,r.channelsSubject=new s.Subject,r.onConnectionRequest=function(){return!0},r.dataChannelBuilder=new Se(r.wc,r.wc.rtcConfiguration),r.myInfo={wsTried:!1,wsSupported:z(),dcTried:!1,dcSupported:!!u.RTCPeerConnection&&"createDataChannel"in u.RTCPeerConnection.prototype},r.negotiationEncoded=t.prototype.encode.call(r,{negotiation:{initiator:r.myInfo}}),e.connectResTrueEncoded||e.connectResFalseEncoded||(e.connectResTrueEncoded=t.prototype.encode.call(r,{connectionResponse:!0}),e.connectResFalseEncoded=t.prototype.encode.call(r,{connectionResponse:!1})),r.allStreams.message.subscribe(function(t){var e=t.streamId,n=t.senderId,i=t.recipientId,o=t.msg;r.handleMessage(e,n,i,o)}),r.subscribeToChannels(),r.subscribeToURLandIDChange(),r}return h(e,t),e.prototype.clean=function(){C.channelBuilder("CLEAN call"),this.dataChannelBuilder.clean(),this.connectsInProgress.clean()},Object.defineProperty(e.prototype,"onChannel",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.connectOverWebChannel=function(t,e,n){return void 0===e&&(e=function(){}),void 0===n&&(n=new Uint8Array),p(this,void 0,void 0,function(){return d(this,function(r){return[2,this.connectOver(this.wc.STREAM_ID,t,e,n)]})})},e.prototype.connectOverSignaling=function(t,e){return void 0===t&&(t=function(){}),void 0===e&&(e=new Uint8Array),p(this,void 0,void 0,function(){return d(this,function(n){return[2,this.connectOver(this.wc.signaling.STREAM_ID,0,t,e)]})})},e.prototype.connectOver=function(t,e,n,r){return p(this,void 0,void 0,function(){var i,o=this;return d(this,function(s){switch(s.label){case 0:return(i=this.connectsInProgress.get(e))?[3,2]:(this.allStreams.sendOver(t,{connectionRequest:r},e,this.wc.myId),[4,(i=this.connectsInProgress.create(e,xe,2e3,function(){return o.dataChannelBuilder.clean(e)})).promise]);case 1:return s.sent(),n(),[2,i.promise];case 2:throw new Error(pe.IN_PROGRESS)}})})},e.prototype.handleMessage=function(t,n,r,i){var o=this;switch(i.type){case"connectionRequest":if(C.channelBuilder("connection Request from ",n),s=this.connectsInProgress.get(n)){if(!(n<this.wc.myId))return;s.reject(new Error(pe.IN_PROGRESS))}this.onConnectionRequest(t,i.connectionRequest)?((s=this.connectsInProgress.create(n,xe,2e3,function(){return o.dataChannelBuilder.clean(n)})).resolve(),C.channelBuilder("connection Response POSITIVE to ",n),this.allStreams.sendOver(t,e.connectResTrueEncoded,n,r)):(C.channelBuilder("connection Response NEGATIVE to ",n),this.allStreams.sendOver(t,e.connectResFalseEncoded,n,r));break;case"connectionResponse":var s;C.channelBuilder("connection Response from ",n),(s=this.connectsInProgress.get(n))&&(i.connectionResponse?(s.resolve(),C.channelBuilder("Send first negotiation message to ",n),this.allStreams.sendOver(t,this.negotiationEncoded,n,r)):s.reject(new Error(pe.DENIED)));break;case"negotiation":if(this.connectsInProgress.has(t,n)){var c=i.negotiation,a=c.initiator,u=c.passive;u||(a.id=n,(u=f({},this.myInfo)).id=r),C.channelBuilder("NEGOTIATION message to proceed from "+n+": ",JSON.stringify({isIamInitiatore:u.id===n,passive:u,initiator:a,senderId:n,recipientId:r})),this.isNagotiable(a,u)?this.proceedNegotiation(t,a,u,u.id===n).catch(function(e){o.rejectConnection(t,n,e),C.channelBuilder("NEGOTIATION with "+n+" FIALED: ",{passive:u,initiator:a}),o.allStreams.sendOver(t,{negotiation:{initiator:a,passive:u}},n,r)}):this.rejectConnection(t,n,new Error(pe.NEGOTIATION_ERROR))}}},e.prototype.proceedNegotiation=function(t,e,n,r){return p(this,void 0,void 0,function(){var i,o,s,c,a;return d(this,function(u){switch(u.label){case 0:return i=b(r?[e,n]:[n,e],2),o=i[0],s=i[1],(c=s.wss&&!o.wsTried)?[4,this.tryWs(t,o,s,r)]:[3,2];case 1:c=u.sent(),u.label=2;case 2:return c?[2]:o.wss&&!s.wsTried?(C.channelBuilder("Prompt the other to connect over WebSocket"),this.allStreams.sendOver(t,{negotiation:{initiator:e,passive:n}},s.id,o.id),[2]):o.dcSupported&&s.dcSupported?(a=!o.dcTried)?[4,this.tryDc(t,o,s,r)]:[3,4]:[3,5];case 3:a=u.sent(),u.label=4;case 4:if(a)return[2];if(!s.dcTried)return C.channelBuilder("Prompt the other to connect over RTCDataChannel"),this.allStreams.sendOver(t,{negotiation:{initiator:e,passive:n}},s.id,o.id),[2];u.label=5;case 5:throw new Error(pe.NEGOTIATION_ERROR)}})})},e.prototype.tryWs=function(t,e,n,r){return p(this,void 0,void 0,function(){var i,o,s;return d(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),i=this.getType(t,r),o=i===ve.WITH_MEMBER?n.wcId:this.wc.myId,[4,this.wc.webSocketBuilder.connect(n.wss,i,n.id,e.id,o)];case 1:return c.sent(),C.channelBuilder("New WebSocket connection with "+n.id),[2,!0];case 2:return"clean"!==(s=c.sent()).message?(C.channelBuilder("WebSocket failed with "+n.id,s),e.wsTried=!0,[2,!1]):[2,!0];case 3:return[2]}})})},e.prototype.tryDc=function(t,e,n,r){return p(this,void 0,void 0,function(){var i,o;return d(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),i=this.getType(t,r),[4,this.dataChannelBuilder.connect(n.id,e.id,i)];case 1:return s.sent(),C.channelBuilder("New RTCDataChannel with "+n.id),[2,!0];case 2:return"clean"!==(o=s.sent()).message?(C.channelBuilder("RTCDataChannel failed with "+n.id,o),e.dcTried=!0,[2,!1]):[2,!0];case 3:return[2]}})})},e.prototype.getType=function(t,e){return t===this.wc.STREAM_ID?ve.WITH_INTERNAL:e?ve.WITH_MEMBER:ve.WITH_JOINING},e.prototype.isNagotiable=function(t,e){return t.wss&&!e.wsTried||e.wss&&!t.wsTried||t.dcSupported&&e.dcSupported&&(!t.dcTried||!e.dcTried)},e.prototype.subscribeToChannels=function(){var t=this;Object(s.merge)(this.dataChannelBuilder.channels,this.wc.webSocketBuilder.channels).subscribe(function(e){var n=e.id,r=e.channel;r.init.then(function(){C.channelBuilder("NEW Channel from ",JSON.stringify({type:r.type,id:n}));var e=t.connectsInProgress.get(n);e?(C.channelBuilder("RESOLVE this NEW Channel"),e.resolve()):C.channelBuilder("this NEW Channel NOT FOUND"),t.channelsSubject.next(r)})})},e.prototype.subscribeToURLandIDChange=function(){var e=this;me.listenUrl.subscribe(function(n){n&&(e.myInfo.wss=n,e.negotiationEncoded=t.prototype.encode.call(e,{negotiation:{initiator:e.myInfo}}))}),this.wc.onIdChange.subscribe(function(n){e.myInfo.wcId=e.wc.id,e.negotiationEncoded=t.prototype.encode.call(e,{negotiation:{initiator:e.myInfo}})})},e.prototype.rejectConnection=function(t,e,n){var r=this.connectsInProgress.get(e);r&&r.reject(n)},e.SERVICE_ID=74,e}(W),Ee=function(t){function e(n){var r=t.call(this,n,e.SERVICE_ID,se.Message)||this;return r.adjacentMembers=new Map,r.distantMembers=new Map,r.antecedentId=0,r.delayedMembers=new Set,r.delayedMembersTimers=new Set,r.adjacentBots=new Set,r.heartbeatMsg=t.prototype.encode.call(r,{heartbeat:!0}),r.wcStream.message.subscribe(function(t){var e=t.channel,n=t.senderId,i=t.msg;return r.handleServiceMessage(e,n,i)}),r.wc.channelBuilder.onConnectionRequest=function(t,e){try{var n=se.ConnectionRequest.decode(e),i=n.id,o=n.adjacentIds;return t!==r.wc.STREAM_ID||(C.topology("CONNECTION REQUEST from "+i+", where adjacent members are: ",o),r.createOrUpdateDistantMember(i,o))}catch(t){return C.warn("Decode Fullmesh onConnectionRequest message error: ",t),!1}},r.wc.channelBuilder.onChannel.subscribe(function(e){C.topology("New adjacent member: "+e.id),r.distantMembers.delete(e.id),r.delayedMembers.delete(e.id);var n=r.adjacentMembers.get(e.id);if(n&&(C.topology("Replacing the same channel"),n.close()),r.adjacentMembers.set(e.id,e),e.url&&r.adjacentBots.add(e),r.notifyDistantMembers(),r.heartbeatInterval||r.startHeartbeatInterval(),e.type===ve.WITH_MEMBER){t.prototype.setState.call(r,V.CONSTRUCTING);var i=e.initData.members;r.connectToMembers(i,e.id).then(function(){t.prototype.setState.call(r,V.CONSTRUCTED),r.startMembersCheckIntervals()})}else r.startMembersCheckIntervals();r.wc.onMemberJoinProxy(e.id),r.updateAntecedentId()}),A&&(window.fullmesh=function(){C.topology("Fullmesh info:",{myId:r.wc.myId,antecedentId:r.antecedentId,signalingState:r.wc.signaling.state,webGroupState:r.wc.state,topologyState:V[r.state],adjacentBots:Array.from(r.adjacentBots).map(function(t){return t.id}),adjacentMembers:Array.from(r.adjacentMembers.keys()).toString(),distantMembers:Array.from(r.distantMembers.keys()).toString(),distantMembersDETAILS:Array.from(r.distantMembers.keys()).map(function(t){var e=r.distantMembers.get(t);return{id:t,adjacentMembers:e?e.adjacentIds:[]}})})}),r}return h(e,t),e.prototype.send=function(t){var e=this;this.adjacentMembers.forEach(function(e){return e.encodeAndSend(t)}),this.distantMembers.forEach(function(n,r){e.sendToDistantPeer(n,f({},t,{recipientId:r}))})},e.prototype.sendTo=function(t){var e=this.adjacentMembers.get(t.recipientId);e?e.encodeAndSend(t):this.sendToDistantPeer(this.distantMembers.get(t.recipientId),t)},e.prototype.forward=function(t){this.sendTo(t)},e.prototype.leave=function(){this.state!==V.IDLE&&(C.topology("LEAVE"),this.clean(),this.adjacentMembers.forEach(function(t){return t.close()}),this.wc.onAdjacentMembersLeaveProxy(Array.from(this.adjacentMembers.keys())),this.adjacentMembers.clear(),t.prototype.setState.call(this,V.IDLE))},e.prototype.onChannelClose=function(t){this.adjacentMembers.delete(t.id)&&(this.adjacentBots.delete(t),this.delayedMembers.delete(t.id),this.wc.onAdjacentMembersLeaveProxy([t.id]),0===this.adjacentMembers.size?this.clean():(this.notifyDistantMembers(),this.updateAntecedentId()),C.topology("Channel closed with "+t.id))},Object.defineProperty(e.prototype,"neighbors",{get:function(){return Array.from(this.adjacentMembers.values())},enumerable:!0,configurable:!0}),e.prototype.clean=function(){C.topology("CLEAN"),this.wc.onDistantMembersLeaveProxy(Array.from(this.distantMembers.keys())),this.distantMembers.clear(),this.antecedentId=0,clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0,clearInterval(this.membersCheckInterval),this.membersCheckInterval=void 0,this.delayedMembers.clear(),this.delayedMembersTimers.forEach(function(t){return clearTimeout(t)}),this.delayedMembersTimers.clear(),this.adjacentBots.clear()},e.prototype.handleServiceMessage=function(t,e,n){switch(n.type){case"members":this.connectToMembers(n.members.ids,e);break;case"adjacentMembers":C.topology("adjacent members received from "+e,n.adjacentMembers.ids);var r=n.adjacentMembers.ids;this.createOrUpdateDistantMember(e,r);break;case"heartbeat":var i=this.distantMembers.get(e);i&&(i.missedHeartbeat=0)}},e.prototype.connectToMembers=function(t,e){var n,r,i=this,o=t.filter(function(t){return!i.adjacentMembers.has(t)&&t!==i.wc.myId});if(0!==o.length){C.topology("TRY TO CONNECT to members",o);var s=[],c=se.ConnectionRequest.encode(se.ConnectionRequest.create({id:this.wc.myId,adjacentIds:Array.from(this.adjacentMembers.keys())})).finish(),a=function(t){u.distantMembers.has(t)||(u.distantMembers.set(t,{adjacentIds:[e],missedHeartbeat:0}),C.topology("NEW distant member = "+t+"; BIS",e),u.updateAntecedentId()),u.delayedMembers.has(t)||(s[s.length]=u.wc.channelBuilder.connectOverWebChannel(t,function(){i.wc.onMemberJoinProxy(t),i.updateAntecedentId()},c).catch(function(e){if(C.topology("FAILED to connect to "+t+", because: "+e.message),e.message===pe.CONNECTION_TIMEOUT||e.message===pe.NEGOTIATION_ERROR||e.message===pe.IN_PROGRESS){i.delayedMembers.add(t);var n=setTimeout(function(){i.delayedMembers.delete(t),i.delayedMembersTimers.delete(n)},3e5);i.delayedMembersTimers.add(n)}}))},u=this;try{for(var l=y(o),h=l.next();!h.done;h=l.next()){a(h.value)}}catch(t){n={error:t}}finally{try{h&&!h.done&&(r=l.return)&&r.call(l)}finally{if(n)throw n.error}}return Promise.all(s)}return Promise.resolve()},e.prototype.notifyDistantMembers=function(){var e=this;if(0!==this.distantMembers.size){var n=t.prototype.encode.call(this,{adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}});this.distantMembers.forEach(function(t,r){return e.wcStream.send(n,r)})}},e.prototype.startMembersCheckIntervals=function(){var t=this;this.membersCheckInterval||(this.membersCheckInterval=setInterval(function(){t.antecedentId&&t.wcStream.send({members:{ids:t.wc.members}},t.antecedentId)},2e4))},e.prototype.startHeartbeatInterval=function(){var t=this;this.heartbeatInterval=setInterval(function(){t.adjacentMembers.forEach(function(t){return t.sendHeartbeat()}),t.distantMembers.forEach(function(e,n){e.missedHeartbeat++,e.missedHeartbeat>=4&&(C.topology("Distant peer "+n+" stopped to responding: too many missed heartbeats"),t.distantMembers.delete(n)&&(t.delayedMembers.delete(n),t.wc.onDistantMembersLeaveProxy([n]),t.updateAntecedentId())),t.wcStream.send(t.heartbeatMsg,n)})},3e3)},e.prototype.sendToDistantPeer=function(t,e){for(var n=1;n<=3;n++){var r=this.findRoutedChannel(t,n);if(r)return void r.encodeAndSend(e)}},e.prototype.findRoutedChannel=function(t,e){var n,r,i,o,s,c;if(t){try{for(var a=y(this.adjacentBots),u=a.next();!u.done;u=a.next()){var l=u.value;if(t.adjacentIds.includes(l.id))return l}}catch(t){n={error:t}}finally{try{u&&!u.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}try{for(var h=y(this.adjacentMembers),f=h.next();!f.done;f=h.next()){var p=b(f.value,2),d=p[0];l=p[1];if(t.adjacentIds.includes(d))return l}}catch(t){i={error:t}}finally{try{f&&!f.done&&(o=h.return)&&o.call(h)}finally{if(i)throw i.error}}if(0!==e)try{for(var g=y(t.adjacentIds),v=g.next();!v.done;v=g.next()){var m=v.value;if(l=this.findRoutedChannel(this.distantMembers.get(m),e-1))return l}}catch(t){s={error:t}}finally{try{v&&!v.done&&(c=g.return)&&c.call(g)}finally{if(s)throw s.error}}}},e.prototype.createOrUpdateDistantMember=function(t,e){if(!this.adjacentMembers.has(t)){var n=this.distantMembers.get(t);return n?(n.adjacentIds=e,C.topology("UPDATE distant member = "+t,n.adjacentIds)):(this.distantMembers.set(t,{adjacentIds:e,missedHeartbeat:0}),this.wc.onMemberJoinProxy(t),C.topology("NEW distant member = "+t,e),this.updateAntecedentId()),!0}return C.topology("ABNORMAL update or create a distant member "+t+", but he is also an adjacent member"),!1},e.prototype.updateAntecedentId=function(){var t,e;if(this.adjacentMembers.size>0){var n=-1,r=-1;try{for(var i=y(this.wc.members),o=i.next();!o.done;o=i.next()){var s=o.value;s!==this.wc.myId&&(s<this.wc.myId&&s>r&&(r=s),n<s&&(n=s))}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}this.antecedentId=-1!==r?r:n}else this.antecedentId=0;C.topology("UPDATE, antecedentId = "+this.antecedentId+", members = ",JSON.stringify(this.wc.members))},e.SERVICE_ID=74315,e}($),ke={topology:G.FULL_MESH,signalingServer:"wss://signaling.netflux.coedit.re",rtcConfiguration:{iceServers:[{urls:"stun:stun3.l.google.com:19302"}]},autoRejoin:!0},Te=function(){function t(t){this.STREAM_ID=2;var e=f({},ke,t),n=e.topology,r=e.autoRejoin,i=e.rtcConfiguration,o=e.signalingServer;this.streamSubject=new s.Subject,this.idSubject=new s.Subject,this.topologyEnum=n,this.autoRejoin=r,this.rtcConfiguration=i,this.members=[],this._id=0,this.key="",this.myId=0,this.state=he.LEFT,this.rejoinEnabled=!1,this.rejoinTimer=void 0,this.topology={},this._onAlone=function(){},this.onMemberJoin=function(){},this.onMemberLeave=function(){},this.onMessage=function(){},this.onMyId=function(){},this.onStateChange=function(){},this.onSignalingStateChange=function(){},this.userMsg=new be,this.signaling=new fe(this,o),this.subscribeToSignalingState(),this.webSocketBuilder=new me(this),this.channelBuilder=new _e(this),this.setTopology(n),A&&this.subscribeToBrowserEvents()}return Object.defineProperty(t.prototype,"onIdChange",{get:function(){return this.idSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t,this.idSubject.next(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"messageFromStream",{get:function(){return this.streamSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onAlone",{set:function(t){this._onAlone=t},enumerable:!0,configurable:!0}),t.prototype.sendOverStream=function(t){this.topology.sendTo(t)},t.prototype.join=function(t){void 0===t&&(t=function(){for(var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",e=F(42),n="",r=0;r<42;r++)n+=t[e[r]%t.length];return n}()),function(t){if("string"!=typeof t)throw new Error('The key type "'+typeof t+'" is not a "string"');if(""===t)throw new Error("The key is an empty string");if(t.length>D)throw new Error("The key length of "+t.length+" exceeds the maximum of "+D+" characters")}(t),this.state===he.LEFT&&this.startJoin(t)},t.prototype.invite=function(t){var e,n;B(t);var r=U(t);try{for(var i=y(this.topology.neighbors),o=i.next();!o.done;o=i.next()){if(r===U(o.value.url))return}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}this.webSocketBuilder.connect(t,ve.WITH_JOINING,-1,-1,this.id).catch(function(e){return C.webgroup("Failed to invite the bot "+t+": "+e.message)})},t.prototype.leave=function(){this.state!==he.LEFT&&(this.key="",this.internalLeave())},t.prototype.send=function(t){var e,n;if(1!==this.members.length)try{for(var r=y(this.userMsg.encodeUserMessage(t)),i=r.next();!i.done;i=r.next()){var o=i.value;this.topology.send({senderId:this.myId,recipientId:0,serviceId:be.SERVICE_ID,content:o})}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},t.prototype.sendTo=function(t,e){var n,r;if(1!==this.members.length)try{for(var i=y(this.userMsg.encodeUserMessage(e)),o=i.next();!o.done;o=i.next()){var s=o.value;this.topology.sendTo({senderId:this.myId,recipientId:t,serviceId:be.SERVICE_ID,content:s})}}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}},t.prototype.onMemberJoinProxy=function(t){this.members.includes(t)||(this.members[this.members.length]=t,this.onMemberJoin(t))},t.prototype.onAdjacentMembersLeaveProxy=function(t){this.onMemberLeaveProxy(t)&&(1===this.members.length?(this._onAlone(),this.topology.leave()):this.signaling.state===$t.CHECKED&&this.topology.state===V.CONSTRUCTED&&this.signaling.check())},t.prototype.onDistantMembersLeaveProxy=function(t){this.onMemberLeaveProxy(t)},t.prototype.init=function(t,e){void 0===e&&(e=R()),C.webgroup("INIT"),this.id=e,this.myId=R(),this.members=[this.myId],this.key=t,this.rejoinEnabled=this.autoRejoin,this.onMyId(this.myId),this.rejoinTimer&&(clearTimeout(this.rejoinTimer),this.rejoinTimer=void 0),this.setState(he.JOINING)},t.prototype.clean=function(){C.webgroup("CLEAN"),this.rejoinTimer&&(clearTimeout(this.rejoinTimer),this.rejoinTimer=void 0),this.members=[],this.id=0,this.myId=0},t.prototype.setState=function(t){this.state!==t&&(C.webGroupState(he[t],this.myId),this.state=t,this.onStateChange(t))},t.prototype.setTopology=function(t){var e=this;this.topologyEnum=t,this.topology=new Ee(this),this.topology.onState.subscribe(function(t){switch(C.webgroup("Topology state: ",V[t]),t){case V.CONSTRUCTING:e.setState(he.JOINING);break;case V.CONSTRUCTED:e.signaling.state===$t.OPEN?e.signaling.check():e.signaling.state===$t.CHECKED?(e.setState(he.JOINED),e.signaling.check()):e.signaling.state===$t.CLOSED&&e.signaling.connect(e.key);break;case V.IDLE:switch(e.channelBuilder.clean(),e.userMsg.clean(),e.signaling.state){case $t.CLOSED:e.rejoinEnabled?e.rejoin():e.internalLeave();break;case $t.CONNECTING:e.setState(he.JOINING);break;case $t.OPEN:e.setState(he.JOINING),e.signaling.check();break;case $t.CHECKING:e.setState(he.JOINING);break;case $t.CHECKED:e.signaling.check()}}})},t.prototype.subscribeToSignalingState=function(){var t=this;this.signaling.onState.subscribe(function(e){switch(C.signalingState($t[e],t.myId),t.onSignalingStateChange(e),e){case $t.CLOSED:t.topology.state===V.IDLE?t.rejoinEnabled?t.rejoin():t.internalLeave():t.topology.state===V.CONSTRUCTED&&(1===t.members.length?t.topology.leave():t.rejoinEnabled&&!t.rejoinTimer&&t.reconnectToSignaling());break;case $t.OPEN:t.topology.state!==V.CONSTRUCTING&&t.signaling.check();break;case $t.CHECKED:t.topology.state===V.IDLE?t.signaling.connected&&t.topology.setJoinedState():t.topology.state===V.CONSTRUCTED&&t.setState(he.JOINED)}})},t.prototype.subscribeToBrowserEvents=function(){var t=this;window.addEventListener("online",function(){return t.onBrowserBack()}),window.addEventListener("visibilitychange",function(){return t.onBrowserBack()}),window.addEventListener("beforeunload",function(){return t.leave()})},t.prototype.startJoin=function(t){void 0===t&&(t=this.key),C.webgroup("start join..."),this.init(t),this.signaling.connect(t)},t.prototype.rejoin=function(){var t=this;this.setState(he.JOINING),P()&&L()?(this.clean(),C.webgroup("rejoin in 3000ms"),this.rejoinTimer=setTimeout(function(){t.signaling.state===$t.CLOSED&&P()&&L()&&t.rejoinEnabled?t.startJoin():(C.webgroup("abandon rejoin because: ",{isVisible:P(),isOnline:L(),signalingState:$t[t.signaling.state],rejoinEnabled:t.rejoinEnabled}),t.internalLeave()),t.rejoinTimer=void 0},3e3)):this.internalLeave()},t.prototype.reconnectToSignaling=function(){var t=this;1!==this.members.length||P()&&L()?(C.webgroup("reconnect to Signaling server in 3000ms"),this.setState(he.JOINING),this.rejoinTimer=setTimeout(function(){t.signaling.state===$t.CLOSED&&(P()&&L()?t.rejoinEnabled&&t.signaling.connect(t.key):1===t.members.length&&t.internalLeave()),t.rejoinTimer=void 0},3e3)):this.internalLeave()},t.prototype.onBrowserBack=function(){P()&&L()&&(C.webgroup("onBrowserBack",{isVisible:P(),isOnline:L()}),this.rejoinEnabled=this.autoRejoin,this.rejoinEnabled&&(this.state===he.LEFT?this.startJoin():this.signaling.state===$t.CLOSED&&this.signaling.connect(this.key)))},t.prototype.onMemberLeaveProxy=function(t){var e=this,n=!1;return t.forEach(function(t){e.members.includes(t)&&(e.members.splice(e.members.indexOf(t),1),n=!0,e.onMemberLeave(t))}),n},t.prototype.internalLeave=function(){C.webgroup("internal leave"),this.rejoinEnabled=!1,this.signaling.close(),this.topology.leave(),this.clean(),this.setState(he.LEFT)},t}(),Ce=new WeakMap,Me=function(){function t(t){void 0===t&&(t={});var e=new Te(t);Ce.set(this,e),this.id=void 0,Reflect.defineProperty(this,"id",{configurable:!1,enumerable:!0,get:function(){return e.id}}),this.myId=void 0,Reflect.defineProperty(this,"myId",{configurable:!1,enumerable:!0,get:function(){return e.myId}}),this.key=void 0,Reflect.defineProperty(this,"key",{configurable:!1,enumerable:!0,get:function(){return e.key}}),this.members=void 0,Reflect.defineProperty(this,"members",{configurable:!1,enumerable:!0,get:function(){return e.members}}),this.neighbors=void 0,Reflect.defineProperty(this,"neighbors",{configurable:!1,enumerable:!0,get:function(){return e.topology.neighbors.map(function(t){return t.id})}}),this.topology=void 0,Reflect.defineProperty(this,"topology",{configurable:!1,enumerable:!0,get:function(){return e.topologyEnum}}),this.state=void 0,Reflect.defineProperty(this,"state",{configurable:!1,enumerable:!0,get:function(){return e.state}}),this.signalingState=void 0,Reflect.defineProperty(this,"signalingState",{configurable:!1,enumerable:!0,get:function(){return e.signaling.state}}),this.signalingServer=void 0,Reflect.defineProperty(this,"signalingServer",{configurable:!1,enumerable:!0,get:function(){return e.signaling.url}}),this.autoRejoin=void 0,Reflect.defineProperty(this,"autoRejoin",{configurable:!1,enumerable:!0,get:function(){return e.autoRejoin},set:function(t){return e.autoRejoin=t}}),this.onMessage=void 0,Reflect.defineProperty(this,"onMessage",{configurable:!0,enumerable:!0,get:function(){return"none"===e.onMessage.name?void 0:e.onMessage},set:function(t){e.onMessage="function"!=typeof t?function(){}:t}}),this.onMyId=void 0,Reflect.defineProperty(this,"onMyId",{configurable:!0,enumerable:!0,get:function(){return"none"===e.onMyId.name?void 0:e.onMyId},set:function(t){e.onMyId="function"!=typeof t?function(){}:t}}),this.onMemberJoin=void 0,Reflect.defineProperty(this,"onMemberJoin",{configurable:!0,enumerable:!0,get:function(){return"none"===e.onMemberJoin.name?void 0:e.onMemberJoin},set:function(t){e.onMemberJoin="function"!=typeof t?function(){}:t}}),this.onMemberLeave=void 0,Reflect.defineProperty(this,"onMemberLeave",{configurable:!0,enumerable:!0,get:function(){return"none"===e.onMemberLeave.name?void 0:e.onMemberLeave},set:function(t){e.onMemberLeave="function"!=typeof t?function(){}:t}}),this.onStateChange=void 0,Reflect.defineProperty(this,"onStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===e.onStateChange.name?void 0:e.onStateChange},set:function(t){e.onStateChange="function"!=typeof t?function(){}:t}}),this.onSignalingStateChange=void 0,Reflect.defineProperty(this,"onSignalingStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===e.onSignalingStateChange.name?void 0:e.onSignalingStateChange},set:function(t){e.onSignalingStateChange="function"!=typeof t?function(){}:t}})}return t.prototype.join=function(t){var e=Ce.get(this);if(e)return e.join(t);throw new Error("WebChannel is undefined")},t.prototype.invite=function(t){var e=Ce.get(this);if(e)return e.invite(t);throw new Error("WebChannel is undefined")},t.prototype.leave=function(){var t=Ce.get(this);if(t)return t.leave();throw new Error("WebChannel is undefined")},t.prototype.send=function(t){var e=Ce.get(this);if(e)return e.send(t);throw new Error("WebChannel is undefined")},t.prototype.sendTo=function(t,e){var n=Ce.get(this);if(n)return n.sendTo(t,e);throw new Error("WebChannel is undefined")},t}(),je=(function(){function t(){}Object.defineProperty(t,"CONNECTING",{get:function(){return $t.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OPEN",{get:function(){return $t.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CLOSED",{get:function(){return $t.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CHECKING",{get:function(){return $t.CHECKING},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CHECKED",{get:function(){return $t.CHECKED},enumerable:!0,configurable:!0})}(),function(){function t(){}return Object.defineProperty(t,"JOINING",{get:function(){return he.JOINING},enumerable:!0,configurable:!0}),Object.defineProperty(t,"JOINED",{get:function(){return he.JOINED},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LEFT",{get:function(){return he.LEFT},enumerable:!0,configurable:!0}),t}()),Ne=(function(){function t(){}Object.defineProperty(t,"FULL_MESH",{get:function(){return G.FULL_MESH},enumerable:!0,configurable:!0})}(),function(){function t(){}Object.defineProperty(t,"DEBUG",{get:function(){return v.DEBUG},enumerable:!0,configurable:!0}),Object.defineProperty(t,"WEB_GROUP",{get:function(){return v.WEB_GROUP},enumerable:!0,configurable:!0}),Object.defineProperty(t,"WEBRTC",{get:function(){return v.WEBRTC},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CHANNEL",{get:function(){return v.CHANNEL},enumerable:!0,configurable:!0}),Object.defineProperty(t,"TOPOLOGY",{get:function(){return v.TOPOLOGY},enumerable:!0,configurable:!0}),Object.defineProperty(t,"SIGNALING",{get:function(){return v.SIGNALING},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CHANNEL_BUILDER",{get:function(){return v.CHANNEL_BUILDER},enumerable:!0,configurable:!0})}(),{url:"",perMessageDeflate:!1,leaveOnceAlone:!0,server:void 0,webGroupOptions:ke}),Ae=function(){function t(t){this.wcOptions=f({},ke,t.webGroupOptions);var e=f({},Ne,t),n=e.leaveOnceAlone,r=e.server,i=e.url,o=e.perMessageDeflate;this.leaveOnceAlone=n,this.server=r,this.listenUrl=i,this.perMessageDeflate=o,this.webGroups=new Map,this.onWebGroup=function(){},this.onError=function(){},this.init()}return Object.defineProperty(t.prototype,"url",{get:function(){if(""!==this.listenUrl)return this.listenUrl;var t=this.server.address();return"ws://"+t.address+":"+t.port},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.webSocketServer=new o.Server({perMessageDeflate:this.perMessageDeflate,verifyClient:function(e){return t.validateURLQuery(e)},server:this.server}),(this.server||this.webSocketServer).on("listening",function(){return me.listenUrl.next(t.url)}),this.webSocketServer.on("error",function(e){me.listenUrl.next(""),t.onError(e)}),this.webSocketServer.on("connection",function(e){var n,r=t.readURLQuery(e.upgradeReq.url),i=r.type,o=r.wcId,s=r.senderId,c=r.key,a=t.webGroups.get(o);if(i!==ve.WITH_MEMBER||void 0!==a&&a.state!==je.LEFT){if(void 0===a)return void e.close();n=Ce.get(a).webSocketBuilder}else{a=new Me(t.wcOptions),t.webGroups.set(o,a);var u=Ce.get(a);t.leaveOnceAlone&&(u.onAlone=function(){u.leave(),t.webGroups.delete(o)}),u.init(c,o),t.onWebGroup(a),u.onMyId(u.myId),n=u.webSocketBuilder}n.newWebSocket(e,s,i)})},t.prototype.validateURLQuery=function(t){try{var e=this.readURLQuery(t.req.url),n=e.type,r=e.wcId,i=e.key;switch(n){case ve.WITH_INTERNAL:return this.webGroups.has(r);case ve.WITH_MEMBER:var o=this.webGroups.get(r);return!!i&&(void 0===o||o.state===je.LEFT);case ve.WITH_JOINING:o=this.webGroups.get(r);return!!i&&void 0!==o&&o.key===i&&o.state!==je.LEFT;default:return!1}}catch(t){return C.warn(t.message),!1}},t.prototype.readURLQuery=function(t){var e="Query parse error: ",n=Object(a.parse)(t,!0).query,r=n.type,i=n.wcId,o=n.senderId,s=n.key;if("string"!=typeof r)throw new Error(e+'"type" parameter is not a string ');if("string"!=typeof i)throw new Error(e+'"wcId" parameter is not a string ');if("string"!=typeof o)throw new Error(e+'"senderId" parameter is not a string ');if("string"!=typeof s&&void 0!==s)throw new Error(e+'"type" parameter is not a string ');if(!r)throw new Error(e+'"type" parameter is undefined');if(!i)throw new Error(e+'"wcId" parameter is undefined');if(!o)throw new Error(e+'"senderId" parameter is undefined');return{type:Number.parseInt(r,10),wcId:Number.parseInt(i,10),senderId:Number.parseInt(o,10),key:s}},t}(),Le=function(){return function(t){Ie=new Ae(t),this.server=void 0,Reflect.defineProperty(this,"server",{configurable:!1,enumerable:!0,get:function(){return Ie.server}}),this.perMessageDeflate=void 0,Reflect.defineProperty(this,"perMessageDeflate",{configurable:!1,enumerable:!0,get:function(){return Ie.perMessageDeflate}}),this.leaveOnceAlone=void 0,Reflect.defineProperty(this,"leaveOnceAlone",{configurable:!1,enumerable:!0,get:function(){return Ie.leaveOnceAlone}}),this.webGroups=void 0,Reflect.defineProperty(this,"webGroups",{configurable:!1,enumerable:!0,get:function(){return Ie.webGroups}}),this.url=void 0,Reflect.defineProperty(this,"url",{configurable:!1,enumerable:!0,get:function(){return Ie.url}}),this.onWebGroup=void 0,Reflect.defineProperty(this,"onWebGroup",{configurable:!0,enumerable:!0,get:function(){return"none"===Ie.onWebGroup.name?void 0:Ie.onWebGroup},set:function(t){Ie.onWebGroup="function"!=typeof t?function(){}:t}}),this.onError=void 0,Reflect.defineProperty(this,"onError",{configurable:!0,enumerable:!0,get:function(){return"none"===Ie.onError.name?void 0:Ie.onError},set:function(t){Ie.onError="function"!=typeof t?function(){}:t}})}}()},function(t,e,n){"use strict";n.r(e),n.d(e,"KeyState",function(){return i}),n.d(e,"Symmetric",function(){return j}),n.d(e,"KeyAgreementBD",function(){return Ht}),n.d(e,"enableDebug",function(){return E}),n.d(e,"Streams",function(){return C}),n.d(e,"MuteCrypto",function(){return M});var r=n(0);n.d(e,"asymmetricCrypto",function(){return r.asymmetricCrypto});var i,o=n(11),s={};!function(t){t[t.UNDEFINED=0]="UNDEFINED",t[t.CALCUL_IN_PROGRESS=1]="CALCUL_IN_PROGRESS",t[t.READY=2]="READY"}(i||(i={}));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var c=function(t,e){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function a(t,e){function n(){this.constructor=t}c(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function u(t,e,n,r){return new(n||(n=Promise))(function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(s,c)}a((r=r.apply(t,e||[])).next())})}function l(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}function h(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function f(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function p(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t}var d=["%cMUTE CRYPTO:%c ","background-color: #81C784; padding: 0 2px",""],y=["%cMUTE CRYPTO ERROR:%c ","background-color: #81C784; padding: 0 2px",""],b=["%cMUTE CRYPTO:%c %cPERFORMANCE:%c ","background-color: #81C784; padding: 0 2px","","background-color: #FFCC80; padding: 0 2px",""],g={debug:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return console.log.apply(console,p(d,t))},error:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return console.error.apply(console,p(y,t))}},v={debug:function(){},error:function(){}},m=v,w=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];console.assert.apply(console,p([t,"MUTE-CRYPTO: "+e],n))},S=function(){},I=S,O={mark:function(t){return s.performance.mark(t)},measure:function(t,e,n){s.performance.measure(t,e,n);var r=s.performance.getEntriesByName(t)[0];console.log.apply(console,p(b,[r.name+" = "+r.duration.toFixed(0)+"ms"])),s.performance.clearMeasures()}},x={mark:function(){},measure:function(){}},_=x;function E(t){void 0===t&&(t=!0),t?(m=g,I=w,_=O):(m=v,I=S,_=x)}function k(t){for(var e,n=0,r=t.length,i="";n<r;)e=t.subarray(n,Math.min(n+32768,r)),i+=String.fromCharCode.apply(null,e),n+=32768;return T(i).substr(0,20)+"..."}function T(t){return"undefined"==typeof window?new Buffer(t).toString("base64"):window.btoa(t)}var C,M=function(){function t(){this.onStateChange=function(){},this.state=i.UNDEFINED}return t.generateKey=function(){return u(this,void 0,void 0,function(){var t,e;return l(this,function(n){switch(n.label){case 0:return[4,r.symmetricCrypto.generateEncryptionKey()];case 1:return t=n.sent(),[4,r.symmetricCrypto.exportKey(t)];case 2:return e=n.sent(),[2,r.symmetricCrypto.toB64(e)]}})})},t.prototype.setState=function(t){this.state!==t&&(m.debug("key state = "+i[t]),this.state=t,this.onStateChange(this.state))},t}(),j=function(t){function e(){var e=t.call(this)||this;return e.key=void 0,e}return a(e,t),e.prototype.importKey=function(e){return u(this,void 0,void 0,function(){var n;return l(this,function(o){switch(o.label){case 0:return n=this,[4,r.symmetricCrypto.importKey(r.symmetricCrypto.fromB64(e))];case 1:return n.key=o.sent(),t.prototype.setState.call(this,i.READY),[2]}})})},e.prototype.encrypt=function(t){return u(this,void 0,void 0,function(){return l(this,function(e){if(this.key)return[2,r.symmetricCrypto.encrypt(t,this.key)];throw new Error("Cryptographic key is not ready yet.")})})},e.prototype.decrypt=function(t){return u(this,void 0,void 0,function(){return l(this,function(e){if(this.key)return[2,r.symmetricCrypto.decrypt(t,this.key)];throw new Error("Cryptographic key is not ready yet.")})})},e}(M);!function(t){t[t.KEY_AGREEMENT_BD=700]="KEY_AGREEMENT_BD"}(C||(C={}));var N=function(){function t(t,e,n){this.value=t,this.initiatorId=e,this.initiatorCounter=n}return t.prototype.isEqual=function(t,e){return this.initiatorId===t&&this.initiatorCounter===e},t}(),A=function(){function t(t,e,n,i,o,s){_.mark("start cycle"),this.id=t,this.myId=i,this.myMembers=s,this.isZBroadcasted=!1,this.isXBroadcasted=!1,this.isFinished=!1,this.firstXadded=!1,this.counter=e,this.members=n,this.send=o,this._onKey=function(){},this.r=r.keyAgreementCrypto.generateRi(),_.mark("R ready"),this.z=r.keyAgreementCrypto.computeZi(this.r),_.mark("Z ready"),this.zArray=new Array(n.length),this.zArray[n.indexOf(i)]=this.z,this.xArray=new Array(n.length)}return t.prototype.addX=function(t,e){this.xArray[t]=e,this.firstXadded||_.mark("start X array"),this.firstXadded=!0},Object.defineProperty(t.prototype,"onKey",{set:function(t){this._onKey=t},enumerable:!0,configurable:!0}),t.prototype.isReadyToBroadcastZ=function(t){return this.members.every(function(e){return t.includes(e)})},t.prototype.checkZArray=function(t,e){var n,i;if(this.isXBroadcasted)this.debug("checkZArray abort -> X broadcasted already");else if(this.members.every(function(t){return e.includes(t)})){try{for(var o=h(this.zArray),s=o.next();!s.done;s=o.next()){if(void 0===s.value)return void this.debug("checkZArray abort -> missing Z value")}}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}_.mark("Z array ready"),this.debug("checkZArray OK");var c=this.members.indexOf(t),a=(c+1)%this.members.length,u=(this.members.length+c-1)%this.members.length,l=r.keyAgreementCrypto.computeXi(this.r,this.zArray[a],this.zArray[u]);_.mark("X ready"),this.assert(void 0===this.xArray[c],"Setting my X value twice"),this.addX(c,l),this.broadcastX(l),this.checkXArray(t,e)}else this.debug("checkZArray abort -> missing a member")},t.prototype.checkXArray=function(t,e){return u(this,void 0,void 0,function(){var n,i,o,s,c,a,u,f,p;return l(this,function(l){switch(l.label){case 0:if(this.isFinished)return this.debug("checkXArray abort -> key computed already"),[2];if(!this.members.every(function(t){return e.includes(t)}))return this.debug("checkXArray abort -> missing a member"),[2];try{for(o=h(this.xArray),s=o.next();!s.done;s=o.next())if(void 0===s.value)return this.debug("checkXArray abort -> missing X value"),[2]}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return _.mark("X array ready"),this.isFinished=!0,this.debug("checkXArray OK"),c=this.members.indexOf(t),a=(this.members.length+c-1)%this.members.length,u=r.keyAgreementCrypto.computeSharedSecret(this.r,this.xArray[c],this.zArray[a],this.xArray),p=N.bind,[4,r.keyAgreementCrypto.deriveKey(u)];case 1:return f=new(p.apply(N,[void 0,l.sent(),this.id,this.counter])),_.mark("end cycle"),_.measure("R","start cycle","R ready"),_.measure("Z","R ready","Z ready"),_.measure("X","Z array ready","X ready"),_.measure("Z array full","Z ready","Z array ready"),_.measure("X array full","start X array","X array ready"),_.measure("secret key","X array ready","end cycle"),_.measure(this.id+"("+this.counter+"): cycle","start cycle","end cycle"),this._onKey(f),[2]}})})},t.prototype.debug=function(t){m.debug(this.id+"("+this.counter+"): "+t+": ",this.formatCycle())},t.prototype.assert=function(t,e){I(t,this.id+"("+this.counter+"): "+e,this.formatCycle())},t.prototype.broadcastZ=function(){this.send({initiator:{id:this.id,counter:this.counter,members:this.members},z:this.z}),this.isZBroadcasted=!0,m.debug("broadcast my Z value")},t.prototype.broadcastX=function(t){this.send({initiator:{id:this.id,counter:this.counter,members:this.members},x:t}),this.isXBroadcasted=!0,this.debug("broadcast my X value")},t.prototype.formatCycle=function(){return{initiatorId:this.id,initiatorCounter:this.counter,initiatorMembers:this.members.slice(),myId:this.myId,myMembers:this.myMembers.slice(),zArray:this.zArray.map(function(t){var e="";return t.forEach(function(t){return e+=String.fromCharCode(t)}),T(e).substring(0,7)}),xArray:this.xArray.map(function(t){var e="";return t.forEach(function(t){return e+=String.fromCharCode(t)}),T(e).substring(0,7)})}},t}(),L="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function P(t,e){return t(e={exports:{}},e.exports),e.exports}var B=function(t,e){var n=new Array(arguments.length-1),r=0,i=2,o=!0;for(;i<arguments.length;)n[r++]=arguments[i++];return new Promise(function(i,s){n[r]=function(t){if(o)if(o=!1,t)s(t);else{for(var e=new Array(arguments.length-1),n=0;n<e.length;)e[n++]=arguments[n];i.apply(null,e)}};try{t.apply(e||null,n)}catch(t){o&&(o=!1,s(t))}})};var R=P(function(t,e){var n=e;n.length=function(t){var e=t.length;if(!e)return 0;for(var n=0;--e%4>1&&"="===t.charAt(e);)++n;return Math.ceil(3*t.length)/4-n};for(var r=new Array(64),i=new Array(123),o=0;o<64;)i[r[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;n.encode=function(t,e,n){for(var i,o=null,s=[],c=0,a=0;e<n;){var u=t[e++];switch(a){case 0:s[c++]=r[u>>2],i=(3&u)<<4,a=1;break;case 1:s[c++]=r[i|u>>4],i=(15&u)<<2,a=2;break;case 2:s[c++]=r[i|u>>6],s[c++]=r[63&u],a=0}c>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,s)),c=0)}return a&&(s[c++]=r[i],s[c++]=61,1===a&&(s[c++]=61)),o?(c&&o.push(String.fromCharCode.apply(String,s.slice(0,c))),o.join("")):String.fromCharCode.apply(String,s.slice(0,c))};n.decode=function(t,e,n){for(var r,o=n,s=0,c=0;c<t.length;){var a=t.charCodeAt(c++);if(61===a&&s>1)break;if(void 0===(a=i[a]))throw Error("invalid encoding");switch(s){case 0:r=a,s=1;break;case 1:e[n++]=r<<2|(48&a)>>4,r=a,s=2;break;case 2:e[n++]=(15&r)<<4|(60&a)>>2,r=a,s=3;break;case 3:e[n++]=(3&r)<<6|a,s=0}}if(1===s)throw Error("invalid encoding");return n-o},n.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}}),D=U;function U(){this._listeners={}}U.prototype.on=function(t,e,n){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:n||this}),this},U.prototype.off=function(t,e){if(void 0===t)this._listeners={};else if(void 0===e)this._listeners[t]=[];else for(var n=this._listeners[t],r=0;r<n.length;)n[r].fn===e?n.splice(r,1):++r;return this},U.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var n=[],r=1;r<arguments.length;)n.push(arguments[r++]);for(r=0;r<e.length;)e[r].fn.apply(e[r++].ctx,n)}return this};var F=z(z);function z(t){return"undefined"!=typeof Float32Array?function(){var e=new Float32Array([-0]),n=new Uint8Array(e.buffer),r=128===n[3];function i(t,r,i){e[0]=t,r[i]=n[0],r[i+1]=n[1],r[i+2]=n[2],r[i+3]=n[3]}function o(t,r,i){e[0]=t,r[i]=n[3],r[i+1]=n[2],r[i+2]=n[1],r[i+3]=n[0]}function s(t,r){return n[0]=t[r],n[1]=t[r+1],n[2]=t[r+2],n[3]=t[r+3],e[0]}function c(t,r){return n[3]=t[r],n[2]=t[r+1],n[1]=t[r+2],n[0]=t[r+3],e[0]}t.writeFloatLE=r?i:o,t.writeFloatBE=r?o:i,t.readFloatLE=r?s:c,t.readFloatBE=r?c:s}():function(){function e(t,e,n,r){var i=e<0?1:0;if(i&&(e=-e),0===e)t(1/e>0?0:2147483648,n,r);else if(isNaN(e))t(2143289344,n,r);else if(e>3.4028234663852886e38)t((i<<31|2139095040)>>>0,n,r);else if(e<1.1754943508222875e-38)t((i<<31|Math.round(e/1.401298464324817e-45))>>>0,n,r);else{var o=Math.floor(Math.log(e)/Math.LN2);t((i<<31|o+127<<23|8388607&Math.round(e*Math.pow(2,-o)*8388608))>>>0,n,r)}}function n(t,e,n){var r=t(e,n),i=2*(r>>31)+1,o=r>>>23&255,s=8388607&r;return 255===o?s?NaN:i*(1/0):0===o?1.401298464324817e-45*i*s:i*Math.pow(2,o-150)*(s+8388608)}t.writeFloatLE=e.bind(null,G),t.writeFloatBE=e.bind(null,V),t.readFloatLE=n.bind(null,W),t.readFloatBE=n.bind(null,$)}(),"undefined"!=typeof Float64Array?function(){var e=new Float64Array([-0]),n=new Uint8Array(e.buffer),r=128===n[7];function i(t,r,i){e[0]=t,r[i]=n[0],r[i+1]=n[1],r[i+2]=n[2],r[i+3]=n[3],r[i+4]=n[4],r[i+5]=n[5],r[i+6]=n[6],r[i+7]=n[7]}function o(t,r,i){e[0]=t,r[i]=n[7],r[i+1]=n[6],r[i+2]=n[5],r[i+3]=n[4],r[i+4]=n[3],r[i+5]=n[2],r[i+6]=n[1],r[i+7]=n[0]}function s(t,r){return n[0]=t[r],n[1]=t[r+1],n[2]=t[r+2],n[3]=t[r+3],n[4]=t[r+4],n[5]=t[r+5],n[6]=t[r+6],n[7]=t[r+7],e[0]}function c(t,r){return n[7]=t[r],n[6]=t[r+1],n[5]=t[r+2],n[4]=t[r+3],n[3]=t[r+4],n[2]=t[r+5],n[1]=t[r+6],n[0]=t[r+7],e[0]}t.writeDoubleLE=r?i:o,t.writeDoubleBE=r?o:i,t.readDoubleLE=r?s:c,t.readDoubleBE=r?c:s}():function(){function e(t,e,n,r,i,o){var s=r<0?1:0;if(s&&(r=-r),0===r)t(0,i,o+e),t(1/r>0?0:2147483648,i,o+n);else if(isNaN(r))t(0,i,o+e),t(2146959360,i,o+n);else if(r>1.7976931348623157e308)t(0,i,o+e),t((s<<31|2146435072)>>>0,i,o+n);else{var c;if(r<2.2250738585072014e-308)t((c=r/5e-324)>>>0,i,o+e),t((s<<31|c/4294967296)>>>0,i,o+n);else{var a=Math.floor(Math.log(r)/Math.LN2);1024===a&&(a=1023),t(4503599627370496*(c=r*Math.pow(2,-a))>>>0,i,o+e),t((s<<31|a+1023<<20|1048576*c&1048575)>>>0,i,o+n)}}}function n(t,e,n,r,i){var o=t(r,i+e),s=t(r,i+n),c=2*(s>>31)+1,a=s>>>20&2047,u=4294967296*(1048575&s)+o;return 2047===a?u?NaN:c*(1/0):0===a?5e-324*c*u:c*Math.pow(2,a-1075)*(u+4503599627370496)}t.writeDoubleLE=e.bind(null,G,0,4),t.writeDoubleBE=e.bind(null,V,4,0),t.readDoubleLE=n.bind(null,W,0,4),t.readDoubleBE=n.bind(null,$,4,0)}(),t}function G(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}function V(t,e,n){e[n]=t>>>24,e[n+1]=t>>>16&255,e[n+2]=t>>>8&255,e[n+3]=255&t}function W(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function $(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}var q=function(t){return null};var H=P(function(t,e){var n=e;n.length=function(t){for(var e=0,n=0,r=0;r<t.length;++r)(n=t.charCodeAt(r))<128?e+=1:n<2048?e+=2:55296==(64512&n)&&56320==(64512&t.charCodeAt(r+1))?(++r,e+=4):e+=3;return e},n.read=function(t,e,n){if(n-e<1)return"";for(var r,i=null,o=[],s=0;e<n;)(r=t[e++])<128?o[s++]=r:r>191&&r<224?o[s++]=(31&r)<<6|63&t[e++]:r>239&&r<365?(r=((7&r)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,o[s++]=55296+(r>>10),o[s++]=56320+(1023&r)):o[s++]=(15&r)<<12|(63&t[e++])<<6|63&t[e++],s>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),s=0);return i?(s&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))},n.write=function(t,e,n){for(var r,i,o=n,s=0;s<t.length;++s)(r=t.charCodeAt(s))<128?e[n++]=r:r<2048?(e[n++]=r>>6|192,e[n++]=63&r|128):55296==(64512&r)&&56320==(64512&(i=t.charCodeAt(s+1)))?(r=65536+((1023&r)<<10)+(1023&i),++s,e[n++]=r>>18|240,e[n++]=r>>12&63|128,e[n++]=r>>6&63|128,e[n++]=63&r|128):(e[n++]=r>>12|224,e[n++]=r>>6&63|128,e[n++]=63&r|128);return n-o}}),K=function(t,e,n){var r=n||8192,i=r>>>1,o=null,s=r;return function(n){if(n<1||n>i)return t(n);s+n>r&&(o=t(r),s=0);var c=e.call(o,s,s+=n);return 7&s&&(s=1+(7|s)),c}};var J=X;function X(t,e){this.lo=t>>>0,this.hi=e>>>0}var Z=X.zero=new X(0,0);Z.toNumber=function(){return 0},Z.zzEncode=Z.zzDecode=function(){return this},Z.length=function(){return 1};var Y=X.zeroHash="\0\0\0\0\0\0\0\0";X.fromNumber=function(t){if(0===t)return Z;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new X(n,r)},X.from=function(t){if("number"==typeof t)return X.fromNumber(t);if(et.isString(t)){if(!et.Long)return X.fromNumber(parseInt(t,10));t=et.Long.fromString(t)}return t.low||t.high?new X(t.low>>>0,t.high>>>0):Z},X.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},X.prototype.toLong=function(t){return et.Long?new et.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var Q=String.prototype.charCodeAt;X.fromHash=function(t){return t===Y?Z:new X((Q.call(t,0)|Q.call(t,1)<<8|Q.call(t,2)<<16|Q.call(t,3)<<24)>>>0,(Q.call(t,4)|Q.call(t,5)<<8|Q.call(t,6)<<16|Q.call(t,7)<<24)>>>0)},X.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},X.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},X.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},X.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10};var tt,et=P(function(t,e){var n=e;function r(t,e,n){for(var r=Object.keys(e),i=0;i<r.length;++i)void 0!==t[r[i]]&&n||(t[r[i]]=e[r[i]]);return t}function i(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(e.prototype=Object.create(Error.prototype)).constructor=e,Object.defineProperty(e.prototype,"name",{get:function(){return t}}),e.prototype.toString=function(){return this.name+": "+this.message},e}n.asPromise=B,n.base64=R,n.EventEmitter=D,n.float=F,n.inquire=q,n.utf8=H,n.pool=K,n.LongBits=J,n.global="undefined"!=typeof window&&window||void 0!==L&&L||"undefined"!=typeof self&&self||L,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=Boolean(n.global.process&&n.global.process.versions&&n.global.process.versions.node),n.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},n.isString=function(t){return"string"==typeof t||t instanceof String},n.isObject=function(t){return t&&"object"==typeof t},n.isset=n.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},n.Buffer=function(){try{var t=n.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(t){return"number"==typeof t?n.Buffer?n._Buffer_allocUnsafe(t):new n.Array(t):n.Buffer?n._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=n.global.dcodeIO&&n.global.dcodeIO.Long||n.global.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(t){return t?n.LongBits.from(t).toHash():n.LongBits.zeroHash},n.longFromHash=function(t,e){var r=n.LongBits.fromHash(t);return n.Long?n.Long.fromBits(r.lo,r.hi,e):r.toNumber(Boolean(e))},n.merge=r,n.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},n.newError=i,n.ProtocolError=i("ProtocolError"),n.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},n.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var t=n.Buffer;t?(n._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},n._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):n._Buffer_from=n._Buffer_allocUnsafe=null}}),nt=at,rt=et.LongBits,it=et.base64,ot=et.utf8;function st(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function ct(){}function at(){this.len=0,this.head=new st(ct,0,0),this.tail=this.head,this.states=null}function ut(t,e,n){e[n]=255&t}function lt(t,e){this.len=t,this.next=void 0,this.val=e}function ht(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function ft(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}at.create=et.Buffer?function(){return(at.create=function(){return new tt})()}:function(){return new at},at.alloc=function(t){return new et.Array(t)},et.Array!==Array&&(at.alloc=et.pool(at.alloc,et.Array.prototype.subarray)),at.prototype._push=function(t,e,n){return this.tail=this.tail.next=new st(t,e,n),this.len+=e,this},lt.prototype=Object.create(st.prototype),lt.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},at.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new lt((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},at.prototype.int32=function(t){return t<0?this._push(ht,10,rt.fromNumber(t)):this.uint32(t)},at.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},at.prototype.uint64=function(t){var e=rt.from(t);return this._push(ht,e.length(),e)},at.prototype.int64=at.prototype.uint64,at.prototype.sint64=function(t){var e=rt.from(t).zzEncode();return this._push(ht,e.length(),e)},at.prototype.bool=function(t){return this._push(ut,1,t?1:0)},at.prototype.fixed32=function(t){return this._push(ft,4,t>>>0)},at.prototype.sfixed32=at.prototype.fixed32,at.prototype.fixed64=function(t){var e=rt.from(t);return this._push(ft,4,e.lo)._push(ft,4,e.hi)},at.prototype.sfixed64=at.prototype.fixed64,at.prototype.float=function(t){return this._push(et.float.writeFloatLE,4,t)},at.prototype.double=function(t){return this._push(et.float.writeDoubleLE,8,t)};var pt=et.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};at.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(ut,1,0);if(et.isString(t)){var n=at.alloc(e=it.length(t));it.decode(t,n,0),t=n}return this.uint32(e)._push(pt,e,t)},at.prototype.string=function(t){var e=ot.length(t);return e?this.uint32(e)._push(ot.write,e,t):this._push(ut,1,0)},at.prototype.fork=function(){return this.states=new function(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}(this),this.head=this.tail=new st(ct,0,0),this.len=0,this},at.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new st(ct,0,0),this.len=0),this},at.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},at.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},at._configure=function(t){tt=t};var dt=bt;(bt.prototype=Object.create(nt.prototype)).constructor=bt;var yt=et.Buffer;function bt(){nt.call(this)}bt.alloc=function(t){return(bt.alloc=et._Buffer_allocUnsafe)(t)};var gt=yt&&yt.prototype instanceof Uint8Array&&"set"===yt.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]};function vt(t,e,n){t.length<40?et.utf8.write(t,e,n):e.utf8Write(t,n)}bt.prototype.bytes=function(t){et.isString(t)&&(t=et._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(gt,e,t),this},bt.prototype.string=function(t){var e=yt.byteLength(t);return this.uint32(e),e&&this._push(vt,e,t),this};var mt,wt=xt,St=et.LongBits,It=et.utf8;function Ot(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function xt(t){this.buf=t,this.pos=0,this.len=t.length}var _t="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new xt(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new xt(t);throw Error("illegal buffer")};function Et(){var t=new St(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw Ot(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw Ot(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function kt(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function Tt(){if(this.pos+8>this.len)throw Ot(this,8);return new St(kt(this.buf,this.pos+=4),kt(this.buf,this.pos+=4))}xt.create=et.Buffer?function(t){return(xt.create=function(t){return et.Buffer.isBuffer(t)?new mt(t):_t(t)})(t)}:_t,xt.prototype._slice=et.Array.prototype.subarray||et.Array.prototype.slice,xt.prototype.uint32=function(){var t=4294967295;return function(){if(t=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return t;if((this.pos+=5)>this.len)throw this.pos=this.len,Ot(this,10);return t}}(),xt.prototype.int32=function(){return 0|this.uint32()},xt.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},xt.prototype.bool=function(){return 0!==this.uint32()},xt.prototype.fixed32=function(){if(this.pos+4>this.len)throw Ot(this,4);return kt(this.buf,this.pos+=4)},xt.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Ot(this,4);return 0|kt(this.buf,this.pos+=4)},xt.prototype.float=function(){if(this.pos+4>this.len)throw Ot(this,4);var t=et.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},xt.prototype.double=function(){if(this.pos+8>this.len)throw Ot(this,4);var t=et.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},xt.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw Ot(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},xt.prototype.string=function(){var t=this.bytes();return It.read(t,0,t.length)},xt.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw Ot(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw Ot(this)}while(128&this.buf[this.pos++]);return this},xt.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},xt._configure=function(t){mt=t;var e=et.Long?"toLong":"toNumber";et.merge(xt.prototype,{int64:function(){return Et.call(this)[e](!1)},uint64:function(){return Et.call(this)[e](!0)},sint64:function(){return Et.call(this).zzDecode()[e](!1)},fixed64:function(){return Tt.call(this)[e](!0)},sfixed64:function(){return Tt.call(this)[e](!1)}})};var Ct=Mt;function Mt(t){wt.call(this,t)}(Mt.prototype=Object.create(wt.prototype)).constructor=Mt,et.Buffer&&(Mt.prototype._slice=et.Buffer.prototype.slice),Mt.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len))};var jt=Nt;function Nt(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");et.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(Nt.prototype=Object.create(et.EventEmitter.prototype)).constructor=Nt,Nt.prototype.rpcCall=function t(e,n,r,i,o){if(!i)throw TypeError("request must be specified");var s=this;if(!o)return et.asPromise(t,s,e,n,r,i);if(s.rpcImpl)try{return s.rpcImpl(e,n[s.requestDelimited?"encodeDelimited":"encode"](i).finish(),function(t,n){if(t)return s.emit("error",t,e),o(t);if(null!==n){if(!(n instanceof r))try{n=r[s.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return s.emit("error",t,e),o(t)}return s.emit("data",n,e),o(null,n)}s.end(!0)})}catch(t){return s.emit("error",t,e),void setTimeout(function(){o(t)},0)}else setTimeout(function(){o(Error("already ended"))},0)},Nt.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};var At=P(function(t,e){e.Service=jt}),Lt={},Pt=P(function(t,e){var n=e;function r(){n.Reader._configure(n.BufferReader),n.util._configure()}n.build="minimal",n.Writer=nt,n.BufferWriter=dt,n.Reader=wt,n.BufferReader=Ct,n.util=et,n.rpc=At,n.roots=Lt,n.configure=r,n.Writer._configure(n.BufferWriter),r()}),Bt=Pt.Reader,Rt=Pt.Writer,Dt=Pt.util,Ut=Pt.roots;const Ft=Bt,zt=Rt,Gt=Dt,Vt=Ut.default||(Ut.default={}),Wt=Vt.Message=(()=>{function t(t){if(t)for(let e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.content=Gt.newBuffer([]),t.prototype.signature=Gt.newBuffer([]),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=zt.create()),null!=t.content&&t.hasOwnProperty("content")&&e.uint32(10).bytes(t.content),null!=t.signature&&t.hasOwnProperty("signature")&&e.uint32(18).bytes(t.signature),e},t.decode=function(t,e){t instanceof Ft||(t=Ft.create(t));let n=void 0===e?t.len:t.pos+e,r=new Vt.Message;for(;t.pos<n;){let e=t.uint32();switch(e>>>3){case 1:r.content=t.bytes();break;case 2:r.signature=t.bytes();break;default:t.skipType(7&e)}}return r},t})(),$t=Vt.Content=(()=>{function t(t){if(t)for(let e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}let e;return t.prototype.initiator=null,t.prototype.z=Gt.newBuffer([]),t.prototype.x=Gt.newBuffer([]),Object.defineProperty(t.prototype,"type",{get:Gt.oneOfGetter(e=["z","x"]),set:Gt.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=zt.create()),null!=t.initiator&&t.hasOwnProperty("initiator")&&Vt.Initiator.encode(t.initiator,e.uint32(10).fork()).ldelim(),null!=t.z&&t.hasOwnProperty("z")&&e.uint32(18).bytes(t.z),null!=t.x&&t.hasOwnProperty("x")&&e.uint32(26).bytes(t.x),e},t.decode=function(t,e){t instanceof Ft||(t=Ft.create(t));let n=void 0===e?t.len:t.pos+e,r=new Vt.Content;for(;t.pos<n;){let e=t.uint32();switch(e>>>3){case 1:r.initiator=Vt.Initiator.decode(t,t.uint32());break;case 2:r.z=t.bytes();break;case 3:r.x=t.bytes();break;default:t.skipType(7&e)}}return r},t})(),qt=(Vt.Initiator=(()=>{function t(t){if(this.members=[],t)for(let e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.counter=0,t.prototype.members=Gt.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=zt.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).uint32(t.id),null!=t.counter&&t.hasOwnProperty("counter")&&e.uint32(16).uint32(t.counter),null!=t.members&&t.members.length){e.uint32(26).fork();for(let n=0;n<t.members.length;++n)e.uint32(t.members[n]);e.ldelim()}return e},t.decode=function(t,e){t instanceof Ft||(t=Ft.create(t));let n=void 0===e?t.len:t.pos+e,r=new Vt.Initiator;for(;t.pos<n;){let e=t.uint32();switch(e>>>3){case 1:r.id=t.uint32();break;case 2:r.counter=t.uint32();break;case 3:if(r.members&&r.members.length||(r.members=[]),2==(7&e)){let e=t.uint32()+t.pos;for(;t.pos<e;)r.members.push(t.uint32())}else r.members.push(t.uint32());break;default:t.skipType(7&e)}}return r},t})(),Vt.CipherMessage=(()=>{function t(t){if(t)for(let e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.counter=0,t.prototype.content=Gt.newBuffer([]),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=zt.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).uint32(t.id),null!=t.counter&&t.hasOwnProperty("counter")&&e.uint32(16).uint32(t.counter),null!=t.content&&t.hasOwnProperty("content")&&e.uint32(26).bytes(t.content),e},t.decode=function(t,e){t instanceof Ft||(t=Ft.create(t));let n=void 0===e?t.len:t.pos+e,r=new Vt.CipherMessage;for(;t.pos<n;){let e=t.uint32();switch(e>>>3){case 1:r.id=t.uint32();break;case 2:r.counter=t.uint32();break;case 3:r.content=t.bytes();break;default:t.skipType(7&e)}}return r},t})());var Ht=function(t){function e(){var e=t.call(this)||this;return e._signingKey=void 0,e.myCounter=0,e.cycles=new Map,e.members=[],e.send=function(){},e.myId=0,e.key=void 0,e.previousKey=void 0,e.isReady=!1,e}return a(e,t),e.prototype.encrypt=function(t){return u(this,void 0,void 0,function(){var e;return l(this,function(n){switch(n.label){case 0:return this.key?[4,r.symmetricCrypto.encrypt(t,this.key.value)]:[3,2];case 1:return e=n.sent(),[2,qt.encode(qt.create({id:this.key.initiatorId,counter:this.key.initiatorCounter,content:e})).finish()];case 2:throw m.debug("Failed to encrypt a message: cryptographic key is not ready yet"),new Error("Failed to encrypt a message: cryptographic key is not ready yet")}})})},e.prototype.decrypt=function(t){return u(this,void 0,void 0,function(){var e,n,i,o;return l(this,function(s){if(this.key){if(e=qt.decode(t),n=e.id,i=e.counter,o=e.content,this.key.isEqual(n,i))return[2,r.symmetricCrypto.decrypt(o,this.key.value)];if(this.previousKey&&this.previousKey.isEqual(n,i))return[2,r.symmetricCrypto.decrypt(o,this.previousKey.value)]}throw m.debug("Failed to decrypt a message"),new Error("Failed to decrypt a message")})})},Object.defineProperty(e.prototype,"signingKey",{set:function(t){this._signingKey=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onSend",{set:function(t){var e=this;this.send=function(n){var i=$t.encode($t.create(n)).finish();e._signingKey?r.asymmetricCrypto.sign(i,e._signingKey).then(function(e){m.debug("Signing message: ",{signature:k(e)}),t(Wt.encode(Wt.create({content:i,signature:e})).finish(),C.KEY_AGREEMENT_BD)}).catch(function(t){return m.error("Signing failed: ",t)}):t(Wt.encode(Wt.create({content:i})).finish(),C.KEY_AGREEMENT_BD)}},enumerable:!0,configurable:!0}),e.prototype.addMember=function(t){this.members.push(t),this.members.sort(function(t,e){return t-e}),m.debug("MEMBER Joined: ",{id:t,currentMembers:this.members.slice()}),this.checkCycles()},e.prototype.removeMember=function(t){var e=this.members.indexOf(t);-1!==e&&this.members.splice(e,1),m.debug("MEMBER Left: ",{id:t,currentMembers:this.members.slice()}),this.checkCycles()},e.prototype.onMessage=function(e,n,o){return u(this,void 0,void 0,function(){var s,c,a,u,h,f,p,d,y,b,g,v;return l(this,function(l){switch(l.label){case 0:return s=Wt.decode(n),c=s.content,a=s.signature,u=$t.decode(c),f=(h=u).initiator,p=f.id,d=f.counter,y=f.members,b=h.type,o?[4,r.asymmetricCrypto.verifySignature(c,a,o)]:[3,2];case 1:if(!l.sent())throw m.error("Verify signature NOT OK: ",{id:e,signature:k(a)}),new Error("Wrong signature");m.debug("Verify signature OK: ",{id:e,signature:k(a)}),l.label=2;case 2:if(!y.includes(this.myId))return[2];if((void 0===(g=this.cycles.get(p))||g.counter<d)&&(t.prototype.setState.call(this,i.CALCUL_IN_PROGRESS),(g=this.createCycle(p,d,y)).debug("NOT an initiator starts a NEW CYCLE"),!g.isZBroadcasted&&g.isReadyToBroadcastZ(this.members)&&(g.broadcastZ(),g.checkZArray(this.myId,this.members))),g.counter===d&&!g.isFinished)switch(v=g.members.indexOf(e),b){case"z":g.debug("received Z value from "+e+", "+v),g.assert(-1!==v,"Unable to find a corresponding Z value of "+e),g.assert(void 0===g.zArray[v],"Setting Z value twice"),g.zArray[v]=u.z.slice(),g.checkZArray(this.myId,this.members);break;case"x":g.debug("received X value from "+e+", "+v),g.assert(-1!==v,"Unable to find a corresponding X value of "+e),g.assert(void 0===g.xArray[v],"Setting X value twice"),g.addX(v,u.x.slice()),g.checkXArray(this.myId,this.members)}return[2]}})})},e.prototype.setMyId=function(t){var e=this.members.indexOf(this.myId);-1!==e?this.members[e]=t:this.members.push(t),this.myId=t,this.myCounter=0,this.members.sort(function(t,e){return t-e})},e.prototype.setReady=function(){this.isReady=!0,this.isInitiator&&this.start()},e.prototype.checkCycles=function(){var t,e;if(this.members.length>1)if(this.isInitiator)this.start();else try{for(var n=h(this.cycles.values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.debug("CHECK CYCLE"),!i.isFinished){if(!i.isZBroadcasted&&i.isReadyToBroadcastZ(this.members)){i.broadcastZ(),i.checkZArray(this.myId,this.members);continue}i.checkZArray(this.myId,this.members),i.checkXArray(this.myId,this.members)}}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}},Object.defineProperty(e.prototype,"isInitiator",{get:function(){return this.members.length>1&&this.members[0]===this.myId},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.isReady&&this.members.length>1&&(t.prototype.setState.call(this,i.CALCUL_IN_PROGRESS),m.debug("INITIATOR starts a NEW CYCLE"),this.createCycle(this.myId,++this.myCounter,this.members).broadcastZ())},e.prototype.createCycle=function(e,n,o){var s=this,c=new A(e,n,o,this.myId,this.send,this.members);return this.cycles.set(e,c),c.onKey=function(e){s.key&&(s.previousKey=s.key),s.key=e,t.prototype.setState.call(s,i.READY),r.symmetricCrypto.exportKey(s.key.value).then(function(t){m.debug("KEY =",r.symmetricCrypto.toB64(t))})},c},e}(M);s.performance=o.performance},function(t,e){t.exports=require("util")},function(t,e){t.exports=require("url")},function(t,e){t.exports=require("perf_hooks")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const r=n(13),i=n(14),o=n(15),s=n(16),c=n(17),a=n(18),u=n(7),l=n(19),h=n(4),f=n(24);let p;try{p=n(26).version}catch(t){try{p=n(!function(){var t=new Error("Cannot find module './package.json'");throw t.code="MODULE_NOT_FOUND",t}()).version}catch(e){h.log.error(t),p=""}}const d="Repono",y="0.0.0.0",b=2e4,g="ws://localhost:20000",v="ws://localhost:8010",m="mutedocs",w="keyagreement",S=!1,I="info",O="";r.version(p).option("-h, --host <ip or host name>","Host address to bind to.",y).option("-p, --port <number>","Port to use for the server.",b).option("-b, --botURL <number>","Bot public URL.",g).option("-s, --signalingURL <url>","Signaling server url.",v).option("","\n").option("-c --cryptography <string>",'Specify cryptography type. Possible values are: "none", "metadata", "keyagreement"',w).option("--cors","Enable Cross-origin Resource Sharing.",S).option("-n, --name <bot name>","Bot name.",d).option("-d, --database <name>","Database name.",m).option("","\n").option("--key <file path>","Private key for the certificate").option("--cert <file path>","The server certificate").option("--ca <file path>","The additional intermediate certificate or certificates that web browsers will need in order to validate the server certificate.").option("","\n").option("-l, --logLevel <none|trace|debug|info|warn|error|fatal>","Logging level.",/^(none|trace|debug|info|warn|error|fatal)$/i,I).option("-f, --logFolder <path>","Path to where log files would be stored.\n                              If not specified stdout will used.",O).parse(process.argv);const{name:x,host:_,port:E,botURL:k,signalingURL:T,database:C,cryptography:M,cors:j,key:N,cert:A,ca:L,logLevel:P,logFolder:B}=r;h.createLogger(B,P),"none"!==P&&u.setLogLevel(u.LogLevel.DEBUG),process.on("uncaughtException",t=>{console.error("uncaughtException -> ",t)});const R=new f.MongooseAdapter;function D(t){const e=t.split("/");return`bot.storage@${t.indexOf("://")>-1?e[2]:e[0]}`}R.connect("localhost",C).then(()=>{h.log.info("Connected to the database  ✓");let t=new s;const e=new a;return e.get("/info",t=>{t.body={displayName:x,login:D(k),avatar:l.BotStorage.AVATAR,version:p}}).get("/docs/:login",async t=>{await R.lookupMetadataByLogin(t.params.login).then(e=>t.body=e).catch(e=>{h.log.error("Could not retreive the document list stored in database",e),t.status=500})}).post("/remove",t=>{const{key:e,login:n}=t.request.body;t.request.body&&e&&n?R.removeLogin(e,n).then(()=>{t.body=!0}).catch(e=>{h.log.error(`Failed to remove login ${n}`,e),t.status=500}):t.status=404}),j&&(t=t.use(o())),t.use(c()).use(e.routes()).use(e.allowedMethods())}).then(t=>{if(h.log.info("Configured routes  ✓"),N&&A&&L){const e=n(27);return n(28).createServer({key:e.readFileSync(N),cert:e.readFileSync(A),ca:e.readFileSync(L)},t.callback())}return i.createServer(t.callback())}).then(t=>{return h.log.info("Configured server  ✓"),t.on("clientError",t=>{h.log.error("Client Error",t)}),new u.Bot({url:k,server:t,leaveOnceAlone:!1,webGroupOptions:{signalingServer:T}}).onWebGroup=(t=>{const e=new l.BotStorage(x,D(k),t,R,M);h.log.info("New peer to peer network invitation received for ",e.signalingKey)}),new Promise(e=>t.listen(E,_,e))}).then(()=>{h.log.info(`Successfully started the storage bot server at ${_}:${E} with the following settings`,{name:x,host:_,port:E,botURL:k,signalingURL:T,cryptography:M,logLevel:P,logFolder:B})}).catch(t=>h.log.fatal(t))},function(t,e){t.exports=require("commander")},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("kcors")},function(t,e){t.exports=require("koa")},function(t,e){t.exports=require("koa-bodyparser")},function(t,e){t.exports=require("koa-router")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const r=n(20),i=n(8),o=n(1),s=n(2),c=n(7),a=n(9),u=n(4),l=n(22),h=12e4,f=1e4;class p{constructor(t,e,n,i,s){this.displayName=t,this.login=e,this.wg=n,this.synchronize=(()=>{}),this.syncDocContentInterval=void 0,this.saveChain=Promise.resolve(),this.mongooseAdapter=i,this.message$=new o.ReplaySubject,this.memberJoin$=new o.ReplaySubject,this.memberLeave$=new o.ReplaySubject,this.state$=new o.ReplaySubject,this.myId$=new o.ReplaySubject,this.subs=[],this.saveInterval=setInterval(()=>{this.mongoDoc&&this.saveContent()},h),this.initWebGroup(),this.initMuteCrypto(s),this.retreiveDocument(n.key).then(t=>{this.mongoDoc=t;const e=t.get("operations").map(t=>r.RichLogootSOperation.fromPlain(t));this.initMuteCore(t,new r.State(new Map,e||[]))}).catch(t=>u.log.error(`Failed to initialize document ${n.key}`,t))}get signalingKey(){return this.wg.key}initWebGroup(){this.wg.onStateChange=(t=>{t===c.WebGroupState.LEFT&&(this.saveContent(),global.clearInterval(this.saveInterval)),this.state$.next(t)}),this.wg.onMemberJoin=(t=>this.memberJoin$.next(t)),this.wg.onMemberLeave=(t=>{this.wg.members.length<2&&this.saveContent(),this.memberLeave$.next(t)}),this.wg.onMyId=(t=>this.myId$.next(t))}async retreiveDocument(t){const e=await this.mongooseAdapter.find(t);return e||await this.mongooseAdapter.create(t)}initMuteCore(t,e){const n=new r.MuteCore({profile:{displayName:this.displayName,login:this.login,avatar:p.AVATAR},docContent:e,metaTitle:{title:t.get("title"),titleModified:t.get("titleModified")},metaFixData:{docCreated:t.get("created"),cryptoKey:t.get("cryptoKey")},metaLogs:{share:t.get("shareLogs"),vector:this.mongooseAdapter.getShareVector(t)}});return n.messageIn$=this.message$,this.subs[this.subs.length]=n.messageOut$.subscribe(({streamId:t,content:e,recipientId:n})=>{t===r.Streams.DOCUMENT_CONTENT&&this.crypto&&this.crypto.state===i.KeyState.READY?this.crypto.encrypt(e).then(e=>this.send(t,e,n)).catch(t=>u.log.error("Failed to encrypt a message: ",t)):this.send(t,e,n)}),this.subs[this.subs.length]=n.remoteTextOperations$.subscribe(()=>{this.lastReceivedState=n.state}),n.memberJoin$=this.memberJoin$,n.memberLeave$=this.memberLeave$,this.subs[this.subs.length]=n.collabJoin$.subscribe(({login:t})=>{this.saveLogins(t)}),this.subs[this.subs.length]=n.remoteCollabUpdate$.subscribe(({login:t})=>this.saveLogins(t)),this.subs[this.subs.length]=n.remoteMetadataUpdate$.subscribe(({type:t,data:e})=>{switch(t){case r.MetaDataType.Title:const{title:n,titleModified:o}=e;this.saveTitle(n,o);break;case r.MetaDataType.FixData:const{docCreated:s,cryptoKey:c}=e;this.saveFixData(s,c),this.crypto instanceof i.Symmetric&&this.crypto.importKey(c);break;case r.MetaDataType.Logs:const{share:u,vector:l}=e;this.saveLogs(u,a.isUndefined(l)?new Map:l)}}),this.synchronize=(()=>{this.wg.members.length>1&&(this.crypto?this.crypto.state===i.KeyState.READY&&n.synchronize():n.synchronize())}),n.collabJoin$.subscribe(()=>n.synchronize()),n}initMuteCrypto(t){switch(u.log.debug("CRYPTOGRAPHY type = ",t),t){case"none":this.crypto=void 0,this.wg.onMessage=((t,e)=>{try{this.message$.next(Object.assign({senderId:t},l.Message.decode(e)))}catch(t){u.log.error("Failed to decode a message: ",t)}});break;case"metadata":this.crypto=new i.Symmetric;const e=this.crypto;this.wg.onMessage=((t,n)=>{try{const{streamId:i,content:o}=l.Message.decode(n);i===r.Streams.DOCUMENT_CONTENT?e.decrypt(o).then(e=>{this.message$.next({senderId:t,streamId:i,content:e})}).catch(t=>u.log.warn("Failed to decrypt document content: ",JSON.stringify(t))):this.message$.next({senderId:t,streamId:i,content:o})}catch(t){u.log.warn("Message from network decode error: ",t.message)}});break;case"keyagreement":this.crypto=new i.KeyAgreementBD,this.crypto.onSend=((t,e)=>this.send(e,t));const n=this.crypto;this.memberJoin$.subscribe(t=>n.addMember(t)),this.memberLeave$.subscribe(t=>n.removeMember(t)),this.state$.subscribe(t=>{t===c.WebGroupState.JOINED&&n.setReady()}),this.myId$.subscribe(t=>n.setMyId(t)),this.wg.onMessage=((t,e)=>{const{streamId:o,content:s}=l.Message.decode(e);o===i.Streams.KEY_AGREEMENT_BD?n.onMessage(t,s):o===r.Streams.DOCUMENT_CONTENT?n.decrypt(s).then(e=>this.message$.next({senderId:t,streamId:o,content:e})).catch(t=>u.log.warn("Failed to decrypt document content: ",JSON.stringify(t))):this.message$.next({senderId:t,streamId:o,content:s})});const a=new o.Subject;this.crypto.onStateChange=(t=>a.next(t)),this.subs[this.subs.length]=o.merge(a.pipe(s.filter(t=>t===i.KeyState.READY)),this.state$.pipe(s.filter(t=>t===c.WebGroupState.JOINED))).pipe(s.auditTime(1e3)).subscribe(()=>this.restartSyncInterval())}}send(t,e,n){const r=l.Message.create({streamId:t,content:e});void 0===n?this.wg.send(l.Message.encode(r).finish()):(n=0===n?this.randomMember():n,this.wg.sendTo(n,l.Message.encode(r).finish()))}randomMember(){const t=this.wg.members.filter(t=>t!==this.wg.myId);return t[Math.ceil(Math.random()*t.length)-1]}saveContent(){try{this.mongoDoc&&this.lastReceivedState&&this.lastReceivedState!==this.lastSavedState&&(this.mongoDoc.set({operations:this.lastReceivedState.richLogootSOps}),this.saveDoc(),this.lastSavedState=this.lastReceivedState)}catch(t){u.log.error("Failed save the document content:",t)}}saveLogins(t){if(this.mongoDoc&&t&&"anonymous"!==t){const e=this.mongoDoc.get("logins");e.includes(t)||(e.push(t),this.mongoDoc.set({logins:e}),this.saveDoc())}}saveTitle(t,e){this.mongoDoc&&(this.mongoDoc.set({title:t,titleModified:e}),this.saveDoc())}saveFixData(t,e){this.mongoDoc&&(this.mongoDoc.set({created:t,cryptoKey:e}),this.saveDoc())}saveLogs(t,e){if(this.mongoDoc){const n=new Map;e.forEach((t,e)=>{n.set(e.toString(),t)}),this.mongoDoc.set({shareLogs:t,shareLogsVector:n}),this.saveDoc()}}async saveDoc(){this.saveChain=this.saveChain.then(async()=>{this.mongoDoc&&await this.mongoDoc.save()}).catch(t=>u.log.warn("Could not save the document: ",t))}restartSyncInterval(){this.syncDocContentInterval&&clearInterval(this.syncDocContentInterval),this.synchronize(),this.syncDocContentInterval=setInterval(()=>this.synchronize(),f)}}p.AVATAR="https://www.shareicon.net/data/256x256/2016/01/01/228083_bot_256x256.png",p.ID=9137,e.BotStorage=p},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(5),i=function(){function t(){this.subs=[]}return Object.defineProperty(t.prototype,"newSub",{set:function(t){this.subs[this.subs.length]=t},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this.subs.forEach(function(t){return t.unsubscribe()})},t}(),o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var c=function(){return(c=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};var a,u={e:{}};function l(){try{return a.apply(this,arguments)}catch(t){return u.e=t,u}}function h(t){return a=t,l}function f(t){return"function"==typeof t}var p=!1,d={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){if(t){var e=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated synchronous error handling behavior by code at: \n"+e.stack)}else p&&console.log("RxJS: Back to a better error behavior. Thank you. <3");p=t},get useDeprecatedSynchronousErrorHandling(){return p}};function y(t){setTimeout(function(){throw t})}var b={closed:!0,next:function(t){},error:function(t){if(d.useDeprecatedSynchronousErrorHandling)throw t;y(t)},complete:function(){}},g=Array.isArray||function(t){return t&&"number"==typeof t.length};function v(t){return null!=t&&"object"==typeof t}function m(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(t,e){return e+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}m.prototype=Object.create(Error.prototype);var w=m,S=function(){function t(t){this.closed=!1,this._parent=null,this._parents=null,this._subscriptions=null,t&&(this._unsubscribe=t)}return t.prototype.unsubscribe=function(){var t,e=!1;if(!this.closed){var n=this._parent,r=this._parents,i=this._unsubscribe,o=this._subscriptions;this.closed=!0,this._parent=null,this._parents=null,this._subscriptions=null;for(var s=-1,c=r?r.length:0;n;)n.remove(this),n=++s<c&&r[s]||null;if(f(i))h(i).call(this)===u&&(e=!0,t=t||(u.e instanceof w?I(u.e.errors):[u.e]));if(g(o))for(s=-1,c=o.length;++s<c;){var a=o[s];if(v(a))if(h(a.unsubscribe).call(a)===u){e=!0,t=t||[];var l=u.e;l instanceof w?t=t.concat(I(l.errors)):t.push(l)}}if(e)throw new w(t)}},t.prototype.add=function(e){if(!e||e===t.EMPTY)return t.EMPTY;if(e===this)return this;var n=e;switch(typeof e){case"function":n=new t(e);case"object":if(n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if("function"!=typeof n._addParent){var r=n;(n=new t)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}return(this._subscriptions||(this._subscriptions=[])).push(n),n._addParent(this),n},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}},t.prototype._addParent=function(t){var e=this._parent,n=this._parents;e&&e!==t?n?-1===n.indexOf(t)&&n.push(t):this._parents=[t]:this._parent=t},t.EMPTY=function(t){return t.closed=!0,t}(new t),t}();function I(t){return t.reduce(function(t,e){return t.concat(e instanceof w?e.errors:e)},[])}var O="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("rxSubscriber"):"@@rxSubscriber",x=function(t){function e(e,n,r){var i=t.call(this)||this;switch(i.syncErrorValue=null,i.syncErrorThrown=!1,i.syncErrorThrowable=!1,i.isStopped=!1,i._parentSubscription=null,arguments.length){case 0:i.destination=b;break;case 1:if(!e){i.destination=b;break}if("object"==typeof e){if(E(e)){var o=e[O]();i.syncErrorThrowable=o.syncErrorThrowable,i.destination=o,o._addParentTeardownLogic(i)}else i.syncErrorThrowable=!0,i.destination=new _(i,e);break}default:i.syncErrorThrowable=!0,i.destination=new _(i,e,n,r)}return i}return s(e,t),e.prototype[O]=function(){return this},e.create=function(t,n,r){var i=new e(t,n,r);return i.syncErrorThrowable=!1,i},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t),this._unsubscribeParentSubscription())},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete(),this._unsubscribeParentSubscription())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._addParentTeardownLogic=function(t){t!==this&&(this._parentSubscription=this.add(t))},e.prototype._unsubscribeParentSubscription=function(){null!==this._parentSubscription&&this._parentSubscription.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parent,e=this._parents;return this._parent=null,this._parents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parent=t,this._parents=e,this._parentSubscription=null,this},e}(S),_=function(t){function e(e,n,r,i){var o,s=t.call(this)||this;s._parentSubscriber=e;var c=s;return f(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==b&&(f((c=Object.create(n)).unsubscribe)&&s.add(c.unsubscribe.bind(c)),c.unsubscribe=s.unsubscribe.bind(s))),s._context=c,s._next=o,s._error=r,s._complete=i,s}return s(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;d.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,n=d.useDeprecatedSynchronousErrorHandling;if(this._error)n&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)n?(e.syncErrorValue=t,e.syncErrorThrown=!0):y(t),this.unsubscribe();else{if(this.unsubscribe(),n)throw t;y(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var n=function(){return t._complete.call(t._context)};d.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),d.useDeprecatedSynchronousErrorHandling)throw t;y(t)}},e.prototype.__tryOrSetError=function(t,e,n){if(!d.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,n)}catch(e){return d.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(y(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(x);function E(t){return t instanceof x||"_addParentTeardownLogic"in t&&t[O]}var k=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.destination.next(e)},e.prototype.notifyError=function(t,e){this.destination.error(t)},e.prototype.notifyComplete=function(t){this.destination.complete()},e}(x),T=function(t){function e(e,n,r){var i=t.call(this)||this;return i.parent=e,i.outerValue=n,i.outerIndex=r,i.index=0,i}return s(e,t),e.prototype._next=function(t){this.parent.notifyNext(this.outerValue,t,this.outerIndex,this.index++,this)},e.prototype._error=function(t){this.parent.notifyError(t,this),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},e}(x);var C="function"==typeof Symbol&&Symbol.observable||"@@observable";function M(){}var j=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(t,e,n){var r=this.operator,i=function(t,e,n){if(t){if(t instanceof x)return t;if(t[O])return t[O]()}return t||e||n?new x(t,e,n):new x(b)}(t,e,n);if(r?r.call(i,this.source):i._addParentTeardownLogic(this.source||d.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),d.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){d.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),t.error(e)}},t.prototype.forEach=function(t,e){var n=this;return new(e=N(e))(function(e,r){var i;i=n.subscribe(function(e){try{t(e)}catch(t){r(t),i&&i.unsubscribe()}},r,e)})},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[C]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:function(t){return t?1===t.length?t[0]:function(e){return t.reduce(function(t,e){return e(t)},e)}:M}(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=N(t))(function(t,n){var r;e.subscribe(function(t){return r=t},function(t){return n(t)},function(){return t(r)})})},t.create=function(e){return new t(e)},t}();function N(t){if(t||(t=d.Promise||Promise),!t)throw new Error("no Promise impl found");return t}var A=function(t){return function(e){for(var n=0,r=t.length;n<r&&!e.closed;n++)e.next(t[n]);e.closed||e.complete()}};var L="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";var P=function(t){if(t instanceof j)return function(e){return t._isScalar?(e.next(t.value),void e.complete()):t.subscribe(e)};if(t&&"function"==typeof t[C])return function(t){return function(e){var n=t[C]();if("function"!=typeof n.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return n.subscribe(e)}}(t);if(function(t){return t&&"number"==typeof t.length&&"function"!=typeof t}(t))return A(t);if(function(t){return t&&"function"!=typeof t.subscribe&&"function"==typeof t.then}(t))return function(t){return function(e){return t.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,y),e}}(t);if(t&&"function"==typeof t[L])return function(t){return function(e){for(var n=t[L]();;){var r=n.next();if(r.done){e.complete();break}if(e.next(r.value),e.closed)break}return"function"==typeof n.return&&e.add(function(){n.return&&n.return()}),e}}(t);var e=v(t)?"an invalid object":"'"+t+"'";throw new TypeError("You provided "+e+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function B(t,e,n,r,i){if(void 0===i&&(i=new T(t,n,r)),!i.closed)return P(e)(i)}!function(t){function e(e,n){var r=t.call(this,e)||this;return r.durationSelector=n,r.hasValue=!1,r}s(e,t),e.prototype._next=function(t){if(this.value=t,this.hasValue=!0,!this.throttled){var e=h(this.durationSelector)(t);if(e===u)this.destination.error(u.e);else{var n=B(this,e);!n||n.closed?this.clearThrottle():this.add(this.throttled=n)}}},e.prototype.clearThrottle=function(){var t=this.value,e=this.hasValue,n=this.throttled;n&&(this.remove(n),this.throttled=null,n.unsubscribe()),e&&(this.value=null,this.hasValue=!1,this.destination.next(t))},e.prototype.notifyNext=function(t,e,n,r){this.clearThrottle()},e.prototype.notifyComplete=function(){this.clearThrottle()}}(k);var R=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.scheduler=e,r.work=n,r.pending=!1,r}return s(e,t),e.prototype.schedule=function(t,e){if(void 0===e&&(e=0),this.closed)return this;this.state=t;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,e)),this.pending=!0,this.delay=e,this.id=this.id||this.requestAsyncId(r,this.id,e),this},e.prototype.requestAsyncId=function(t,e,n){return void 0===n&&(n=0),setInterval(t.flush.bind(t,this),n)},e.prototype.recycleAsyncId=function(t,e,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return e;clearInterval(e)},e.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(t,e);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,e){var n=!1,r=void 0;try{this.work(t)}catch(t){n=!0,r=!!t&&t||new Error(t)}if(n)return this.unsubscribe(),r},e.prototype._unsubscribe=function(){var t=this.id,e=this.scheduler,n=e.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=t&&(this.id=this.recycleAsyncId(e,t,null)),this.delay=null},e}(function(t){function e(e,n){return t.call(this)||this}return s(e,t),e.prototype.schedule=function(t,e){return void 0===e&&(e=0),this},e}(S)),D=function(){function t(e,n){void 0===n&&(n=t.now),this.SchedulerAction=e,this.now=n}return t.prototype.schedule=function(t,e,n){return void 0===e&&(e=0),new this.SchedulerAction(this,t).schedule(n,e)},t.now=function(){return Date.now()},t}(),U=function(t){function e(n,r){void 0===r&&(r=D.now);var i=t.call(this,n,function(){return e.delegate&&e.delegate!==i?e.delegate.now():r()})||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}return s(e,t),e.prototype.schedule=function(n,r,i){return void 0===r&&(r=0),e.delegate&&e.delegate!==this?e.delegate.schedule(n,r,i):t.prototype.schedule.call(this,n,r,i)},e.prototype.flush=function(t){var e=this.actions;if(this.active)e.push(t);else{var n;this.active=!0;do{if(n=t.execute(t.state,t.delay))break}while(t=e.shift());if(this.active=!1,n){for(;t=e.shift();)t.unsubscribe();throw n}}},e}(D),F=new U(R);(function(t){function e(e,n){var r=t.call(this,e)||this;return r.buffer=[],r.add(B(r,n)),r}s(e,t),e.prototype._next=function(t){this.buffer.push(t)},e.prototype.notifyNext=function(t,e,n,r,i){var o=this.buffer;this.buffer=[],this.destination.next(o)}})(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.bufferSize=n,r.buffer=[],r}s(e,t),e.prototype._next=function(t){var e=this.buffer;e.push(t),e.length==this.bufferSize&&(this.destination.next(e),this.buffer=[])},e.prototype._complete=function(){var e=this.buffer;e.length>0&&this.destination.next(e),t.prototype._complete.call(this)}}(x),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.bufferSize=n,i.startBufferEvery=r,i.buffers=[],i.count=0,i}s(e,t),e.prototype._next=function(t){var e=this.bufferSize,n=this.startBufferEvery,r=this.buffers,i=this.count;this.count++,i%n==0&&r.push([]);for(var o=r.length;o--;){var s=r[o];s.push(t),s.length===e&&(r.splice(o,1),this.destination.next(s))}},e.prototype._complete=function(){for(var e=this.buffers,n=this.destination;e.length>0;){var r=e.shift();r.length>0&&n.next(r)}t.prototype._complete.call(this)}}(x);var z=function(){return function(){this.buffer=[]}}();!function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;s.bufferTimeSpan=n,s.bufferCreationInterval=r,s.maxBufferSize=i,s.scheduler=o,s.contexts=[];var c=s.openContext();if(s.timespanOnly=null==r||r<0,s.timespanOnly){var a={subscriber:s,context:c,bufferTimeSpan:n};s.add(c.closeAction=o.schedule(G,n,a))}else{var u={subscriber:s,context:c},l={bufferTimeSpan:n,bufferCreationInterval:r,subscriber:s,scheduler:o};s.add(c.closeAction=o.schedule(W,n,u)),s.add(o.schedule(V,r,l))}return s}s(e,t),e.prototype._next=function(t){for(var e,n=this.contexts,r=n.length,i=0;i<r;i++){var o=n[i],s=o.buffer;s.push(t),s.length==this.maxBufferSize&&(e=o)}e&&this.onBufferFull(e)},e.prototype._error=function(e){this.contexts.length=0,t.prototype._error.call(this,e)},e.prototype._complete=function(){for(var e=this.contexts,n=this.destination;e.length>0;){var r=e.shift();n.next(r.buffer)}t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){this.contexts=null},e.prototype.onBufferFull=function(t){this.closeContext(t);var e=t.closeAction;if(e.unsubscribe(),this.remove(e),!this.closed&&this.timespanOnly){t=this.openContext();var n=this.bufferTimeSpan,r={subscriber:this,context:t,bufferTimeSpan:n};this.add(t.closeAction=this.scheduler.schedule(G,n,r))}},e.prototype.openContext=function(){var t=new z;return this.contexts.push(t),t},e.prototype.closeContext=function(t){this.destination.next(t.buffer);var e=this.contexts;(e?e.indexOf(t):-1)>=0&&e.splice(e.indexOf(t),1)}}(x);function G(t){var e=t.subscriber,n=t.context;n&&e.closeContext(n),e.closed||(t.context=e.openContext(),t.context.closeAction=this.schedule(t,t.bufferTimeSpan))}function V(t){var e=t.bufferCreationInterval,n=t.bufferTimeSpan,r=t.subscriber,i=t.scheduler,o=r.openContext();r.closed||(r.add(o.closeAction=i.schedule(W,n,{subscriber:r,context:o})),this.schedule(t,e))}function W(t){var e=t.subscriber,n=t.context;e.closeContext(n)}(function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.openings=n,i.closingSelector=r,i.contexts=[],i.add(B(i,n)),i}s(e,t),e.prototype._next=function(t){for(var e=this.contexts,n=e.length,r=0;r<n;r++)e[r].buffer.push(t)},e.prototype._error=function(e){for(var n=this.contexts;n.length>0;){var r=n.shift();r.subscription.unsubscribe(),r.buffer=null,r.subscription=null}this.contexts=null,t.prototype._error.call(this,e)},e.prototype._complete=function(){for(var e=this.contexts;e.length>0;){var n=e.shift();this.destination.next(n.buffer),n.subscription.unsubscribe(),n.buffer=null,n.subscription=null}this.contexts=null,t.prototype._complete.call(this)},e.prototype.notifyNext=function(t,e,n,r,i){t?this.closeBuffer(t):this.openBuffer(e)},e.prototype.notifyComplete=function(t){this.closeBuffer(t.context)},e.prototype.openBuffer=function(t){try{var e=this.closingSelector.call(this,t);e&&this.trySubscribe(e)}catch(t){this._error(t)}},e.prototype.closeBuffer=function(t){var e=this.contexts;if(e&&t){var n=t.buffer,r=t.subscription;this.destination.next(n),e.splice(e.indexOf(t),1),this.remove(r),r.unsubscribe()}},e.prototype.trySubscribe=function(t){var e=this.contexts,n=new S,r={buffer:[],subscription:n};e.push(r);var i=B(this,t,r);!i||i.closed?this.closeBuffer(r):(i.context=r,this.add(i),n.add(i))}})(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.closingSelector=n,r.subscribing=!1,r.openBuffer(),r}s(e,t),e.prototype._next=function(t){this.buffer.push(t)},e.prototype._complete=function(){var e=this.buffer;e&&this.destination.next(e),t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){this.buffer=null,this.subscribing=!1},e.prototype.notifyNext=function(t,e,n,r,i){this.openBuffer()},e.prototype.notifyComplete=function(){this.subscribing?this.complete():this.openBuffer()},e.prototype.openBuffer=function(){var t=this.closingSubscription;t&&(this.remove(t),t.unsubscribe());var e=this.buffer;this.buffer&&this.destination.next(e),this.buffer=[];var n=h(this.closingSelector)();n===u?this.error(u.e):(t=new S,this.closingSubscription=t,this.add(t),this.subscribing=!0,t.add(B(this,n)),this.subscribing=!1)}}(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.selector=n,i.caught=r,i}s(e,t),e.prototype.error=function(e){if(!this.isStopped){var n=void 0;try{n=this.selector(e,this.caught)}catch(e){return void t.prototype.error.call(this,e)}this._unsubscribeAndRecycle();var r=new T(this,void 0,void 0);this.add(r),B(this,n,void 0,void 0,r)}}}(k);function $(t,e){return new j(e?function(n){var r=new S,i=0;return r.add(e.schedule(function(){i!==t.length?(n.next(t[i++]),n.closed||r.add(this.schedule())):n.complete()})),r}:A(t))}var q={},H=(function(t){function e(e,n){var r=t.call(this,e)||this;return r.resultSelector=n,r.active=0,r.values=[],r.observables=[],r}s(e,t),e.prototype._next=function(t){this.values.push(q),this.observables.push(t)},e.prototype._complete=function(){var t=this.observables,e=t.length;if(0===e)this.destination.complete();else{this.active=e,this.toRespond=e;for(var n=0;n<e;n++){var r=t[n];this.add(B(this,r,r,n))}}},e.prototype.notifyComplete=function(t){0==(this.active-=1)&&this.destination.complete()},e.prototype.notifyNext=function(t,e,n,r,i){var o=this.values,s=o[n],c=this.toRespond?s===q?--this.toRespond:this.toRespond:0;o[n]=e,0===c&&(this.resultSelector?this._tryResultSelector(o):this.destination.next(o.slice()))},e.prototype._tryResultSelector=function(t){var e;try{e=this.resultSelector.apply(this,t)}catch(t){return void this.destination.error(t)}this.destination.next(e)}}(k),new j(function(t){return t.complete()}));function K(t){return t?function(t){return new j(function(e){return t.schedule(function(){return e.complete()})})}(t):H}function J(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[t.length-1];switch(!function(t){return t&&"function"==typeof t.schedule}(n)?n=void 0:t.pop(),t.length){case 0:return K(n);case 1:return n?$(t,n):function(t){var e=new j(function(e){e.next(t),e.complete()});return e._isScalar=!0,e.value=t,e}(t[0]);default:return $(t,n)}}var X=function(){function t(t,e){this.project=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new Z(t,this.project,this.thisArg))},t}(),Z=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.project=n,i.count=0,i.thisArg=r||i,i}return s(e,t),e.prototype._next=function(t){var e;try{e=this.project.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(x);!function(t){function e(e,n,r){void 0===r&&(r=Number.POSITIVE_INFINITY);var i=t.call(this,e)||this;return i.project=n,i.concurrent=r,i.hasCompleted=!1,i.buffer=[],i.active=0,i.index=0,i}s(e,t),e.prototype._next=function(t){this.active<this.concurrent?this._tryNext(t):this.buffer.push(t)},e.prototype._tryNext=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this.active++,this._innerSub(e,t,n)},e.prototype._innerSub=function(t,e,n){var r=new T(this,void 0,void 0);this.add(r),B(this,t,e,n,r)},e.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete()},e.prototype.notifyNext=function(t,e,n,r,i){this.destination.next(e)},e.prototype.notifyComplete=function(t){var e=this.buffer;this.remove(t),this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()}}(k);function Y(t){return t}(function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.predicate=n,i.source=r,i.count=0,i.index=0,i}s(e,t),e.prototype._next=function(t){this.predicate?this._tryPredicate(t):this.count++},e.prototype._tryPredicate=function(t){var e;try{e=this.predicate(t,this.index++,this.source)}catch(t){return void this.destination.error(t)}e&&this.count++},e.prototype._complete=function(){this.destination.next(this.count),this.destination.complete()}})(x),function(t){function e(e,n){var r=t.call(this,e)||this;return r.durationSelector=n,r.hasValue=!1,r.durationSubscription=null,r}s(e,t),e.prototype._next=function(t){try{var e=this.durationSelector.call(this,t);e&&this._tryNext(t,e)}catch(t){this.destination.error(t)}},e.prototype._complete=function(){this.emitValue(),this.destination.complete()},e.prototype._tryNext=function(t,e){var n=this.durationSubscription;this.value=t,this.hasValue=!0,n&&(n.unsubscribe(),this.remove(n)),(n=B(this,e))&&!n.closed&&this.add(this.durationSubscription=n)},e.prototype.notifyNext=function(t,e,n,r,i){this.emitValue()},e.prototype.notifyComplete=function(){this.emitValue()},e.prototype.emitValue=function(){if(this.hasValue){var e=this.value,n=this.durationSubscription;n&&(this.durationSubscription=null,n.unsubscribe(),this.remove(n)),this.value=null,this.hasValue=!1,t.prototype._next.call(this,e)}}}(k);var Q=function(){function t(t,e){this.dueTime=t,this.scheduler=e}return t.prototype.call=function(t,e){return e.subscribe(new tt(t,this.dueTime,this.scheduler))},t}(),tt=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.dueTime=n,i.scheduler=r,i.debouncedSubscription=null,i.lastValue=null,i.hasValue=!1,i}return s(e,t),e.prototype._next=function(t){this.clearDebounce(),this.lastValue=t,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule(et,this.dueTime,this))},e.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},e.prototype.debouncedNext=function(){if(this.clearDebounce(),this.hasValue){var t=this.lastValue;this.lastValue=null,this.hasValue=!1,this.destination.next(t)}},e.prototype.clearDebounce=function(){var t=this.debouncedSubscription;null!==t&&(this.remove(t),t.unsubscribe(),this.debouncedSubscription=null)},e}(x);function et(t){t.debouncedNext()}var nt=function(){function t(t){this.defaultValue=t}return t.prototype.call=function(t,e){return e.subscribe(new rt(t,this.defaultValue))},t}(),rt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.defaultValue=n,r.isEmpty=!0,r}return s(e,t),e.prototype._next=function(t){this.isEmpty=!1,this.destination.next(t)},e.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},e}(x);function it(t){var e=t.error;t.subscriber.error(e)}var ot=function(){function t(t,e,n){this.kind=t,this.value=e,this.error=n,this.hasValue="N"===t}return t.prototype.observe=function(t){switch(this.kind){case"N":return t.next&&t.next(this.value);case"E":return t.error&&t.error(this.error);case"C":return t.complete&&t.complete()}},t.prototype.do=function(t,e,n){switch(this.kind){case"N":return t&&t(this.value);case"E":return e&&e(this.error);case"C":return n&&n()}},t.prototype.accept=function(t,e,n){return t&&"function"==typeof t.next?this.observe(t):this.do(t,e,n)},t.prototype.toObservable=function(){switch(this.kind){case"N":return J(this.value);case"E":return function(t,e){return new j(e?function(n){return e.schedule(it,0,{error:t,subscriber:n})}:function(e){return e.error(t)})}(this.error);case"C":return K()}throw new Error("unexpected notification kind value")},t.createNext=function(e){return void 0!==e?new t("N",e):t.undefinedValueNotification},t.createError=function(e){return new t("E",void 0,e)},t.createComplete=function(){return t.completeNotification},t.completeNotification=new t("C"),t.undefinedValueNotification=new t("N",void 0),t}(),st=(function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.delay=n,i.scheduler=r,i.queue=[],i.active=!1,i.errored=!1,i}s(e,t),e.dispatch=function(t){for(var e=t.source,n=e.queue,r=t.scheduler,i=t.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(t,o)}else this.unsubscribe(),e.active=!1},e.prototype._schedule=function(t){this.active=!0,this.add(t.schedule(e.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))},e.prototype.scheduleNotification=function(t){if(!0!==this.errored){var e=this.scheduler,n=new st(e.now()+this.delay,t);this.queue.push(n),!1===this.active&&this._schedule(e)}},e.prototype._next=function(t){this.scheduleNotification(ot.createNext(t))},e.prototype._error=function(t){this.errored=!0,this.queue=[],this.destination.error(t)},e.prototype._complete=function(){this.scheduleNotification(ot.createComplete())}}(x),function(){return function(t,e){this.time=t,this.notification=e}}()),ct=(function(t){function e(e,n){var r=t.call(this,e)||this;return r.delayDurationSelector=n,r.completed=!1,r.delayNotifierSubscriptions=[],r.index=0,r}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.destination.next(t),this.removeSubscription(i),this.tryComplete()},e.prototype.notifyError=function(t,e){this._error(t)},e.prototype.notifyComplete=function(t){var e=this.removeSubscription(t);e&&this.destination.next(e),this.tryComplete()},e.prototype._next=function(t){var e=this.index++;try{var n=this.delayDurationSelector(t,e);n&&this.tryDelay(n,t)}catch(t){this.destination.error(t)}},e.prototype._complete=function(){this.completed=!0,this.tryComplete()},e.prototype.removeSubscription=function(t){t.unsubscribe();var e=this.delayNotifierSubscriptions.indexOf(t);return-1!==e&&this.delayNotifierSubscriptions.splice(e,1),t.outerValue},e.prototype.tryDelay=function(t,e){var n=B(this,t,e);n&&!n.closed&&(this.add(n),this.delayNotifierSubscriptions.push(n))},e.prototype.tryComplete=function(){this.completed&&0===this.delayNotifierSubscriptions.length&&this.destination.complete()}}(k),function(t){function e(e,n){var r=t.call(this)||this;return r.source=e,r.subscriptionDelay=n,r}s(e,t),e.prototype._subscribe=function(t){this.subscriptionDelay.subscribe(new ct(t,this.source))}}(j),function(t){function e(e,n){var r=t.call(this)||this;return r.parent=e,r.source=n,r.sourceSubscribed=!1,r}return s(e,t),e.prototype._next=function(t){this.subscribeToSource()},e.prototype._error=function(t){this.unsubscribe(),this.parent.error(t)},e.prototype._complete=function(){this.subscribeToSource()},e.prototype.subscribeToSource=function(){this.sourceSubscribed||(this.sourceSubscribed=!0,this.unsubscribe(),this.source.subscribe(this.parent))},e}(x));(function(t){function e(e){return t.call(this,e)||this}s(e,t),e.prototype._next=function(t){t.observe(this.destination)}})(x),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.keySelector=n,i.values=new Set,r&&i.add(B(i,r)),i}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.values.clear()},e.prototype.notifyError=function(t,e){this._error(t)},e.prototype._next=function(t){this.keySelector?this._useKeySelector(t):this._finalizeNext(t,t)},e.prototype._useKeySelector=function(t){var e,n=this.destination;try{e=this.keySelector(t)}catch(t){return void n.error(t)}this._finalizeNext(e,t)},e.prototype._finalizeNext=function(t,e){var n=this.values;n.has(t)||(n.add(t),this.destination.next(e))}}(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.keySelector=r,i.hasKey=!1,"function"==typeof n&&(i.compare=n),i}s(e,t),e.prototype.compare=function(t,e){return t===e},e.prototype._next=function(t){var e=t;if(this.keySelector&&(e=h(this.keySelector)(t))===u)return this.destination.error(u.e);var n=!1;if(this.hasKey){if((n=h(this.compare)(this.key,e))===u)return this.destination.error(u.e)}else this.hasKey=!0;!1===Boolean(n)&&(this.key=e,this.destination.next(t))}}(x);function at(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}at.prototype=Object.create(Error.prototype);var ut=at;function lt(t,e){return function(n){return n.lift(new ht(t,e))}}var ht=function(){function t(t,e){this.predicate=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new ft(t,this.predicate,this.thisArg))},t}(),ft=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.predicate=n,i.thisArg=r,i.count=0,i}return s(e,t),e.prototype._next=function(t){var e;try{e=this.predicate.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}e&&this.destination.next(t)},e}(x);var pt=function(){function t(t,e,n){this.nextOrObserver=t,this.error=e,this.complete=n}return t.prototype.call=function(t,e){return e.subscribe(new dt(t,this.nextOrObserver,this.error,this.complete))},t}(),dt=function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o._tapNext=M,o._tapError=M,o._tapComplete=M,o._tapError=r||M,o._tapComplete=i||M,f(n)?(o._context=o,o._tapNext=n):n&&(o._context=n,o._tapNext=n.next||M,o._tapError=n.error||M,o._tapComplete=n.complete||M),o}return s(e,t),e.prototype._next=function(t){try{this._tapNext.call(this._context,t)}catch(t){return void this.destination.error(t)}this.destination.next(t)},e.prototype._error=function(t){try{this._tapError.call(this._context,t)}catch(t){return void this.destination.error(t)}this.destination.error(t)},e.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(t){return void this.destination.error(t)}return this.destination.complete()},e}(x);function yt(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}yt.prototype=Object.create(Error.prototype);var bt=yt,gt=function(t){return void 0===t&&(t=vt),function(t,e,n){return function(r){return r.lift(new pt(t,e,n))}}({hasValue:!1,next:function(){this.hasValue=!0},complete:function(){if(!this.hasValue)throw t()}})};function vt(){return new bt}var mt=function(){function t(t){if(this.total=t,this.total<0)throw new ut}return t.prototype.call=function(t,e){return e.subscribe(new wt(t,this.total))},t}(),wt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.total=n,r.count=0,r}return s(e,t),e.prototype._next=function(t){var e=this.total,n=++this.count;n<=e&&(this.destination.next(t),n===e&&(this.destination.complete(),this.unsubscribe()))},e}(x);(function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.predicate=n,o.thisArg=r,o.source=i,o.index=0,o.thisArg=r||o,o}s(e,t),e.prototype.notifyComplete=function(t){this.destination.next(t),this.destination.complete()},e.prototype._next=function(t){var e=!1;try{e=this.predicate.call(this.thisArg,t,this.index++,this.source)}catch(t){return void this.destination.error(t)}e||this.notifyComplete(!1)},e.prototype._complete=function(){this.notifyComplete(!0)}})(x),function(t){function e(e){var n=t.call(this,e)||this;return n.hasCompleted=!1,n.hasSubscription=!1,n}s(e,t),e.prototype._next=function(t){this.hasSubscription||(this.hasSubscription=!0,this.add(B(this,t)))},e.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},e.prototype.notifyComplete=function(t){this.remove(t),this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()}}(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.project=n,r.hasSubscription=!1,r.hasCompleted=!1,r.index=0,r}s(e,t),e.prototype._next=function(t){this.hasSubscription||this.tryNext(t)},e.prototype.tryNext=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this.hasSubscription=!0,this._innerSub(e,t,n)},e.prototype._innerSub=function(t,e,n){var r=new T(this,void 0,void 0);this.add(r),B(this,t,e,n,r)},e.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},e.prototype.notifyNext=function(t,e,n,r,i){this.destination.next(e)},e.prototype.notifyError=function(t){this.destination.error(t)},e.prototype.notifyComplete=function(t){this.remove(t),this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()}}(k),function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.project=n,o.concurrent=r,o.scheduler=i,o.index=0,o.active=0,o.hasCompleted=!1,r<Number.POSITIVE_INFINITY&&(o.buffer=[]),o}s(e,t),e.dispatch=function(t){var e=t.subscriber,n=t.result,r=t.value,i=t.index;e.subscribeToProjection(n,r,i)},e.prototype._next=function(t){var n=this.destination;if(n.closed)this._complete();else{var r=this.index++;if(this.active<this.concurrent){n.next(t);var i=h(this.project)(t,r);if(i===u)n.error(u.e);else if(this.scheduler){var o={subscriber:this,result:i,value:t,index:r};this.add(this.scheduler.schedule(e.dispatch,0,o))}else this.subscribeToProjection(i,t,r)}else this.buffer.push(t)}},e.prototype.subscribeToProjection=function(t,e,n){this.active++,this.add(B(this,t,e,n))},e.prototype._complete=function(){this.hasCompleted=!0,this.hasCompleted&&0===this.active&&this.destination.complete()},e.prototype.notifyNext=function(t,e,n,r,i){this._next(e)},e.prototype.notifyComplete=function(t){var e=this.buffer;this.remove(t),this.active--,e&&e.length>0&&this._next(e.shift()),this.hasCompleted&&0===this.active&&this.destination.complete()}}(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.add(new S(n)),r}s(e,t)}(x),function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;return s.predicate=n,s.source=r,s.yieldIndex=i,s.thisArg=o,s.index=0,s}s(e,t),e.prototype.notifyComplete=function(t){var e=this.destination;e.next(t),e.complete(),this.unsubscribe()},e.prototype._next=function(t){var e=this.predicate,n=this.thisArg,r=this.index++;try{e.call(n||this,t,r,this.source)&&this.notifyComplete(this.yieldIndex?r:t)}catch(t){this.destination.error(t)}},e.prototype._complete=function(){this.notifyComplete(this.yieldIndex?-1:void 0)}}(x);function St(t,e){var n=arguments.length>=2;return function(r){return r.pipe(t?lt(function(e,n){return t(e,n,r)}):Y,function(t){return function(e){return 0===t?K():e.lift(new mt(t))}}(1),n?function(t){return void 0===t&&(t=null),function(e){return e.lift(new nt(t))}}(e):gt(function(){return new bt}))}}function It(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}It.prototype=Object.create(Error.prototype);var Ot=It,xt=function(t){function e(e,n){var r=t.call(this)||this;return r.subject=e,r.subscriber=n,r.closed=!1,r}return s(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var n=e.indexOf(this.subscriber);-1!==n&&e.splice(n,1)}}},e}(S),_t=function(t){function e(e){var n=t.call(this,e)||this;return n.destination=e,n}return s(e,t),e}(x),Et=function(t){function e(){var e=t.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return s(e,t),e.prototype[O]=function(){return new _t(this)},e.prototype.lift=function(t){var e=new kt(this,this);return e.operator=t,e},e.prototype.next=function(t){if(this.closed)throw new Ot;if(!this.isStopped)for(var e=this.observers,n=e.length,r=e.slice(),i=0;i<n;i++)r[i].next(t)},e.prototype.error=function(t){if(this.closed)throw new Ot;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,n=e.length,r=e.slice(),i=0;i<n;i++)r[i].error(t);this.observers.length=0},e.prototype.complete=function(){if(this.closed)throw new Ot;this.isStopped=!0;for(var t=this.observers,e=t.length,n=t.slice(),r=0;r<e;r++)n[r].complete();this.observers.length=0},e.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},e.prototype._trySubscribe=function(e){if(this.closed)throw new Ot;return t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){if(this.closed)throw new Ot;return this.hasError?(t.error(this.thrownError),S.EMPTY):this.isStopped?(t.complete(),S.EMPTY):(this.observers.push(t),new xt(this,t))},e.prototype.asObservable=function(){var t=new j;return t.source=this,t},e.create=function(t,e){return new kt(t,e)},e}(j),kt=function(t){function e(e,n){var r=t.call(this)||this;return r.destination=e,r.source=n,r}return s(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):S.EMPTY},e}(Et),Tt=(function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;return s.keySelector=n,s.elementSelector=r,s.durationSelector=i,s.subjectSelector=o,s.groups=null,s.attemptedToUnsubscribe=!1,s.count=0,s}s(e,t),e.prototype._next=function(t){var e;try{e=this.keySelector(t)}catch(t){return void this.error(t)}this._group(t,e)},e.prototype._group=function(t,e){var n=this.groups;n||(n=this.groups=new Map);var r,i=n.get(e);if(this.elementSelector)try{r=this.elementSelector(t)}catch(t){this.error(t)}else r=t;if(!i){i=this.subjectSelector?this.subjectSelector():new Et,n.set(e,i);var o=new Ct(e,i,this);if(this.destination.next(o),this.durationSelector){var s=void 0;try{s=this.durationSelector(new Ct(e,i))}catch(t){return void this.error(t)}this.add(s.subscribe(new Tt(e,i,this)))}}i.closed||i.next(r)},e.prototype._error=function(t){var e=this.groups;e&&(e.forEach(function(e,n){e.error(t)}),e.clear()),this.destination.error(t)},e.prototype._complete=function(){var t=this.groups;t&&(t.forEach(function(t,e){t.complete()}),t.clear()),this.destination.complete()},e.prototype.removeGroup=function(t){this.groups.delete(t)},e.prototype.unsubscribe=function(){this.closed||(this.attemptedToUnsubscribe=!0,0===this.count&&t.prototype.unsubscribe.call(this))}}(x),function(t){function e(e,n,r){var i=t.call(this,n)||this;return i.key=e,i.group=n,i.parent=r,i}return s(e,t),e.prototype._next=function(t){this.complete()},e.prototype._unsubscribe=function(){var t=this.parent,e=this.key;this.key=this.parent=null,t&&t.removeGroup(e)},e}(x)),Ct=function(t){function e(e,n,r){var i=t.call(this)||this;return i.key=e,i.groupSubject=n,i.refCountSubscription=r,i}return s(e,t),e.prototype._subscribe=function(t){var e=new S,n=this.refCountSubscription,r=this.groupSubject;return n&&!n.closed&&e.add(new Mt(n)),e.add(r.subscribe(t)),e},e}(j),Mt=function(t){function e(e){var n=t.call(this)||this;return n.parent=e,e.count++,n}return s(e,t),e.prototype.unsubscribe=function(){var e=this.parent;e.closed||this.closed||(t.prototype.unsubscribe.call(this),e.count-=1,0===e.count&&e.attemptedToUnsubscribe&&e.unsubscribe())},e}(S);(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}s(e,t),e.prototype._next=function(t){}})(x),function(t){function e(e){return t.call(this,e)||this}s(e,t),e.prototype.notifyComplete=function(t){var e=this.destination;e.next(t),e.complete()},e.prototype._next=function(t){this.notifyComplete(!1)},e.prototype._complete=function(){this.notifyComplete(!0)}}(x),function(t){function e(e,n){var r=t.call(this,e)||this;return r.total=n,r.ring=new Array,r.count=0,r}s(e,t),e.prototype._next=function(t){var e=this.ring,n=this.total,r=this.count++;e.length<n?e.push(t):e[r%n]=t},e.prototype._complete=function(){var t=this.destination,e=this.count;if(e>0)for(var n=this.count>=this.total?this.total:this.count,r=this.ring,i=0;i<n;i++){var o=e++%n;t.next(r[o])}t.complete()}}(x),function(t){function e(e,n){var r=t.call(this,e)||this;return r.value=n,r}s(e,t),e.prototype._next=function(t){this.destination.next(this.value)}}(x),function(t){function e(e){return t.call(this,e)||this}s(e,t),e.prototype._next=function(t){this.destination.next(ot.createNext(t))},e.prototype._error=function(t){var e=this.destination;e.next(ot.createError(t)),e.complete()},e.prototype._complete=function(){var t=this.destination;t.next(ot.createComplete()),t.complete()}}(x),function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.accumulator=n,o._seed=r,o.hasSeed=i,o.index=0,o}s(e,t),Object.defineProperty(e.prototype,"seed",{get:function(){return this._seed},set:function(t){this.hasSeed=!0,this._seed=t},enumerable:!0,configurable:!0}),e.prototype._next=function(t){if(this.hasSeed)return this._tryNext(t);this.seed=t,this.destination.next(t)},e.prototype._tryNext=function(t){var e,n=this.index++;try{e=this.accumulator(this.seed,t,n)}catch(t){this.destination.error(t)}this.seed=e,this.destination.next(e)}}(x),function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.accumulator=n,o.acc=r,o.concurrent=i,o.hasValue=!1,o.hasCompleted=!1,o.buffer=[],o.active=0,o.index=0,o}s(e,t),e.prototype._next=function(t){if(this.active<this.concurrent){var e=this.index++,n=h(this.accumulator)(this.acc,t),r=this.destination;n===u?r.error(u.e):(this.active++,this._innerSub(n,t,e))}else this.buffer.push(t)},e.prototype._innerSub=function(t,e,n){var r=new T(this,void 0,void 0);this.add(r),B(this,t,e,n,r)},e.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())},e.prototype.notifyNext=function(t,e,n,r,i){var o=this.destination;this.acc=e,this.hasValue=!0,o.next(e)},e.prototype.notifyComplete=function(t){var e=this.buffer;this.remove(t),this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())}}(k);var jt=function(){function t(t){this.connectable=t}return t.prototype.call=function(t,e){var n=this.connectable;n._refCount++;var r=new Nt(t,n),i=e.subscribe(r);return r.closed||(r.connection=n.connect()),i},t}(),Nt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.connectable=n,r}return s(e,t),e.prototype._unsubscribe=function(){var t=this.connectable;if(t){this.connectable=null;var e=t._refCount;if(e<=0)this.connection=null;else if(t._refCount=e-1,e>1)this.connection=null;else{var n=this.connection,r=t._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null},e}(x),At=function(t){function e(e,n){var r=t.call(this)||this;return r.source=e,r.subjectFactory=n,r._refCount=0,r._isComplete=!1,r}return s(e,t),e.prototype._subscribe=function(t){return this.getSubject().subscribe(t)},e.prototype.getSubject=function(){var t=this._subject;return t&&!t.isStopped||(this._subject=this.subjectFactory()),this._subject},e.prototype.connect=function(){var t=this._connection;return t||(this._isComplete=!1,(t=this._connection=new S).add(this.source.subscribe(new Lt(this.getSubject(),this))),t.closed?(this._connection=null,t=S.EMPTY):this._connection=t),t},e.prototype.refCount=function(){return function(t){return t.lift(new jt(t))}(this)},e}(j).prototype,Lt=(At._subscribe,At._isComplete,At.getSubject,At.connect,At.refCount,function(t){function e(e,n){var r=t.call(this,e)||this;return r.connectable=n,r}return s(e,t),e.prototype._error=function(e){this._unsubscribe(),t.prototype._error.call(this,e)},e.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){var t=this.connectable;if(t){this.connectable=null;var e=t._connection;t._refCount=0,t._subject=null,t._connection=null,e&&e.unsubscribe()}},e}(_t)),Pt=(function(t){function e(e,n){var r=t.call(this,e)||this;return r.connectable=n,r}s(e,t),e.prototype._unsubscribe=function(){var t=this.connectable;if(t){this.connectable=null;var e=t._refCount;if(e<=0)this.connection=null;else if(t._refCount=e-1,e>1)this.connection=null;else{var n=this.connection,r=t._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null}}(x),function(t){function e(e,n,r){void 0===r&&(r=0);var i=t.call(this,e)||this;return i.scheduler=n,i.delay=r,i}return s(e,t),e.dispatch=function(t){var e=t.notification,n=t.destination;e.observe(n),this.unsubscribe()},e.prototype.scheduleMessage=function(t){this.add(this.scheduler.schedule(e.dispatch,this.delay,new Bt(t,this.destination)))},e.prototype._next=function(t){this.scheduleMessage(ot.createNext(t))},e.prototype._error=function(t){this.scheduleMessage(ot.createError(t))},e.prototype._complete=function(){this.scheduleMessage(ot.createComplete())},e}(x)),Bt=function(){return function(t,e){this.notification=t,this.destination=e}}(),Rt=(function(t){function e(e,n){var r=t.call(this,e)||this;return r.destination=e,r.nextSources=n,r}s(e,t),e.prototype.notifyError=function(t,e){this.subscribeToNextSource()},e.prototype.notifyComplete=function(t){this.subscribeToNextSource()},e.prototype._error=function(t){this.subscribeToNextSource()},e.prototype._complete=function(){this.subscribeToNextSource()},e.prototype.subscribeToNextSource=function(){var t=this.nextSources.shift();if(t){var e=new T(this,void 0,void 0);this.add(e),B(this,t,void 0,void 0,e)}else this.destination.complete()}}(k),function(t){function e(e){var n=t.call(this,e)||this;return n.hasPrev=!1,n}s(e,t),e.prototype._next=function(t){this.hasPrev?this.destination.next([this.prev,t]):this.hasPrev=!0,this.prev=t}}(x),function(t){function e(e){var n=t.call(this)||this;return n._value=e,n}s(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),e.prototype._subscribe=function(e){var n=t.prototype._subscribe.call(this,e);return n&&!n.closed&&e.next(this._value),n},e.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new Ot;return this._value},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)}}(Et),function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.value=null,e.hasNext=!1,e.hasCompleted=!1,e}s(e,t),e.prototype._subscribe=function(e){return this.hasError?(e.error(this.thrownError),S.EMPTY):this.hasCompleted&&this.hasNext?(e.next(this.value),e.complete(),S.EMPTY):t.prototype._subscribe.call(this,e)},e.prototype.next=function(t){this.hasCompleted||(this.value=t,this.hasNext=!0)},e.prototype.error=function(e){this.hasCompleted||t.prototype.error.call(this,e)},e.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&t.prototype.next.call(this,this.value),t.prototype.complete.call(this)}}(Et),function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.scheduler=e,r.work=n,r}return s(e,t),e.prototype.schedule=function(e,n){return void 0===n&&(n=0),n>0?t.prototype.schedule.call(this,e,n):(this.delay=n,this.state=e,this.scheduler.flush(this),this)},e.prototype.execute=function(e,n){return n>0||this.closed?t.prototype.execute.call(this,e,n):this._execute(e,n)},e.prototype.requestAsyncId=function(e,n,r){return void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0?t.prototype.requestAsyncId.call(this,e,n,r):e.flush(this)},e}(R)),Dt=new(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(U))(Rt),Ut=(function(t){function e(e,n,r){void 0===e&&(e=Number.POSITIVE_INFINITY),void 0===n&&(n=Number.POSITIVE_INFINITY);var i=t.call(this)||this;return i.scheduler=r,i._events=[],i._infiniteTimeWindow=!1,i._bufferSize=e<1?1:e,i._windowTime=n<1?1:n,n===Number.POSITIVE_INFINITY?(i._infiniteTimeWindow=!0,i.next=i.nextInfiniteTimeWindow):i.next=i.nextTimeWindow,i}s(e,t),e.prototype.nextInfiniteTimeWindow=function(e){var n=this._events;n.push(e),n.length>this._bufferSize&&n.shift(),t.prototype.next.call(this,e)},e.prototype.nextTimeWindow=function(e){this._events.push(new Ut(this._getNow(),e)),this._trimBufferThenGetEvents(),t.prototype.next.call(this,e)},e.prototype._subscribe=function(t){var e,n=this._infiniteTimeWindow,r=n?this._events:this._trimBufferThenGetEvents(),i=this.scheduler,o=r.length;if(this.closed)throw new Ot;if(this.isStopped||this.hasError?e=S.EMPTY:(this.observers.push(t),e=new xt(this,t)),i&&t.add(t=new Pt(t,i)),n)for(var s=0;s<o&&!t.closed;s++)t.next(r[s]);else for(s=0;s<o&&!t.closed;s++)t.next(r[s].value);return this.hasError?t.error(this.thrownError):this.isStopped&&t.complete(),e},e.prototype._getNow=function(){return(this.scheduler||Dt).now()},e.prototype._trimBufferThenGetEvents=function(){for(var t=this._getNow(),e=this._bufferSize,n=this._windowTime,r=this._events,i=r.length,o=0;o<i&&!(t-r[o].time<n);)o++;return i>e&&(o=Math.max(o,i-e)),o>0&&r.splice(0,o),r}}(Et),function(){return function(t,e){this.time=t,this.value=e}}());(function(t){function e(e){var n=t.call(this,e)||this;return n.hasFirst=!1,n.observables=[],n.subscriptions=[],n}s(e,t),e.prototype._next=function(t){this.observables.push(t)},e.prototype._complete=function(){var t=this.observables,e=t.length;if(0===e)this.destination.complete();else{for(var n=0;n<e&&!this.hasFirst;n++){var r=t[n],i=B(this,r,r,n);this.subscriptions&&this.subscriptions.push(i),this.add(i)}this.observables=null}},e.prototype.notifyNext=function(t,e,n,r,i){if(!this.hasFirst){this.hasFirst=!0;for(var o=0;o<this.subscriptions.length;o++)if(o!==n){var s=this.subscriptions[o];s.unsubscribe(),this.remove(s)}this.subscriptions=null}this.destination.next(e)}})(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.count=n,i.source=r,i}s(e,t),e.prototype.complete=function(){if(!this.isStopped){var e=this.source,n=this.count;if(0===n)return t.prototype.complete.call(this);n>-1&&(this.count=n-1),e.subscribe(this._unsubscribeAndRecycle())}}}(x),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.notifier=n,i.source=r,i.sourceIsBeingSubscribedTo=!0,i}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.sourceIsBeingSubscribedTo=!0,this.source.subscribe(this)},e.prototype.notifyComplete=function(e){if(!1===this.sourceIsBeingSubscribedTo)return t.prototype.complete.call(this)},e.prototype.complete=function(){if(this.sourceIsBeingSubscribedTo=!1,!this.isStopped){if(this.retries||this.subscribeToRetries(),!this.retriesSubscription||this.retriesSubscription.closed)return t.prototype.complete.call(this);this._unsubscribeAndRecycle(),this.notifications.next()}},e.prototype._unsubscribe=function(){var t=this.notifications,e=this.retriesSubscription;t&&(t.unsubscribe(),this.notifications=null),e&&(e.unsubscribe(),this.retriesSubscription=null),this.retries=null},e.prototype._unsubscribeAndRecycle=function(){var e=this._unsubscribe;return this._unsubscribe=null,t.prototype._unsubscribeAndRecycle.call(this),this._unsubscribe=e,this},e.prototype.subscribeToRetries=function(){this.notifications=new Et;var e=h(this.notifier)(this.notifications);if(e===u)return t.prototype.complete.call(this);this.retries=e,this.retriesSubscription=B(this,e)}}(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.count=n,i.source=r,i}s(e,t),e.prototype.error=function(e){if(!this.isStopped){var n=this.source,r=this.count;if(0===r)return t.prototype.error.call(this,e);r>-1&&(this.count=r-1),n.subscribe(this._unsubscribeAndRecycle())}}}(x),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.notifier=n,i.source=r,i}s(e,t),e.prototype.error=function(e){if(!this.isStopped){var n=this.errors,r=this.retries,i=this.retriesSubscription;if(r)this.errors=null,this.retriesSubscription=null;else{if(n=new Et,(r=h(this.notifier)(n))===u)return t.prototype.error.call(this,u.e);i=B(this,r)}this._unsubscribeAndRecycle(),this.errors=n,this.retries=r,this.retriesSubscription=i,n.next(e)}},e.prototype._unsubscribe=function(){var t=this.errors,e=this.retriesSubscription;t&&(t.unsubscribe(),this.errors=null),e&&(e.unsubscribe(),this.retriesSubscription=null),this.retries=null},e.prototype.notifyNext=function(t,e,n,r,i){var o=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=o,this.source.subscribe(this)}}(k),function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.hasValue=!1,e}s(e,t),e.prototype._next=function(t){this.value=t,this.hasValue=!0},e.prototype.notifyNext=function(t,e,n,r,i){this.emitValue()},e.prototype.notifyComplete=function(){this.emitValue()},e.prototype.emitValue=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.value))}}(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.period=n,i.scheduler=r,i.hasValue=!1,i.add(r.schedule(Ft,n,{subscriber:i,period:n})),i}s(e,t),e.prototype._next=function(t){this.lastValue=t,this.hasValue=!0},e.prototype.notifyNext=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.lastValue))}}(x);function Ft(t){var e=t.subscriber,n=t.period;e.notifyNext(),this.schedule(t,n)}!function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.compareTo=n,i.comparor=r,i._a=[],i._b=[],i._oneComplete=!1,i.add(n.subscribe(new zt(e,i))),i}s(e,t),e.prototype._next=function(t){this._oneComplete&&0===this._b.length?this.emit(!1):(this._a.push(t),this.checkValues())},e.prototype._complete=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0},e.prototype.checkValues=function(){for(var t=this._a,e=this._b,n=this.comparor;t.length>0&&e.length>0;){var r=t.shift(),i=e.shift(),o=!1;n?(o=h(n)(r,i))===u&&this.destination.error(u.e):o=r===i,o||this.emit(!1)}},e.prototype.emit=function(t){var e=this.destination;e.next(t),e.complete()},e.prototype.nextB=function(t){this._oneComplete&&0===this._a.length?this.emit(!1):(this._b.push(t),this.checkValues())}}(x);var zt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.parent=n,r}return s(e,t),e.prototype._next=function(t){this.parent.nextB(t)},e.prototype._error=function(t){this.parent.error(t)},e.prototype._complete=function(){this.parent._complete()},e}(x),Gt=(function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.predicate=n,i.source=r,i.seenValue=!1,i.index=0,i}s(e,t),e.prototype.applySingleValue=function(t){this.seenValue?this.destination.error("Sequence contains more than one element"):(this.seenValue=!0,this.singleValue=t)},e.prototype._next=function(t){var e=this.index++;this.predicate?this.tryNext(t,e):this.applySingleValue(t)},e.prototype.tryNext=function(t,e){try{this.predicate(t,e,this.source)&&this.applySingleValue(t)}catch(t){this.destination.error(t)}},e.prototype._complete=function(){var t=this.destination;this.index>0?(t.next(this.seenValue?this.singleValue:void 0),t.complete()):t.error(new bt)}}(x),function(t){function e(e,n){var r=t.call(this,e)||this;return r.total=n,r.count=0,r}s(e,t),e.prototype._next=function(t){++this.count>this.total&&this.destination.next(t)}}(x),function(t){function e(e,n){var r=t.call(this,e)||this;return r._skipCount=n,r._count=0,r._ring=new Array(n),r}s(e,t),e.prototype._next=function(t){var e=this._skipCount,n=this._count++;if(n<e)this._ring[n]=t;else{var r=n%e,i=this._ring,o=i[r];i[r]=t,this.destination.next(o)}}}(x),function(t){function e(e,n){var r=t.call(this,e)||this;r.hasValue=!1;var i=new T(r,void 0,void 0);return r.add(i),r.innerSubscription=i,B(r,n,void 0,void 0,i),r}s(e,t),e.prototype._next=function(e){this.hasValue&&t.prototype._next.call(this,e)},e.prototype.notifyNext=function(t,e,n,r,i){this.hasValue=!0,this.innerSubscription&&this.innerSubscription.unsubscribe()},e.prototype.notifyComplete=function(){}}(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.predicate=n,r.skipping=!0,r.index=0,r}s(e,t),e.prototype._next=function(t){var e=this.destination;this.skipping&&this.tryCallPredicate(t),this.skipping||e.next(t)},e.prototype.tryCallPredicate=function(t){try{var e=this.predicate(t,this.index++);this.skipping=Boolean(e)}catch(t){this.destination.error(t)}}}(x),1),Vt={};var Wt=function(t){var e=Gt++;return Vt[e]=t,Promise.resolve().then(function(){return function(t){var e=Vt[t];e&&e()}(e)}),e},$t=function(t){delete Vt[t]},qt=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.scheduler=e,r.work=n,r}return s(e,t),e.prototype.requestAsyncId=function(e,n,r){return void 0===r&&(r=0),null!==r&&r>0?t.prototype.requestAsyncId.call(this,e,n,r):(e.actions.push(this),e.scheduled||(e.scheduled=Wt(e.flush.bind(e,null))))},e.prototype.recycleAsyncId=function(e,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return t.prototype.recycleAsyncId.call(this,e,n,r);0===e.actions.length&&($t(n),e.scheduled=void 0)},e}(R),Ht=new(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.flush=function(t){this.active=!0,this.scheduled=void 0;var e,n=this.actions,r=-1,i=n.length;t=t||n.shift();do{if(e=t.execute(t.state,t.delay))break}while(++r<i&&(t=n.shift()));if(this.active=!1,e){for(;++r<i&&(t=n.shift());)t.unsubscribe();throw e}},e}(U))(qt);(function(t){function e(e,n,r){void 0===n&&(n=0),void 0===r&&(r=Ht);var i=t.call(this)||this;return i.source=e,i.delayTime=n,i.scheduler=r,(!function(t){return!g(t)&&t-parseFloat(t)+1>=0}(n)||n<0)&&(i.delayTime=0),r&&"function"==typeof r.schedule||(i.scheduler=Ht),i}s(e,t),e.create=function(t,n,r){return void 0===n&&(n=0),void 0===r&&(r=Ht),new e(t,n,r)},e.dispatch=function(t){var e=t.source,n=t.subscriber;return this.add(e.subscribe(n))},e.prototype._subscribe=function(t){var n=this.delayTime,r=this.source;return this.scheduler.schedule(e.dispatch,n,{source:r,subscriber:t})}})(j),function(t){function e(e,n){var r=t.call(this,e)||this;return r.project=n,r.index=0,r}s(e,t),e.prototype._next=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this._innerSub(e,t,n)},e.prototype._innerSub=function(t,e,n){var r=this.innerSubscription;r&&r.unsubscribe();var i=new T(this,void 0,void 0);this.add(i),this.innerSubscription=B(this,t,e,n,i)},e.prototype._complete=function(){var e=this.innerSubscription;e&&!e.closed||t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){this.innerSubscription=null},e.prototype.notifyComplete=function(e){this.remove(e),this.innerSubscription=null,this.isStopped&&t.prototype._complete.call(this)},e.prototype.notifyNext=function(t,e,n,r,i){this.destination.next(e)}}(k),function(t){function e(e){var n=t.call(this,e)||this;return n.seenValue=!1,n}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.seenValue=!0,this.complete()},e.prototype.notifyComplete=function(){}}(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.predicate=n,r.index=0,r}s(e,t),e.prototype._next=function(t){var e,n=this.destination;try{e=this.predicate(t,this.index++)}catch(t){return void n.error(t)}this.nextOrComplete(t,e)},e.prototype.nextOrComplete=function(t,e){var n=this.destination;Boolean(e)?n.next(t):n.complete()}}(x),function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.destination=e,o.durationSelector=n,o._leading=r,o._trailing=i,o._hasValue=!1,o}s(e,t),e.prototype._next=function(t){this._hasValue=!0,this._sendValue=t,this._throttled||(this._leading?this.send():this.throttle(t))},e.prototype.send=function(){var t=this._hasValue,e=this._sendValue;t&&(this.destination.next(e),this.throttle(e)),this._hasValue=!1,this._sendValue=null},e.prototype.throttle=function(t){var e=this.tryDurationSelector(t);e&&this.add(this._throttled=B(this,e))},e.prototype.tryDurationSelector=function(t){try{return this.durationSelector(t)}catch(t){return this.destination.error(t),null}},e.prototype.throttlingDone=function(){var t=this._throttled,e=this._trailing;t&&t.unsubscribe(),this._throttled=null,e&&this.send()},e.prototype.notifyNext=function(t,e,n,r,i){this.throttlingDone()},e.prototype.notifyComplete=function(){this.throttlingDone()}}(k),function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;return s.duration=n,s.scheduler=r,s.leading=i,s.trailing=o,s._hasTrailingValue=!1,s._trailingValue=null,s}s(e,t),e.prototype._next=function(t){this.throttled?this.trailing&&(this._trailingValue=t,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(Kt,this.duration,{subscriber:this})),this.leading&&this.destination.next(t))},e.prototype._complete=function(){this._hasTrailingValue?(this.destination.next(this._trailingValue),this.destination.complete()):this.destination.complete()},e.prototype.clearThrottle=function(){var t=this.throttled;t&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),t.unsubscribe(),this.remove(t),this.throttled=null)}}(x);function Kt(t){t.subscriber.clearThrottle()}(function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;return s.absoluteTimeout=n,s.waitFor=r,s.withObservable=i,s.scheduler=o,s.action=null,s.scheduleTimeout(),s}s(e,t),e.dispatchTimeout=function(t){var e=t.withObservable;t._unsubscribeAndRecycle(),t.add(B(t,e))},e.prototype.scheduleTimeout=function(){var t=this.action;t?this.action=t.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(e.dispatchTimeout,this.waitFor,this))},e.prototype._next=function(e){this.absoluteTimeout||this.scheduleTimeout(),t.prototype._next.call(this,e)},e.prototype._unsubscribe=function(){this.action=null,this.scheduler=null,this.withObservable=null}})(k),function(t){function e(e){var n=t.call(this,e)||this;return n.window=new Et,e.next(n.window),n}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.openWindow()},e.prototype.notifyError=function(t,e){this._error(t)},e.prototype.notifyComplete=function(t){this._complete()},e.prototype._next=function(t){this.window.next(t)},e.prototype._error=function(t){this.window.error(t),this.destination.error(t)},e.prototype._complete=function(){this.window.complete(),this.destination.complete()},e.prototype._unsubscribe=function(){this.window=null},e.prototype.openWindow=function(){var t=this.window;t&&t.complete();var e=this.destination,n=this.window=new Et;e.next(n)}}(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.destination=e,i.windowSize=n,i.startWindowEvery=r,i.windows=[new Et],i.count=0,e.next(i.windows[0]),i}s(e,t),e.prototype._next=function(t){for(var e=this.startWindowEvery>0?this.startWindowEvery:this.windowSize,n=this.destination,r=this.windowSize,i=this.windows,o=i.length,s=0;s<o&&!this.closed;s++)i[s].next(t);var c=this.count-r+1;if(c>=0&&c%e==0&&!this.closed&&i.shift().complete(),++this.count%e==0&&!this.closed){var a=new Et;i.push(a),n.next(a)}},e.prototype._error=function(t){var e=this.windows;if(e)for(;e.length>0&&!this.closed;)e.shift().error(t);this.destination.error(t)},e.prototype._complete=function(){var t=this.windows;if(t)for(;t.length>0&&!this.closed;)t.shift().complete();this.destination.complete()},e.prototype._unsubscribe=function(){this.count=0,this.windows=null}}(x);var Jt=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._numberOfNextedValues=0,e}return s(e,t),e.prototype.next=function(e){this._numberOfNextedValues++,t.prototype.next.call(this,e)},Object.defineProperty(e.prototype,"numberOfNextedValues",{get:function(){return this._numberOfNextedValues},enumerable:!0,configurable:!0}),e}(Et);!function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;s.destination=e,s.windowTimeSpan=n,s.windowCreationInterval=r,s.maxWindowSize=i,s.scheduler=o,s.windows=[];var c=s.openWindow();if(null!==r&&r>=0){var a={subscriber:s,window:c,context:null},u={windowTimeSpan:n,windowCreationInterval:r,subscriber:s,scheduler:o};s.add(o.schedule(Yt,n,a)),s.add(o.schedule(Zt,r,u))}else{var l={subscriber:s,window:c,windowTimeSpan:n};s.add(o.schedule(Xt,n,l))}return s}s(e,t),e.prototype._next=function(t){for(var e=this.windows,n=e.length,r=0;r<n;r++){var i=e[r];i.closed||(i.next(t),i.numberOfNextedValues>=this.maxWindowSize&&this.closeWindow(i))}},e.prototype._error=function(t){for(var e=this.windows;e.length>0;)e.shift().error(t);this.destination.error(t)},e.prototype._complete=function(){for(var t=this.windows;t.length>0;){var e=t.shift();e.closed||e.complete()}this.destination.complete()},e.prototype.openWindow=function(){var t=new Jt;return this.windows.push(t),this.destination.next(t),t},e.prototype.closeWindow=function(t){t.complete();var e=this.windows;e.splice(e.indexOf(t),1)}}(x);function Xt(t){var e=t.subscriber,n=t.windowTimeSpan,r=t.window;r&&e.closeWindow(r),t.window=e.openWindow(),this.schedule(t,n)}function Zt(t){var e=t.windowTimeSpan,n=t.subscriber,r=t.scheduler,i=t.windowCreationInterval,o={action:this,subscription:null},s={subscriber:n,window:n.openWindow(),context:o};o.subscription=r.schedule(Yt,e,s),this.add(o.subscription),this.schedule(t,i)}function Yt(t){var e=t.subscriber,n=t.window,r=t.context;r&&r.action&&r.subscription&&r.action.remove(r.subscription),e.closeWindow(n)}(function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.openings=n,i.closingSelector=r,i.contexts=[],i.add(i.openSubscription=B(i,n,n)),i}s(e,t),e.prototype._next=function(t){var e=this.contexts;if(e)for(var n=e.length,r=0;r<n;r++)e[r].window.next(t)},e.prototype._error=function(e){var n=this.contexts;if(this.contexts=null,n)for(var r=n.length,i=-1;++i<r;){var o=n[i];o.window.error(e),o.subscription.unsubscribe()}t.prototype._error.call(this,e)},e.prototype._complete=function(){var e=this.contexts;if(this.contexts=null,e)for(var n=e.length,r=-1;++r<n;){var i=e[r];i.window.complete(),i.subscription.unsubscribe()}t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){var t=this.contexts;if(this.contexts=null,t)for(var e=t.length,n=-1;++n<e;){var r=t[n];r.window.unsubscribe(),r.subscription.unsubscribe()}},e.prototype.notifyNext=function(t,e,n,r,i){if(t===this.openings){var o=h(this.closingSelector)(e);if(o===u)return this.error(u.e);var s=new Et,c=new S,a={window:s,subscription:c};this.contexts.push(a);var l=B(this,o,a);l.closed?this.closeWindow(this.contexts.length-1):(l.context=a,c.add(l)),this.destination.next(s)}else this.closeWindow(this.contexts.indexOf(t))},e.prototype.notifyError=function(t){this.error(t)},e.prototype.notifyComplete=function(t){t!==this.openSubscription&&this.closeWindow(this.contexts.indexOf(t.context))},e.prototype.closeWindow=function(t){if(-1!==t){var e=this.contexts,n=e[t],r=n.window,i=n.subscription;e.splice(t,1),r.complete(),i.unsubscribe()}}})(k),function(t){function e(e,n){var r=t.call(this,e)||this;return r.destination=e,r.closingSelector=n,r.openWindow(),r}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.openWindow(i)},e.prototype.notifyError=function(t,e){this._error(t)},e.prototype.notifyComplete=function(t){this.openWindow(t)},e.prototype._next=function(t){this.window.next(t)},e.prototype._error=function(t){this.window.error(t),this.destination.error(t),this.unsubscribeClosingNotification()},e.prototype._complete=function(){this.window.complete(),this.destination.complete(),this.unsubscribeClosingNotification()},e.prototype.unsubscribeClosingNotification=function(){this.closingNotification&&this.closingNotification.unsubscribe()},e.prototype.openWindow=function(t){void 0===t&&(t=null),t&&(this.remove(t),t.unsubscribe());var e=this.window;e&&e.complete();var n=this.window=new Et;this.destination.next(n);var r=h(this.closingSelector)();if(r===u){var i=u.e;this.destination.error(i),this.window.error(i)}else this.add(this.closingNotification=B(this,r))}}(k),function(t){function e(e,n,r){var i=t.call(this,e)||this;i.observables=n,i.project=r,i.toRespond=[];var o=n.length;i.values=new Array(o);for(var s=0;s<o;s++)i.toRespond.push(s);for(s=0;s<o;s++){var c=n[s];i.add(B(i,c,c,s))}return i}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.values[n]=e;var o=this.toRespond;if(o.length>0){var s=o.indexOf(n);-1!==s&&o.splice(s,1)}},e.prototype.notifyComplete=function(){},e.prototype._next=function(t){if(0===this.toRespond.length){var e=[t].concat(this.values);this.project?this._tryProject(e):this.destination.next(e)}},e.prototype._tryProject=function(t){var e;try{e=this.project.apply(this,t)}catch(t){return void this.destination.error(t)}this.destination.next(e)}}(k);function Qt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[t.length-1];return"function"==typeof n&&t.pop(),$(t,void 0).lift(new te(n))}var te=function(){function t(t){this.resultSelector=t}return t.prototype.call=function(t,e){return e.subscribe(new ee(t,this.resultSelector))},t}(),ee=function(t){function e(e,n,r){void 0===r&&(r=Object.create(null));var i=t.call(this,e)||this;return i.iterators=[],i.active=0,i.resultSelector="function"==typeof n?n:null,i.values=r,i}return s(e,t),e.prototype._next=function(t){var e=this.iterators;g(t)?e.push(new re(t)):"function"==typeof t[L]?e.push(new ne(t[L]())):e.push(new ie(this.destination,this,t))},e.prototype._complete=function(){var t=this.iterators,e=t.length;if(0!==e){this.active=e;for(var n=0;n<e;n++){var r=t[n];r.stillUnsubscribed?this.add(r.subscribe(r,n)):this.active--}}else this.destination.complete()},e.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},e.prototype.checkIterators=function(){for(var t=this.iterators,e=t.length,n=this.destination,r=0;r<e;r++){if("function"==typeof(s=t[r]).hasValue&&!s.hasValue())return}var i=!1,o=[];for(r=0;r<e;r++){var s,c=(s=t[r]).next();if(s.hasCompleted()&&(i=!0),c.done)return void n.complete();o.push(c.value)}this.resultSelector?this._tryresultSelector(o):n.next(o),i&&n.complete()},e.prototype._tryresultSelector=function(t){var e;try{e=this.resultSelector.apply(this,t)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(x),ne=function(){function t(t){this.iterator=t,this.nextResult=t.next()}return t.prototype.hasValue=function(){return!0},t.prototype.next=function(){var t=this.nextResult;return this.nextResult=this.iterator.next(),t},t.prototype.hasCompleted=function(){var t=this.nextResult;return t&&t.done},t}(),re=function(){function t(t){this.array=t,this.index=0,this.length=0,this.length=t.length}return t.prototype[L]=function(){return this},t.prototype.next=function(t){var e=this.index++,n=this.array;return e<this.length?{value:n[e],done:!1}:{value:null,done:!0}},t.prototype.hasValue=function(){return this.array.length>this.index},t.prototype.hasCompleted=function(){return this.array.length===this.index},t}(),ie=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.parent=n,i.observable=r,i.stillUnsubscribed=!0,i.buffer=[],i.isComplete=!1,i}return s(e,t),e.prototype[L]=function(){return this},e.prototype.next=function(){var t=this.buffer;return 0===t.length&&this.isComplete?{value:null,done:!0}:{value:t.shift(),done:!1}},e.prototype.hasValue=function(){return this.buffer.length>0},e.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},e.prototype.notifyComplete=function(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},e.prototype.notifyNext=function(t,e,n,r,i){this.buffer.push(e),this.parent.checkIterators()},e.prototype.subscribe=function(t,e){return B(this,this.observable,this,e)},e}(k),oe=function(t){function e(e,n,r,i){var o=t.call(this)||this;return o.proto=i,o.messageIn$=e.pipe(lt(function(t){return t.streamId===r}),function(t,e){return function(n){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new X(t,e))}}(function(t){var e=t.senderId,n=t.content;return{senderId:e,msg:i.decode(n)}})),o.messageOut$=n,o.streamId=r,o}return s(e,t),e.prototype.send=function(t,e){this.messageOut$.next({streamId:this.streamId,recipientId:e,content:this.proto.encode(this.proto.create(t)).finish()})},e}(i),se={};var ce="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ae(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function ue(t,e){return t(e={exports:{}},e.exports),e.exports}var le=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isDot=function(t){return"object"==typeof t&&null!==t&&"number"==typeof t.replicaNumber&&Number.isInteger(t.replicaNumber)&&"number"==typeof t.clock&&Number.isInteger(t.clock)}});ae(le);le.isDot;var he=ue(function(t,e){function n(t){return Number.isSafeInteger(t)&&e.INT32_BOTTOM<=t&&t<=e.INT32_TOP}Object.defineProperty(e,"__esModule",{value:!0}),e.INT32_BOTTOM=-2147483648,e.INT32_TOP=2147483647,e.isInt32=n,e.randomInt32=function(t,e){console.assert(n(t),"l must be an int32"),console.assert(n(e),"u must be an int32"),console.assert(t<e,"u is greater than l");var r=Math.random()*(e-t)+t,i=Math.floor(r);return console.assert(n(i)&&t<=i&&i<e,"result is an integer 32 in [l, u["),i}});ae(he);he.INT32_BOTTOM,he.INT32_TOP,he.isInt32,he.randomInt32;var fe=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e,n,r){console.assert([t,e,n,r].every(he.isInt32),"each value ∈ int32"),this.random=t,this.replicaNumber=e,this.clock=n,this.offset=r}return t.fromPlain=function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.random&&he.isInt32(e.random)&&"number"==typeof e.replicaNumber&&he.isInt32(e.replicaNumber)&&"number"==typeof e.clock&&he.isInt32(e.clock)&&"number"==typeof e.offset&&he.isInt32(e.offset)?new t(e.random,e.replicaNumber,e.clock,e.offset):null},t.fromBase=function(e,n){return console.assert(he.isInt32(n),"offset ∈ int32"),new t(e.random,e.replicaNumber,e.clock,n)},t.prototype.compareTo=function(t){for(var e=this.asArray(),n=t.asArray(),r=0;r<e.length&&e[r]===n[r];)r++;return r===e.length?0:e[r]<n[r]?-1:1},t.prototype.equals=function(t){return this.equalsBase(t)&&this.offset===t.offset},t.prototype.equalsBase=function(t){return this.random===t.random&&this.replicaNumber===t.replicaNumber&&this.clock===t.clock},t.prototype.asArray=function(){return[this.random,this.replicaNumber,this.clock,this.offset]},t.prototype.digest=function(){return this.asArray().reduce(function(t,e){return 17*t+e|0},0)},t.prototype.toString=function(){return this.random+","+this.replicaNumber+","+this.clock+","+this.offset},t}();e.IdentifierTuple=n});ae(fe);fe.IdentifierTuple;var pe=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){console.assert(t.length>0,"tuples must not be empty");var e=t[t.length-1].random;console.assert(e>he.INT32_BOTTOM),this.tuples=t}return t.fromPlain=function(e){if("object"==typeof e&&null!==e){var n=e.tuples;if(n instanceof Array&&n.length>0){for(var r=!0,i=0,o=[];r&&i<n.length;){var s=fe.IdentifierTuple.fromPlain(n[i]);null!==s?o.push(s):r=!1,i++}if(r&&o[o.length-1].random>he.INT32_BOTTOM)return new t(o)}}return null},t.fromBase=function(e,n){return console.assert(he.isInt32(n),"offset ∈ int32"),new t(e.tuples.map(function(t,r){return r===e.length-1?fe.IdentifierTuple.fromBase(t,n):t}))},Object.defineProperty(t.prototype,"generator",{get:function(){return this.tuples[this.tuples.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.tuples.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"replicaNumber",{get:function(){return this.tuples[this.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"clock",{get:function(){return this.tuples[this.length-1].clock},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dot",{get:function(){return{replicaNumber:this.replicaNumber,clock:this.clock}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastOffset",{get:function(){return this.tuples[this.length-1].offset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"base",{get:function(){var t=this.tuples.reduce(function(t,e){return t.concat(e.asArray())},[]);return t.pop(),t},enumerable:!0,configurable:!0}),t.prototype.longestCommonPrefix=function(t){for(var e=[],n=Math.min(this.tuples.length,t.tuples.length),r=0;r<n&&this.tuples[r].equals(t.tuples[r]);)e.push(this.tuples[r]),r++;return e},t.prototype.longestCommonBase=function(t){for(var e=[],n=Math.min(this.tuples.length,t.tuples.length),r=0,i=!1;!i&&r<n;){var o=this.tuples[r],s=t.tuples[r];o.equals(s)?e.push(o):(i=!0,o.equalsBase(s)&&e.push(o)),r++}return e},t.prototype.isPrefix=function(t){return this.isBasePrefix(t)&&this.lastOffset===t.tuples[this.length-1].offset},t.prototype.isBasePrefix=function(t){var e=this;return this.length<=t.length&&this.tuples.every(function(n,r){var i=t.tuples[r];return r===e.tuples.length-1?n.equalsBase(i):n.equals(i)})},t.prototype.commonPrefixLength=function(t){for(var e=Math.min(this.tuples.length,t.tuples.length),n=0;n<e&&this.tuples[n].equals(t.tuples[n]);)n++;return n},t.prototype.equals=function(t){return this.equalsBase(t)&&this.lastOffset===t.lastOffset},t.prototype.equalsBase=function(t){var e=this;return this.length===t.length&&this.tuples.every(function(n,r){var i=t.tuples[r];return r<e.length-1?n.equals(i):n.equalsBase(i)})},t.prototype.compareTo=function(t){if(this.equals(t))return 0;if(this.isPrefix(t))return-1;if(t.isPrefix(this))return 1;var e=this.commonPrefixLength(t);return this.tuples[e].compareTo(t.tuples[e])},t.prototype.hasPlaceAfter=function(t){return console.assert(he.isInt32(t),"length ∈ int32"),console.assert(t>0,"length > 0 "),this.lastOffset<=he.INT32_TOP-t},t.prototype.hasPlaceBefore=function(t){return console.assert(he.isInt32(t),"length ∈ int32"),console.assert(t>0,"length > 0 "),this.lastOffset>=he.INT32_BOTTOM+t},t.prototype.maxOffsetBeforeNext=function(t,e){if(console.assert(he.isInt32(e),"max ∈ int32"),console.assert(-1===this.compareTo(t),"this must be less than next"),this.equalsBase(t))return console.assert(e<t.lastOffset,"max must be less than next.lastOffset"),e;if(this.isBasePrefix(t)){var n=t.tuples[this.length-1].offset;return Math.min(n,e)}return e},t.prototype.minOffsetAfterPrev=function(t,e){if(console.assert(he.isInt32(e),"min ∈ int32"),this.equalsBase(t))return console.assert(e>t.lastOffset,"min must be greater than prev.lastOffset"),e;if(this.isBasePrefix(t)){var n=t.tuples[this.length-1].offset;return Math.max(n+1,e)}return e},t.prototype.digest=function(){return this.tuples.reduce(function(t,e){return 17*t+e.digest()|0},0)},t.prototype.toString=function(){return"Id["+this.tuples.join(",")+"]"},t}();e.Identifier=n});ae(pe);pe.Identifier;var de=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){console.assert(he.isInt32(e),"end ∈ int32"),console.assert(t.lastOffset<=e,"idBegin must be less than or equal to idEnd"),this.idBegin=t,this.end=e}return t.fromPlain=function(e){if("object"==typeof e&&null!==e){var n=pe.Identifier.fromPlain(e.idBegin);if(null!==n&&"number"==typeof e.end&&he.isInt32(e.end)&&n.lastOffset<=e.end)return new t(n,e.end)}return null},Object.defineProperty(t.prototype,"begin",{get:function(){return this.idBegin.lastOffset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"idEnd",{get:function(){return this.getBaseId(this.end)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.end-this.begin+1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"base",{get:function(){return this.idBegin.base},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dot",{get:function(){return this.idBegin.dot},enumerable:!0,configurable:!0}),t.prototype.equals=function(t){return this.idBegin.equals(t.idBegin)&&this.begin===t.begin&&this.end===t.end},t.prototype.union=function(e,n){console.assert(he.isInt32(e),"aBegin ∈ int32"),console.assert(he.isInt32(n),"aEnd ∈ int32");var r=Math.min(this.begin,e),i=Math.max(this.end,n);return new t(pe.Identifier.fromBase(this.idBegin,r),i)},t.prototype.containsId=function(t){return-1===this.idBegin.compareTo(t)&&1===this.idEnd.compareTo(t)},t.prototype.getBaseId=function(t){return console.assert(he.isInt32(t),"offset ∈ int32"),console.assert(this.begin<=t&&t<=this.end,"offset must be included in the interval"),pe.Identifier.fromBase(this.idBegin,t)},t.prototype.digest=function(){return 17*this.idBegin.digest()+this.end|0},t.prototype.toString=function(){return"IdInterval["+this.idBegin.tuples.join(",")+" .. "+this.end+"]"},t}();e.IdentifierInterval=n});ae(de);de.IdentifierInterval;var ye=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){console.assert(he.isInt32(e)&&e>=0,"nbElt must be a non-negative integer"),this.idInterval=t,this.nbElement=e}return t.fromPlain=function(e){if("object"==typeof e&&null!==e){var n=e.idInterval,r=e.nbElement;if(n instanceof Object&&"number"==typeof r&&he.isInt32(r)&&r>=0){var i=de.IdentifierInterval.fromPlain(n);if(null!==i)return new t(i,r)}}return null},t.prototype.isMine=function(t){return this.idInterval.idBegin.generator===t},t.prototype.addBlock=function(t,e){console.assert(he.isInt32(e)&&e>0,"length must be a positive int32"),this.nbElement+=e,this.idInterval=this.idInterval.union(t,t+e-1)},t.prototype.delBlock=function(t){console.assert(he.isInt32(t)&&t>0,"nbElt must be a positive int32"),this.nbElement-=t},t.prototype.toString=function(){return"{"+this.nbElement+","+this.idInterval.toString()+"}"},t}();e.LogootSBlock=n});ae(ye);ye.LogootSBlock;var be=ue(function(t,e){var n=ce&&ce.__generator||function(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=r[2&o[0]?"return":o[0]?"throw":"next"])&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[0,i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(e,"__esModule",{value:!0});var r=new fe.IdentifierTuple(he.INT32_BOTTOM,0,0,0),i=new fe.IdentifierTuple(he.INT32_TOP,0,0,0);function o(t,e){var r,i;return n(this,function(n){switch(n.label){case 0:r=0,i=t,n.label=1;case 1:return r<i.length?[4,i[r]]:[3,4];case 2:n.sent(),n.label=3;case 3:return r++,[3,1];case 4:return[4,e];case 5:return n.sent(),[3,4];case 6:return[2]}})}function s(t){return null!==t?t.tuples:[]}e.createBetweenPosition=function(t,e,n,c){console.assert(null===t||null===e||-1===t.compareTo(e),"id1 < id2"),console.assert(he.isInt32(n),"replicaNumber is an int32"),console.assert(he.isInt32(c),"clock is an int32");for(var a=o(s(t),r),u=o(s(e),i),l=[],h=a.next().value,f=u.next().value;f.random-h.random<2;)l.push(h),h=a.next().value,f=u.next().value;var p=he.randomInt32(h.random+1,f.random);return l.push(new fe.IdentifierTuple(p,n,c,0)),new pe.Identifier(l)}});ae(be);be.createBetweenPosition;var ge=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.compareBase=function(t,e){var n=t.idBegin,r=t.begin,i=t.end,o=e.idBegin,s=e.begin,c=e.end;return n.equalsBase(o)?r===s&&i===c?6:i+1===s?4:r===c+1?5:i<s?1:c<r?0:(console.warn("Trying to duplicate existing identifiers: ",t,e),6):function(t,e){var n=t.idBegin,r=e.idBegin;return console.assert(!n.equalsBase(r),"the bases of the ids must be different"),t.containsId(r)?3:e.containsId(n)?2:-1===n.compareTo(r)?1:0}(t,e)}});ae(ge);ge.compareBase;var ve=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.fromPlain=function(t){if("object"==typeof t&&null!==t){var e=t.l;if("string"==typeof e&&e.length>0){var n=t.id,i=pe.Identifier.fromPlain(n);if(null!==i)return new r(i,e)}}return null},t}(),r=function(){function t(t,e){console.assert(e.length>0,"content must not be empty"),this.id=t,this.content=e}return t.fromPlain=function(e){if("object"==typeof e&&null!==e){var r=e.content;if(!("string"==typeof r&&r.length>0))return n.fromPlain(e);var i=e.id,o=pe.Identifier.fromPlain(i);if(null!==o)return new t(o,r)}return null},t.prototype.equals=function(t){return this.id.equals(t.id)&&this.content===t.content},t.prototype.execute=function(t){return t.addBlock(this.content,this.id)},t}();e.LogootSAdd=r});ae(ve);ve.LogootSAdd;var me=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=Array.prototype.concat,r=function(){function t(t){console.assert(t.length>0,"lid must not be empty"),this.lid=t}return t.fromPlain=function(e){if("object"==typeof e&&null!==e){var n=e.lid;if(n instanceof Array&&n.length>0){for(var r=!0,i=0,o=[];r&&i<n.length;){var s=de.IdentifierInterval.fromPlain(n[i]);null!==s?o.push(s):r=!1,i++}if(r)return new t(o)}}return null},t.prototype.equals=function(t){return this.lid.length===t.lid.length&&this.lid.every(function(e,n){var r=t.lid[n];return e.equals(r)})},t.prototype.execute=function(t){return n.apply([],this.lid.map(function(e){return t.delBlock(e)}))},t}();e.LogootSDel=r});ae(me);me.LogootSDel;var we=ue(function(t,e){function n(t){return null!==t?t.height:0}function r(t){return null!==t?t.sizeNodeAndChildren:0}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e,i,o,s){console.assert(he.isInt32(e),"actualBegin ∈ int32"),console.assert(t.idInterval.begin<=e,"actualBegin must be greater than or equal to idInterval.begin"),this.block=t,this.actualBegin=e,this.length=i,this.left=o,this.right=s,this.height=Math.max(n(o),n(s))+1,this.sizeNodeAndChildren=i+r(o)+r(s)}return t.fromPlain=function(e){if("object"==typeof e&&null!==e){var n=e.block,r=e.actualBegin,i=e.length,o=e.left,s=e.right;if(n instanceof Object&&"number"==typeof r&&he.isInt32(r)&&"number"==typeof i&&he.isInt32(i)&&i>=0){var c=ye.LogootSBlock.fromPlain(n),a=t.fromPlain(s),u=t.fromPlain(o);if(null!==c&&c.idInterval.begin<=r&&c.idInterval.end-c.idInterval.begin>=i-1)return new t(c,r,i,u,a)}}return null},t.leaf=function(e,n,r){return console.assert(he.isInt32(n),"aOffset ∈ int32"),console.assert(he.isInt32(r),"lenth ∈ int32"),console.assert(r>0,"lenth > 0"),e.addBlock(n,r),new t(e,n,r,null,null)},Object.defineProperty(t.prototype,"actualEnd",{get:function(){return this.actualBegin+this.length-1},enumerable:!0,configurable:!0}),t.prototype.getIdBegin=function(){return this.block.idInterval.getBaseId(this.actualBegin)},t.prototype.getIdEnd=function(){return this.block.idInterval.getBaseId(this.actualEnd)},t.prototype.addString=function(t){console.assert(he.isInt32(t),"length  ∈ int32"),this.sizeNodeAndChildren+=t},t.prototype.appendEnd=function(t){console.assert(he.isInt32(t),"length  ∈ int32"),console.assert(t>0,""+t," > 0");var e=this.actualEnd+1;return this.length+=t,this.block.addBlock(e,t),this.block.idInterval.getBaseId(e)},t.prototype.appendBegin=function(t){return console.assert(he.isInt32(t),"length  ∈ int32"),console.assert(t>0,""+t," > 0"),this.actualBegin-=t,this.length+=t,this.block.addBlock(this.actualBegin,t),this.getIdBegin()},t.prototype.deleteOffsets=function(t,e){console.assert(he.isInt32(t),"begin  ∈ int32"),console.assert(he.isInt32(e),"end  ∈ int32"),console.assert(t<=e,"begin <= end: "+t," <= "+e),console.assert(this.block.idInterval.begin<=t,"this.block.idInterval.begin <= to begin: "+this.block.idInterval.begin," <= "+t),console.assert(e<=this.block.idInterval.end,"end <= this.block.idInterval.end: "+e," <= "+this.block.idInterval.end);var n=null,r=Math.max(this.actualBegin,t),i=Math.min(this.actualEnd,e);if(r<=i){var o=i-r+1;this.block.delBlock(o),o!==this.length&&(r===this.actualBegin?this.actualBegin=i+1:i!==this.actualEnd&&(n=this.split(i-this.actualBegin+1,null))),this.length=this.length-o}return n},t.prototype.split=function(e,n){var r=new t(this.block,this.actualBegin+e,this.length-e,n,this.right);return this.length=e,this.right=r,this.height=Math.max(this.height,r.height),r},t.prototype.leftSubtreeSize=function(){return r(this.left)},t.prototype.rightSubtreeSize=function(){return r(this.right)},t.prototype.sumDirectChildren=function(){this.height=Math.max(n(this.left),n(this.right))+1,this.sizeNodeAndChildren=this.leftSubtreeSize()+this.rightSubtreeSize()+this.length},t.prototype.replaceChildren=function(t,e){this.left===t?this.left=e:this.right===t&&(this.right=e)},t.prototype.balanceScore=function(){return n(this.right)-n(this.left)},t.prototype.become=function(t){this.sizeNodeAndChildren=-this.length+t.length,this.length=t.length,this.actualBegin=t.actualBegin,this.block=t.block},t.prototype.isAppendableAfter=function(t,e){return this.block.isMine(t)&&this.block.idInterval.end===this.actualEnd&&this.block.idInterval.idEnd.hasPlaceAfter(e)},t.prototype.isAppendableBefore=function(t,e){return this.block.isMine(t)&&this.block.idInterval.begin===this.actualBegin&&this.block.idInterval.idBegin.hasPlaceBefore(e)},t.prototype.toString=function(){var t=this.getIdentifierInterval().toString(),e=null!==this.left?this.left.toString():"\t#";return(null!==this.right?this.right.toString():"\t#").replace(/(\t+)/g,"\t$1")+"\n\t"+t+"\n"+e.replace(/(\t+)/g,"\t$1")},t.prototype.toList=function(){var t=this.getIdentifierInterval(),e=null!==this.left?this.left.toList():[],n=null!==this.right?this.right.toList():[];return e.concat(t,n)},t.prototype.getIdentifierInterval=function(){return new de.IdentifierInterval(this.getIdBegin(),this.actualEnd)},t.prototype.getBlocks=function(){var t=[this.block],e=this.left;null!==e&&(t=t.concat(e.getBlocks()));var n=this.right;return null!==n&&(t=t.concat(n.getBlocks())),t},t}();e.RopesNodes=i});ae(we);we.RopesNodes;var Se=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){console.assert(he.isInt32(t),"offset  ∈ int32"),console.assert(he.isInt32(e),"length  ∈ int32"),console.assert(e>0,"length > 0"),this.offset=t,this.length=e}return t.prototype.equals=function(t){return this.offset===t.offset&&this.length===t.length},t.prototype.applyTo=function(t){return t.delLocal(this.offset,this.offset+this.length-1)},t}();e.TextDelete=n});ae(Se);Se.TextDelete;var Ie=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){console.assert(he.isInt32(t),"offset ∈ int32"),this.offset=t,this.content=e}return t.prototype.equals=function(t){return this.offset===t.offset&&this.content===t.content},t.prototype.applyTo=function(t){return t.insertLocal(this.offset,this.content)},t}();e.TextInsert=n});ae(Ie);Ie.TextInsert;var Oe=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.insert=function(t,e,n){console.assert(Number.isSafeInteger(e),"index ∈ safe integer");var r=Math.max(0,e);return t.slice(0,r)+n+t.slice(r)},e.del=function(t,e,n){return console.assert(Number.isSafeInteger(e),"begin ∈ safe integer"),console.assert(Number.isSafeInteger(n),"end ∈ safe integer"),t.slice(0,e)+t.slice(n+1)},e.occurrences=function(t,e){for(var n=0,r=e.length,i=t.indexOf(e);-1!==i;)n++,i=t.indexOf(e,i+r);return n}});ae(Oe);Oe.insert,Oe.del,Oe.occurrences;var xe=ue(function(t,e){function n(t){return t.left}function r(t){return t.right}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=null),void 0===r&&(r=""),console.assert(he.isInt32(t),"replica ∈ int32"),console.assert(he.isInt32(e),"clock ∈ int32"),this.replicaNumber=t,this.clock=e,this.root=n,this.str=r;var i={};if(null!==n){console.assert(r.length===n.sizeNodeAndChildren,"str length must match the number of elements in the model");for(var o=0,s=n.getBlocks();o<s.length;o++){var c=s[o];i[c.idInterval.base.join(",")]=c}}else console.assert(0===r.length,"str must be empty when no root is provided");this.mapBaseToBlock=i}return t.empty=function(){return new t(0,0)},t.fromPlain=function(e,n,r){if(console.assert(he.isInt32(e),"replica ∈ int32"),console.assert(he.isInt32(n),"clock ∈ int32"),"object"==typeof r&&null!==r){var i=r.str,o=r.root;if("string"==typeof i){var s=we.RopesNodes.fromPlain(o);if(null!==s&&i.length===s.sizeNodeAndChildren)return new t(e,n,s,i)}}return null},t.prototype.getBlock=function(t){var e,n=this.mapBaseToBlock,r=t.base.join(",");return n.hasOwnProperty(r)?e=n[r]:(e=new ye.LogootSBlock(t,0),this.mapBaseToBlock[r]=e),e},t.prototype.addBlockFrom=function(t,e,n,r){var i=this,o=this.addBlockFromRec(t,e,n,r);return o.forEach(function(t){i.applyTextInsert(t)}),o},t.prototype.addBlockFromRec=function(t,e,n,r){for(var i=[],o=[],s=!0,c=r;s;)switch(i.push(n),ge.compareBase(e,n.getIdentifierInterval())){case 0:null===n.right?(n.right=we.RopesNodes.leaf(this.getBlock(e),e.begin,t.length),c=c+n.leftSubtreeSize()+n.length,o.push(new Ie.TextInsert(c,t)),s=!1):(c=c+n.leftSubtreeSize()+n.length,n=n.right);break;case 1:null===n.left?(n.left=we.RopesNodes.leaf(this.getBlock(e),e.begin,t.length),o.push(new Ie.TextInsert(c,t)),s=!1):n=n.left;break;case 2:var a=n.getIdBegin().length-1,u=e.idBegin.tuples[a].offset,l=we.RopesNodes.leaf(this.getBlock(e),e.begin,t.length);i.push(n.split(u-n.actualBegin+1,l)),c+=n.leftSubtreeSize(),o.push(new Ie.TextInsert(c+u-n.actualBegin+1,t)),s=!1;break;case 3:a=e.idBegin.length-1,u=n.getIdBegin().tuples[a].offset;var h=t.substr(0,u+1-e.begin),f=new de.IdentifierInterval(e.idBegin,u);null===n.left?(n.left=we.RopesNodes.leaf(this.getBlock(f),f.begin,h.length),o.push(new Ie.TextInsert(c,h))):Array.prototype.push.apply(o,this.addBlockFromRec(h,f,n.left,c)),h=t.substr(u+1-e.begin,t.length);var p=pe.Identifier.fromBase(e.idBegin,u+1);f=new de.IdentifierInterval(p,e.end),c=c+n.leftSubtreeSize()+n.length,null===n.right?(n.right=we.RopesNodes.leaf(this.getBlock(f),f.begin,h.length),o.push(new Ie.TextInsert(c,h))):Array.prototype.push.apply(o,this.addBlockFromRec(h,f,n.right,c)),s=!1;break;case 4:if(null!==n.left){var d=n.getIdBegin().minOffsetAfterPrev(n.left.getIdEnd(),e.begin);(y=t.substr(d-e.begin,t.length)).length>0&&(n.appendBegin(y.length),o.push(new Ie.TextInsert(c+n.leftSubtreeSize(),y)),this.ascendentUpdate(i,y.length)),d-1>=e.begin?(t=t.substr(0,d-e.begin),e=new de.IdentifierInterval(e.idBegin,d-1),n=n.left):s=!1}else o.push(new Ie.TextInsert(c,t)),n.appendBegin(t.length),this.ascendentUpdate(i,t.length),s=!1;break;case 5:if(null!==n.right){d=n.getIdEnd().maxOffsetBeforeNext(n.right.getIdBegin(),e.end);var y=t.substr(0,d+1-e.begin);if(c=c+n.leftSubtreeSize()+n.length,y.length>0&&(n.appendEnd(y.length),o.push(new Ie.TextInsert(c,y)),this.ascendentUpdate(i,y.length)),e.end>=d+1){t=t.substr(d+1-e.begin,t.length);p=pe.Identifier.fromBase(e.idBegin,d+1);e=new de.IdentifierInterval(p,e.end),n=n.right,c+=y.length}else s=!1}else c=c+n.leftSubtreeSize()+n.length,o.push(new Ie.TextInsert(c,t)),n.appendEnd(t.length),this.ascendentUpdate(i,t.length),s=!1;break;case 6:s=!1}return this.balance(i),o},t.prototype.applyTextInsert=function(t){this.str=Oe.insert(this.str,t.offset,t.content)},t.prototype.applyTextDelete=function(t){var e=t.offset+t.length-1;this.str=Oe.del(this.str,t.offset,e)},t.prototype.addBlock=function(t,e){var n=new de.IdentifierInterval(e,e.lastOffset+t.length-1);if(null===this.root){var r=new ye.LogootSBlock(n,0);this.mapBaseToBlock[r.idInterval.base.join(",")]=r,this.root=we.RopesNodes.leaf(r,e.lastOffset,t.length);var i=new Ie.TextInsert(0,t);return this.applyTextInsert(i),[i]}return this.addBlockFrom(t,n,this.root,0)},t.prototype.mkNode=function(t,e,n){console.assert(he.isInt32(n)&&n>0,"length ∈ int32"),console.assert(n>0,"length > 0");var r=be.createBetweenPosition(t,e,this.replicaNumber,this.clock++),i=new de.IdentifierInterval(r,n-1),o=new ye.LogootSBlock(i,0);return this.mapBaseToBlock[i.base.join(",")]=o,we.RopesNodes.leaf(o,0,n)},t.prototype.insertLocal=function(t,e){if(console.assert(he.isInt32(t),"pos ∈ int32"),null===this.root)return this.root=this.mkNode(null,null,e.length),this.str=Oe.insert(this.str,t,e),new ve.LogootSAdd(this.root.getIdBegin(),e);var i=void 0,o=this.str.length;this.str=Oe.insert(this.str,t,e);var s=void 0;if(0===t){if((s=[]).push(this.root),(a=this.getXest(n,s)).isAppendableBefore(this.replicaNumber,e.length)){var c=a.appendBegin(e.length);return this.ascendentUpdate(s,e.length),new ve.LogootSAdd(c,e)}i=this.mkNode(null,a.getIdBegin(),e.length),a.left=i}else if(t>=o){var a;if((s=[]).push(this.root),(a=this.getXest(r,s)).isAppendableAfter(this.replicaNumber,e.length)){var u=a.appendEnd(e.length);return this.ascendentUpdate(s,e.length),new ve.LogootSAdd(u,e)}i=this.mkNode(a.getIdEnd(),null,e.length),a.right=i}else{var l=this.searchNode(t);if(l.i>0){var h=l.node.block.idInterval.getBaseId(l.node.actualBegin+l.i-1),f=l.node.block.idInterval.getBaseId(l.node.actualBegin+l.i);i=this.mkNode(h,f,e.length),(s=l.path).push(l.node.split(l.i,i))}else{var p=this.searchNode(t-1);if(l.node.isAppendableBefore(this.replicaNumber,e.length)){var d=l.node.appendBegin(e.length);return this.ascendentUpdate(l.path,e.length),new ve.LogootSAdd(d,e)}if(p.node.isAppendableAfter(this.replicaNumber,e.length)){var y=p.node.appendEnd(e.length);return this.ascendentUpdate(p.path,e.length),new ve.LogootSAdd(y,e)}(i=this.mkNode(p.node.getIdEnd(),l.node.getIdBegin(),e.length)).right=p.node.right,p.node.right=i,(s=p.path).push(i)}}return this.balance(s),new ve.LogootSAdd(i.getIdBegin(),e)},t.prototype.getXest=function(t,e){for(var n=e[e.length-1],r=t(n);null!==r;)n=r,e[e.length]=r,r=t(r);return n},t.prototype.searchPos=function(t,e){for(var n=0,r=this.root;null!==r;)if(e.push(r),-1===t.compareTo(r.getIdBegin()))r=r.left;else if(1===t.compareTo(r.getIdEnd()))n=n+r.leftSubtreeSize()+r.length,r=r.right;else{if(t.equalsBase(r.getIdBegin()))return n+r.leftSubtreeSize();r=null}return-1},t.prototype.searchNode=function(t){console.assert(he.isInt32(t),"pos ∈ int32");for(var e=this.root,n=[];null!==e;){n.push(e);var r=e.leftSubtreeSize();if(t<r)e=e.left;else{if(t<r+e.length)return{i:t-r,node:e,path:n};t-=r+e.length,e=e.right}}return null},t.prototype.ascendentUpdate=function(t,e){console.assert(he.isInt32(e),"length ∈ int32");for(var n=0,r=t;n<r.length;n++){r[n].addString(e)}},t.prototype.delBlock=function(t){for(var e,n=this,r=[];;){var i=[];if(-1===(e=this.searchPos(t.idBegin,i))){if(!(t.begin<t.end))break;var o=pe.Identifier.fromBase(t.idBegin,t.begin+1);t=new de.IdentifierInterval(o,t.end)}else{var s=i[i.length-1],c=Math.min(t.end,s.actualEnd),a=e+t.begin-s.actualBegin,u=c-t.begin+1;r.push(new Se.TextDelete(a,u));var l=s.deleteOffsets(t.begin,c);if(0===s.length?this.delNode(i):null!==l?(i.push(l),this.balance(i)):this.ascendentUpdate(i,t.begin-c-1),c===t.end)break;o=pe.Identifier.fromBase(t.idBegin,c);t=new de.IdentifierInterval(o,t.end)}}return r.forEach(function(t){n.applyTextDelete(t)}),r},t.prototype.delLocal=function(t,e){console.assert(he.isInt32(t),"begin ∈ int32"),console.assert(he.isInt32(e),"end ∈ int32"),console.assert(t<=e,""+t," <= "+e),this.str=Oe.del(this.str,t,e);var n=e-t+1,r=[];do{var i=this.searchNode(t);if(null!==i){var o=i.node.actualBegin+i.i,s=Math.min(o+n-1,i.node.actualEnd),c=i.node.getIdBegin(),a=pe.Identifier.fromBase(c,o);r.push(new de.IdentifierInterval(a,s));var u=i.node.deleteOffsets(o,s);n-=s-o+1,0===i.node.length?this.delNode(i.path):null!==u?(i.path.push(u),this.balance(i.path)):this.ascendentUpdate(i.path,o-s-1)}else n=0}while(n>0);return new me.LogootSDel(r)},t.prototype.delNode=function(t){var e=t[t.length-1];if(0===e.block.nbElement&&delete this.mapBaseToBlock[e.block.idInterval.base.join(",")],null===e.right)e===this.root?this.root=e.left:(t.pop(),t[t.length-1].replaceChildren(e,e.left));else if(null===e.left)e===this.root?this.root=e.right:(t.pop(),t[t.length-1].replaceChildren(e,e.right));else{t.push(e.right);var n=this.getMinPath(t);e.become(n),t.pop(),t[t.length-1].replaceChildren(n,n.right)}this.balance(t)},t.prototype.getMinPath=function(t){console.assert(0!==t.length,"path has at least one item");for(var e=t[t.length-1];null!==e.left;)e=e.left,t.push(e);return e},t.prototype.balance=function(t){for(;t.length>0;){var e=t.pop(),n=0===t.length?null:t[t.length-1];e.sumDirectChildren();for(var r=e.balanceScore();Math.abs(r)>=2;)n=r>=2?null!==e.right&&e.right.balanceScore()<=-1?this.rotateRL(e,n):this.rotateLeft(e,n):null!==e.left&&e.left.balanceScore()>=1?this.rotateLR(e,n):this.rotateRight(e,n),t.push(n),r=e.balanceScore()}},t.prototype.rotateLeft=function(t,e){console.assert(null!==t.right,"There exists a right node"),console.assert(t===this.root==(null===e),"The father is null when we are rotating left the root");var n=t.right;return t===this.root?this.root=n:e.replaceChildren(t,n),t.right=n.left,n.left=t,t.sumDirectChildren(),n.sumDirectChildren(),n},t.prototype.rotateRight=function(t,e){console.assert(null!==t.left,"There exists a left node"),console.assert(t===this.root==(null===e),"The father is null when we are rotating right the root");var n=t.left;return t===this.root?this.root=n:e.replaceChildren(t,n),t.left=n.right,n.right=t,t.sumDirectChildren(),n.sumDirectChildren(),n},t.prototype.rotateRL=function(t,e){console.assert(null!==t.right,"There exists a right node");var n=t.right;return console.assert(null!==n.left,"There exists a left node of the right node"),this.rotateRight(n,t),this.rotateLeft(t,e)},t.prototype.rotateLR=function(t,e){console.assert(null!==t.left,"There exists a left node");var n=t.left;return console.assert(null!==n.right,"There exists a right node of the left node"),this.rotateLeft(n,t),this.rotateRight(t,e)},t.prototype.getNext=function(t){var e=t[t.length-1];if(null===e.right){if(t.length>1)if(t[t.length-2].left===e)return t.pop(),!0;return!1}return t.push(e.right),this.getXest(n,t),!0},t.prototype.digest=function(){var t=0,e=this.root;if(null!==e)for(var n=0,r=e.toList();n<r.length;n++){t=17*t+r[n].digest()|0}return t},t}();e.LogootSRopes=i});ae(xe);xe.LogootSRopes;var _e=ue(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isDot=le.isDot,e.IdentifierTuple=fe.IdentifierTuple,e.Identifier=pe.Identifier,e.IdentifierInterval=de.IdentifierInterval,e.LogootSBlock=ye.LogootSBlock,e.LogootSRopes=xe.LogootSRopes,e.RopesNodes=we.RopesNodes,e.LogootSAdd=ve.LogootSAdd,e.LogootSDel=me.LogootSDel,e.TextDelete=Se.TextDelete,e.TextInsert=Ie.TextInsert,e.insert=Oe.insert,e.del=Oe.del,e.occurrences=Oe.occurrences});ae(_e);var Ee=_e.isDot,ke=(_e.IdentifierTuple,_e.Identifier),Te=(_e.IdentifierInterval,_e.LogootSBlock,_e.LogootSRopes),Ce=(_e.RopesNodes,_e.LogootSAdd),Me=_e.LogootSDel,je=_e.TextDelete,Ne=_e.TextInsert,Ae=(_e.insert,_e.del,_e.occurrences,function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.scheduler=e,r.work=n,r}return s(e,t),e.prototype.requestAsyncId=function(e,n,r){return void 0===r&&(r=0),null!==r&&r>0?t.prototype.requestAsyncId.call(this,e,n,r):(e.actions.push(this),e.scheduled||(e.scheduled=requestAnimationFrame(function(){return e.flush(null)})))},e.prototype.recycleAsyncId=function(e,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return t.prototype.recycleAsyncId.call(this,e,n,r);0===e.actions.length&&(cancelAnimationFrame(n),e.scheduled=void 0)},e}(R)),Le=(new(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.flush=function(t){this.active=!0,this.scheduled=void 0;var e,n=this.actions,r=-1,i=n.length;t=t||n.shift();do{if(e=t.execute(t.state,t.delay))break}while(++r<i&&(t=n.shift()));if(this.active=!1,e){for(;++r<i&&(t=n.shift());)t.unsubscribe();throw e}},e}(U))(Ae),function(t){function e(e,n){void 0===e&&(e=Le),void 0===n&&(n=Number.POSITIVE_INFINITY);var r=t.call(this,e,function(){return r.frame})||this;return r.maxFrames=n,r.frame=0,r.index=-1,r}s(e,t),e.prototype.flush=function(){for(var t,e,n=this.actions,r=this.maxFrames;(e=n.shift())&&(this.frame=e.delay)<=r&&!(t=e.execute(e.state,e.delay)););if(t){for(;e=n.shift();)e.unsubscribe();throw t}},e.frameTimeFactor=10}(U),function(t){function e(e,n,r){void 0===r&&(r=e.index+=1);var i=t.call(this,e,n)||this;return i.scheduler=e,i.work=n,i.index=r,i.active=!0,i.index=e.index=r,i}return s(e,t),e.prototype.schedule=function(n,r){if(void 0===r&&(r=0),!this.id)return t.prototype.schedule.call(this,n,r);this.active=!1;var i=new e(this.scheduler,this.work);return this.add(i),i.schedule(n,r)},e.prototype.requestAsyncId=function(t,n,r){void 0===r&&(r=0),this.delay=t.frame+r;var i=t.actions;return i.push(this),i.sort(e.sortActions),!0},e.prototype.recycleAsyncId=function(t,e,n){void 0===n&&(n=0)},e.prototype._execute=function(e,n){if(!0===this.active)return t.prototype._execute.call(this,e,n)},e.sortActions=function(t,e){return t.delay===e.delay?t.index===e.index?0:t.index>e.index?1:-1:t.delay>e.delay?1:-1},e}(R)),Pe=(function(t){function e(e,n){var r=t.call(this,e)||this;r.sources=n,r.completed=0,r.haveValues=0;var i=n.length;r.values=new Array(i);for(var o=0;o<i;o++){var s=B(r,n[o],null,o);s&&r.add(s)}return r}s(e,t),e.prototype.notifyNext=function(t,e,n,r,i){this.values[n]=e,i._hasValue||(i._hasValue=!0,this.haveValues++)},e.prototype.notifyComplete=function(t){var e=this.destination,n=this.haveValues,r=this.values,i=r.length;t._hasValue?(this.completed++,this.completed===i&&(n===i&&e.next(r),e.complete())):e.complete()}}(k),new j(M),function(t){function e(e){var n=t.call(this)||this;return n.doc=new Te(e),n.digestSubject=new Et,n.treeSubject=new Et,n.localLogootSOperationsSubject=new Et,n.remoteTextOperationsSubject=new Et,n.localOperationLogsSubject=new Et,n.remoteOperationLogsSubject=new Et,n.updateSubject=new Et,n.newSub=n.updateSubject.pipe(function(t,e){return void 0===e&&(e=F),function(n){return n.lift(new Q(t,e))}}(1e3)).subscribe(function(){n.treeSubject.next(JSON.stringify(n.doc)),n.digestSubject.next(n.doc.digest())}),n}return s(e,t),Object.defineProperty(e.prototype,"localTextOperations$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){e.handleTextOperations(t),e.updateSubject.next()})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteLogootSOperations$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){var n=t.collaborator,r=t.operations.map(function(t){return e.handleRemoteOperation(t)}).reduce(function(t,e){return t.concat(e)},[]);e.remoteTextOperationsSubject.next({collaborator:n,operations:r}),e.updateSubject.next()})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"digest$",{get:function(){return this.digestSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tree$",{get:function(){return this.treeSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localLogootSOperations$",{get:function(){return this.localLogootSOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteTextOperations$",{get:function(){return this.remoteTextOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localOperationLog$",{get:function(){return this.localOperationLogsSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteOperationLog$",{get:function(){return this.remoteOperationLogsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.localLogootSOperationsSubject.complete(),this.remoteTextOperationsSubject.complete(),this.updateSubject.complete(),t.prototype.dispose.call(this)},e.prototype.handleTextOperations=function(t){var e=this;t.forEach(function(t){var n=t.applyTo(e.doc);e.localOperationLogsSubject.next({textop:t,logootsop:n}),e.localLogootSOperationsSubject.next(n)})},e.prototype.handleRemoteOperation=function(t){var e=t.execute(this.doc);return this.remoteOperationLogsSubject.next({textop:e,logootsop:t}),e},e.prototype.positionFromIndex=function(t){var e=this.doc.searchNode(t);if(null!==e){var n=e.node.actualBegin+e.i;return{id:ke.fromBase(e.node.getIdBegin(),n),index:e.i}}},e.prototype.indexFromId=function(t){return this.doc.searchPos(ke.fromPlain(t),new Array)},e}(i)),Be="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Re(t,e){return t(e={exports:{}},e.exports),e.exports}var De=function(t,e){var n=new Array(arguments.length-1),r=0,i=2,o=!0;for(;i<arguments.length;)n[r++]=arguments[i++];return new Promise(function(i,s){n[r]=function(t){if(o)if(o=!1,t)s(t);else{for(var e=new Array(arguments.length-1),n=0;n<e.length;)e[n++]=arguments[n];i.apply(null,e)}};try{t.apply(e||null,n)}catch(t){o&&(o=!1,s(t))}})};var Ue=Re(function(t,e){var n=e;n.length=function(t){var e=t.length;if(!e)return 0;for(var n=0;--e%4>1&&"="===t.charAt(e);)++n;return Math.ceil(3*t.length)/4-n};for(var r=new Array(64),i=new Array(123),o=0;o<64;)i[r[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;n.encode=function(t,e,n){for(var i,o=null,s=[],c=0,a=0;e<n;){var u=t[e++];switch(a){case 0:s[c++]=r[u>>2],i=(3&u)<<4,a=1;break;case 1:s[c++]=r[i|u>>4],i=(15&u)<<2,a=2;break;case 2:s[c++]=r[i|u>>6],s[c++]=r[63&u],a=0}c>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,s)),c=0)}return a&&(s[c++]=r[i],s[c++]=61,1===a&&(s[c++]=61)),o?(c&&o.push(String.fromCharCode.apply(String,s.slice(0,c))),o.join("")):String.fromCharCode.apply(String,s.slice(0,c))};n.decode=function(t,e,n){for(var r,o=n,s=0,c=0;c<t.length;){var a=t.charCodeAt(c++);if(61===a&&s>1)break;if(void 0===(a=i[a]))throw Error("invalid encoding");switch(s){case 0:r=a,s=1;break;case 1:e[n++]=r<<2|(48&a)>>4,r=a,s=2;break;case 2:e[n++]=(15&r)<<4|(60&a)>>2,r=a,s=3;break;case 3:e[n++]=(3&r)<<6|a,s=0}}if(1===s)throw Error("invalid encoding");return n-o},n.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}}),Fe=ze;function ze(){this._listeners={}}ze.prototype.on=function(t,e,n){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:n||this}),this},ze.prototype.off=function(t,e){if(void 0===t)this._listeners={};else if(void 0===e)this._listeners[t]=[];else for(var n=this._listeners[t],r=0;r<n.length;)n[r].fn===e?n.splice(r,1):++r;return this},ze.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var n=[],r=1;r<arguments.length;)n.push(arguments[r++]);for(r=0;r<e.length;)e[r].fn.apply(e[r++].ctx,n)}return this};var Ge=Ve(Ve);function Ve(t){return"undefined"!=typeof Float32Array?function(){var e=new Float32Array([-0]),n=new Uint8Array(e.buffer),r=128===n[3];function i(t,r,i){e[0]=t,r[i]=n[0],r[i+1]=n[1],r[i+2]=n[2],r[i+3]=n[3]}function o(t,r,i){e[0]=t,r[i]=n[3],r[i+1]=n[2],r[i+2]=n[1],r[i+3]=n[0]}function s(t,r){return n[0]=t[r],n[1]=t[r+1],n[2]=t[r+2],n[3]=t[r+3],e[0]}function c(t,r){return n[3]=t[r],n[2]=t[r+1],n[1]=t[r+2],n[0]=t[r+3],e[0]}t.writeFloatLE=r?i:o,t.writeFloatBE=r?o:i,t.readFloatLE=r?s:c,t.readFloatBE=r?c:s}():function(){function e(t,e,n,r){var i=e<0?1:0;if(i&&(e=-e),0===e)t(1/e>0?0:2147483648,n,r);else if(isNaN(e))t(2143289344,n,r);else if(e>3.4028234663852886e38)t((i<<31|2139095040)>>>0,n,r);else if(e<1.1754943508222875e-38)t((i<<31|Math.round(e/1.401298464324817e-45))>>>0,n,r);else{var o=Math.floor(Math.log(e)/Math.LN2);t((i<<31|o+127<<23|8388607&Math.round(e*Math.pow(2,-o)*8388608))>>>0,n,r)}}function n(t,e,n){var r=t(e,n),i=2*(r>>31)+1,o=r>>>23&255,s=8388607&r;return 255===o?s?NaN:i*(1/0):0===o?1.401298464324817e-45*i*s:i*Math.pow(2,o-150)*(s+8388608)}t.writeFloatLE=e.bind(null,We),t.writeFloatBE=e.bind(null,$e),t.readFloatLE=n.bind(null,qe),t.readFloatBE=n.bind(null,He)}(),"undefined"!=typeof Float64Array?function(){var e=new Float64Array([-0]),n=new Uint8Array(e.buffer),r=128===n[7];function i(t,r,i){e[0]=t,r[i]=n[0],r[i+1]=n[1],r[i+2]=n[2],r[i+3]=n[3],r[i+4]=n[4],r[i+5]=n[5],r[i+6]=n[6],r[i+7]=n[7]}function o(t,r,i){e[0]=t,r[i]=n[7],r[i+1]=n[6],r[i+2]=n[5],r[i+3]=n[4],r[i+4]=n[3],r[i+5]=n[2],r[i+6]=n[1],r[i+7]=n[0]}function s(t,r){return n[0]=t[r],n[1]=t[r+1],n[2]=t[r+2],n[3]=t[r+3],n[4]=t[r+4],n[5]=t[r+5],n[6]=t[r+6],n[7]=t[r+7],e[0]}function c(t,r){return n[7]=t[r],n[6]=t[r+1],n[5]=t[r+2],n[4]=t[r+3],n[3]=t[r+4],n[2]=t[r+5],n[1]=t[r+6],n[0]=t[r+7],e[0]}t.writeDoubleLE=r?i:o,t.writeDoubleBE=r?o:i,t.readDoubleLE=r?s:c,t.readDoubleBE=r?c:s}():function(){function e(t,e,n,r,i,o){var s=r<0?1:0;if(s&&(r=-r),0===r)t(0,i,o+e),t(1/r>0?0:2147483648,i,o+n);else if(isNaN(r))t(0,i,o+e),t(2146959360,i,o+n);else if(r>1.7976931348623157e308)t(0,i,o+e),t((s<<31|2146435072)>>>0,i,o+n);else{var c;if(r<2.2250738585072014e-308)t((c=r/5e-324)>>>0,i,o+e),t((s<<31|c/4294967296)>>>0,i,o+n);else{var a=Math.floor(Math.log(r)/Math.LN2);1024===a&&(a=1023),t(4503599627370496*(c=r*Math.pow(2,-a))>>>0,i,o+e),t((s<<31|a+1023<<20|1048576*c&1048575)>>>0,i,o+n)}}}function n(t,e,n,r,i){var o=t(r,i+e),s=t(r,i+n),c=2*(s>>31)+1,a=s>>>20&2047,u=4294967296*(1048575&s)+o;return 2047===a?u?NaN:c*(1/0):0===a?5e-324*c*u:c*Math.pow(2,a-1075)*(u+4503599627370496)}t.writeDoubleLE=e.bind(null,We,0,4),t.writeDoubleBE=e.bind(null,$e,4,0),t.readDoubleLE=n.bind(null,qe,0,4),t.readDoubleBE=n.bind(null,He,4,0)}(),t}function We(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}function $e(t,e,n){e[n]=t>>>24,e[n+1]=t>>>16&255,e[n+2]=t>>>8&255,e[n+3]=255&t}function qe(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function He(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}var Ke=function(t){return null};var Je=Re(function(t,e){var n=e;n.length=function(t){for(var e=0,n=0,r=0;r<t.length;++r)(n=t.charCodeAt(r))<128?e+=1:n<2048?e+=2:55296==(64512&n)&&56320==(64512&t.charCodeAt(r+1))?(++r,e+=4):e+=3;return e},n.read=function(t,e,n){if(n-e<1)return"";for(var r,i=null,o=[],s=0;e<n;)(r=t[e++])<128?o[s++]=r:r>191&&r<224?o[s++]=(31&r)<<6|63&t[e++]:r>239&&r<365?(r=((7&r)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,o[s++]=55296+(r>>10),o[s++]=56320+(1023&r)):o[s++]=(15&r)<<12|(63&t[e++])<<6|63&t[e++],s>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),s=0);return i?(s&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))},n.write=function(t,e,n){for(var r,i,o=n,s=0;s<t.length;++s)(r=t.charCodeAt(s))<128?e[n++]=r:r<2048?(e[n++]=r>>6|192,e[n++]=63&r|128):55296==(64512&r)&&56320==(64512&(i=t.charCodeAt(s+1)))?(r=65536+((1023&r)<<10)+(1023&i),++s,e[n++]=r>>18|240,e[n++]=r>>12&63|128,e[n++]=r>>6&63|128,e[n++]=63&r|128):(e[n++]=r>>12|224,e[n++]=r>>6&63|128,e[n++]=63&r|128);return n-o}}),Xe=function(t,e,n){var r=n||8192,i=r>>>1,o=null,s=r;return function(n){if(n<1||n>i)return t(n);s+n>r&&(o=t(r),s=0);var c=e.call(o,s,s+=n);return 7&s&&(s=1+(7|s)),c}};var Ze=Ye;function Ye(t,e){this.lo=t>>>0,this.hi=e>>>0}var Qe=Ye.zero=new Ye(0,0);Qe.toNumber=function(){return 0},Qe.zzEncode=Qe.zzDecode=function(){return this},Qe.length=function(){return 1};var tn=Ye.zeroHash="\0\0\0\0\0\0\0\0";Ye.fromNumber=function(t){if(0===t)return Qe;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new Ye(n,r)},Ye.from=function(t){if("number"==typeof t)return Ye.fromNumber(t);if(rn.isString(t)){if(!rn.Long)return Ye.fromNumber(parseInt(t,10));t=rn.Long.fromString(t)}return t.low||t.high?new Ye(t.low>>>0,t.high>>>0):Qe},Ye.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},Ye.prototype.toLong=function(t){return rn.Long?new rn.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var en=String.prototype.charCodeAt;Ye.fromHash=function(t){return t===tn?Qe:new Ye((en.call(t,0)|en.call(t,1)<<8|en.call(t,2)<<16|en.call(t,3)<<24)>>>0,(en.call(t,4)|en.call(t,5)<<8|en.call(t,6)<<16|en.call(t,7)<<24)>>>0)},Ye.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},Ye.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},Ye.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},Ye.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10};var nn,rn=Re(function(t,e){var n=e;function r(t,e,n){for(var r=Object.keys(e),i=0;i<r.length;++i)void 0!==t[r[i]]&&n||(t[r[i]]=e[r[i]]);return t}function i(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(e.prototype=Object.create(Error.prototype)).constructor=e,Object.defineProperty(e.prototype,"name",{get:function(){return t}}),e.prototype.toString=function(){return this.name+": "+this.message},e}n.asPromise=De,n.base64=Ue,n.EventEmitter=Fe,n.float=Ge,n.inquire=Ke,n.utf8=Je,n.pool=Xe,n.LongBits=Ze,n.global="undefined"!=typeof window&&window||void 0!==Be&&Be||"undefined"!=typeof self&&self||Be,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=Boolean(n.global.process&&n.global.process.versions&&n.global.process.versions.node),n.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},n.isString=function(t){return"string"==typeof t||t instanceof String},n.isObject=function(t){return t&&"object"==typeof t},n.isset=n.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},n.Buffer=function(){try{var t=n.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(t){return"number"==typeof t?n.Buffer?n._Buffer_allocUnsafe(t):new n.Array(t):n.Buffer?n._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=n.global.dcodeIO&&n.global.dcodeIO.Long||n.global.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(t){return t?n.LongBits.from(t).toHash():n.LongBits.zeroHash},n.longFromHash=function(t,e){var r=n.LongBits.fromHash(t);return n.Long?n.Long.fromBits(r.lo,r.hi,e):r.toNumber(Boolean(e))},n.merge=r,n.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},n.newError=i,n.ProtocolError=i("ProtocolError"),n.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},n.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var t=n.Buffer;t?(n._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},n._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):n._Buffer_from=n._Buffer_allocUnsafe=null}}),on=hn,sn=rn.LongBits,cn=rn.base64,an=rn.utf8;function un(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function ln(){}function hn(){this.len=0,this.head=new un(ln,0,0),this.tail=this.head,this.states=null}function fn(t,e,n){e[n]=255&t}function pn(t,e){this.len=t,this.next=void 0,this.val=e}function dn(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function yn(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}hn.create=rn.Buffer?function(){return(hn.create=function(){return new nn})()}:function(){return new hn},hn.alloc=function(t){return new rn.Array(t)},rn.Array!==Array&&(hn.alloc=rn.pool(hn.alloc,rn.Array.prototype.subarray)),hn.prototype._push=function(t,e,n){return this.tail=this.tail.next=new un(t,e,n),this.len+=e,this},pn.prototype=Object.create(un.prototype),pn.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},hn.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new pn((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},hn.prototype.int32=function(t){return t<0?this._push(dn,10,sn.fromNumber(t)):this.uint32(t)},hn.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},hn.prototype.uint64=function(t){var e=sn.from(t);return this._push(dn,e.length(),e)},hn.prototype.int64=hn.prototype.uint64,hn.prototype.sint64=function(t){var e=sn.from(t).zzEncode();return this._push(dn,e.length(),e)},hn.prototype.bool=function(t){return this._push(fn,1,t?1:0)},hn.prototype.fixed32=function(t){return this._push(yn,4,t>>>0)},hn.prototype.sfixed32=hn.prototype.fixed32,hn.prototype.fixed64=function(t){var e=sn.from(t);return this._push(yn,4,e.lo)._push(yn,4,e.hi)},hn.prototype.sfixed64=hn.prototype.fixed64,hn.prototype.float=function(t){return this._push(rn.float.writeFloatLE,4,t)},hn.prototype.double=function(t){return this._push(rn.float.writeDoubleLE,8,t)};var bn=rn.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};hn.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(fn,1,0);if(rn.isString(t)){var n=hn.alloc(e=cn.length(t));cn.decode(t,n,0),t=n}return this.uint32(e)._push(bn,e,t)},hn.prototype.string=function(t){var e=an.length(t);return e?this.uint32(e)._push(an.write,e,t):this._push(fn,1,0)},hn.prototype.fork=function(){return this.states=new function(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}(this),this.head=this.tail=new un(ln,0,0),this.len=0,this},hn.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new un(ln,0,0),this.len=0),this},hn.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},hn.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},hn._configure=function(t){nn=t};var gn=mn;(mn.prototype=Object.create(on.prototype)).constructor=mn;var vn=rn.Buffer;function mn(){on.call(this)}mn.alloc=function(t){return(mn.alloc=rn._Buffer_allocUnsafe)(t)};var wn=vn&&vn.prototype instanceof Uint8Array&&"set"===vn.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]};function Sn(t,e,n){t.length<40?rn.utf8.write(t,e,n):e.utf8Write(t,n)}mn.prototype.bytes=function(t){rn.isString(t)&&(t=rn._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(wn,e,t),this},mn.prototype.string=function(t){var e=vn.byteLength(t);return this.uint32(e),e&&this._push(Sn,e,t),this};var In,On=kn,xn=rn.LongBits,_n=rn.utf8;function En(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function kn(t){this.buf=t,this.pos=0,this.len=t.length}var Tn="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new kn(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new kn(t);throw Error("illegal buffer")};function Cn(){var t=new xn(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw En(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw En(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function Mn(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function jn(){if(this.pos+8>this.len)throw En(this,8);return new xn(Mn(this.buf,this.pos+=4),Mn(this.buf,this.pos+=4))}kn.create=rn.Buffer?function(t){return(kn.create=function(t){return rn.Buffer.isBuffer(t)?new In(t):Tn(t)})(t)}:Tn,kn.prototype._slice=rn.Array.prototype.subarray||rn.Array.prototype.slice,kn.prototype.uint32=function(){var t=4294967295;return function(){if(t=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return t;if(t=(t|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return t;if((this.pos+=5)>this.len)throw this.pos=this.len,En(this,10);return t}}(),kn.prototype.int32=function(){return 0|this.uint32()},kn.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},kn.prototype.bool=function(){return 0!==this.uint32()},kn.prototype.fixed32=function(){if(this.pos+4>this.len)throw En(this,4);return Mn(this.buf,this.pos+=4)},kn.prototype.sfixed32=function(){if(this.pos+4>this.len)throw En(this,4);return 0|Mn(this.buf,this.pos+=4)},kn.prototype.float=function(){if(this.pos+4>this.len)throw En(this,4);var t=rn.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},kn.prototype.double=function(){if(this.pos+8>this.len)throw En(this,4);var t=rn.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},kn.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw En(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},kn.prototype.string=function(){var t=this.bytes();return _n.read(t,0,t.length)},kn.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw En(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw En(this)}while(128&this.buf[this.pos++]);return this},kn.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},kn._configure=function(t){In=t;var e=rn.Long?"toLong":"toNumber";rn.merge(kn.prototype,{int64:function(){return Cn.call(this)[e](!1)},uint64:function(){return Cn.call(this)[e](!0)},sint64:function(){return Cn.call(this).zzDecode()[e](!1)},fixed64:function(){return jn.call(this)[e](!0)},sfixed64:function(){return jn.call(this)[e](!1)}})};var Nn=An;function An(t){On.call(this,t)}(An.prototype=Object.create(On.prototype)).constructor=An,rn.Buffer&&(An.prototype._slice=rn.Buffer.prototype.slice),An.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len))};var Ln=Pn;function Pn(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");rn.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(Pn.prototype=Object.create(rn.EventEmitter.prototype)).constructor=Pn,Pn.prototype.rpcCall=function t(e,n,r,i,o){if(!i)throw TypeError("request must be specified");var s=this;if(!o)return rn.asPromise(t,s,e,n,r,i);if(s.rpcImpl)try{return s.rpcImpl(e,n[s.requestDelimited?"encodeDelimited":"encode"](i).finish(),function(t,n){if(t)return s.emit("error",t,e),o(t);if(null!==n){if(!(n instanceof r))try{n=r[s.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return s.emit("error",t,e),o(t)}return s.emit("data",n,e),o(null,n)}s.end(!0)})}catch(t){return s.emit("error",t,e),void setTimeout(function(){o(t)},0)}else setTimeout(function(){o(Error("already ended"))},0)},Pn.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};var Bn=Re(function(t,e){e.Service=Ln}),Rn={},Dn=Re(function(t,e){var n=e;function r(){n.Reader._configure(n.BufferReader),n.util._configure()}n.build="minimal",n.Writer=on,n.BufferWriter=gn,n.Reader=On,n.BufferReader=Nn,n.util=rn,n.rpc=Bn,n.roots=Rn,n.configure=r,n.Writer._configure(n.BufferWriter),r()}),Un=Dn.Reader,Fn=Dn.Writer,zn=Dn.util,Gn=Dn.roots,Vn=Un,Wn=Fn,$n=zn,qn=Gn.default||(Gn.default={}),Hn=qn.sync=function(){var t={};return t.SyncMsg=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.richLogootSOpMsg=null,t.prototype.querySync=null,t.prototype.replySync=null,Object.defineProperty(t.prototype,"type",{get:$n.oneOfGetter(e=["richLogootSOpMsg","querySync","replySync"]),set:$n.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.richLogootSOpMsg&&t.hasOwnProperty("richLogootSOpMsg")&&qn.sync.RichLogootSOperationMsg.encode(t.richLogootSOpMsg,e.uint32(10).fork()).ldelim(),null!=t.querySync&&t.hasOwnProperty("querySync")&&qn.sync.QuerySyncMsg.encode(t.querySync,e.uint32(18).fork()).ldelim(),null!=t.replySync&&t.hasOwnProperty("replySync")&&qn.sync.ReplySyncMsg.encode(t.replySync,e.uint32(26).fork()).ldelim(),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.SyncMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.richLogootSOpMsg=qn.sync.RichLogootSOperationMsg.decode(t,t.uint32());break;case 2:r.querySync=qn.sync.QuerySyncMsg.decode(t,t.uint32());break;case 3:r.replySync=qn.sync.ReplySyncMsg.decode(t,t.uint32());break;default:t.skipType(7&i)}}return r},t}(),t.RichLogootSOperationMsg=function(){function t(t){if(this.dependencies=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}var e;return t.prototype.id=0,t.prototype.clock=0,t.prototype.logootSAddMsg=null,t.prototype.logootSDelMsg=null,t.prototype.dependencies=$n.emptyArray,Object.defineProperty(t.prototype,"type",{get:$n.oneOfGetter(e=["logootSAddMsg","logootSDelMsg"]),set:$n.oneOfSetter(e)}),t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=Wn.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).int32(t.id),null!=t.clock&&t.hasOwnProperty("clock")&&e.uint32(16).int32(t.clock),null!=t.logootSAddMsg&&t.hasOwnProperty("logootSAddMsg")&&qn.sync.LogootSAddMsg.encode(t.logootSAddMsg,e.uint32(26).fork()).ldelim(),null!=t.logootSDelMsg&&t.hasOwnProperty("logootSDelMsg")&&qn.sync.LogootSDelMsg.encode(t.logootSDelMsg,e.uint32(34).fork()).ldelim(),null!=t.dependencies&&t.dependencies.length)for(var n=0;n<t.dependencies.length;++n)qn.sync.DotMsg.encode(t.dependencies[n],e.uint32(42).fork()).ldelim();return e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.RichLogootSOperationMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=t.int32();break;case 2:r.clock=t.int32();break;case 3:r.logootSAddMsg=qn.sync.LogootSAddMsg.decode(t,t.uint32());break;case 4:r.logootSDelMsg=qn.sync.LogootSDelMsg.decode(t,t.uint32());break;case 5:r.dependencies&&r.dependencies.length||(r.dependencies=[]),r.dependencies.push(qn.sync.DotMsg.decode(t,t.uint32()));break;default:t.skipType(7&i)}}return r},t}(),t.LogootSAddMsg=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=null,t.prototype.content="",t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.id&&t.hasOwnProperty("id")&&qn.sync.IdentifierMsg.encode(t.id,e.uint32(10).fork()).ldelim(),null!=t.content&&t.hasOwnProperty("content")&&e.uint32(18).string(t.content),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.LogootSAddMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=qn.sync.IdentifierMsg.decode(t,t.uint32());break;case 2:r.content=t.string();break;default:t.skipType(7&i)}}return r},t}(),t.IdentifierMsg=function(){function t(t){if(this.tuples=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.tuples=$n.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=Wn.create()),null!=t.tuples&&t.tuples.length)for(var n=0;n<t.tuples.length;++n)qn.sync.IdentifierTupleMsg.encode(t.tuples[n],e.uint32(10).fork()).ldelim();return e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.IdentifierMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.tuples&&r.tuples.length||(r.tuples=[]),r.tuples.push(qn.sync.IdentifierTupleMsg.decode(t,t.uint32()));break;default:t.skipType(7&i)}}return r},t}(),t.IdentifierTupleMsg=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.random=0,t.prototype.replicaNumber=0,t.prototype.clock=0,t.prototype.offset=0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.random&&t.hasOwnProperty("random")&&e.uint32(8).int32(t.random),null!=t.replicaNumber&&t.hasOwnProperty("replicaNumber")&&e.uint32(16).int32(t.replicaNumber),null!=t.clock&&t.hasOwnProperty("clock")&&e.uint32(24).int32(t.clock),null!=t.offset&&t.hasOwnProperty("offset")&&e.uint32(32).int32(t.offset),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.IdentifierTupleMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.random=t.int32();break;case 2:r.replicaNumber=t.int32();break;case 3:r.clock=t.int32();break;case 4:r.offset=t.int32();break;default:t.skipType(7&i)}}return r},t}(),t.LogootSDelMsg=function(){function t(t){if(this.lid=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.lid=$n.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=Wn.create()),null!=t.lid&&t.lid.length)for(var n=0;n<t.lid.length;++n)qn.sync.IdentifierIntervalMsg.encode(t.lid[n],e.uint32(10).fork()).ldelim();return e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.LogootSDelMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.lid&&r.lid.length||(r.lid=[]),r.lid.push(qn.sync.IdentifierIntervalMsg.decode(t,t.uint32()));break;default:t.skipType(7&i)}}return r},t}(),t.IdentifierIntervalMsg=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.idBegin=null,t.prototype.end=0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.idBegin&&t.hasOwnProperty("idBegin")&&qn.sync.IdentifierMsg.encode(t.idBegin,e.uint32(10).fork()).ldelim(),null!=t.end&&t.hasOwnProperty("end")&&e.uint32(16).int32(t.end),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.IdentifierIntervalMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.idBegin=qn.sync.IdentifierMsg.decode(t,t.uint32());break;case 2:r.end=t.int32();break;default:t.skipType(7&i)}}return r},t}(),t.QuerySyncMsg=function(){function t(t){if(this.vector={},t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.vector=$n.emptyObject,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=Wn.create()),null!=t.vector&&t.hasOwnProperty("vector"))for(var n=Object.keys(t.vector),r=0;r<n.length;++r)e.uint32(10).fork().uint32(8).int32(n[r]).uint32(16).int32(t.vector[n[r]]).ldelim();return e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n,r=void 0===e?t.len:t.pos+e,i=new qn.sync.QuerySyncMsg;t.pos<r;){var o=t.uint32();switch(o>>>3){case 1:t.skip().pos++,i.vector===$n.emptyObject&&(i.vector={}),n=t.int32(),t.pos++,i.vector[n]=t.int32();break;default:t.skipType(7&o)}}return i},t}(),t.ReplySyncMsg=function(){function t(t){if(this.richLogootSOpsMsg=[],this.intervals=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.richLogootSOpsMsg=$n.emptyArray,t.prototype.intervals=$n.emptyArray,t.create=function(e){return new t(e)},t.encode=function(t,e){if(e||(e=Wn.create()),null!=t.richLogootSOpsMsg&&t.richLogootSOpsMsg.length)for(var n=0;n<t.richLogootSOpsMsg.length;++n)qn.sync.RichLogootSOperationMsg.encode(t.richLogootSOpsMsg[n],e.uint32(10).fork()).ldelim();if(null!=t.intervals&&t.intervals.length)for(n=0;n<t.intervals.length;++n)qn.sync.IntervalMsg.encode(t.intervals[n],e.uint32(18).fork()).ldelim();return e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.ReplySyncMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.richLogootSOpsMsg&&r.richLogootSOpsMsg.length||(r.richLogootSOpsMsg=[]),r.richLogootSOpsMsg.push(qn.sync.RichLogootSOperationMsg.decode(t,t.uint32()));break;case 2:r.intervals&&r.intervals.length||(r.intervals=[]),r.intervals.push(qn.sync.IntervalMsg.decode(t,t.uint32()));break;default:t.skipType(7&i)}}return r},t}(),t.IntervalMsg=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.id=0,t.prototype.begin=0,t.prototype.end=0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.id&&t.hasOwnProperty("id")&&e.uint32(8).int32(t.id),null!=t.begin&&t.hasOwnProperty("begin")&&e.uint32(16).int32(t.begin),null!=t.end&&t.hasOwnProperty("end")&&e.uint32(24).int32(t.end),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.IntervalMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.id=t.int32();break;case 2:r.begin=t.int32();break;case 3:r.end=t.int32();break;default:t.skipType(7&i)}}return r},t}(),t.DotMsg=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.replicaNumber=0,t.prototype.clock=0,t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.replicaNumber&&t.hasOwnProperty("replicaNumber")&&e.uint32(8).int32(t.replicaNumber),null!=t.clock&&t.hasOwnProperty("clock")&&e.uint32(16).int32(t.clock),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.sync.DotMsg;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.replicaNumber=t.int32();break;case 2:r.clock=t.int32();break;default:t.skipType(7&i)}}return r},t}(),t}(),Kn=qn.collaborator=function(){var t={};return t.Collaborator=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.muteCoreId=0,t.prototype.displayName="",t.prototype.login="",t.prototype.email="",t.prototype.avatar="",t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.muteCoreId&&t.hasOwnProperty("muteCoreId")&&e.uint32(8).sint32(t.muteCoreId),null!=t.displayName&&t.hasOwnProperty("displayName")&&e.uint32(18).string(t.displayName),null!=t.login&&t.hasOwnProperty("login")&&e.uint32(26).string(t.login),null!=t.email&&t.hasOwnProperty("email")&&e.uint32(34).string(t.email),null!=t.avatar&&t.hasOwnProperty("avatar")&&e.uint32(42).string(t.avatar),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.collaborator.Collaborator;t.pos<n;){var i=t.uint32();switch(i>>>3){case 1:r.muteCoreId=t.sint32();break;case 2:r.displayName=t.string();break;case 3:r.login=t.string();break;case 4:r.email=t.string();break;case 5:r.avatar=t.string();break;default:t.skipType(7&i)}}return r},t}(),t}(),Jn=qn.metadata=function(){var t={};return t.MetaData=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.type=0,t.prototype.data="",t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=Wn.create()),null!=t.type&&t.hasOwnProperty("type")&&e.uint32(0).int32(t.type),null!=t.data&&t.hasOwnProperty("data")&&e.uint32(10).string(t.data),e},t.decode=function(t,e){t instanceof Vn||(t=Vn.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new qn.metadata.MetaData;t.pos<n;){var i=t.uint32();switch(i>>>3){case 0:r.type=t.int32();break;case 1:r.data=t.string();break;default:t.skipType(7&i)}}return r},t}(),t}();!function(t){t[t.COLLABORATORS=400]="COLLABORATORS",t[t.METADATA=401]="METADATA",t[t.DOCUMENT_CONTENT=402]="DOCUMENT_CONTENT"}(e.Streams||(e.Streams={}));var Xn,Zn=function(){function t(t){this._state=t}return t.merge=function(t,e){var n=t.docCreated<e.docCreated?t:e;return{docCreated:n.docCreated,cryptoKey:n.cryptoKey}},t.prototype.handleRemoteFixDataState=function(e){return this._state=t.merge(this._state,e),this._state},Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),t}(),Yn=function(){function t(t,e,n){this.id=t,this.begin=e,this.end=n}return t.prototype.equals=function(t){return this.id===t.id&&this.begin===t.begin&&this.end===t.end},t}(),Qn=function(){function t(t,e){this.richLogootSOps=t,this.intervals=e}return t.prototype.equals=function(t){return this.richLogootSOps.length===t.richLogootSOps.length&&this.intervals.length===t.intervals.length&&this.richLogootSOps.every(function(e,n){return e.equals(t.richLogootSOps[n])})&&this.intervals.every(function(e,n){return e.equals(t.intervals[n])})},t}(),tr=function(){function t(t,e,n,r){void 0===r&&(r=[]),this.id=t,this.clock=e,this.logootSOp=n,this.dependencies=r}return t.fromPlain=function(e){if("object"==typeof e&&null!==e&&"number"==typeof e.id&&Number.isInteger(e.id)&&"number"==typeof e.clock&&Number.isInteger(e.clock)&&e.dependencies instanceof Array&&e.dependencies.every(Ee)){var n=Ce.fromPlain(e.logootSOp);if(n instanceof Ce)return new t(e.id,e.clock,n);var r=Me.fromPlain(e.logootSOp);if(r instanceof Me&&e.dependencies.length>0)return new t(e.id,e.clock,r,e.dependencies)}return null},t.prototype.equals=function(t){var e=this.id===t.id&&this.clock===t.clock;return this.logootSOp instanceof Ce&&t.logootSOp instanceof Ce?e&&this.logootSOp.equals(t.logootSOp):this.logootSOp instanceof Me&&t.logootSOp instanceof Me&&(e&&this.logootSOp.equals(t.logootSOp)&&this.dependencies.every(function(e,n){var r=e.replicaNumber,i=e.clock,o=t.dependencies[n],s=o.replicaNumber,c=o.clock;return r===s&&i===c}))},t}(),er=function(){return function(t,e){this.vector=t,this.richLogootSOps=e}}();!function(t){t[t.SUPERIOR=1]="SUPERIOR",t[t.INFERIOR=-1]="INFERIOR",t[t.EQUAL=2]="EQUAL",t[t.CONCURRENT=0]="CONCURRENT"}(Xn||(Xn={}));var nr=function(){function t(t){t&&t.forEach(function(t){console.assert(t>=0,"Each value of a state vector must be positive")}),this.vector=new Map(t)}return t.prototype.get=function(t){return this.vector.get(t)},t.prototype.set=function(t,e){console.assert(e>=0,"clock must be positive"),console.assert(this.isDeliverable(t,e)),this.vector.set(t,e)},t.prototype.clear=function(){this.vector.clear()},Object.defineProperty(t.prototype,"size",{get:function(){return this.vector.size},enumerable:!0,configurable:!0}),t.prototype.isAlreadyDelivered=function(t,e){var n=this.get(t);return void 0!==n&&n>=e},t.prototype.isDeliverable=function(t,e){if(this.isAlreadyDelivered(t,e))return!1;var n=this.get(t);return void 0===n?0===e:e===n+1},t.prototype.forEach=function(t){this.vector.forEach(t)},t.prototype.asMap=function(){return new Map(this.vector)},t.prototype.computeMissingIntervals=function(t){var e=this,n=[];return t.vector.forEach(function(t,r){var i=e.get(r);void 0===i?n.push(new Yn(r,0,t)):i<t&&n.push(new Yn(r,i+1,t))}),n},t.prototype.compareTo=function(t){var e=this;if(t.size<this.size)return-t.compareTo(this);var n=this.size<t.size?Xn.INFERIOR:Xn.EQUAL;return this.forEach(function(r,i){var o=t.get(i);void 0===o&&e.size===t.size?n=Xn.CONCURRENT:void 0===o?n=n===Xn.INFERIOR?Xn.CONCURRENT:Xn.SUPERIOR:r<o?n=n===Xn.SUPERIOR?Xn.CONCURRENT:Xn.INFERIOR:r>o&&(n=n===Xn.INFERIOR?Xn.CONCURRENT:Xn.SUPERIOR),Xn.CONCURRENT}),n},t.prototype.maxPairwise=function(t){var e=new Map,n=[];this.vector.forEach(function(r,i){n.push(i);var o=t.vector.get(i);o?e.set(i,Math.max(r,o)):e.set(i,r)}),t.vector.forEach(function(t,r){n.includes(r)||e.set(r,t)}),this.vector=e},t}(),rr=function(t){function e(e,n,r){var i=t.call(this)||this;return i.id=e,i.clock=0,i.collabsService=r,i.vector=new nr,i.appliedOperationsSubject=new Et,i.localRichLogootSOperationsSubject=new Et,i.querySyncSubject=new Et,i.remoteLogootSOperationsSubject=new Et,i.logsRemoteRichLogootsOperationsSubject=new Et,i.replySyncSubject=new Et,i.richLogootSOps=[],i.vector.clear(),i.applyRichLogootSOperations(n.richLogootSOps),i}return s(e,t),e.prototype.sync=function(){this.querySyncSubject.next(this.vector)},Object.defineProperty(e.prototype,"localRichLogootSOperations",{get:function(){return this.localRichLogootSOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"querySync$",{get:function(){return this.querySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteLogootSOperations$",{get:function(){return this.remoteLogootSOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"logsRemoteRichLogootsOperations$",{get:function(){return this.logsRemoteRichLogootsOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"replySync$",{get:function(){return this.replySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return new er(this.vector.asMap(),this.richLogootSOps)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"getClock",{get:function(){return this.clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"getVector",{get:function(){return this.vector.asMap()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localLogootSOperations$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){var n=t instanceof Me?e.getDependencies(t):[],r=new tr(e.id,e.clock,t,n);e.updateState(r),e.localRichLogootSOperationsSubject.next(r),e.clock++})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteQuerySync$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){var n=e.computeMissingOps(t),r=e.vector.computeMissingIntervals(t);e.replySyncSubject.next(new Qn(n,r))})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteReplySync$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){var n=t.richLogootSOps,r=t.intervals;n.length>0&&e.applyRichLogootSOperations(n),r.forEach(function(t){var n=t.id,r=t.begin,i=t.end;e.richLogootSOps.filter(function(t){var e=t.id,o=t.clock;return n===e&&r<=o&&o<=i}).forEach(function(t){return e.localRichLogootSOperationsSubject.next(t)})})})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteRichLogootSOperations$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){return e.applyRichLogootSOperations([t])})},enumerable:!0,configurable:!0}),e.prototype.computeMissingOps=function(t){return this.richLogootSOps.filter(function(e){var n=e.id,r=e.clock,i=t.get(n);return void 0===i||i<r})},e.prototype.dispose=function(){this.appliedOperationsSubject.complete(),this.localRichLogootSOperationsSubject.complete(),this.querySyncSubject.complete(),this.remoteLogootSOperationsSubject.complete(),this.replySyncSubject.complete(),t.prototype.dispose.call(this)},e.prototype.applyRichLogootSOperations=function(t){var e=this;setTimeout(function(){var n=t.filter(function(t){var n=t.id,r=t.clock;return!e.vector.isAlreadyDelivered(n,r)});if(n.length>0){var r=[];n.forEach(function(t){if(e.isDeliverable(t)){var n=t.logootSOp;e.updateState(t),r.push(n),e.logsRemoteRichLogootsOperationsSubject.next({clock:t.clock,author:t.id,operation:t.logootSOp})}else e.bufferOperation(t)}),r.length>0&&(e.remoteLogootSOperationsSubject.next({collaborator:e.collabsService.getCollaborator(n[0].id),operations:r}),e.appliedOperationsSubject.next())}})},e.prototype.bufferOperation=function(t){var e=this;this.appliedOperationsSubject.pipe(St(function(){return e.isDeliverable(t)})).subscribe(function(){e.vector.isAlreadyDelivered(t.id,t.clock)||e.applyRichLogootSOperations([t])})},e.prototype.updateState=function(t){console.assert(this.isDeliverable(t));var e=t.id,n=t.clock;this.vector.set(e,n),this.richLogootSOps.push(t)},e.prototype.isDeliverable=function(t){var e=t.id,n=t.clock,r=t.dependencies;return this.vector.isDeliverable(e,n)&&this.hasDeliveredDependencies(r)},e.prototype.hasDeliveredDependencies=function(t){var e=this;return t.every(function(t){var n=e.vector.get(t.replicaNumber);return void 0!==n&&t.clock<=n})},e.prototype.getDependencies=function(t){var e=this;return t.lid.map(function(t){var n=t.idBegin.replicaNumber;return{replicaNumber:n,clock:e.vector.get(n)}})},e}(i),ir=function(t){function n(n,r){var i=t.call(this,n,r,e.Streams.DOCUMENT_CONTENT,Hn.SyncMsg)||this;return i.remoteQuerySyncSubject=new Et,i.remoteQuerySyncIdSubject=new Et,i.remoteRichLogootSOperationSubject=new Et,i.remoteReplySyncSubject=new Et,i.newSub=i.messageIn$.subscribe(function(t){var e=t.senderId,n=t.msg;switch(n.type){case"richLogootSOpMsg":i.handleRichLogootSOpMsg(n.richLogootSOpMsg);break;case"querySync":i.remoteQuerySyncIdSubject.next(e),i.handleQuerySyncMsg(n.querySync);break;case"replySync":i.handleReplySyncMsg(n.replySync)}}),i}return s(n,t),Object.defineProperty(n.prototype,"localRichLogootSOperations$",{set:function(e){var n=this;this.newSub=e.subscribe(function(e){t.prototype.send.call(n,{richLogootSOpMsg:n.serializeRichLogootSOperation(e)})})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"querySync$",{set:function(e){var n=this;this.newSub=e.subscribe(function(e){var r=Hn.QuerySyncMsg.create();e.forEach(function(t,e){void 0!==e&&void 0!==t&&(r.vector[e]=t)}),t.prototype.send.call(n,{querySync:r})})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"replySync$",{set:function(e){var n=this;this.newSub=Qt(e,this.remoteQuerySyncIdSubject.asObservable(),function(t,e){return{id:e,replySyncEvent:t}}).subscribe(function(e){var r=e.id,i=e.replySyncEvent,o=i.richLogootSOps,s=i.intervals,c=Hn.ReplySyncMsg.create();c.richLogootSOpsMsg=o.map(function(t){return n.serializeRichLogootSOperation(t)}),c.intervals=s.map(function(t){var e=t.id,n=t.begin,r=t.end;return Hn.IntervalMsg.create({id:e,begin:n,end:r})}),t.prototype.send.call(n,{replySync:c},r)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"remoteRichLogootSOperations$",{get:function(){return this.remoteRichLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"remoteQuerySync$",{get:function(){return this.remoteQuerySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"remoteReplySync$",{get:function(){return this.remoteReplySyncSubject.asObservable()},enumerable:!0,configurable:!0}),n.prototype.dispose=function(){this.remoteQuerySyncSubject.complete(),this.remoteQuerySyncIdSubject.complete(),this.remoteRichLogootSOperationSubject.complete(),this.remoteReplySyncSubject.complete(),t.prototype.dispose.call(this)},n.prototype.handleRichLogootSOpMsg=function(t){this.remoteRichLogootSOperationSubject.next(this.deserializeRichLogootSOperation(t))},n.prototype.handleQuerySyncMsg=function(t){var e=new Map;Object.keys(t.vector).forEach(function(n){e.set(parseInt(n,10),t.vector[n])}),this.remoteQuerySyncSubject.next(new nr(e))},n.prototype.handleReplySyncMsg=function(t){var e=this,n=t.richLogootSOpsMsg,r=t.intervals,i=n.map(function(t){return e.deserializeRichLogootSOperation(t)});this.remoteReplySyncSubject.next(new Qn(i,r.map(function(t){var e=t.id,n=t.begin,r=t.end;return new Yn(e,n,r)})))},n.prototype.serializeRichLogootSOperation=function(t){var e=t.id,n=t.clock,r=t.dependencies,i=t.logootSOp,o=Hn.RichLogootSOperationMsg.create({id:e,clock:n,dependencies:r});return i instanceof Me?o.logootSDelMsg=Hn.LogootSDelMsg.create(i):i instanceof Ce&&(o.logootSAddMsg=Hn.LogootSAddMsg.create(i)),o},n.prototype.deserializeRichLogootSOperation=function(t){var e=t.id,n=t.clock,r=t.dependencies,i=t.logootSAddMsg,o=t.logootSDelMsg;return tr.fromPlain({id:e,clock:n,logootSOp:i||o,dependencies:r})},n}(oe),or=function(){function t(t,e,n){this.id=t,this.share=e,this.state=new nr(n)}return t.prototype.merge=function(t){var e=this.state.compareTo(t.state);e===Xn.INFERIOR?(this.share=t.share,this.state=t.state):e===Xn.CONCURRENT&&(this.share=this.share&&t.share,this.state.maxPairwise(t.state))},t.prototype.setShare=function(t){this.share=t;var e=this.state.get(this.id);void 0!==e?this.state.set(this.id,e+1):this.state.set(this.id,0)},t.prototype.getState=function(){return{share:this.share,vector:this.state.asMap(),id:this.id}},Object.defineProperty(t.prototype,"isShared",{get:function(){return this.share},enumerable:!0,configurable:!0}),t}(),sr=function(){function t(t,e){this._id=t,this.crdt=new or(t,e.share,e.vector)}return t.prototype.handleLocalLogState=function(t){this.crdt.setShare(t)},t.prototype.handleRemoteLogState=function(t,e){var n=new or(t,e.share,e.vector);return this.crdt.merge(n),this.state},Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this.crdt.getState()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stateWithVectorAsArray",{get:function(){var t=this.state,e=t.vector||new Map,n=Array.from(e);return{share:t.share,vector:n}},enumerable:!0,configurable:!0}),t}(),cr=function(){function t(t){this._state=t}return t.merge=function(t,e){var n=t.titleModified>e.titleModified?t:e;return{title:n.title,titleModified:n.titleModified}},t.prototype.handleLocalState=function(e){this._state=t.merge(this._state,e)},t.prototype.handleRemoteState=function(e){return this._state=t.merge(this._state,e),this._state},Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),t}();!function(t){t[t.Title=0]="Title",t[t.FixData=1]="FixData",t[t.Logs=2]="Logs"}(e.MetaDataType||(e.MetaDataType={}));var ar=function(t){function n(n,r,i,o,s,c){var a=t.call(this,n,r,e.Streams.METADATA,Jn.MetaData)||this;return a.title=new cr(i),a.fixData=new Zn(o),a.logs=new sr(c,s),a.localUpdateSubject=new Et,a.remoteUpdateSubject=new Et,a.newSub=a.messageIn$.subscribe(function(t){var n=t.msg,r=n.type,i=n.data,o=JSON.parse(i);switch(r){case e.MetaDataType.Title:a.remoteUpdateSubject.next({type:e.MetaDataType.Title,data:a.title.handleRemoteState(o)});break;case e.MetaDataType.FixData:a.remoteUpdateSubject.next({type:e.MetaDataType.FixData,data:a.fixData.handleRemoteFixDataState(o)});break;case e.MetaDataType.Logs:o.vector=new Map(o.vector),a.remoteUpdateSubject.next({type:e.MetaDataType.Logs,data:a.logs.handleRemoteLogState(o.id,{share:o.share,vector:o.vector})});break;default:console.error("No MetaDataType for type "+r)}}),a}return s(n,t),n.mergeTitle=function(t,e){return cr.merge(t,e)},n.mergeFixData=function(t,e){return Zn.merge(t,e)},Object.defineProperty(n.prototype,"localUpdate$",{set:function(n){var r=this;this.newSub=n.subscribe(function(n){var i=n.type,o=n.data;switch(i){case e.MetaDataType.Title:var s=o,c=s.title,a=s.titleModified;r.title.handleLocalState({title:c,titleModified:a}),t.prototype.send.call(r,{type:e.MetaDataType.Title,data:JSON.stringify(r.title.state)});break;case e.MetaDataType.FixData:break;case e.MetaDataType.Logs:var u=o.share;r.logs.handleLocalLogState(u),r.remoteUpdateSubject.next({type:e.MetaDataType.Logs,data:r.logs.state});var l=r.logs.state;t.prototype.send.call(r,{type:e.MetaDataType.Logs,data:JSON.stringify({id:r.logs.id,share:l.share,vector:Array.from(l.vector||new Map)})});break;default:console.error("No MetaDataType for type "+i)}})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"memberJoin$",{set:function(n){var r=this;this.newSub=n.subscribe(function(n){t.prototype.send.call(r,{type:e.MetaDataType.FixData,data:JSON.stringify(r.fixData.state)},n),t.prototype.send.call(r,{type:e.MetaDataType.Title,data:JSON.stringify(r.title.state)},n);var i=r.logs.stateWithVectorAsArray;t.prototype.send.call(r,{type:e.MetaDataType.Logs,data:JSON.stringify({share:i.share,vector:i.vector})},n)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"remoteUpdate$",{get:function(){return this.remoteUpdateSubject.asObservable()},enumerable:!0,configurable:!0}),n.prototype.dispose=function(){this.localUpdateSubject.complete(),this.remoteUpdateSubject.complete()},n}(oe),ur=function(t){function n(n,r,i){var o=t.call(this,n,r,e.Streams.COLLABORATORS,Kn.Collaborator)||this;return o.me=i,o.collaborators=new Map,o.updateSubject=new Et,o.joinSubject=new Et,o.leaveSubject=new Et,o.newSub=o.messageIn$.subscribe(function(t){var e=t.senderId,n=t.msg,r=c({id:e},n),i=o.collaborators.get(e);i?(i.muteCoreId=r.muteCoreId||i.muteCoreId,i.displayName=r.displayName||i.displayName,i.login=r.login||i.login,i.email=r.email||i.email,i.avatar=r.avatar||i.avatar,o.updateSubject.next(i)):(o.collaborators.set(r.id,r),o.joinSubject.next(r))}),o}return s(n,t),n.prototype.getCollaborator=function(t){var e,n;try{for(var r=function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}(this.collaborators.values()),i=r.next();!i.done;i=r.next()){var o=i.value;if(o.muteCoreId===t)return o}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}},Object.defineProperty(n.prototype,"remoteUpdate$",{get:function(){return this.updateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"join$",{get:function(){return this.joinSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"leave$",{get:function(){return this.leaveSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"memberJoin$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){return e.emitUpdate(t)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"memberLeave$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){var n=e.collaborators.get(t);n&&e.leaveSubject.next(n),e.collaborators.delete(t)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localUpdate",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){Object.assign(e.me,t),e.emitUpdate()})},enumerable:!0,configurable:!0}),n.prototype.dispose=function(){this.updateSubject.complete(),this.joinSubject.complete(),this.leaveSubject.complete(),t.prototype.dispose.call(this)},n.prototype.emitUpdate=function(e){var n=this.me,r=(n.id,function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&(n[r[i]]=t[r[i]])}return n}(n,["id"]));t.prototype.send.call(this,r,e)},n}(oe),lr=function(t){function e(e){var n=e.profile,r=e.docContent,i=e.metaTitle,o=e.metaFixData,s=e.metaLogs,a=t.call(this)||this,u=n.muteCoreId||("getRandomValues"in se.crypto?se.crypto.getRandomValues(new Int32Array(1))[0]:se.crypto.randomBytes(4).readInt32BE(0,!0));n.muteCoreId||(n.muteCoreId=u),a._messageOut$=new Et,a._messageIn$=new Et,a._localOperationForLog$=new Et,a._remoteOperationForLog=new Et,a.collaboratorsService=new ur(a._messageIn$,a._messageOut$,c({id:0},n)),a.doc=new Pe(n.muteCoreId),a.metaDataService=new ar(a._messageIn$,a._messageOut$,i,o,s,u),a.sync=new rr(n.muteCoreId,r,a.collaboratorsService),a.syncMessageService=new ir(a._messageIn$,a._messageOut$),a.doc.remoteLogootSOperations$=a.sync.remoteLogootSOperations$,a.sync.localLogootSOperations$=a.doc.localLogootSOperations$,a.sync.remoteQuerySync$=a.syncMessageService.remoteQuerySync$,a.sync.remoteReplySync$=a.syncMessageService.remoteReplySync$,a.sync.remoteRichLogootSOperations$=a.syncMessageService.remoteRichLogootSOperations$,a.syncMessageService.localRichLogootSOperations$=a.sync.localRichLogootSOperations,a.syncMessageService.querySync$=a.sync.querySync$,a.syncMessageService.replySync$=a.sync.replySync$,a.newSub=a.doc.localOperationLog$.subscribe(function(t){a.logLocalOperation(u,t.textop,t.logootsop)});var l=Qt(a.doc.remoteOperationLog$,a.sync.logsRemoteRichLogootsOperations$,function(t,e){return{v1:t,v2:e}});return a.newSub=l.subscribe(function(t){var e=t.v1,n=t.v2;a.logRemoteOperation(u,e.textop,e.logootsop,n.clock,n.author)}),a}return s(e,t),e.mergeTitle=function(t,e){return ar.mergeTitle(t,e)},e.mergeFixData=function(t,e){return ar.mergeFixData(t,e)},Object.defineProperty(e.prototype,"myMuteCoreId",{get:function(){return this.collaboratorsService.me.muteCoreId||0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this.sync.state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageIn$",{set:function(t){var e=this;this.newSub=t.subscribe(function(t){return e._messageIn$.next(t)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageOut$",{get:function(){return this._messageOut$.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localOperationForLog$",{get:function(){return this._localOperationForLog$.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteOperationForLog",{get:function(){return this._remoteOperationForLog.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localTextOperations$",{set:function(t){this.doc.localTextOperations$=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteTextOperations$",{get:function(){return this.doc.remoteTextOperations$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"digestUpdate$",{get:function(){return this.doc.digest$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"treeUpdate$",{get:function(){return this.doc.tree$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteCollabUpdate$",{get:function(){return this.collaboratorsService.remoteUpdate$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localCollabUpdate$",{set:function(t){this.collaboratorsService.localUpdate=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"collabJoin$",{get:function(){return this.collaboratorsService.join$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"collabLeave$",{get:function(){return this.collaboratorsService.leave$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memberJoin$",{set:function(t){this.collaboratorsService.memberJoin$=t,this.metaDataService.memberJoin$=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memberLeave$",{set:function(t){this.collaboratorsService.memberLeave$=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteMetadataUpdate$",{get:function(){return this.metaDataService.remoteUpdate$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localMetadataUpdate$",{set:function(t){this.metaDataService.localUpdate$=t},enumerable:!0,configurable:!0}),e.prototype.synchronize=function(){this.sync.sync()},e.prototype.indexFromId=function(t){return this.doc.indexFromId(t)},e.prototype.positionFromIndex=function(t){return this.doc.positionFromIndex(t)},e.prototype.dispose=function(){this.collaboratorsService.dispose(),this.doc.dispose(),this.metaDataService.dispose(),this.sync.dispose(),this.syncMessageService.dispose()},e.prototype.logLocalOperation=function(t,e,n){if(n instanceof Ce){var r=n,i=e;this._localOperationForLog$.next({type:"localInsertion",siteId:t,clock:this.sync.getClock,position:i.offset,content:i.content,length:i.content.length,logootsOperation:r,context:this.sync.getVector})}else if(n instanceof Me){r=n,i=e;this._localOperationForLog$.next({type:"localDeletion",siteId:t,clock:this.sync.getClock,position:i.offset,length:i.length,logootsOperation:r,context:this.sync.getVector})}},e.prototype.logRemoteOperation=function(t,e,n,r,i){if(n instanceof Ce){var o=n;this._remoteOperationForLog.next({type:"remoteInsertion",siteId:t,remoteSiteId:i,remoteClock:r,textOperation:e,logootsOperation:o,context:this.sync.getVector})}else if(n instanceof Me){o=n;this._remoteOperationForLog.next({type:"remoteDeletion",siteId:t,remoteSiteId:i,remoteClock:r,textOperation:e,logootsOperation:o,context:this.sync.getVector})}},e}(i);try{se.crypto=r}catch(t){console.error(t.message)}e.MuteCore=lr,e.RichLogootSOperation=tr,e.State=er,e.TextInsert=Ne,e.TextDelete=je},function(t,e){t.exports=require("bunyan")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Message=void 0;var r=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}(n(23));var i=r.Reader,o=r.Writer,s=r.util,c=r.roots.default||(r.roots.default={});e.Message=c.Message=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.streamId=0,t.prototype.content=s.newBuffer([]),t.create=function(e){return new t(e)},t.encode=function(t,e){return e||(e=o.create()),null!=t.streamId&&t.hasOwnProperty("streamId")&&e.uint32(8).uint32(t.streamId),null!=t.content&&t.hasOwnProperty("content")&&e.uint32(18).bytes(t.content),e},t.decode=function(t,e){t instanceof i||(t=i.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new c.Message;t.pos<n;){var o=t.uint32();switch(o>>>3){case 1:r.streamId=t.uint32();break;case 2:r.content=t.bytes();break;default:t.skipType(7&o)}}return r},t}();e.default=c},function(t,e){t.exports=require("protobufjs/minimal")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const r=n(8),i=n(25),o=n(9),s=n(4),c="Untitled Document";e.MongooseAdapter=class{constructor(){this.DocModel=i.model("Doc",new i.Schema({key:String,signalingKey:{type:String,require:!0},cryptoKey:{type:String,default:""},title:{type:String,default:c},titleModified:{type:Number,default:0},created:Number,logins:[],operations:Array,shareLogs:Boolean,shareLogsVector:{type:Map,of:Number}}))}connect(t,e){return i.connection.on("close",()=>s.log.warn("Connection to the database has been closed")),i.connect(`mongodb://${t}:27017/${e}`,{useNewUrlParser:!0})}async find(t){const e=await this.DocModel.findOne({signalingKey:t}).exec();if(e){const t=e.get("key");t&&(e.set({key:void 0,signalingKey:t,cryptoKey:await r.Symmetric.generateKey()}),await e.save())}return e}async lookupMetadataByLogin(t){const e=await this.DocModel.find({logins:t},"-operations -logins").exec(),n=[];for(const t of e){const e=t.get("key");e&&(t.set({key:void 0,signalingKey:e,cryptoKey:await r.Symmetric.generateKey()}),await t.save());const i=t.get("signalingKey"),o=t.get("cryptoKey"),s=t.get("title"),c=t.get("titleModified"),a=t.get("created"),u=t.get("shareLogs"),l=this.getShareVector(t);n.push({signalingKey:i,cryptoKey:o,title:s,titleModified:c,created:a,shareLogs:u,shareLogsVector:l})}return n}async removeLogin(t,e){const n=await this.find(t);if(n){const t=n.get("logins");for(let n=0;n<t.length;n++)if(t[n]===e){t.splice(n);break}n.set("logins",t),await n.save()}}async create(t){const e=await r.Symmetric.generateKey();return this.DocModel.create({signalingKey:t,created:Date.now(),cryptoKey:e})}getShareVector(t){const e=t.get("shareLogsVector");if(o.isUndefined(e))return new Map;const n=new Map;for(const t of e.keys()){const r=parseInt(t,10);n.set(r,e.get(t))}return n}}},function(t,e){t.exports=require("mongoose")},function(t){t.exports={name:"mute-bot-storage",version:"2.1.1",description:"",main:"index.js",scripts:{start:"node server.js",dev:"nodemon --watch src -e js,ts --exec 'npm run build && chmod +x dist/server.js && node dist/server.js --cors --logLevel trace | bunyan'",build:"webpack",lint:"tslint --fix -p tsconfig.json 'src/**/*.ts' -e 'src/**/*.proto' -e 'src/**/*.d.ts' && prettier --write --list-different 'src/**/*.ts' './*.{ts,js,json,md}'  && markdownlint ./*.md -i 'CHANGELOG.md'",proto:"pbjs -t static-module -w es6 --no-verify --no-delimited --no-convert src/proto/index.proto -o src/proto/index.es6.js && pbts src/proto/index.es6.js -o src/proto/index.d.ts",postproto:"babel --presets env -o src/proto/index.js src/proto/index.es6.js && rm src/proto/index.es6.js",cz:"git-cz",precommit:"lint-staged && npm run build && git add dist/*",commitmsg:"commitlint -e $GIT_PARAMS",prerelease:"npm run build && git add dist/*",release:"standard-version --no-verify"},files:["dist/server.js"],keywords:["bot","storage","peer-network"],author:"",engines:{node:">=8.1.4"},license:"AGPL-3.0",dependencies:{"@coast-team/mute-core":"file:../mute-core/coast-team-mute-core-0.0.0-development.tgz","@coast-team/mute-crypto":"^0.4.1",bunyan:"^1.8.12",commander:"^2.18.0",kcors:"^2.2.2",koa:"^2.5.2","koa-bodyparser":"^4.2.1","koa-router":"^7.4.0",mongoose:"^5.2.13",netflux:"^4.3.1","node-webcrypto-ossl":"^1.0.38",protobufjs:"^6.8.8",rxjs:"^6.3.2","text-encoding":"^0.6.4",uws:"10.148.1"},devDependencies:{"@commitlint/cli":"^7.1.2","@commitlint/config-conventional":"^7.1.2","@types/bunyan":"^1.8.4","@types/commander":"^2.12.2","@types/kcors":"^2.2.3","@types/koa":"^2.0.46","@types/koa-bodyparser":"^5.0.1","@types/koa-router":"^7.0.31","@types/mongoose":"^5.2.11","@types/node":"^8.10.29","babel-cli":"^6.26.0","babel-preset-env":"^1.7.0",commitizen:"^2.10.1","cz-conventional-changelog":"^2.1.0",husky:"^0.14.3","lint-staged":"^7.2.2","markdownlint-cli":"^0.13.0",nodemon:"^1.18.4",prettier:"^1.14.2","standard-version":"^4.4.0","ts-loader":"^5.0.0",tslint:"^5.11.0","tslint-config-prettier":"^1.15.0",typescript:"^3.0.3","validate-commit-msg":"^2.11.1",webpack:"^4.17.2","webpack-cli":"^3.1.0","webpack-node-externals":"^1.7.2"},commitlint:{extends:["@commitlint/config-conventional"]},config:{commitizen:{path:"node_modules/cz-conventional-changelog"}},"lint-staged":{linters:{"*.md":["prettier --write --list-different","git add","markdownlint -i 'CHANGELOG.md'"],"*.ts":["tslint --fix -p tsconfig.json -e src/proto/* -e 'src/**/*.d.ts'","git add"],"*.{ts,json,scss,css}":["prettier --write --list-different -e *proto*","git add"]},concurrent:!1}}},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("https")}]);