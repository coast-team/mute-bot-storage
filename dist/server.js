!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=46)}([function(e,t){e.exports=require("rxjs/Subject")},function(e,t){e.exports=require("rxjs/operators")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(34);t.isDot=o.isDot;var r=n(9);t.IdentifierTuple=r.IdentifierTuple;var i=n(6);t.Identifier=i.Identifier;var s=n(5);t.IdentifierInterval=s.IdentifierInterval;var c=n(8);t.LogootSBlock=c.LogootSBlock;var a=n(33);t.LogootSRopes=a.LogootSRopes;var u=n(14);t.RopesNodes=u.RopesNodes;var l=n(16);t.LogootSAdd=l.LogootSAdd;var f=n(15);t.LogootSDel=f.LogootSDel;var p=n(13);t.TextDelete=p.TextDelete;var h=n(12);t.TextInsert=h.TextInsert;var d=n(11);t.insert=d.insert,t.del=d.del,t.occurrences=d.occurrences},function(e,t,n){"use strict";function o(e){return Number.isSafeInteger(e)&&t.INT32_BOTTOM<=e&&e<=t.INT32_TOP}Object.defineProperty(t,"__esModule",{value:!0}),t.INT32_BOTTOM=-2147483648,t.INT32_TOP=2147483647,t.isInt32=o,t.randomInt32=function(e,t){console.assert(o(e),"l must be an int32"),console.assert(o(t),"u must be an int32"),console.assert(e<t,"u is greater than l");var n=Math.random()*(t-e)+e,r=Math.floor(n);return console.assert(o(r)&&e<=r&&r<t,"result is an integer 32 in [l, u["),r}},function(e,t){e.exports=require("protobufjs/minimal")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=n(3),i=function(){function e(e,t){console.assert(r.isInt32(t),"end ∈ int32"),console.assert(e.lastOffset<=t,"idBegin must be less than or equal to idEnd"),this.idBegin=e,this.end=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=o.Identifier.fromPlain(t.idBegin);if(null!==n&&"number"==typeof t.end&&r.isInt32(t.end)&&n.lastOffset<=t.end)return new e(n,t.end)}return null},Object.defineProperty(e.prototype,"begin",{get:function(){return this.idBegin.lastOffset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"idEnd",{get:function(){return this.getBaseId(this.end)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.end-this.begin+1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){return this.idBegin.base},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dot",{get:function(){return this.idBegin.dot},enumerable:!0,configurable:!0}),e.prototype.equals=function(e){return this.idBegin.equals(e.idBegin)&&this.begin===e.begin&&this.end===e.end},e.prototype.union=function(t,n){console.assert(r.isInt32(t),"aBegin ∈ int32"),console.assert(r.isInt32(n),"aEnd ∈ int32");var i=Math.min(this.begin,t),s=Math.max(this.end,n);return new e(o.Identifier.fromBase(this.idBegin,i),s)},e.prototype.containsId=function(e){return-1===this.idBegin.compareTo(e)&&1===this.idEnd.compareTo(e)},e.prototype.getBaseId=function(e){return console.assert(r.isInt32(e),"offset ∈ int32"),console.assert(this.begin<=e&&e<=this.end,"offset must be included in the interval"),o.Identifier.fromBase(this.idBegin,e)},e.prototype.digest=function(){return 17*this.idBegin.digest()+this.end|0},e.prototype.toString=function(){return"IdInterval["+this.idBegin.tuples.join(",")+" .. "+this.end+"]"},e}();t.IdentifierInterval=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(9),r=n(3),i=function(){function e(e){console.assert(e.length>0,"tuples must not be empty");var t=e[e.length-1].random;console.assert(t>r.INT32_BOTTOM),this.tuples=e}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.tuples;if(n instanceof Array&&n.length>0){for(var i=!0,s=0,c=[];i&&s<n.length;){var a=o.IdentifierTuple.fromPlain(n[s]);null!==a?c.push(a):i=!1,s++}if(i&&c[c.length-1].random>r.INT32_BOTTOM)return new e(c)}}return null},e.fromBase=function(t,n){return console.assert(r.isInt32(n),"offset ∈ int32"),new e(t.tuples.map(function(e,r){return r===t.length-1?o.IdentifierTuple.fromBase(e,n):e}))},Object.defineProperty(e.prototype,"generator",{get:function(){return this.tuples[this.tuples.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.tuples.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"replicaNumber",{get:function(){return this.tuples[this.length-1].replicaNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clock",{get:function(){return this.tuples[this.length-1].clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dot",{get:function(){return{replicaNumber:this.replicaNumber,clock:this.clock}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastOffset",{get:function(){return this.tuples[this.length-1].offset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"base",{get:function(){var e=this.tuples.reduce(function(e,t){return e.concat(t.asArray())},[]);return e.pop(),e},enumerable:!0,configurable:!0}),e.prototype.longestCommonPrefix=function(e){for(var t=[],n=Math.min(this.tuples.length,e.tuples.length),o=0;o<n&&this.tuples[o].equals(e.tuples[o]);)t.push(this.tuples[o]),o++;return t},e.prototype.longestCommonBase=function(e){for(var t=[],n=Math.min(this.tuples.length,e.tuples.length),o=0,r=!1;!r&&o<n;){var i=this.tuples[o],s=e.tuples[o];i.equals(s)?t.push(i):(r=!0,i.equalsBase(s)&&t.push(i)),o++}return t},e.prototype.isPrefix=function(e){return this.isBasePrefix(e)&&this.lastOffset===e.tuples[this.length-1].offset},e.prototype.isBasePrefix=function(e){var t=this;return this.length<=e.length&&this.tuples.every(function(n,o){var r=e.tuples[o];return o===t.tuples.length-1?n.equalsBase(r):n.equals(r)})},e.prototype.commonPrefixLength=function(e){for(var t=Math.min(this.tuples.length,e.tuples.length),n=0;n<t&&this.tuples[n].equals(e.tuples[n]);)n++;return n},e.prototype.equals=function(e){return this.equalsBase(e)&&this.lastOffset===e.lastOffset},e.prototype.equalsBase=function(e){var t=this;return this.length===e.length&&this.tuples.every(function(n,o){var r=e.tuples[o];return o<t.length-1?n.equals(r):n.equalsBase(r)})},e.prototype.compareTo=function(e){if(this.equals(e))return 0;if(this.isPrefix(e))return-1;if(e.isPrefix(this))return 1;var t=this.commonPrefixLength(e);return this.tuples[t].compareTo(e.tuples[t])},e.prototype.hasPlaceAfter=function(e){return console.assert(r.isInt32(e),"length ∈ int32"),console.assert(e>0,"length > 0 "),this.lastOffset<=r.INT32_TOP-e},e.prototype.hasPlaceBefore=function(e){return console.assert(r.isInt32(e),"length ∈ int32"),console.assert(e>0,"length > 0 "),this.lastOffset>=r.INT32_BOTTOM+e},e.prototype.maxOffsetBeforeNext=function(e,t){if(console.assert(r.isInt32(t),"max ∈ int32"),console.assert(-1===this.compareTo(e),"this must be less than next"),this.equalsBase(e))return console.assert(t<e.lastOffset,"max must be less than next.lastOffset"),t;if(this.isBasePrefix(e)){var n=e.tuples[this.length-1].offset;return Math.min(n,t)}return t},e.prototype.minOffsetAfterPrev=function(e,t){if(console.assert(r.isInt32(t),"min ∈ int32"),this.equalsBase(e))return console.assert(t>e.lastOffset,"min must be greater than prev.lastOffset"),t;if(this.isBasePrefix(e)){var n=e.tuples[this.length-1].offset;return Math.max(n+1,t)}return t},e.prototype.digest=function(){return this.tuples.reduce(function(e,t){return 17*e+t.digest()|0},0)},e.prototype.toString=function(){return"Id["+this.tuples.join(",")+"]"},e}();t.Identifier=i},function(e,t){e.exports=require("rxjs/observable/merge")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(5),r=n(3),i=function(){function e(e,t){console.assert(r.isInt32(t)&&t>=0,"nbElt must be a non-negative integer"),this.idInterval=e,this.nbElement=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.idInterval,i=t.nbElement;if(n instanceof Object&&"number"==typeof i&&r.isInt32(i)&&i>=0){var s=o.IdentifierInterval.fromPlain(n);if(null!==s)return new e(s,i)}}return null},e.prototype.isMine=function(e){return this.idInterval.idBegin.generator===e},e.prototype.addBlock=function(e,t){console.assert(r.isInt32(t)&&t>0,"length must be a positive int32"),this.nbElement+=t,this.idInterval=this.idInterval.union(e,e+t-1)},e.prototype.delBlock=function(e){console.assert(r.isInt32(e)&&e>0,"nbElt must be a positive int32"),this.nbElement-=e},e.prototype.toString=function(){return"{"+this.nbElement+","+this.idInterval.toString()+"}"},e}();t.LogootSBlock=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(3),r=function(){function e(e,t,n,r){console.assert([e,t,n,r].every(o.isInt32),"each value ∈ int32"),this.random=e,this.replicaNumber=t,this.clock=n,this.offset=r}return e.fromPlain=function(t){return"object"==typeof t&&null!==t&&"number"==typeof t.random&&o.isInt32(t.random)&&"number"==typeof t.replicaNumber&&o.isInt32(t.replicaNumber)&&"number"==typeof t.clock&&o.isInt32(t.clock)&&"number"==typeof t.offset&&o.isInt32(t.offset)?new e(t.random,t.replicaNumber,t.clock,t.offset):null},e.fromBase=function(t,n){return console.assert(o.isInt32(n),"offset ∈ int32"),new e(t.random,t.replicaNumber,t.clock,n)},e.prototype.compareTo=function(e){for(var t=this.asArray(),n=e.asArray(),o=0;o<t.length&&t[o]===n[o];)o++;return o===t.length?0:t[o]<n[o]?-1:1},e.prototype.equals=function(e){return this.equalsBase(e)&&this.offset===e.offset},e.prototype.equalsBase=function(e){return this.random===e.random&&this.replicaNumber===e.replicaNumber&&this.clock===e.clock},e.prototype.asArray=function(){return[this.random,this.replicaNumber,this.clock,this.offset]},e.prototype.digest=function(){return this.asArray().reduce(function(e,t){return 17*e+t|0},0)},e.prototype.toString=function(){return this.random+","+this.replicaNumber+","+this.clock+","+this.offset},e}();t.IdentifierTuple=r},function(e,t){e.exports=require("rxjs/ReplaySubject")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.insert=function(e,t,n){console.assert(Number.isSafeInteger(t),"index ∈ safe integer");var o=Math.max(0,t);return e.slice(0,o)+n+e.slice(o)},t.del=function(e,t,n){return console.assert(Number.isSafeInteger(t),"begin ∈ safe integer"),console.assert(Number.isSafeInteger(n),"end ∈ safe integer"),e.slice(0,t)+e.slice(n+1)},t.occurrences=function(e,t){for(var n=0,o=t.length,r=e.indexOf(t);-1!==r;)n++,r=e.indexOf(t,r+o);return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(3),r=function(){function e(e,t){console.assert(o.isInt32(e),"offset ∈ int32"),this.offset=e,this.content=t}return e.prototype.equals=function(e){return this.offset===e.offset&&this.content===e.content},e.prototype.applyTo=function(e){return e.insertLocal(this.offset,this.content)},e}();t.TextInsert=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(3),r=function(){function e(e,t){console.assert(o.isInt32(e),"offset  ∈ int32"),console.assert(o.isInt32(t),"length  ∈ int32"),console.assert(t>0,"length > 0"),this.offset=e,this.length=t}return e.prototype.equals=function(e){return this.offset===e.offset&&this.length===e.length},e.prototype.applyTo=function(e){return e.delLocal(this.offset,this.offset+this.length-1)},e}();t.TextDelete=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(5),r=n(3),i=n(8);function s(e){return null!==e?e.height:0}function c(e){return null!==e?e.sizeNodeAndChildren:0}var a=function(){function e(e,t,n,o,i){console.assert(r.isInt32(t),"actualBegin ∈ int32"),console.assert(e.idInterval.begin<=t,"actualBegin must be greater than or equal to idInterval.begin"),this.block=e,this.actualBegin=t,this.length=n,this.left=o,this.right=i,this.height=Math.max(s(o),s(i))+1,this.sizeNodeAndChildren=n+c(o)+c(i)}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.block,o=t.actualBegin,s=t.length,c=t.left,a=t.right;if(n instanceof Object&&"number"==typeof o&&r.isInt32(o)&&"number"==typeof s&&r.isInt32(s)&&s>=0){var u=i.LogootSBlock.fromPlain(n),l=e.fromPlain(a),f=e.fromPlain(c);if(null!==u&&u.idInterval.begin<=o&&u.idInterval.end-u.idInterval.begin>=s-1)return new e(u,o,s,f,l)}}return null},e.leaf=function(t,n,o){return console.assert(r.isInt32(n),"aOffset ∈ int32"),console.assert(r.isInt32(o),"lenth ∈ int32"),console.assert(o>0,"lenth > 0"),t.addBlock(n,o),new e(t,n,o,null,null)},Object.defineProperty(e.prototype,"actualEnd",{get:function(){return this.actualBegin+this.length-1},enumerable:!0,configurable:!0}),e.prototype.getIdBegin=function(){return this.block.idInterval.getBaseId(this.actualBegin)},e.prototype.getIdEnd=function(){return this.block.idInterval.getBaseId(this.actualEnd)},e.prototype.addString=function(e){console.assert(r.isInt32(e),"length  ∈ int32"),this.sizeNodeAndChildren+=e},e.prototype.appendEnd=function(e){console.assert(r.isInt32(e),"length  ∈ int32"),console.assert(e>0,""+e," > 0");var t=this.actualEnd+1;return this.length+=e,this.block.addBlock(t,e),this.block.idInterval.getBaseId(t)},e.prototype.appendBegin=function(e){return console.assert(r.isInt32(e),"length  ∈ int32"),console.assert(e>0,""+e," > 0"),this.actualBegin-=e,this.length+=e,this.block.addBlock(this.actualBegin,e),this.getIdBegin()},e.prototype.deleteOffsets=function(e,t){console.assert(r.isInt32(e),"begin  ∈ int32"),console.assert(r.isInt32(t),"end  ∈ int32"),console.assert(e<=t,"begin <= end: "+e," <= "+t),console.assert(this.block.idInterval.begin<=e,"this.block.idInterval.begin <= to begin: "+this.block.idInterval.begin," <= "+e),console.assert(t<=this.block.idInterval.end,"end <= this.block.idInterval.end: "+t," <= "+this.block.idInterval.end);var n=null,o=Math.max(this.actualBegin,e),i=Math.min(this.actualEnd,t);if(o<=i){var s=i-o+1;this.block.delBlock(s),s!==this.length&&(o===this.actualBegin?this.actualBegin=i+1:i!==this.actualEnd&&(n=this.split(i-this.actualBegin+1,null))),this.length=this.length-s}return n},e.prototype.split=function(t,n){var o=new e(this.block,this.actualBegin+t,this.length-t,n,this.right);return this.length=t,this.right=o,this.height=Math.max(this.height,o.height),o},e.prototype.leftSubtreeSize=function(){return c(this.left)},e.prototype.rightSubtreeSize=function(){return c(this.right)},e.prototype.sumDirectChildren=function(){this.height=Math.max(s(this.left),s(this.right))+1,this.sizeNodeAndChildren=this.leftSubtreeSize()+this.rightSubtreeSize()+this.length},e.prototype.replaceChildren=function(e,t){this.left===e?this.left=t:this.right===e&&(this.right=t)},e.prototype.balanceScore=function(){return s(this.right)-s(this.left)},e.prototype.become=function(e){this.sizeNodeAndChildren=-this.length+e.length,this.length=e.length,this.actualBegin=e.actualBegin,this.block=e.block},e.prototype.isAppendableAfter=function(e,t){return this.block.isMine(e)&&this.block.idInterval.end===this.actualEnd&&this.block.idInterval.idEnd.hasPlaceAfter(t)},e.prototype.isAppendableBefore=function(e,t){return this.block.isMine(e)&&this.block.idInterval.begin===this.actualBegin&&this.block.idInterval.idBegin.hasPlaceBefore(t)},e.prototype.toString=function(){var e=this.getIdentifierInterval().toString(),t=null!==this.left?this.left.toString():"\t#";return(null!==this.right?this.right.toString():"\t#").replace(/(\t+)/g,"\t$1")+"\n\t"+e+"\n"+t.replace(/(\t+)/g,"\t$1")},e.prototype.toList=function(){var e=this.getIdentifierInterval(),t=null!==this.left?this.left.toList():[],n=null!==this.right?this.right.toList():[];return t.concat(e,n)},e.prototype.getIdentifierInterval=function(){return new o.IdentifierInterval(this.getIdBegin(),this.actualEnd)},e.prototype.getBlocks=function(){var e=[this.block],t=this.left;null!==t&&(e=e.concat(t.getBlocks()));var n=this.right;return null!==n&&(e=e.concat(n.getBlocks())),e},e}();t.RopesNodes=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(5),r=Array.prototype.concat,i=function(){function e(e){console.assert(e.length>0,"lid must not be empty"),this.lid=e}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.lid;if(n instanceof Array&&n.length>0){for(var r=!0,i=0,s=[];r&&i<n.length;){var c=o.IdentifierInterval.fromPlain(n[i]);null!==c?s.push(c):r=!1,i++}if(r)return new e(s)}}return null},e.prototype.equals=function(e){return this.lid.length===e.lid.length&&this.lid.every(function(t,n){var o=e.lid[n];return t.equals(o)})},e.prototype.execute=function(e){return r.apply([],this.lid.map(function(t){return e.delBlock(t)}))},e}();t.LogootSDel=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(){function e(){}return e.fromPlain=function(e){if("object"==typeof e&&null!==e){var t=e.l;if("string"==typeof t&&t.length>0){var n=e.id,r=o.Identifier.fromPlain(n);if(null!==r)return new i(r,t)}}return null},e}(),i=function(){function e(e,t){console.assert(t.length>0,"content must not be empty"),this.id=e,this.content=t}return e.fromPlain=function(t){if("object"==typeof t&&null!==t){var n=t.content;if(!("string"==typeof n&&n.length>0))return r.fromPlain(t);var i=t.id,s=o.Identifier.fromPlain(i);if(null!==s)return new e(s,n)}return null},e.prototype.equals=function(e){return this.id.equals(e.id)&&this.content===e.content},e.prototype.execute=function(e){return e.addBlock(this.content,this.id)},e}();t.LogootSAdd=i},function(e,t){e.exports=require("uws")},function(e,t){e.exports=require("rxjs/observable/zip")},function(e,t){e.exports=require("rxjs/Observable")},function(e,t){e.exports=require("rxjs/BehaviorSubject")},function(e,t,n){"use strict";n.r(t);n(39);var o=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s},r=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(o(arguments[t]));return e},i=void 0!==global.window;function s(){return!i||global.window.navigator.onLine}function c(){return!i||"visible"===global.window.document.visibilityState}function a(e){return new RegExp("^(?:wss|ws)://[^\\s]+(?::\\d{2,5})?$","i").test(e)}function u(e){var t;if(void 0===e&&(e=1),i)t=new Uint32Array(e),global.crypto.getRandomValues(t);else{t=[];for(var n=crypto.randomBytes(4*e),o=0;o<n.length;o+=4)t[t.length]=n.readUInt32BE(o,!0)}return t}var l,f,p="background-color: #FFCA28; padding: 0 3px",h="background-color: #b3ba2e; padding: 0 3px",d="background-color: #CE93D8; padding: 0 3px",g="background-color: #90CAF9; padding: 0 3px",b="background-color: #26A69A; padding: 0 3px",y="background-color: #66BB6A; padding: 0 3px",v="background-color: #F57C00; padding: 0 3px",m="background-color: #9FA8DA; padding: 0 2px",S="background-color: #EF9A9A; padding: 0 2px",w={webgroup:function(){},signalingState:function(){},webGroupState:function(){},webrtc:function(){},channel:function(){},topology:function(){},signaling:function(){},channelBuilder:function(){},debug:function(){}};(f=l||(l={}))[f.DEBUG=0]="DEBUG",f[f.WEB_GROUP=1]="WEB_GROUP",f[f.WEBRTC=2]="WEBRTC",f[f.CHANNEL=3]="CHANNEL",f[f.TOPOLOGY=4]="TOPOLOGY",f[f.SIGNALING=5]="SIGNALING",f[f.CHANNEL_BUILDER=6]="CHANNEL_BUILDER";var O,I,j=[];!function(e){e[e.FULL_MESH=0]="FULL_MESH"}(O||(O={})),function(e){e[e.JOINING=0]="JOINING",e[e.JOINED=1]="JOINED",e[e.STABLE=2]="STABLE",e[e.DISCONNECTING=3]="DISCONNECTING",e[e.DISCONNECTED=4]="DISCONNECTED"}(I||(I={}));var M=n(1),k=n(0),T="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function E(e,t){return e(t={exports:{}},t.exports),t.exports}var C=function(e,t){var n=new Array(arguments.length-1),o=0,r=2,i=!0;for(;r<arguments.length;)n[o++]=arguments[r++];return new Promise(function(r,s){n[o]=function(e){if(i)if(i=!1,e)s(e);else{for(var t=new Array(arguments.length-1),n=0;n<t.length;)t[n++]=arguments[n];r.apply(null,t)}};try{e.apply(t||null,n)}catch(e){i&&(i=!1,s(e))}})};var P=E(function(e,t){var n=t;n.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&"="===e.charAt(t);)++n;return Math.ceil(3*e.length)/4-n};for(var o=new Array(64),r=new Array(123),i=0;i<64;)r[o[i]=i<26?i+65:i<52?i+71:i<62?i-4:i-59|43]=i++;n.encode=function(e,t,n){for(var r,i=null,s=[],c=0,a=0;t<n;){var u=e[t++];switch(a){case 0:s[c++]=o[u>>2],r=(3&u)<<4,a=1;break;case 1:s[c++]=o[r|u>>4],r=(15&u)<<2,a=2;break;case 2:s[c++]=o[r|u>>6],s[c++]=o[63&u],a=0}c>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,s)),c=0)}return a&&(s[c++]=o[r],s[c++]=61,1===a&&(s[c++]=61)),i?(c&&i.push(String.fromCharCode.apply(String,s.slice(0,c))),i.join("")):String.fromCharCode.apply(String,s.slice(0,c))};n.decode=function(e,t,n){for(var o,i=n,s=0,c=0;c<e.length;){var a=e.charCodeAt(c++);if(61===a&&s>1)break;if(void 0===(a=r[a]))throw Error("invalid encoding");switch(s){case 0:o=a,s=1;break;case 1:t[n++]=o<<2|(48&a)>>4,o=a,s=2;break;case 2:t[n++]=(15&o)<<4|(60&a)>>2,o=a,s=3;break;case 3:t[n++]=(3&o)<<6|a,s=0}}if(1===s)throw Error("invalid encoding");return n-i},n.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}}),L=B;function B(){this._listeners={}}B.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this},B.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var n=this._listeners[e],o=0;o<n.length;)n[o].fn===t?n.splice(o,1):++o;return this},B.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],o=1;o<arguments.length;)n.push(arguments[o++]);for(o=0;o<t.length;)t[o].fn.apply(t[o++].ctx,n)}return this};var R=N(N);function N(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),n=new Uint8Array(t.buffer),o=128===n[3];function r(e,o,r){t[0]=e,o[r]=n[0],o[r+1]=n[1],o[r+2]=n[2],o[r+3]=n[3]}function i(e,o,r){t[0]=e,o[r]=n[3],o[r+1]=n[2],o[r+2]=n[1],o[r+3]=n[0]}function s(e,o){return n[0]=e[o],n[1]=e[o+1],n[2]=e[o+2],n[3]=e[o+3],t[0]}function c(e,o){return n[3]=e[o],n[2]=e[o+1],n[1]=e[o+2],n[0]=e[o+3],t[0]}e.writeFloatLE=o?r:i,e.writeFloatBE=o?i:r,e.readFloatLE=o?s:c,e.readFloatBE=o?c:s}():function(){function t(e,t,n,o){var r=t<0?1:0;if(r&&(t=-t),0===t)e(1/t>0?0:2147483648,n,o);else if(isNaN(t))e(2143289344,n,o);else if(t>3.4028234663852886e38)e((r<<31|2139095040)>>>0,n,o);else if(t<1.1754943508222875e-38)e((r<<31|Math.round(t/1.401298464324817e-45))>>>0,n,o);else{var i=Math.floor(Math.log(t)/Math.LN2);e((r<<31|i+127<<23|8388607&Math.round(t*Math.pow(2,-i)*8388608))>>>0,n,o)}}function n(e,t,n){var o=e(t,n),r=2*(o>>31)+1,i=o>>>23&255,s=8388607&o;return 255===i?s?NaN:r*(1/0):0===i?1.401298464324817e-45*r*s:r*Math.pow(2,i-150)*(s+8388608)}e.writeFloatLE=t.bind(null,x),e.writeFloatBE=t.bind(null,D),e.readFloatLE=n.bind(null,A),e.readFloatBE=n.bind(null,_)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),n=new Uint8Array(t.buffer),o=128===n[7];function r(e,o,r){t[0]=e,o[r]=n[0],o[r+1]=n[1],o[r+2]=n[2],o[r+3]=n[3],o[r+4]=n[4],o[r+5]=n[5],o[r+6]=n[6],o[r+7]=n[7]}function i(e,o,r){t[0]=e,o[r]=n[7],o[r+1]=n[6],o[r+2]=n[5],o[r+3]=n[4],o[r+4]=n[3],o[r+5]=n[2],o[r+6]=n[1],o[r+7]=n[0]}function s(e,o){return n[0]=e[o],n[1]=e[o+1],n[2]=e[o+2],n[3]=e[o+3],n[4]=e[o+4],n[5]=e[o+5],n[6]=e[o+6],n[7]=e[o+7],t[0]}function c(e,o){return n[7]=e[o],n[6]=e[o+1],n[5]=e[o+2],n[4]=e[o+3],n[3]=e[o+4],n[2]=e[o+5],n[1]=e[o+6],n[0]=e[o+7],t[0]}e.writeDoubleLE=o?r:i,e.writeDoubleBE=o?i:r,e.readDoubleLE=o?s:c,e.readDoubleBE=o?c:s}():function(){function t(e,t,n,o,r,i){var s=o<0?1:0;if(s&&(o=-o),0===o)e(0,r,i+t),e(1/o>0?0:2147483648,r,i+n);else if(isNaN(o))e(0,r,i+t),e(2146959360,r,i+n);else if(o>1.7976931348623157e308)e(0,r,i+t),e((s<<31|2146435072)>>>0,r,i+n);else{var c;if(o<2.2250738585072014e-308)e((c=o/5e-324)>>>0,r,i+t),e((s<<31|c/4294967296)>>>0,r,i+n);else{var a=Math.floor(Math.log(o)/Math.LN2);1024===a&&(a=1023),e(4503599627370496*(c=o*Math.pow(2,-a))>>>0,r,i+t),e((s<<31|a+1023<<20|1048576*c&1048575)>>>0,r,i+n)}}}function n(e,t,n,o,r){var i=e(o,r+t),s=e(o,r+n),c=2*(s>>31)+1,a=s>>>20&2047,u=4294967296*(1048575&s)+i;return 2047===a?u?NaN:c*(1/0):0===a?5e-324*c*u:c*Math.pow(2,a-1075)*(u+4503599627370496)}e.writeDoubleLE=t.bind(null,x,0,4),e.writeDoubleBE=t.bind(null,D,4,0),e.readDoubleLE=n.bind(null,A,0,4),e.readDoubleBE=n.bind(null,_,4,0)}(),e}function x(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}function D(e,t,n){t[n]=e>>>24,t[n+1]=e>>>16&255,t[n+2]=e>>>8&255,t[n+3]=255&e}function A(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function _(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}var G=function(e){try{var t=void 0;if(t&&(t.length||Object.keys(t).length))return t}catch(e){}return null};var U=E(function(e,t){var n=t;n.length=function(e){for(var t=0,n=0,o=0;o<e.length;++o)(n=e.charCodeAt(o))<128?t+=1:n<2048?t+=2:55296==(64512&n)&&56320==(64512&e.charCodeAt(o+1))?(++o,t+=4):t+=3;return t},n.read=function(e,t,n){if(n-t<1)return"";for(var o,r=null,i=[],s=0;t<n;)(o=e[t++])<128?i[s++]=o:o>191&&o<224?i[s++]=(31&o)<<6|63&e[t++]:o>239&&o<365?(o=((7&o)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,i[s++]=55296+(o>>10),i[s++]=56320+(1023&o)):i[s++]=(15&o)<<12|(63&e[t++])<<6|63&e[t++],s>8191&&((r||(r=[])).push(String.fromCharCode.apply(String,i)),s=0);return r?(s&&r.push(String.fromCharCode.apply(String,i.slice(0,s))),r.join("")):String.fromCharCode.apply(String,i.slice(0,s))},n.write=function(e,t,n){for(var o,r,i=n,s=0;s<e.length;++s)(o=e.charCodeAt(s))<128?t[n++]=o:o<2048?(t[n++]=o>>6|192,t[n++]=63&o|128):55296==(64512&o)&&56320==(64512&(r=e.charCodeAt(s+1)))?(o=65536+((1023&o)<<10)+(1023&r),++s,t[n++]=o>>18|240,t[n++]=o>>12&63|128,t[n++]=o>>6&63|128,t[n++]=63&o|128):(t[n++]=o>>12|224,t[n++]=o>>6&63|128,t[n++]=63&o|128);return n-i}}),q=function(e,t,n){var o=n||8192,r=o>>>1,i=null,s=o;return function(n){if(n<1||n>r)return e(n);s+n>o&&(i=e(o),s=0);var c=t.call(i,s,s+=n);return 7&s&&(s=1+(7|s)),c}};var F=W;function W(e,t){this.lo=e>>>0,this.hi=t>>>0}var H=W.zero=new W(0,0);H.toNumber=function(){return 0},H.zzEncode=H.zzDecode=function(){return this},H.length=function(){return 1};var J=W.zeroHash="\0\0\0\0\0\0\0\0";W.fromNumber=function(e){if(0===e)return H;var t=e<0;t&&(e=-e);var n=e>>>0,o=(e-n)/4294967296>>>0;return t&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new W(n,o)},W.from=function(e){if("number"==typeof e)return W.fromNumber(e);if(X.isString(e)){if(!X.Long)return W.fromNumber(parseInt(e,10));e=X.Long.fromString(e)}return e.low||e.high?new W(e.low>>>0,e.high>>>0):H},W.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+4294967296*n)}return this.lo+4294967296*this.hi},W.prototype.toLong=function(e){return X.Long?new X.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var z=String.prototype.charCodeAt;W.fromHash=function(e){return e===J?H:new W((z.call(e,0)|z.call(e,1)<<8|z.call(e,2)<<16|z.call(e,3)<<24)>>>0,(z.call(e,4)|z.call(e,5)<<8|z.call(e,6)<<16|z.call(e,7)<<24)>>>0)},W.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},W.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},W.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},W.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10};var Q,$="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},X=E(function(e,t){var n=t;function o(e,t,n){for(var o=Object.keys(t),r=0;r<o.length;++r)void 0!==e[o[r]]&&n||(e[o[r]]=t[o[r]]);return e}function r(e){function t(e,n){if(!(this instanceof t))return new t(e,n);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&o(this,n)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}n.asPromise=C,n.base64=P,n.EventEmitter=L,n.float=R,n.inquire=G,n.utf8=U,n.pool=q,n.LongBits=F,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isNode=Boolean(T.process&&T.process.versions&&T.process.versions.node),n.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},n.isString=function(e){return"string"==typeof e||e instanceof String},n.isObject=function(e){return e&&"object"===(void 0===e?"undefined":$(e))},n.isset=n.isSet=function(e,t){var n=e[t];return!(null==n||!e.hasOwnProperty(t))&&("object"!==(void 0===n?"undefined":$(n))||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},n.Buffer=function(){try{var e=n.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),n._Buffer_from=null,n._Buffer_allocUnsafe=null,n.newBuffer=function(e){return"number"==typeof e?n.Buffer?n._Buffer_allocUnsafe(e):new n.Array(e):n.Buffer?n._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=T.dcodeIO&&T.dcodeIO.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(e){return e?n.LongBits.from(e).toHash():n.LongBits.zeroHash},n.longFromHash=function(e,t){var o=n.LongBits.fromHash(e);return n.Long?n.Long.fromBits(o.lo,o.hi,t):o.toNumber(Boolean(t))},n.merge=o,n.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},n.newError=r,n.ProtocolError=r("ProtocolError"),n.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var e=Object.keys(this),n=e.length-1;n>-1;--n)if(1===t[e[n]]&&void 0!==this[e[n]]&&null!==this[e[n]])return e[n]}},n.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n._configure=function(){var e=n.Buffer;e?(n._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,n){return new e(t,n)},n._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):n._Buffer_from=n._Buffer_allocUnsafe=null}}),V=ne,Y=X.LongBits,K=X.base64,Z=X.utf8;function ee(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}function te(){}function ne(){this.len=0,this.head=new ee(te,0,0),this.tail=this.head,this.states=null}function oe(e,t,n){t[n]=255&e}function re(e,t){this.len=e,this.next=void 0,this.val=t}function ie(e,t,n){for(;e.hi;)t[n++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[n++]=127&e.lo|128,e.lo=e.lo>>>7;t[n++]=e.lo}function se(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}ne.create=X.Buffer?function(){return(ne.create=function(){return new Q})()}:function(){return new ne},ne.alloc=function(e){return new X.Array(e)},X.Array!==Array&&(ne.alloc=X.pool(ne.alloc,X.Array.prototype.subarray)),ne.prototype._push=function(e,t,n){return this.tail=this.tail.next=new ee(e,t,n),this.len+=t,this},re.prototype=Object.create(ee.prototype),re.prototype.fn=function(e,t,n){for(;e>127;)t[n++]=127&e|128,e>>>=7;t[n]=e},ne.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new re((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},ne.prototype.int32=function(e){return e<0?this._push(ie,10,Y.fromNumber(e)):this.uint32(e)},ne.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},ne.prototype.uint64=function(e){var t=Y.from(e);return this._push(ie,t.length(),t)},ne.prototype.int64=ne.prototype.uint64,ne.prototype.sint64=function(e){var t=Y.from(e).zzEncode();return this._push(ie,t.length(),t)},ne.prototype.bool=function(e){return this._push(oe,1,e?1:0)},ne.prototype.fixed32=function(e){return this._push(se,4,e>>>0)},ne.prototype.sfixed32=ne.prototype.fixed32,ne.prototype.fixed64=function(e){var t=Y.from(e);return this._push(se,4,t.lo)._push(se,4,t.hi)},ne.prototype.sfixed64=ne.prototype.fixed64,ne.prototype.float=function(e){return this._push(X.float.writeFloatLE,4,e)},ne.prototype.double=function(e){return this._push(X.float.writeDoubleLE,8,e)};var ce=X.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var o=0;o<e.length;++o)t[n+o]=e[o]};ne.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(oe,1,0);if(X.isString(e)){var n=ne.alloc(t=K.length(e));K.decode(e,n,0),e=n}return this.uint32(t)._push(ce,t,e)},ne.prototype.string=function(e){var t=Z.length(e);return t?this.uint32(t)._push(Z.write,t,e):this._push(oe,1,0)},ne.prototype.fork=function(){return this.states=new function(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}(this),this.head=this.tail=new ee(te,0,0),this.len=0,this},ne.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new ee(te,0,0),this.len=0),this},ne.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this},ne.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t},ne._configure=function(e){Q=e};var ae=le;(le.prototype=Object.create(V.prototype)).constructor=le;var ue=X.Buffer;function le(){V.call(this)}le.alloc=function(e){return(le.alloc=X._Buffer_allocUnsafe)(e)};var fe=ue&&ue.prototype instanceof Uint8Array&&"set"===ue.prototype.set.name?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var o=0;o<e.length;)t[n++]=e[o++]};function pe(e,t,n){e.length<40?X.utf8.write(e,t,n):t.utf8Write(e,n)}le.prototype.bytes=function(e){X.isString(e)&&(e=X._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(fe,t,e),this},le.prototype.string=function(e){var t=ue.byteLength(e);return this.uint32(t),t&&this._push(pe,t,e),this};var he,de=ve,ge=X.LongBits,be=X.utf8;function ye(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function ve(e){this.buf=e,this.pos=0,this.len=e.length}var me,Se="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new ve(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new ve(e);throw Error("illegal buffer")};function we(){var e=new ge(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw ye(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw ye(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function Oe(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function Ie(){if(this.pos+8>this.len)throw ye(this,8);return new ge(Oe(this.buf,this.pos+=4),Oe(this.buf,this.pos+=4))}ve.create=X.Buffer?function(e){return(ve.create=function(e){return X.Buffer.isBuffer(e)?new he(e):Se(e)})(e)}:Se,ve.prototype._slice=X.Array.prototype.subarray||X.Array.prototype.slice,ve.prototype.uint32=(me=4294967295,function(){if(me=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return me;if(me=(me|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return me;if(me=(me|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return me;if(me=(me|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return me;if(me=(me|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return me;if((this.pos+=5)>this.len)throw this.pos=this.len,ye(this,10);return me}),ve.prototype.int32=function(){return 0|this.uint32()},ve.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},ve.prototype.bool=function(){return 0!==this.uint32()},ve.prototype.fixed32=function(){if(this.pos+4>this.len)throw ye(this,4);return Oe(this.buf,this.pos+=4)},ve.prototype.sfixed32=function(){if(this.pos+4>this.len)throw ye(this,4);return 0|Oe(this.buf,this.pos+=4)},ve.prototype.float=function(){if(this.pos+4>this.len)throw ye(this,4);var e=X.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},ve.prototype.double=function(){if(this.pos+8>this.len)throw ye(this,4);var e=X.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},ve.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw ye(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,n):t===n?new this.buf.constructor(0):this._slice.call(this.buf,t,n)},ve.prototype.string=function(){var e=this.bytes();return be.read(e,0,e.length)},ve.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw ye(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw ye(this)}while(128&this.buf[this.pos++]);return this},ve.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;;){if(4==(e=7&this.uint32()))break;this.skipType(e)}break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},ve._configure=function(e){he=e;var t=X.Long?"toLong":"toNumber";X.merge(ve.prototype,{int64:function(){return we.call(this)[t](!1)},uint64:function(){return we.call(this)[t](!0)},sint64:function(){return we.call(this).zzDecode()[t](!1)},fixed64:function(){return Ie.call(this)[t](!0)},sfixed64:function(){return Ie.call(this)[t](!1)}})};var je=Me;function Me(e){de.call(this,e)}(Me.prototype=Object.create(de.prototype)).constructor=Me,X.Buffer&&(Me.prototype._slice=X.Buffer.prototype.slice),Me.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len))};var ke=Te;function Te(e,t,n){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");X.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(n)}(Te.prototype=Object.create(X.EventEmitter.prototype)).constructor=Te,Te.prototype.rpcCall=function e(t,n,o,r,i){if(!r)throw TypeError("request must be specified");var s=this;if(!i)return X.asPromise(e,s,t,n,o,r);if(s.rpcImpl)try{return s.rpcImpl(t,n[s.requestDelimited?"encodeDelimited":"encode"](r).finish(),function(e,n){if(e)return s.emit("error",e,t),i(e);if(null!==n){if(!(n instanceof o))try{n=o[s.responseDelimited?"decodeDelimited":"decode"](n)}catch(e){return s.emit("error",e,t),i(e)}return s.emit("data",n,t),i(null,n)}s.end(!0)})}catch(e){return s.emit("error",e,t),void setTimeout(function(){i(e)},0)}else setTimeout(function(){i(Error("already ended"))},0)},Te.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};var Ee,Ce,Pe=E(function(e,t){t.Service=ke}),Le={},Be=E(function(e,t){var n=t;function o(){n.Reader._configure(n.BufferReader),n.util._configure()}n.build="minimal",n.Writer=V,n.BufferWriter=ae,n.Reader=de,n.BufferReader=je,n.util=X,n.rpc=Pe,n.roots=Le,n.configure=o,n.Writer._configure(n.BufferWriter),o()}),Re=Be.Reader,Ne=Be.Writer,xe=Be.util,De=Be.roots,Ae=Re,_e=Ne,Ge=xe,Ue=De.default||(De.default={}),qe=Ue.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.senderId=0,e.prototype.recipientId=0,e.prototype.isService=!1,e.prototype.content=Ge.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.senderId&&e.hasOwnProperty("senderId")&&t.uint32(8).uint32(e.senderId),null!=e.recipientId&&e.hasOwnProperty("recipientId")&&t.uint32(16).uint32(e.recipientId),null!=e.isService&&e.hasOwnProperty("isService")&&t.uint32(24).bool(e.isService),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(34).bytes(e.content),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.senderId=e.uint32();break;case 2:o.recipientId=e.uint32();break;case 3:o.isService=e.bool();break;case 4:o.content=e.bytes();break;default:e.skipType(7&r)}}return o},e}(),Fe=Ue.user=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.length=0,e.prototype.type=0,e.prototype.full=Ge.newBuffer([]),e.prototype.chunk=null;var t,n,o;return Object.defineProperty(e.prototype,"content",{get:Ge.oneOfGetter(t=["full","chunk"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.length&&e.hasOwnProperty("length")&&t.uint32(8).uint32(e.length),null!=e.type&&e.hasOwnProperty("type")&&t.uint32(16).int32(e.type),null!=e.full&&e.hasOwnProperty("full")&&t.uint32(26).bytes(e.full),null!=e.chunk&&e.hasOwnProperty("chunk")&&Ue.user.Message.Chunk.encode(e.chunk,t.uint32(34).fork()).ldelim(),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.user.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.length=e.uint32();break;case 2:o.type=e.int32();break;case 3:o.full=e.bytes();break;case 4:o.chunk=Ue.user.Message.Chunk.decode(e,e.uint32());break;default:e.skipType(7&r)}}return o},e.Chunk=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.number=0,e.prototype.content=Ge.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.number&&e.hasOwnProperty("number")&&t.uint32(16).uint32(e.number),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(34).bytes(e.content),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.user.Message.Chunk;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.id=e.uint32();break;case 2:o.number=e.uint32();break;case 4:o.content=e.bytes();break;default:e.skipType(7&r)}}return o},e}(),e.Type=(n={},(o=Object.create(n))[n[0]="STRING"]=0,o[n[1]="U_INT_8_ARRAY"]=1,o),e}(),e}(),We=Ue.service=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.content=Ge.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).bytes(e.content),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.service.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.id=e.uint32();break;case 2:o.content=e.bytes();break;default:e.skipType(7&r)}}return o},e}(),e}(),He=Ue.webChannel=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.init=null,e.prototype.initOk=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ge.oneOfGetter(t=["init","initOk"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.init&&e.hasOwnProperty("init")&&Ue.webChannel.InitData.encode(e.init,t.uint32(10).fork()).ldelim(),null!=e.initOk&&e.hasOwnProperty("initOk")&&t.uint32(16).bool(e.initOk),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.webChannel.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.init=Ue.webChannel.InitData.decode(e,e.uint32());break;case 2:o.initOk=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e.InitData=function(){function e(e){if(this.generatedIds=[],this.members=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.topology=0,e.prototype.wcId=0,e.prototype.generatedIds=Ge.emptyArray,e.prototype.members=Ge.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=_e.create()),null!=e.topology&&e.hasOwnProperty("topology")&&t.uint32(8).uint32(e.topology),null!=e.wcId&&e.hasOwnProperty("wcId")&&t.uint32(16).uint32(e.wcId),null!=e.generatedIds&&e.generatedIds.length){t.uint32(26).fork();for(var n=0;n<e.generatedIds.length;++n)t.uint32(e.generatedIds[n]);t.ldelim()}if(null!=e.members&&e.members.length){t.uint32(34).fork();for(var o=0;o<e.members.length;++o)t.uint32(e.members[o]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.webChannel.InitData;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.topology=e.uint32();break;case 2:o.wcId=e.uint32();break;case 3:if(o.generatedIds&&o.generatedIds.length||(o.generatedIds=[]),2==(7&r))for(var i=e.uint32()+e.pos;e.pos<i;)o.generatedIds.push(e.uint32());else o.generatedIds.push(e.uint32());break;case 4:if(o.members&&o.members.length||(o.members=[]),2==(7&r))for(var s=e.uint32()+e.pos;e.pos<s;)o.members.push(e.uint32());else o.members.push(e.uint32());break;default:e.skipType(7&r)}}return o},e}(),e}(),Je=Ue.channelBuilder=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.request=null,e.prototype.response=null,e.prototype.failed="",e.prototype.ping=!1,e.prototype.pong=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ge.oneOfGetter(t=["request","response","failed","ping","pong"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.request&&e.hasOwnProperty("request")&&Ue.channelBuilder.Connection.encode(e.request,t.uint32(10).fork()).ldelim(),null!=e.response&&e.hasOwnProperty("response")&&Ue.channelBuilder.Connection.encode(e.response,t.uint32(18).fork()).ldelim(),null!=e.failed&&e.hasOwnProperty("failed")&&t.uint32(26).string(e.failed),null!=e.ping&&e.hasOwnProperty("ping")&&t.uint32(32).bool(e.ping),null!=e.pong&&e.hasOwnProperty("pong")&&t.uint32(40).bool(e.pong),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.channelBuilder.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.request=Ue.channelBuilder.Connection.decode(e,e.uint32());break;case 2:o.response=Ue.channelBuilder.Connection.decode(e,e.uint32());break;case 3:o.failed=e.string();break;case 4:o.ping=e.bool();break;case 5:o.pong=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e.Connection=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.wsUrl="",e.prototype.isWrtcSupport=!1,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.wsUrl&&e.hasOwnProperty("wsUrl")&&t.uint32(10).string(e.wsUrl),null!=e.isWrtcSupport&&e.hasOwnProperty("isWrtcSupport")&&t.uint32(16).bool(e.isWrtcSupport),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.channelBuilder.Connection;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.wsUrl=e.string();break;case 2:o.isWrtcSupport=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e}(),ze=Ue.fullMesh=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.membersResponse=null,e.prototype.membersRequest=!1,e.prototype.adjacentMembers=null,e.prototype.heartbeat=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ge.oneOfGetter(t=["membersResponse","membersRequest","adjacentMembers","heartbeat"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.membersResponse&&e.hasOwnProperty("membersResponse")&&Ue.fullMesh.Peers.encode(e.membersResponse,t.uint32(10).fork()).ldelim(),null!=e.membersRequest&&e.hasOwnProperty("membersRequest")&&t.uint32(16).bool(e.membersRequest),null!=e.adjacentMembers&&e.hasOwnProperty("adjacentMembers")&&Ue.fullMesh.Peers.encode(e.adjacentMembers,t.uint32(26).fork()).ldelim(),null!=e.heartbeat&&e.hasOwnProperty("heartbeat")&&t.uint32(40).bool(e.heartbeat),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.fullMesh.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.membersResponse=Ue.fullMesh.Peers.decode(e,e.uint32());break;case 2:o.membersRequest=e.bool();break;case 3:o.adjacentMembers=Ue.fullMesh.Peers.decode(e,e.uint32());break;case 5:o.heartbeat=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e.Peers=function(){function e(e){if(this.ids=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.ids=Ge.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=_e.create()),null!=e.ids&&e.ids.length){t.uint32(10).fork();for(var n=0;n<e.ids.length;++n)t.uint32(e.ids[n]);t.ldelim()}return t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.fullMesh.Peers;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:if(o.ids&&o.ids.length||(o.ids=[]),2==(7&r))for(var i=e.uint32()+e.pos;e.pos<i;)o.ids.push(e.uint32());else o.ids.push(e.uint32());break;default:e.skipType(7&r)}}return o},e}(),e}(),Qe=Ue.webRTCBuilder=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.isInitiator=!1,e.prototype.offer="",e.prototype.answer="",e.prototype.iceCandidate=null,e.prototype.isError=!1,e.prototype.isEnd=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ge.oneOfGetter(t=["offer","answer","iceCandidate","isError","isEnd"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.isInitiator&&e.hasOwnProperty("isInitiator")&&t.uint32(8).bool(e.isInitiator),null!=e.offer&&e.hasOwnProperty("offer")&&t.uint32(18).string(e.offer),null!=e.answer&&e.hasOwnProperty("answer")&&t.uint32(26).string(e.answer),null!=e.iceCandidate&&e.hasOwnProperty("iceCandidate")&&Ue.webRTCBuilder.IceCandidate.encode(e.iceCandidate,t.uint32(34).fork()).ldelim(),null!=e.isError&&e.hasOwnProperty("isError")&&t.uint32(40).bool(e.isError),null!=e.isEnd&&e.hasOwnProperty("isEnd")&&t.uint32(48).bool(e.isEnd),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.webRTCBuilder.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.isInitiator=e.bool();break;case 2:o.offer=e.string();break;case 3:o.answer=e.string();break;case 4:o.iceCandidate=Ue.webRTCBuilder.IceCandidate.decode(e,e.uint32());break;case 5:o.isError=e.bool();break;case 6:o.isEnd=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e.IceCandidate=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.candidate="",e.prototype.sdpMid="",e.prototype.sdpMLineIndex=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.candidate&&e.hasOwnProperty("candidate")&&t.uint32(10).string(e.candidate),null!=e.sdpMid&&e.hasOwnProperty("sdpMid")&&t.uint32(18).string(e.sdpMid),null!=e.sdpMLineIndex&&e.hasOwnProperty("sdpMLineIndex")&&t.uint32(24).uint32(e.sdpMLineIndex),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.webRTCBuilder.IceCandidate;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.candidate=e.string();break;case 2:o.sdpMid=e.string();break;case 3:o.sdpMLineIndex=e.uint32();break;default:e.skipType(7&r)}}return o},e}(),e}(),$e=Ue.signaling=function(){var e={};return e.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.content=null,e.prototype.isFirst=!1,e.prototype.stable=!1,e.prototype.heartbeat=!1,e.prototype.tryAnother=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ge.oneOfGetter(t=["content","isFirst","stable","heartbeat","tryAnother"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.content&&e.hasOwnProperty("content")&&Ue.signaling.Content.encode(e.content,t.uint32(10).fork()).ldelim(),null!=e.isFirst&&e.hasOwnProperty("isFirst")&&t.uint32(16).bool(e.isFirst),null!=e.stable&&e.hasOwnProperty("stable")&&t.uint32(24).bool(e.stable),null!=e.heartbeat&&e.hasOwnProperty("heartbeat")&&t.uint32(32).bool(e.heartbeat),null!=e.tryAnother&&e.hasOwnProperty("tryAnother")&&t.uint32(40).bool(e.tryAnother),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.signaling.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.content=Ue.signaling.Content.decode(e,e.uint32());break;case 2:o.isFirst=e.bool();break;case 3:o.stable=e.bool();break;case 4:o.heartbeat=e.bool();break;case 5:o.tryAnother=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e.Content=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}e.prototype.id=0,e.prototype.data=Ge.newBuffer([]),e.prototype.isError=!1,e.prototype.isEnd=!1;var t;return Object.defineProperty(e.prototype,"type",{get:Ge.oneOfGetter(t=["data","isError","isEnd"]),set:Ge.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=_e.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).uint32(e.id),null!=e.data&&e.hasOwnProperty("data")&&t.uint32(18).bytes(e.data),null!=e.isError&&e.hasOwnProperty("isError")&&t.uint32(24).bool(e.isError),null!=e.isEnd&&e.hasOwnProperty("isEnd")&&t.uint32(32).bool(e.isEnd),t},e.decode=function(e,t){e instanceof Ae||(e=Ae.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new Ue.signaling.Content;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:o.id=e.uint32();break;case 2:o.data=e.bytes();break;case 3:o.isError=e.bool();break;case 4:o.isEnd=e.bool();break;default:e.skipType(7&r)}}return o},e}(),e}(),Xe=$e.Message.encode($e.Message.create({heartbeat:!0})).finish();(Ce=Ee||(Ee={}))[Ce.CONNECTING=0]="CONNECTING",Ce[Ce.CONNECTED=1]="CONNECTED",Ce[Ce.STABLE=2]="STABLE",Ce[Ce.CLOSING=3]="CLOSING",Ce[Ce.CLOSED=4]="CLOSED";var Ve,Ye,Ke,Ze,et=function(){function e(e,t){this.url=t,this.state=Ee.CLOSED,this.wc=e,this.completeWs=function(){},this.stateSubject=new k.Subject,this.channelSubject=new k.Subject}return Object.defineProperty(e.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onChannel",{get:function(){return this.channelSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.open=function(){this.state===Ee.CONNECTED&&(this.send({stable:!0}),this.setState(Ee.STABLE))},e.prototype.join=function(e){var t=this;this.state!==Ee.CLOSING&&this.state!==Ee.CLOSED&&(this.ws.onclose=function(){},this.ws.onmessage=function(){},this.ws.onerror=function(){},clearInterval(this.heartbeatInterval),this.missedHeartbeat=0,this.completeWs(),this.ws.close()),this.setState(Ee.CONNECTING),this.wc.webSocketBuilder.connect(this.getFullURL(e)).then(function(e){t.ws=e,t.wsObservable=t.createObservable(t.ws),t.startHeartbeat(),t.wsObservable.subscribe(function(e){switch(e.type){case"heartbeat":t.missedHeartbeat=0;break;case"isFirst":e.isFirst?t.setState(Ee.STABLE):t.connectOverSignaling()}})}).catch(function(){return t.setState(Ee.CLOSED)})},e.prototype.close=function(){this.state!==Ee.CLOSING&&this.state!==Ee.CLOSED&&(this.setState(Ee.CLOSING),this.ws&&this.ws.close(1e3))},e.prototype.connectOverSignaling=function(){var e=this;this.ws.readyState===WebSocket.OPEN&&this.wc.webRTCBuilder.connectOverSignaling(this.getWebRTCStream()).then(function(){return e.setState(Ee.CONNECTED)}).catch(function(){return e.send({tryAnother:!0})})},e.prototype.setState=function(e){var t=this;this.state!==e&&(this.state=e,this.stateSubject.next(e),e===Ee.STABLE&&this.wc.webRTCBuilder.onChannelFromSignaling(this.getWebRTCStream()).subscribe(function(e){return t.channelSubject.next(e)}))},e.prototype.startHeartbeat=function(){var e=this;this.missedHeartbeat=0,this.heartbeatInterval=global.setInterval(function(){try{if(e.missedHeartbeat++,e.missedHeartbeat>=3)throw new Error("Too many missed heartbeats");e.heartbeat()}catch(t){global.clearInterval(e.heartbeatInterval),w.signaling("Closing connection with Signaling. Reason: "+t.message),e.setState(Ee.CLOSING),e.ws.close(4002,"Signaling is not responding")}},5e3)},e.prototype.createObservable=function(e){var t=this,n=new k.Subject;return this.completeWs=function(){return n.complete()},e.binaryType="arraybuffer",e.onmessage=function(t){try{n.next($e.Message.decode(new Uint8Array(t.data)))}catch(t){e.close(4010,t.message)}},e.onerror=function(e){return n.error(e)},e.onclose=function(e){clearInterval(t.heartbeatInterval),t.missedHeartbeat=0,t.setState(Ee.CLOSED),n.complete(),w.signaling("Connection with Signaling '"+t.url+"' closed: "+e.code+": "+e.reason)},n.asObservable()},e.prototype.send=function(e){if(this.ws.readyState===WebSocket.OPEN)try{this.ws.send($e.Message.encode($e.Message.create(e)).finish())}catch(e){w.signaling("Failed send to Signaling: "+e.message)}},e.prototype.heartbeat=function(){if(this.ws.readyState===WebSocket.OPEN)try{this.ws.send(Xe)}catch(e){w.signaling("Failed send to Signaling: "+e.message)}},e.prototype.getWebRTCStream=function(){var e=this;return{message:this.wsObservable.pipe(Object(M.filter)(function(e){return"content"===e.type}),Object(M.pluck)("content")),send:function(t){return e.send({content:t})}}},e.prototype.getFullURL=function(e){return this.url.endsWith("/")?this.url+e:this.url+"/"+e},e}(),tt=function(){function e(e,t,n){void 0===n&&(n={id:1});var o=this;w.channel("New Channel: Me: "+e.myId+" with "+n.id),this.wc=e,this.connection=t,this._id=n.id,this.rtcPeerConnection=n.rtcPeerConnection,this.isIntermediary=!1,this.missedHeartbeat=0,this.updateHeartbeatMsg(this.wc.topologyService.heartbeat),this.rtcPeerConnection?this.maximumMissedHeartBeat=3:this.maximumMissedHeartBeat=12,i?(t.binaryType="arraybuffer",this.send=this.sendInBrowser):this.rtcPeerConnection?(t.binaryType="arraybuffer",this.send=this.sendInNodeViaDataChannel):this.send=this.sendInNodeViaWebSocket,this.connection.onmessage=function(t){var n=t.data;return e.onMessageProxy(o,new Uint8Array(n))},this.connection.onclose=function(t){w.channel("Connection with "+o.id+" has closed"),e.topologyService.onChannelClose(t,o)},this.connection.onerror=function(t){w.channel("Channel error: ",t),e.topologyService.onChannelError(t,o),o.close()}}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e,this.fullHeartbeatMsg=this.wc.encode({recipientId:e,content:this.topologyHeartbeatMsg})},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.connection.close(),this.rtcPeerConnection&&this.rtcPeerConnection.close()},e.prototype.closeQuietly=function(){this.connection.onmessage=void 0,this.connection.onclose=void 0,this.connection.onerror=void 0,this.close()},e.prototype.sendHeartbeat=function(){this.send(this.fullHeartbeatMsg)},e.prototype.updateHeartbeatMsg=function(e){this.topologyHeartbeatMsg=e,this.fullHeartbeatMsg=this.wc.encode({recipientId:this._id,content:e})},e.prototype.sendInBrowser=function(e){try{this.connection.send(e)}catch(e){w.channel("Channel sendInBrowser ERROR",e)}},e.prototype.sendInNodeViaWebSocket=function(e){try{this.connection.send(e,{binary:!0})}catch(e){w.channel("Channel sendInNodeViaWebSocket ERROR",e)}},e.prototype.sendInNodeViaDataChannel=function(e){this.sendInBrowser(e.slice(0))},e}(),nt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},ot=new global.TextEncoder,rt=new global.TextDecoder,it=function(){function e(){this.buffers=new Map}return e.prototype.encode=function(e){var t=this.userDataToType(e),n=t.type,o=t.bytes,r={length:o.length,type:n};if(o.length<=15e3)return r.full=o,[Fe.Message.encode(Fe.Message.create(r)).finish()];r.chunk={id:Math.ceil(65535*Math.random())};for(var i=Math.ceil(o.length/15e3),s=new Array(i),c=0;c<i;c++){var a=15e3*c,u=a+Math.min(15e3,o.length-15e3*c);r.chunk.number=c,r.chunk.content=new Uint8Array(o.slice(a,u)),s[c]=Fe.Message.encode(Fe.Message.create(r)).finish()}return s},e.prototype.decode=function(e,t){var n,o=Fe.Message.decode(e);switch(o.content){case"full":n=o.full;break;case"chunk":var r=this.getBuffer(t,o.chunk.id);void 0===r?(r=new st(o.length,o.chunk.content,o.chunk.number),this.setBuffer(t,o.chunk.id,r),n=void 0):n=r.append(o.chunk.content,o.chunk.number);break;default:throw new Error("Unknown message integrity")}if(void 0!==n)switch(o.type){case Fe.Message.Type.U_INT_8_ARRAY:return n;case Fe.Message.Type.STRING:return rt.decode(n);default:throw new Error("Unknown message type")}return n},e.prototype.userDataToType=function(e){if(e instanceof Uint8Array)return{type:Fe.Message.Type.U_INT_8_ARRAY,bytes:e};if("string"==typeof e)return{type:Fe.Message.Type.STRING,bytes:ot.encode(e)};if(e instanceof String)return{type:Fe.Message.Type.STRING,bytes:ot.encode(""+e)};throw new Error("Message neigther a string type or a Uint8Array type")},e.prototype.getBuffer=function(e,t){var n=this.buffers.get(e);if(void 0!==n)return n.get(t)},e.prototype.setBuffer=function(e,t,n){var o=this.buffers.get(e);void 0===o&&(o=new Map),o.set(t,n),this.buffers.set(e,o)},e}(),st=function(){function e(e,t,n){this.fullData=new Uint8Array(e),this.currentLength=0,this.append(t,n)}return e.prototype.append=function(e,t){var n,o,r=15e3*t;this.currentLength+=e.length;try{for(var i=nt(e),s=i.next();!s.done;s=i.next()){var c=s.value;this.fullData[r++]=c}}catch(e){n={error:e}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return this.currentLength===this.fullData.length?this.fullData:void 0},e}(),ct=new(n(20).BehaviorSubject)(""),at=function(){function e(e){this.wc=e,this.channelsSubject=new k.Subject}return e.listen=function(){return ct},e.newIncomingSocket=function(e,t,n){e.webSocketBuilder.channelsSubject.next(new tt(e,t,{id:n}))},Object.defineProperty(e.prototype,"onChannel",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.connect=function(e,t){var n=this;return new Promise(function(o,r){try{if(a(e)&&-1!==e.search(/^wss?/)){var i=void 0!==t?e+"/internalChannel?wcId="+n.wc.id+"&senderId="+n.wc.myId:e,s=new global.WebSocket(i),c=setTimeout(function(){s.readyState!==s.OPEN&&(s.close(),r(new Error("WebSocket 6000ms connection timeout with '"+e+"'")))},6e3);s.onopen=function(){clearTimeout(c),o(void 0===t?s:new tt(n.wc,s,{id:t}))},s.onerror=function(e){return r(e)},s.onclose=function(t){return r(new Error("WebSocket connection to '"+e+"' failed with code "+t.code+": "+t.reason))}}else r(new Error(e+" is not a valid URL"))}catch(e){r(e)}})},e}(),ut=function(){function e(e,t,n){this.serviceId=e,this.protoMessage=t,void 0!==n&&this.setupServiceMessage(n)}return e.encodeServiceMessage=function(e,t){return We.Message.encode(We.Message.create({id:e,content:t})).finish()},e.prototype.encode=function(e){return We.Message.encode(We.Message.create({id:this.serviceId,content:this.protoMessage.encode(this.protoMessage.create(e)).finish()})).finish()},e.prototype.decode=function(e){return this.protoMessage.decode(e)},e.prototype.setupServiceMessage=function(e){var t=this;this.onServiceMessage=e.pipe(Object(M.filter)(function(e){return e.id===t.serviceId}),Object(M.map)(function(e){var n=e.channel,o=e.senderId,r=e.recipientId,i=e.content;return{channel:n,senderId:o,recipientId:r,msg:t.protoMessage.decode(i)}}))},e}(),lt=n(19),ft=n(10),pt=(Ve=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Ve(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ht=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s},dt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},gt=0,bt=300,yt=function(e){function t(t,n){var o=e.call(this,bt,Qe.Message,t.serviceMessageSubject)||this;return o.wc=t,o.rtcConfiguration=n,o}return pt(t,e),Object.defineProperty(t,"isSupported",{get:function(){return void 0!==global.RTCPeerConnection},enumerable:!0,configurable:!0}),t.prototype.onChannelFromWebChannel=function(){var n=this;if(t.isSupported)return this.onChannel(this.onServiceMessage.pipe(Object(M.filter)(function(e){return e.msg.isInitiator}),Object(M.map)(function(e){var t=e.msg,n=e.senderId;return t.id=n,t})),function(t,o){return n.wc.sendToProxy({recipientId:o,content:e.prototype.encode.call(n,t)})});throw w.webrtc("WebRTC is not supported"),new Error("WebRTC is not supported")},t.prototype.connectOverWebChannel=function(n){var o=this;if(t.isSupported)return this.establishChannel(this.onServiceMessage.pipe(Object(M.filter)(function(e){var t=e.msg;return e.senderId===n&&!t.isInitiator}),Object(M.pluck)("msg")),function(t){t.isInitiator=!0,o.wc.sendToProxy({recipientId:n,content:e.prototype.encode.call(o,t)})},n);throw new Error("WebRTC is not supported")},t.prototype.onChannelFromSignaling=function(n){var o=this;if(t.isSupported)return this.onChannel(n.message.pipe(Object(M.filter)(function(e){return 0!==e.id}),Object(M.map)(function(t){if("data"===t.type){var n=e.prototype.decode.call(o,t.data);return n.id=t.id,n}return t})),function(e,t){"isError"in e||"isEnd"in e||(e.data=Qe.Message.encode(Qe.Message.create(e)).finish()),e.id=t,n.send(e)});throw new Error("WebRTC is not supported")},t.prototype.connectOverSignaling=function(n){var o=this;if(t.isSupported)return this.establishChannel(n.message.pipe(Object(M.filter)(function(e){return 0===e.id}),Object(M.map)(function(t){return"data"===t.type?e.prototype.decode.call(o,t.data):t})),function(e){"isError"in e||"isEnd"in e?n.send(e):n.send({data:Qe.Message.encode(Qe.Message.create(e)).finish()})});throw new Error("WebRTC is not supported")},t.prototype.establishChannel=function(e,t,n){var o=this;void 0===n&&(n=1);var r=!1,i=new global.RTCPeerConnection(this.rtcConfiguration);i.onicegatheringstatechange=function(){w.webrtc("ICE GATHERING STATE changed to",i.iceGatheringState),"complete"===i.iceGatheringState&&r&&(t({isEnd:!0}),r=!1)},gt++,i.onsignalingstatechange=function(){w.webrtc("SIGNALING STATE changed to",i.signalingState)};var s=new ft.ReplaySubject;return this.setupLocalCandidates(i,function(e){return t({iceCandidate:e})}),new Promise(function(c,a){var u=e.subscribe(function(e){var n=e.answer,o=e.iceCandidate,r=e.isError,c=e.isEnd;i.oniceconnectionstatechange=function(){w.webrtc(gt+": ICE CONNECTION STATE changed to",i.iceConnectionState),"failed"===i.iceConnectionState&&(s.complete(),i.close(),t({isError:!0}),u.unsubscribe(),a(new Error(gt+": Failed to establish RTCDataChannel: Ice Connection failed")))},r?(s.complete(),u.unsubscribe(),"connected"!==i.iceConnectionState&&"completed"!==i.iceConnectionState?(w.webrtc(gt+": Failed to establish RTCDataChannel: remote peer error"),i.close(),a(new Error(gt+": Remote peer error"))):w.webrtc(gt+": Remote peer error, but RTCDataChannel has still been established")):n?(w.webrtc(gt+": REMOTE Answer is received",{answer:n}),i.setRemoteDescription({type:"answer",sdp:n}).then(function(){s.subscribe(function(e){return i.addIceCandidate(e).catch(function(e){return w.webrtc("${id}: Failed to add REMOTE Ice Candidate",e)})})}).catch(function(e){w.webrtc(gt+": Failed to establish RTCDataChannel: Set REMOTE Answer ERROR",e),s.complete(),i.close(),t({isError:!0}),u.unsubscribe(),a(new Error(gt+": Error during setting a remote answer"))})):o?""!==o.candidate?(w.webrtc(gt+": REMOTE Ice Candidate is received",o),s.next(new global.RTCIceCandidate(o))):(w.webrtc(gt+": REMOTE Ice Candidate gathering COMPLETED",o.candidate),s.complete()):c?(w.webrtc(gt+": REMOTE Peer FINISHED send all data"),u.unsubscribe()):(w.webrtc(gt+": Unknown message from a remote peer: stopping connection establishment"),s.complete(),i.close(),t({isError:!0}),u.unsubscribe(),a(new Error(gt+": Unknown message from a remote peer")))},function(e){w.webrtc(gt+": Intermidiary steram was interrupted",e),s.complete(),"connected"!==i.iceConnectionState&&"completed"!==i.iceConnectionState?(w.webrtc(gt+": Failed to establish RTCDataChannel: Intermidiary steram was interrupted"),i.close(),a(e)):w.webrtc(gt+": Intermidiary steram was interrupted, but RTCDataChannel has still been established")},function(){if(s.complete(),"connected"!==i.iceConnectionState&&"completed"!==i.iceConnectionState){var e=new Error("Intermidiary steram was closed");w.webrtc(gt+": Failed to establish RTCDataChannel",e),i.close(),a(e)}else w.webrtc(gt+": Connection with Signaling closed, but RTCDataChannel has still been established")});o.openChannel(i,n).then(c).catch(function(e){s.complete(),i.close(),t({isError:!0}),u.unsubscribe(),a(e)}),i.createOffer().then(function(e){return i.setLocalDescription(e)}).then(function(){i.localDescription&&i.localDescription.sdp&&(t({offer:i.localDescription.sdp}),r=!0,"complete"===i.iceGatheringState&&t({isEnd:!0}))}).catch(function(e){s.complete(),i.close(),t({isError:!0}),u.unsubscribe(),w.webrtc(gt+": Failed to establish RTCDataChannel: Error while setting LOCAL Offer",e),a(e)})})},t.prototype.onChannel=function(e,t){var n=this,o=new Map,r=[];return lt.Observable.create(function(i){e.pipe(Object(M.filter)(function(e){var t=e.id;return!r.includes(t)})).subscribe(function(e){var s,c,a,u,l,f=e.offer,p=e.iceCandidate,h=e.id,d=e.isError,g=e.isEnd,b=function(e,n,i){n.oniceconnectionstatechange=function(){},i.complete(),t({isError:!0},e),o.delete(h),r[r.length]=e};d?(w.webrtc(h+": Failed to establish RTCDataChannel: remote peer error"),(u=o.get(h))&&(u[1].complete(),o.delete(h)),r[r.length]=h):((u=o.get(h))?(l=ht(u,3),s=l[0],c=l[1],a=l[2]):(a=!1,(s=new global.RTCPeerConnection(n.rtcConfiguration)).oniceconnectionstatechange=function(){w.webrtc(h+": ICE CONNECTION STATE changed to",s.iceConnectionState),"failed"===s.iceConnectionState&&b(h,s,c)},s.onicegatheringstatechange=function(){w.webrtc(h+": ICE GATHERING STATE changed to",s.iceGatheringState),"complete"===s.iceGatheringState&&a&&(t({isEnd:!0},h),s.onicegatheringstatechange=function(){})},s.onsignalingstatechange=function(){w.webrtc(h+": SIGNALING STATE changed to",s.signalingState)},c=new ft.ReplaySubject,n.setupLocalCandidates(s,function(e){return t({iceCandidate:e},h)}),n.openChannel(s).then(function(e){s.oniceconnectionstatechange=function(){},i.next(e)}).catch(function(){return b(h,s,c)}),o.set(h,[s,c,a])),f?(w.webrtc(h+": REMOTE OFFER is received",{offer:f}),s.setRemoteDescription({type:"offer",sdp:f}).then(function(){return c.subscribe(function(e){return s.addIceCandidate(e).catch(function(e){return w.webrtc(h+": Failed to addIceCandidate",e)})})}).then(function(){return s.createAnswer()}).then(function(e){return s.setLocalDescription(e)}).then(function(){s.localDescription&&s.localDescription.sdp&&(w.webrtc(h+": Send LOCAL ANSWER",{answer:s.localDescription.sdp}),t({answer:s.localDescription.sdp},h),a=!0,"complete"===s.iceGatheringState&&(t({isEnd:!0},h),s.onicegatheringstatechange=function(){}))}).catch(function(e){w.webrtc(h+": Error during offer/answer setting",e),b(h,s,c)})):p?""!==p.candidate?(w.webrtc(h+": REMOTE Ice Candidate is received",p),c.next(new global.RTCIceCandidate(p))):(w.webrtc(h+": REMOTE Ice Candidate gathering COMPLETED",p.candidate),c.complete()):g?(w.webrtc(h+": REMOTE Peer FINISHED send all data"),o.delete(h)):(w.webrtc(h+": Unknown message from a remote peer: stopping connection establishment",e),b(h,s,c)))},function(e){w.webrtc("Intermidiary steram was interrupted",e);try{for(var t=dt(o),n=t.next();!n.done;n=t.next()){var r=ht(n.value,2),s=r[0],c=ht(r[1],2),a=c[0];c[1].complete(),"connected"!==a.iceConnectionState&&"completed"!==a.iceConnectionState?(w.webrtc(s+": Failed to establish RTCDataChannel"),a.close()):w.webrtc(s+": RTCDataChannel with "+s+" has still been established")}}catch(e){u={error:e}}finally{try{n&&!n.done&&(l=t.return)&&l.call(t)}finally{if(u)throw u.error}}var u,l;i.error(e)},function(){w.webrtc("${id}: Intermidiary stream has closed");try{for(var e=dt(o),t=e.next();!t.done;t=e.next()){var n=ht(t.value,2),r=n[0],s=ht(n[1],2),c=s[0];s[1].complete(),"connected"!==c.iceConnectionState&&"completed"!==c.iceConnectionState?(w.webrtc(r+": Failed to establish RTCDataChannel: Intermidiary stream has closed"),c.close()):w.webrtc(r+": RTCDataChannel has still been established")}}catch(e){a={error:e}}finally{try{t&&!t.done&&(u=e.return)&&u.call(e)}finally{if(a)throw a.error}}var a,u;i.complete()})})},t.prototype.setupLocalCandidates=function(e,t){e.onicecandidate=function(e){null!==e.candidate&&(w.webrtc("LOCAL Ice Candidate gathered",e.candidate.candidate),t({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex}))}},t.prototype.openChannel=function(e,t){var n,o=this;if(t){try{n=e.createDataChannel(this.wc.myId.toString())}catch(e){return w.webrtc("Failed to create RTCDataChannel",e),Promise.reject(e)}return new Promise(function(r,i){var s=setTimeout(function(){if("open"!==n.readyState){n.close();var e="RTCDataChannel 20000ms connection timeout with '"+t+"'";w.webrtc(e),i(new Error(e))}},2e4);n.onopen=function(){clearTimeout(s),w.webrtc("RTCDataChannel with "+t+" has opened",e.sctp),r(new tt(o.wc,n,{rtcPeerConnection:e,id:t}))}})}return new Promise(function(t,r){var i=setTimeout(function(){if(void 0===n||"open"!==n.readyState){void 0!==n&&n.close();var e="RTCDataChannel 20000ms connection timeout with joining peer";w.webrtc(e),r(new Error(e))}},2e4);e.ondatachannel=function(r){n=r.channel;var s=Number.parseInt(n.label,10);n.onopen=function(){clearTimeout(i),w.webrtc("RTCDataChannel with "+s+" has opened",e.sctp),t(new tt(o.wc,n,{rtcPeerConnection:e,id:s}))}}})},t}(ut),vt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),mt=function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})},St=function(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=o[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},wt=100,Ot={wsUrl:"",isWrtcSupport:!1},It=Math.max(2e4,6e3)+3e3,jt=700,Mt=ut.encodeServiceMessage(wt,Je.Message.encode(Je.Message.create({ping:!0})).finish()),kt=ut.encodeServiceMessage(wt,Je.Message.encode(Je.Message.create({pong:!0})).finish()),Tt=function(e){function t(t){var n=e.call(this,wt,Je.Message,t.serviceMessageSubject)||this;return n.wc=t,n.connectionRequests=new Map,n.pingPongRequests=new Map,n.channelsSubject=new k.Subject,n.pingPongTimeout=jt,n.pingPongDates=new Map,Ot.isWrtcSupport=yt.isSupported,Ot.isWrtcSupport&&t.webRTCBuilder.onChannelFromWebChannel().subscribe(function(e){return n.handleChannel(e)}),at.listen().subscribe(function(o){Ot.wsUrl=o,o&&t.webSocketBuilder.onChannel.subscribe(function(e){return n.handleChannel(e)});var r={wsUrl:o,isWrtcSupport:Ot.isWrtcSupport};Ye=e.prototype.encode.call(n,{request:r}),Ke=e.prototype.encode.call(n,{response:r})}),n.onServiceMessage.subscribe(function(e){return n.treatServiceMessage(e)}),n}return vt(t,e),Object.defineProperty(t.prototype,"onChannel",{get:function(){return this.channelsSubject.asObservable()},enumerable:!0,configurable:!0}),t.prototype.connectTo=function(e){return mt(this,void 0,void 0,function(){var t=this;return St(this,function(n){switch(n.label){case 0:return[4,this.isResponding(e)];case 1:return n.sent(),[4,new Promise(function(n,o){var r=setTimeout(function(){t.connectionRequests.delete(e),o(new Error("ChannelBuilder timeout"))},It);t.connectionRequests.set(e,{resolve:function(o){t.connectionRequests.delete(e),clearTimeout(r),n(o)},reject:function(n){t.connectionRequests.delete(e),o(n)}}),t.wc.sendToProxy({recipientId:e,content:Ye})})];case 2:return[2,n.sent()]}})})},t.prototype.isResponding=function(e){var t=this,n=this.pingPongRequests.get(e);if(n)return n.promise;this.wc.sendToProxy({recipientId:e,content:Mt});var o=new Promise(function(n,r){var i=setTimeout(function(){t.pingPongRequests.delete(e),r(new Error("pingpong"))},t.pingPongTimeout);t.pingPongRequests.set(e,{promise:o,resolve:function(){t.pingPongRequests.delete(e),clearTimeout(i),n()}}),t.pingPongDates.set(e,global.Date.now())});return o},t.prototype.handleChannel=function(e){var t=this.connectionRequests.get(e.id);t?t.resolve(e):this.channelsSubject.next(e)},t.prototype.treatServiceMessage=function(t){var n=this,o=t.senderId,r=t.msg;switch(r.type){case"ping":this.wc.sendToProxy({recipientId:o,content:kt});break;case"pong":var i=this.pingPongRequests.get(o),s=global.Date.now(),c=this.pingPongDates.get(o);i?(w.channelBuilder("Ping/Pong latency is: "+(s-c)),i.resolve()):(w.channelBuilder("INCREASING Ping/Pong timeout, as current latency is: "+(s-c)+" new value: ",s-c+500),this.pingPongTimeout=global.Math.min(s-c+500,3e3));break;case"failed":console.warn("treatServiceMessage ERROR: ",r.failed);var a=this.connectionRequests.get(o);void 0!==a&&a.reject(new Error(r.failed));break;case"request":var u=r.request,l=u.wsUrl,f=u.isWrtcSupport;l?this.wc.webSocketBuilder.connect(l,o).then(function(e){return n.handleChannel(e)}).catch(function(t){Ot.wsUrl?n.wc.sendToProxy({recipientId:o,content:Ke}):n.wc.sendToProxy({recipientId:o,content:e.prototype.encode.call(n,{failed:"Failed to establish a socket: "+t})})}):f?Ot.wsUrl?this.wc.sendToProxy({recipientId:o,content:Ke}):Ot.isWrtcSupport?this.wc.webRTCBuilder.connectOverWebChannel(o).then(function(e){return n.handleChannel(e)}).catch(function(t){n.wc.sendToProxy({recipientId:o,content:e.prototype.encode.call(n,{failed:"Failed establish a data channel: "+t.message})})}):this.wc.sendToProxy({recipientId:o,content:e.prototype.encode.call(this,{failed:"No common connectors"})}):l||f||(Ot.wsUrl?this.wc.sendToProxy({recipientId:o,content:Ke}):this.wc.sendToProxy({recipientId:o,content:e.prototype.encode.call(this,{failed:"No common connectors"})}));break;case"response":(l=r.response.wsUrl)&&this.wc.webSocketBuilder.connect(l,o).then(function(e){return n.handleChannel(e)}).catch(function(e){var t=n.connectionRequests.get(o);t&&t.reject(new Error("Failed to establish a socket: "+e.message))})}},t}(ut),Et=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ct=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},Pt=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s},Lt=3,Bt=function(e){function t(t){var n=e.call(this,Lt,ze.Message,t.serviceMessageSubject)||this;return n.wc=t,n.adjacentMembers=new Map,n.distantMembers=new Map,n.connectingMembers=new Set,n.stateSubject=new k.Subject,n.heartbeat=ut.encodeServiceMessage(Lt,ze.Message.encode(ze.Message.create({heartbeat:!0})).finish()),n._state=I.DISCONNECTED,n.onServiceMessage.subscribe(function(e){return n.handleSvcMsg(e)}),n.wc.channelBuilder.onChannel.subscribe(function(e){return n.addAdjacentMember(e)}),global.fullmesh=function(){w.topology("Fullmesh info:",{myId:n.wc.myId,signalingState:Ee[n.wc.signaling.state],webGroupState:Ze[n.wc.state],topologyState:I[n._state],adjacentMembers:Array.from(n.adjacentMembers.keys()).toString(),distantMembers:Array.from(n.distantMembers.keys()).toString(),connectingMembers:Array.from(n.connectingMembers.values()).toString(),distantMembersDETAILS:Array.from(n.distantMembers.keys()).map(function(e){var t=n.distantMembers.get(e);return{id:e,adjacentMembers:t?t.adjacentIds:[]}})})},n}return Et(t,e),Object.defineProperty(t.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),t.prototype.setStable=function(){this.setState(I.STABLE)},t.prototype.addJoining=function(e){this.addAdjacentMember(e)},t.prototype.initJoining=function(e,t){var n=this;this.setState(I.JOINING),this.addAdjacentMember(e),1===t.length?this.setState(I.STABLE):this.connectToMany(t,e.id).then(function(){n.membersRequest(),n.setState(I.JOINED),n.setState(I.STABLE)})},t.prototype.send=function(e){var t=this;this.adjacentMembers.forEach(function(n){return n.send(t.wc.encode(e))}),this.distantMembers.forEach(function(n,o){t.sendToDistantPeer(n,{recipientId:o,isService:e.isService,content:e.content})})},t.prototype.sendTo=function(e){var t=this.adjacentMembers.get(e.recipientId);t?t.send(this.wc.encode(e)):this.sendToDistantPeer(this.distantMembers.get(e.recipientId),e)},t.prototype.forward=function(e){e.recipientId>1&&this.sendTo(e)},t.prototype.leave=function(){var e=this;this._state!==I.DISCONNECTED&&(0===this.adjacentMembers.size?(this.clean(),this.setState(I.DISCONNECTED)):this.adjacentMembers.forEach(function(t){return e.deleteAdjacentMember(t)}))},t.prototype.onChannelClose=function(e,t){this.deleteAdjacentMember(t,!1)},t.prototype.onChannelError=function(e){w.topology("Channel error: "+e.type)},t.prototype.clean=function(){var e=this;this.distantMembers.forEach(function(t,n){return e.wc.onMemberLeaveProxy(n)}),this.distantMembers.clear(),this.connectingMembers.clear(),w.topology("CLEAR HEARTBEAT Interval................................."),clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0,clearInterval(this.membersRequestInterval),this.membersRequestInterval=void 0},t.prototype.handleSvcMsg=function(t){var n=t.channel,o=t.senderId,r=t.msg;switch(r.type){case"membersResponse":this.connectToMany(r.membersResponse.ids,o);break;case"membersRequest":n.send(this.wc.encode({recipientId:n.id,content:e.prototype.encode.call(this,{membersResponse:{ids:this.wc.members}})}));break;case"adjacentMembers":if(!this.adjacentMembers.has(o)&&o!==this.wc.myId)if(s=this.distantMembers.get(o))s.adjacentIds=r.adjacentMembers.ids;else{this.distantMembers.set(o,{adjacentIds:r.adjacentMembers.ids,missedHeartbeat:0});var i=e.prototype.encode.call(this,{adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}});this.wc.sendToProxy({recipientId:o,content:i}),this.connectTo(o)}break;case"heartbeat":var s;(s=this.distantMembers.get(o))?s.missedHeartbeat=0:n.id===o&&(n.missedHeartbeat=0)}},t.prototype.addAdjacentMember=function(e){if(this._state===I.DISCONNECTED)w.topology("Closing channel quietly as the topology state is: ",I[this._state]),e.closeQuietly();else{w.topology("Adding new adjacent member: ",e.id),this.distantMembers.delete(e.id);var t=this.adjacentMembers.get(e.id);t&&(w.topology("Replacing the same channel"),t.closeQuietly()),this.adjacentMembers.set(e.id,e),this.notifyDistantPeers(),this.wc.onMemberJoinProxy(e.id),1===this.adjacentMembers.size&&void 0===this.membersRequestInterval&&this.startIntervals()}},t.prototype.deleteAdjacentMember=function(e,t){void 0===t&&(t=!0),w.topology("Removing adjacent member: ",e.id),this.adjacentMembers.delete(e.id),this.wc.onMemberLeaveProxy(e.id),0===this.adjacentMembers.size?(this.clean(),this.setState(I.DISCONNECTED)):this.notifyDistantPeers(),t&&e.closeQuietly()},t.prototype.connectToMany=function(t,n){var o=this;if(this._state!==I.DISCONNECTED){var r=t.filter(function(e){return!o.adjacentMembers.has(e)&&!o.connectingMembers.has(e)&&e!==o.wc.myId});if(0!==r.length){var i=e.prototype.encode.call(this,{adjacentMembers:{ids:Array.from(this.adjacentMembers.keys())}}),s=[];return r.forEach(function(e){o.distantMembers.has(e)||o.distantMembers.set(e,{adjacentIds:[n],missedHeartbeat:0}),o.wc.sendToProxy({recipientId:e,content:i}),s[s.length]=o.connectTo(e)}),Promise.all(s)}}return Promise.resolve()},t.prototype.connectTo=function(e){var t=this;return this.connectingMembers.add(e),(e<this.wc.myId?this.wc.channelBuilder.connectTo(e).then(function(e){return t.addAdjacentMember(e)}).catch(function(n){if("pingpong"!==n.message)return t.wc.channelBuilder.isResponding(e).then(function(){return t.wc.onMemberJoinProxy(e)});w.topology(t.wc.myId+" failed to connect to "+e+": "+n.message)}).catch(function(){}):this.wc.channelBuilder.isResponding(e).then(function(){return t.wc.onMemberJoinProxy(e)}).catch(function(){})).then(function(){t.connectingMembers.delete(e)})},t.prototype.membersRequest=function(){if(0!==this.adjacentMembers.size){for(var t=Math.floor(Math.random()*this.adjacentMembers.size),n=this.adjacentMembers.values(),o=0;o<t;o++)n.next();var r=n.next().value;r.send(this.wc.encode({recipientId:r.id,content:e.prototype.encode.call(this,{membersRequest:!0})}))}},t.prototype.sendToDistantPeer=function(e,t){for(var n=1;n<=3;n++){var o=this.findRoutedChannel(e,n);if(o)return void o.send(this.wc.encode(t))}},t.prototype.findRoutedChannel=function(e,t){if(e){try{for(var n=Ct(this.adjacentMembers),o=n.next();!o.done;o=n.next()){var r=Pt(o.value,2),i=r[0],s=r[1];if(e.adjacentIds.includes(i))return s}}catch(e){l={error:e}}finally{try{o&&!o.done&&(f=n.return)&&f.call(n)}finally{if(l)throw l.error}}if(0!==t)try{for(var c=Ct(e.adjacentIds),a=c.next();!a.done;a=c.next()){var u=a.value;if(s=this.findRoutedChannel(this.distantMembers.get(u),t-1))return s}}catch(e){p={error:e}}finally{try{a&&!a.done&&(h=c.return)&&h.call(c)}finally{if(p)throw p.error}}}var l,f,p,h},t.prototype.notifyDistantPeers=function(){var t=this;this._state!==I.DISCONNECTED&&this.distantMembers.forEach(function(n,o){return t.wc.sendToProxy({recipientId:o,content:e.prototype.encode.call(t,{adjacentMembers:{ids:Array.from(t.adjacentMembers.keys())}})})})},t.prototype.setState=function(e){this._state!==e&&(this._state=e,this.stateSubject.next(e))},t.prototype.startIntervals=function(){var e=this;this.membersRequestInterval=global.setInterval(function(){return e.membersRequest()},6e3),this.heartbeatInterval=global.setInterval(function(){e.adjacentMembers.forEach(function(t){try{if(t.missedHeartbeat++,t.missedHeartbeat>=t.maximumMissedHeartBeat)throw new Error("Too many missed heartbeats");t.sendHeartbeat()}catch(n){w.topology("Closing connection with "+t.id+". Reason: "+n.message),e.deleteAdjacentMember(t)}}),e.distantMembers.forEach(function(t,n){try{if(t.missedHeartbeat++,t.missedHeartbeat>=5)throw new Error("Too many missed heartbeats");e.wc.sendToProxy({recipientId:n,content:e.heartbeat})}catch(t){w.topology("Distant peer "+n+" has left. Reason: "+t.message),e.distantMembers.delete(n),e.wc.onMemberLeaveProxy(n)}})},3e3)},t}(ut),Rt=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Nt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},xt=200,Dt={topology:O.FULL_MESH,signalingServer:"wss://signaling.netflux.coedit.re",rtcConfiguration:{iceServers:[{urls:"stun:stun3.l.google.com:19302"}]},autoRejoin:!0};!function(e){e[e.JOINING=0]="JOINING",e[e.JOINED=1]="JOINED",e[e.LEAVING=2]="LEAVING",e[e.LEFT=3]="LEFT"}(Ze||(Ze={}));var At=function(e){function t(t){var n=void 0===t?{}:t,o=n.topology,r=void 0===o?Dt.topology:o,s=n.signalingServer,a=void 0===s?Dt.signalingServer:s,u=n.rtcConfiguration,l=void 0===u?Dt.rtcConfiguration:u,f=n.autoRejoin,p=void 0===f?Dt.autoRejoin:f,h=e.call(this,xt,He.Message)||this;return h.topology=r,h.id=h.generateId(),h.myId=h.generateId(),h.members=[h.myId],h.key="",h.autoRejoin=p,h.onMemberJoin=function(){},h.onMemberLeave=function(){},h.onMessage=function(){},h.onStateChange=function(){},h.onSignalingStateChange=function(){},h.state=Ze.LEFT,h.userMsg=new it,h.signaling=new et(h,a),h.signaling.onChannel.subscribe(function(e){return h.initChannel(e)}),h.signaling.onState.subscribe(function(e){switch(w.signalingState(Ee[e],h.myId),h.onSignalingStateChange(e),e){case Ee.CONNECTING:h.setState(Ze.JOINING);break;case Ee.CLOSED:h.topologyService.state===I.DISCONNECTED&&h.setState(Ze.LEFT),h.rejoin(3e3);break;case Ee.STABLE:h.topologyService.setStable()}}),h.serviceMessageSubject=new k.Subject,e.prototype.setupServiceMessage.call(h,h.serviceMessageSubject),h.webRTCBuilder=new yt(h,l),h.webSocketBuilder=new at(h),h.channelBuilder=new Tt(h),h.onServiceMessage.subscribe(function(e){return h.treatServiceMessage(e)},function(e){return console.error("service/WebChannel inner message error",e)}),h.setTopology(r),i&&(global.window.addEventListener("online",function(){c()&&h.state===Gt.LEFT&&h.rejoin()}),global.window.addEventListener("visibilitychange",function(){c()&&h.state===Gt.LEFT&&h.rejoin()}),global.window.addEventListener("beforeunload",function(){return h.internalLeave()})),h}return Rt(t,e),t.prototype.join=function(e){if(void 0===e&&(e=function(){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t=u(42),n="",o=0;o<42;o++)n+=e[t[o]%e.length];return n}()),"string"!=typeof e)throw new Error('Failed to join: the key type "'+typeof e+'" is not a "string"');if(""===e)throw new Error("Failed to join: the key is an empty string");if(e.length>512)throw new Error("Failed to join : the key length of "+e.length+" exceeds the maximum of 512 characters");this.key=e,s()&&this.state===Ze.LEFT&&this.signaling.state===Ee.CLOSED&&(this.setState(Ze.JOINING),this.isRejoinDisabled=!this.autoRejoin,this.signaling.join(this.key))},t.prototype.invite=function(e){var t=this;if(!a(e))throw new Error("Failed to invite a bot: "+e+" is not a valid URL");this.webSocketBuilder.connect(e+"/invite?wcId="+this.id+"&senderId="+this.myId).then(function(e){return t.initChannel(new tt(t,e))}).catch(function(t){return console.error("Failed to invite the bot "+e+": "+t.message)})},t.prototype.leave=function(){this.state!==Ze.LEAVING&&this.state!==Ze.LEFT&&(this.setState(Ze.LEAVING),this.key="",this.isRejoinDisabled=!0,this.signaling.close(),this.topologyService.leave())},t.prototype.send=function(e){if(1!==this.members.length){var t={senderId:this.myId,recipientId:0,isService:!1},n=this.userMsg.encode(e);try{for(var o=Nt(n),r=o.next();!r.done;r=o.next()){var i=r.value;t.content=i,this.topologyService.send(t)}}catch(e){s={error:e}}finally{try{r&&!r.done&&(c=o.return)&&c.call(o)}finally{if(s)throw s.error}}}var s,c},t.prototype.sendTo=function(e,t){if(1!==this.members.length){var n={senderId:this.myId,recipientId:e,isService:!1},o=this.userMsg.encode(t);try{for(var r=Nt(o),i=r.next();!i.done;i=r.next()){var s=i.value;n.content=s,this.topologyService.sendTo(n)}}catch(e){c={error:e}}finally{try{i&&!i.done&&(a=r.return)&&a.call(r)}finally{if(c)throw c.error}}}var c,a},t.prototype.onMemberJoinProxy=function(e){this.members.includes(e)||(this.members[this.members.length]=e,this.onMemberJoin(e))},t.prototype.onMemberLeaveProxy=function(e){this.members.includes(e)&&(this.members.splice(this.members.indexOf(e),1),this.onMemberLeave(e))},t.prototype.sendToProxy=function(e){var t=void 0===e?{}:e,n=t.senderId,o=void 0===n?this.myId:n,r=t.recipientId,i=void 0===r?this.myId:r,s=t.isService,c=void 0===s||s,a=t.content;this.topologyService.sendTo({senderId:o,recipientId:i,isService:c,content:a})},t.prototype.sendProxy=function(e){var t=void 0===e?{}:e,n=t.senderId,o=void 0===n?this.myId:n,r=t.recipientId,i=void 0===r?0:r,s=t.isService,c=void 0===s||s,a=t.content;this.topologyService.send({senderId:o,recipientId:i,isService:c,content:a})},t.prototype.encode=function(e){var t=void 0===e?{}:e,n=t.senderId,o=void 0===n?this.myId:n,r=t.recipientId,i=void 0===r?0:r,s=t.isService,c={senderId:o,recipientId:i,isService:void 0===s||s,content:t.content};return qe.encode(qe.create(c)).finish()},t.prototype.onMessageProxy=function(e,t){var n=qe.decode(new Uint8Array(t));0!==n.recipientId&&n.recipientId!==this.myId&&1!==n.recipientId||this.treatMessage(e,n),n.recipientId!==this.myId&&this.topologyService.forward(n)},t.prototype.treatMessage=function(e,t){if(t.isService){var n=We.Message.decode(t.content);n.channel=e,n.senderId=t.senderId,n.recipientId=t.recipientId,this.serviceMessageSubject.next(n)}else{var o=this.userMsg.decode(t.content,t.senderId);void 0!==o&&this.onMessage(t.senderId,o)}},t.prototype.treatServiceMessage=function(t){var n=t.channel,o=t.senderId,r=t.msg;switch(r.type){case"init":var i=r.init,s=i.topology,c=i.wcId,a=i.generatedIds,u=i.members;if(this.members.includes(o)){if(!a.includes(this.myId))return this.setState(Ze.LEAVING),console.warn("Failed merge networks: my members contain intermediary peer id,\n            but my id is not included into the intermediary peer members"),n.closeQuietly(),void this.topologyService.leave();if(this.topology!==s)return this.setState(Ze.LEAVING),console.warn("Failed merge networks: different topologies"),n.closeQuietly(),void this.topologyService.leave();w.webgroup("I:"+this.myId+" close connection with intermediary member "+o+",\n          because already connected with him"),this.setState(Ze.JOINED),n.closeQuietly()}else this.setTopology(s),this.id=c,n.id=o,n.send(this.encode({recipientId:n.id,content:e.prototype.encode.call(this,{initOk:!0})})),this.topologyService.initJoining(n,u);break;case"initOk":n.id=o,this.topologyService.addJoining(n);break;default:throw new Error('Unknown message type: "'+r.type+'"')}},t.prototype.setState=function(e){this.state!==e&&(w.webGroupState(Ze[e],this.myId),this.state=e,this.onStateChange(e))},t.prototype.initChannel=function(t){var n=this.encode({recipientId:1,content:e.prototype.encode.call(this,{init:{topology:this.topology,wcId:this.id,generatedIds:this.members,members:this.members}})});t.send(n)},t.prototype.setTopology=function(e){void 0!==this.topologyService?this.topology!==e&&(this.topology=e,this.topologyService.leave(),this.topologyService=new Bt(this),this.subscribeToTopology()):(this.topology=e,this.topologyService=new Bt(this),this.subscribeToTopology())},t.prototype.subscribeToTopology=function(){var e=this;this.topologySub&&this.topologySub.unsubscribe(),this.topologySub=this.topologyService.onState.subscribe(function(t){switch(t){case I.JOINING:e.setState(Ze.JOINING);break;case I.JOINED:e.setState(Ze.JOINED);break;case I.STABLE:e.setState(Ze.JOINED),e.signaling.open();break;case I.DISCONNECTED:e.signaling.state===Ee.CLOSED&&e.setState(Ze.LEFT),e.rejoin(2e3)}})},t.prototype.rejoin=function(e){var t=this;void 0===e&&(e=0),this.isRejoinDisabled||(this.isRejoinDisabled=!this.autoRejoin,global.clearTimeout(this.rejoinTimer),this.rejoinTimer=setTimeout(function(){s()&&c()&&(w.webgroup("REJOIN..."),t.signaling.join(t.key))},e))},t.prototype.generateId=function(e){void 0===e&&(e=[]);var t=u()[0];return e.includes(t)?this.generateId():t},t.prototype.internalLeave=function(){this.state!==Ze.LEAVING&&this.state!==Ze.LEFT&&(this.signaling.close(),this.topologyService.leave(),this.setState(Ze.LEFT))},t}(ut),_t=new WeakMap,Gt=function(){function e(){}return Object.defineProperty(e,"JOINING",{get:function(){return Ze.JOINING},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.JOINING,{get:function(){return Ze[Ze.JOINING]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"JOINED",{get:function(){return Ze.JOINED},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.JOINED,{get:function(){return Ze[Ze.JOINED]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"LEAVING",{get:function(){return Ze.LEAVING},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.LEAVING,{get:function(){return Ze[Ze.LEAVING]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"LEFT",{get:function(){return Ze.LEFT},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.LEFT,{get:function(){return Ze[Ze.LEFT]},enumerable:!0,configurable:!0}),e}(),Ut=function(){function e(e){void 0===e&&(e={});var t=new At(e);_t.set(this,t),this.id=void 0,Reflect.defineProperty(this,"id",{configurable:!1,enumerable:!0,get:function(){return t.id}}),this.myId=void 0,Reflect.defineProperty(this,"myId",{configurable:!1,enumerable:!0,get:function(){return t.myId}}),this.key=void 0,Reflect.defineProperty(this,"key",{configurable:!1,enumerable:!0,get:function(){return t.key}}),this.members=void 0,Reflect.defineProperty(this,"members",{configurable:!1,enumerable:!0,get:function(){return t.members}}),this.topology=void 0,Reflect.defineProperty(this,"topology",{configurable:!1,enumerable:!0,get:function(){return t.topology}}),this.state=void 0,Reflect.defineProperty(this,"state",{configurable:!1,enumerable:!0,get:function(){return t.state}}),this.signalingState=void 0,Reflect.defineProperty(this,"signalingState",{configurable:!1,enumerable:!0,get:function(){return t.signaling.state}}),this.signalingServer=void 0,Reflect.defineProperty(this,"signalingServer",{configurable:!1,enumerable:!0,get:function(){return t.signaling.url}}),this.autoRejoin=void 0,Reflect.defineProperty(this,"autoRejoin",{configurable:!1,enumerable:!0,get:function(){return t.autoRejoin},set:function(e){return t.autoRejoin=e}}),this.onMessage=void 0,Reflect.defineProperty(this,"onMessage",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMessage.name?void 0:t.onMessage},set:function(e){t.onMessage="function"!=typeof e?function(){}:e}}),this.onMemberJoin=void 0,Reflect.defineProperty(this,"onMemberJoin",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMemberJoin.name?void 0:t.onMemberJoin},set:function(e){t.onMemberJoin="function"!=typeof e?function(){}:e}}),this.onMemberLeave=void 0,Reflect.defineProperty(this,"onMemberLeave",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onMemberLeave.name?void 0:t.onMemberLeave},set:function(e){t.onMemberLeave="function"!=typeof e?function(){}:e}}),this.onStateChange=void 0,Reflect.defineProperty(this,"onStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onStateChange.name?void 0:t.onStateChange},set:function(e){t.onStateChange="function"!=typeof e?function(){}:e}}),this.onSignalingStateChange=void 0,Reflect.defineProperty(this,"onSignalingStateChange",{configurable:!0,enumerable:!0,get:function(){return"none"===t.onSignalingStateChange.name?void 0:t.onSignalingStateChange},set:function(e){t.onSignalingStateChange="function"!=typeof e?function(){}:e}})}return e.prototype.join=function(e){var t=_t.get(this);if(t)return t.join(e);throw new Error("WebChannel is undefined")},e.prototype.invite=function(e){var t=_t.get(this);if(t)return t.invite(e);throw new Error("WebChannel is undefined")},e.prototype.leave=function(){var e=_t.get(this);if(e)return e.leave();throw new Error("WebChannel is undefined")},e.prototype.send=function(e){var t=_t.get(this);if(t)return t.send(e);throw new Error("WebChannel is undefined")},e.prototype.sendTo=function(e,t){var n=_t.get(this);if(n)return n.sendTo(e,t);throw new Error("WebChannel is undefined")},e}();function qt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];!function(e){(j=e).includes(l.WEB_GROUP)?(w.webgroup=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WebGroup%c: "+e,p,""):console.info.apply(console,r(["%cNETFLUX WebGroup%c: "+e,p,""],t))},w.signalingState=function(e,t){console.info("%cNETFLUX "+t+" WebGroup%c: Signaling: %c"+e+"%c",p,"",m,"")},w.webGroupState=function(e,t){console.info("%cNETFLUX "+t+" WebGroup%c: WebGroup: %c"+e+"%c",p,"",S,"")}):(w.webgroup=function(){},w.signalingState=function(){},w.webGroupState=function(){}),j.includes(l.WEBRTC)?w.webrtc=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX WebRTC%c: "+e,d,""):console.info.apply(console,r(["%cNETFLUX WebRTC%c: "+e,d,""],t))}:w.webrtc=function(){},j.includes(l.CHANNEL)?w.channel=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Channel%c: "+e,g,""):console.info.apply(console,r(["%cNETFLUX Channel%c: "+e,g,""],t))}:w.channel=function(){},j.includes(l.TOPOLOGY)?w.topology=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Topology%c: "+e,b,""):console.info.apply(console,r(["%cNETFLUX Topology%c: "+e,b,""],t))}:w.topology=function(){},j.includes(l.SIGNALING)?w.signaling=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Signaling%c: "+e,y,""):console.info.apply(console,r(["%cNETFLUX Signaling%c: "+e,y,""],t))}:w.signaling=function(){},j.includes(l.CHANNEL_BUILDER)?w.channelBuilder=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX ChannelBuilder%c: "+e,v,""):console.info.apply(console,r(["%cNETFLUX ChannelBuilder%c: "+e,v,""],t))}:w.channelBuilder=function(){},j.includes(l.DEBUG)?w.debug=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];0===t.length?console.info("%cNETFLUX Debug%c: "+e,h,""):console.info.apply(console,r(["%cNETFLUX Debug%c: "+e,h,""],t))}:w.debug=function(){}}(e)}var Ft,Wt=function(){function e(){}return Object.defineProperty(e,"CONNECTING",{get:function(){return Ee.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.CONNECTING,{get:function(){return Ee[Ee.CONNECTING]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CONNECTED",{get:function(){return Ee.CONNECTED},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.CONNECTED,{get:function(){return Ee[Ee.CONNECTED]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"STABLE",{get:function(){return Ee.STABLE},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.STABLE,{get:function(){return Ee[Ee.STABLE]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return Ee.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.CLOSING,{get:function(){return Ee[Ee.CLOSING]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return Ee.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.CLOSED,{get:function(){return Ee[Ee.CLOSED]},enumerable:!0,configurable:!0}),e}(),Ht=function(){function e(){}return Object.defineProperty(e,"FULL_MESH",{get:function(){return O.FULL_MESH},enumerable:!0,configurable:!0}),Object.defineProperty(e,e.FULL_MESH,{get:function(){return O[O.FULL_MESH]},enumerable:!0,configurable:!0}),e}(),Jt=function(){function e(){}return Object.defineProperty(e,"DEBUG",{get:function(){return l.DEBUG},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.DEBUG,{get:function(){return l[l.DEBUG]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WEB_GROUP",{get:function(){return l.WEB_GROUP},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.WEB_GROUP,{get:function(){return l[l.WEB_GROUP]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WEBRTC",{get:function(){return l.WEBRTC},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.WEBRTC,{get:function(){return l[l.WEBRTC]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHANNEL",{get:function(){return l.CHANNEL},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.CHANNEL,{get:function(){return l[l.CHANNEL]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"TOPOLOGY",{get:function(){return l.TOPOLOGY},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.TOPOLOGY,{get:function(){return l[l.TOPOLOGY]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"SIGNALING",{get:function(){return l.SIGNALING},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.SIGNALING,{get:function(){return l[l.SIGNALING]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CHANNEL_BUILDER",{get:function(){return l.CHANNEL_BUILDER},enumerable:!0,configurable:!0}),Object.defineProperty(e,l.CHANNEL_BUILDER,{get:function(){return l[l.CHANNEL_BUILDER]},enumerable:!0,configurable:!0}),e}(),zt=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},Qt=n(36),$t=n(17),Xt=function(){function e(e){var t=e.url,n=void 0===t?"":t,o=e.perMessageDeflate,r=void 0!==o&&o,i=e.server,s=e.webGroupOptions,c=void 0===s?{topology:Dt.topology,signalingServer:Dt.signalingServer,rtcConfiguration:Dt.rtcConfiguration,autoRejoin:!1}:s;this.wcOptions=Object.assign({},Dt,{autoRejoin:!1},c),this.server=i,this.listenUrl=n,this.perMessageDeflate=r,this.webGroups=new Set,this.onWebGroup=function(){},this.onError=function(){},this.init()}return Object.defineProperty(e.prototype,"url",{get:function(){if(""!==this.listenUrl)return this.listenUrl;var e=this.server.address();return"ws://"+e.address+":"+e.port},enumerable:!0,configurable:!0}),e.prototype.getWebGroup=function(e){try{for(var t=zt(this.webGroups),n=t.next();!n.done;n=t.next()){var o=n.value;if(e===o.id)return o}}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=t.return)&&i.call(t)}finally{if(r)throw r.error}}var r,i},e.prototype.init=function(){var e=this;this.webSocketServer=new $t.Server({perMessageDeflate:this.perMessageDeflate,verifyClient:function(t){return e.validateConnection(t)},server:this.server}),(this.server||this.webSocketServer).on("listening",function(){return at.listen().next(e.url)}),this.webSocketServer.on("error",function(t){at.listen().next(""),e.onError(t)}),this.webSocketServer.on("connection",function(t){var n=Qt.parse(t.upgradeReq.url,!0),o=n.pathname,r=n.query,i=Number(r.wcId),s=e.getWebGroup(i),c=Number(r.senderId);switch(o){case"/invite":s&&1===s.members.length&&e.webGroups.delete(s),s=new Ut(e.wcOptions);var a=_t.get(s);a.id=i,e.webGroups.add(s),e.onWebGroup(s),new tt(a,t,{id:c});break;case"/internalChannel":void 0!==s?at.newIncomingSocket(_t.get(s),t,c):console.error("Cannot find WebChannel for a new internal channel")}})},e.prototype.validateConnection=function(e){var t=Qt.parse(e.req.url,!0),n=t.pathname,o=t.query,r=o.wcId?Number(o.wcId):void 0;switch(n){case"/invite":if(r){var i=this.getWebGroup(r);return(void 0===i||1===i.members.length)&&o.senderId}return!1;case"/internalChannel":return void 0!==o.senderId&&void 0!==r&&void 0!==this.getWebGroup(r);default:return!1}},e}(),Vt=function(){return function(e){Ft=new Xt(e),this.server=void 0,Reflect.defineProperty(this,"server",{configurable:!1,enumerable:!0,get:function(){return Ft.server}}),this.perMessageDeflate=void 0,Reflect.defineProperty(this,"perMessageDeflate",{configurable:!1,enumerable:!0,get:function(){return Ft.perMessageDeflate}}),this.webGroups=void 0,Reflect.defineProperty(this,"webGroups",{configurable:!1,enumerable:!0,get:function(){return Ft.webGroups}}),this.url=void 0,Reflect.defineProperty(this,"url",{configurable:!1,enumerable:!0,get:function(){return Ft.url}}),this.onWebGroup=void 0,Reflect.defineProperty(this,"onWebGroup",{configurable:!0,enumerable:!0,get:function(){return"none"===Ft.onWebGroup.name?void 0:Ft.onWebGroup},set:function(e){Ft.onWebGroup="function"!=typeof e?function(){}:e}}),this.onError=void 0,Reflect.defineProperty(this,"onError",{configurable:!0,enumerable:!0,get:function(){return"none"===Ft.onError.name?void 0:Ft.onError},set:function(e){Ft.onError="function"!=typeof e?function(){}:e}})}}();n.d(t,"WebGroup",function(){return Ut}),n.d(t,"WebGroupState",function(){return Gt}),n.d(t,"setLogLevel",function(){return qt}),n.d(t,"SignalingState",function(){return Wt}),n.d(t,"Topology",function(){return Ht}),n.d(t,"LogLevel",function(){return Jt}),n.d(t,"WebGroupBotServer",function(){return Vt})},function(e,t,n){"use strict";n.r(t);var o,r=function(){return function(e,t){this.id=e,this.pseudo=t}}(),i=n(1),s=n(0),c=function(){return function(e,t){this.service=e,this.content=t}}(),a=(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t}(c),l=function(){return function(e,t,n){this.id=e,this.key=t,this.created=n}}(),f=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),p=function(e){function t(t,n,o,r){var i=e.call(this,t,r)||this;return i.id=n,i.isBroadcast=o,i}return f(t,e),t}(c),h=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(c),g=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),b=function(e){function t(t,n,o){var r=e.call(this,t,o)||this;return r.id=n,r}return g(t,e),t}(c),y=n(4);const v=y.Reader,m=y.Writer,S=y.util,w=y.roots.default||(y.roots.default={}),O=w.sync=(()=>{const e={};return e.SyncMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.richLogootSOpMsg=null,e.prototype.querySync=null,e.prototype.replySync=null,Object.defineProperty(e.prototype,"type",{get:S.oneOfGetter(t=["richLogootSOpMsg","querySync","replySync"]),set:S.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.richLogootSOpMsg&&e.hasOwnProperty("richLogootSOpMsg")&&w.sync.RichLogootSOperationMsg.encode(e.richLogootSOpMsg,t.uint32(10).fork()).ldelim(),null!=e.querySync&&e.hasOwnProperty("querySync")&&w.sync.QuerySyncMsg.encode(e.querySync,t.uint32(18).fork()).ldelim(),null!=e.replySync&&e.hasOwnProperty("replySync")&&w.sync.ReplySyncMsg.encode(e.replySync,t.uint32(26).fork()).ldelim(),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.SyncMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.richLogootSOpMsg=w.sync.RichLogootSOperationMsg.decode(e,e.uint32());break;case 2:o.querySync=w.sync.QuerySyncMsg.decode(e,e.uint32());break;case 3:o.replySync=w.sync.ReplySyncMsg.decode(e,e.uint32());break;default:e.skipType(7&t)}}return o},e}(),e.RichLogootSOperationMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.id=0,e.prototype.clock=0,e.prototype.logootSAddMsg=null,e.prototype.logootSDelMsg=null,Object.defineProperty(e.prototype,"type",{get:S.oneOfGetter(t=["logootSAddMsg","logootSDelMsg"]),set:S.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).int32(e.id),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(16).int32(e.clock),null!=e.logootSAddMsg&&e.hasOwnProperty("logootSAddMsg")&&w.sync.LogootSAddMsg.encode(e.logootSAddMsg,t.uint32(26).fork()).ldelim(),null!=e.logootSDelMsg&&e.hasOwnProperty("logootSDelMsg")&&w.sync.LogootSDelMsg.encode(e.logootSDelMsg,t.uint32(34).fork()).ldelim(),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.RichLogootSOperationMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.id=e.int32();break;case 2:o.clock=e.int32();break;case 3:o.logootSAddMsg=w.sync.LogootSAddMsg.decode(e,e.uint32());break;case 4:o.logootSDelMsg=w.sync.LogootSDelMsg.decode(e,e.uint32());break;default:e.skipType(7&t)}}return o},e}(),e.LogootSAddMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=null,e.prototype.content="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.id&&e.hasOwnProperty("id")&&w.sync.IdentifierMsg.encode(e.id,t.uint32(10).fork()).ldelim(),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).string(e.content),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.LogootSAddMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.id=w.sync.IdentifierMsg.decode(e,e.uint32());break;case 2:o.content=e.string();break;default:e.skipType(7&t)}}return o},e}(),e.IdentifierMsg=function(){function e(e){if(this.tuples=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.tuples=S.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=m.create()),null!=e.tuples&&e.tuples.length)for(let n=0;n<e.tuples.length;++n)w.sync.IdentifierTupleMsg.encode(e.tuples[n],t.uint32(10).fork()).ldelim();return t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.IdentifierMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.tuples&&o.tuples.length||(o.tuples=[]),o.tuples.push(w.sync.IdentifierTupleMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return o},e}(),e.IdentifierTupleMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.random=0,e.prototype.replicaNumber=0,e.prototype.clock=0,e.prototype.offset=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.random&&e.hasOwnProperty("random")&&t.uint32(8).int32(e.random),null!=e.replicaNumber&&e.hasOwnProperty("replicaNumber")&&t.uint32(16).int32(e.replicaNumber),null!=e.clock&&e.hasOwnProperty("clock")&&t.uint32(24).int32(e.clock),null!=e.offset&&e.hasOwnProperty("offset")&&t.uint32(32).int32(e.offset),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.IdentifierTupleMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.random=e.int32();break;case 2:o.replicaNumber=e.int32();break;case 3:o.clock=e.int32();break;case 4:o.offset=e.int32();break;default:e.skipType(7&t)}}return o},e}(),e.LogootSDelMsg=function(){function e(e){if(this.lid=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.lid=S.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=m.create()),null!=e.lid&&e.lid.length)for(let n=0;n<e.lid.length;++n)w.sync.IdentifierIntervalMsg.encode(e.lid[n],t.uint32(10).fork()).ldelim();return t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.LogootSDelMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.lid&&o.lid.length||(o.lid=[]),o.lid.push(w.sync.IdentifierIntervalMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return o},e}(),e.IdentifierIntervalMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.idBegin=null,e.prototype.end=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.idBegin&&e.hasOwnProperty("idBegin")&&w.sync.IdentifierMsg.encode(e.idBegin,t.uint32(10).fork()).ldelim(),null!=e.end&&e.hasOwnProperty("end")&&t.uint32(16).int32(e.end),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.IdentifierIntervalMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.idBegin=w.sync.IdentifierMsg.decode(e,e.uint32());break;case 2:o.end=e.int32();break;default:e.skipType(7&t)}}return o},e}(),e.QuerySyncMsg=function(){function e(e){if(this.vector={},e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.vector=S.emptyObject,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=m.create()),null!=e.vector&&e.hasOwnProperty("vector"))for(let n=Object.keys(e.vector),o=0;o<n.length;++o)t.uint32(10).fork().uint32(8).int32(n[o]).uint32(16).int32(e.vector[n[o]]).ldelim();return t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n,o=void 0===t?e.len:e.pos+t,r=new w.sync.QuerySyncMsg;for(;e.pos<o;){let t=e.uint32();switch(t>>>3){case 1:e.skip().pos++,r.vector===S.emptyObject&&(r.vector={}),n=e.int32(),e.pos++,r.vector[n]=e.int32();break;default:e.skipType(7&t)}}return r},e}(),e.ReplySyncMsg=function(){function e(e){if(this.richLogootSOpsMsg=[],this.intervals=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.richLogootSOpsMsg=S.emptyArray,e.prototype.intervals=S.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=m.create()),null!=e.richLogootSOpsMsg&&e.richLogootSOpsMsg.length)for(let n=0;n<e.richLogootSOpsMsg.length;++n)w.sync.RichLogootSOperationMsg.encode(e.richLogootSOpsMsg[n],t.uint32(10).fork()).ldelim();if(null!=e.intervals&&e.intervals.length)for(let n=0;n<e.intervals.length;++n)w.sync.IntervalMsg.encode(e.intervals[n],t.uint32(18).fork()).ldelim();return t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.ReplySyncMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.richLogootSOpsMsg&&o.richLogootSOpsMsg.length||(o.richLogootSOpsMsg=[]),o.richLogootSOpsMsg.push(w.sync.RichLogootSOperationMsg.decode(e,e.uint32()));break;case 2:o.intervals&&o.intervals.length||(o.intervals=[]),o.intervals.push(w.sync.IntervalMsg.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return o},e}(),e.IntervalMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=0,e.prototype.begin=0,e.prototype.end=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.id&&e.hasOwnProperty("id")&&t.uint32(8).int32(e.id),null!=e.begin&&e.hasOwnProperty("begin")&&t.uint32(16).int32(e.begin),null!=e.end&&e.hasOwnProperty("end")&&t.uint32(24).int32(e.end),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.sync.IntervalMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.id=e.int32();break;case 2:o.begin=e.int32();break;case 3:o.end=e.int32();break;default:e.skipType(7&t)}}return o},e}(),e})(),I=w.collaborator=(()=>{const e={};return e.CollaboratorMsg=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.pseudo="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=m.create()),null!=e.pseudo&&e.hasOwnProperty("pseudo")&&t.uint32(10).string(e.pseudo),t},e.decode=function(e,t){e instanceof v||(e=v.create(e));let n=void 0===t?e.len:e.pos+t,o=new w.collaborator.CollaboratorMsg;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:o.pseudo=e.string();break;default:e.skipType(7&t)}}return o},e}(),e})();var j=function(){function e(){this.collaboratorChangePseudoSubject=new s.Subject,this.collaboratorJoinSubject=new s.Subject,this.collaboratorLeaveSubject=new s.Subject,this.disposeSubject=new s.Subject,this.msgToBroadcastSubject=new s.Subject,this.msgToSendRandomlySubject=new s.Subject,this.msgToSendToSubject=new s.Subject}return Object.defineProperty(e.prototype,"onCollaboratorChangePseudo",{get:function(){return this.collaboratorChangePseudoSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onCollaboratorJoin",{get:function(){return this.collaboratorJoinSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onCollaboratorLeave",{get:function(){return this.collaboratorLeaveSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToBroadcast",{get:function(){return this.msgToBroadcastSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendRandomly",{get:function(){return this.msgToSendRandomlySubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendTo",{get:function(){return this.msgToSendToSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leaveSource",{set:function(e){},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.disposeSubject),Object(i.filter)(function(t){return t.service===e.ID})).subscribe(function(e){var t=I.CollaboratorMsg.decode(e.content),o=e.id,i=t.pseudo;n.collaboratorChangePseudoSubject.next(new r(o,i))})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"peerJoinSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(t){n.emitPseudo(n.pseudonym,t);var o=new r(t,e.DEFAULT_PSEUDO);n.collaboratorJoinSubject.next(o)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"peerLeaveSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.collaboratorLeaveSubject.next(e)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pseudoSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.pseudonym=e,t.emitPseudo(e)})},enumerable:!0,configurable:!0}),e.prototype.emitPseudo=function(t,n){var o=I.CollaboratorMsg.create({pseudo:t});if(n){var r=new b(e.ID,n,I.CollaboratorMsg.encode(o).finish());this.msgToSendToSubject.next(r)}else{r=new u(e.ID,I.CollaboratorMsg.encode(o).finish());this.msgToBroadcastSubject.next(r)}return I.CollaboratorMsg.encode(o).finish()},e.prototype.dispose=function(){this.collaboratorChangePseudoSubject.complete(),this.collaboratorJoinSubject.complete(),this.collaboratorLeaveSubject.complete(),this.disposeSubject.next(),this.disposeSubject.complete(),this.msgToBroadcastSubject.complete(),this.msgToSendRandomlySubject.complete(),this.msgToSendToSubject.complete()},e.DEFAULT_PSEUDO="Anonymous",e.ID="Collaborators",e}(),M=n(2),k=function(){function e(e){var t=this;this.doc=new M.LogootSRopes(e),this.disposeSubject=new s.Subject,this.docDigestSubject=new s.Subject,this.docTreeSubject=new s.Subject,this.localLogootSOperationSubject=new s.Subject,this.remoteTextOperationsSubject=new s.Subject,this.updateSubject=new s.Subject,this.updateSubject.pipe(Object(i.takeUntil)(this.disposeSubject),Object(i.debounceTime)(1e3)).subscribe(function(){t.docTreeSubject.next(JSON.stringify(t.doc)),t.docDigestSubject.next(t.doc.digest())})}return Object.defineProperty(e.prototype,"initSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.docID=e})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localTextOperationsSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.handleTextOperations(e),t.updateSubject.next()})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteLogootSOperationSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){var n=e.map(function(e){return t.handleRemoteOperation(e)}).reduce(function(e,t){return e.concat(t)},[]);t.remoteTextOperationsSubject.next(n),t.updateSubject.next()})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDocDigest",{get:function(){return this.docDigestSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDocTree",{get:function(){return this.docTreeSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onLocalLogootSOperation",{get:function(){return this.localLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteTextOperations",{get:function(){return this.remoteTextOperationsSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.disposeSubject.next(),this.disposeSubject.complete(),this.localLogootSOperationSubject.complete(),this.remoteTextOperationsSubject.complete(),this.updateSubject.complete()},e.prototype.handleTextOperations=function(e){var t=this;e.forEach(function(e){var n=e.applyTo(t.doc);t.localLogootSOperationSubject.next(n)})},e.prototype.handleRemoteOperation=function(e){return e.execute(this.doc)},e.prototype.positionFromIndex=function(e){var t=this.doc.searchNode(e);if(null!==t){var n=t.node.actualBegin+t.i;return{id:M.Identifier.fromBase(t.node.getIdBegin(),n),index:t.i}}return null},e.prototype.indexFromId=function(e){return this.doc.searchPos(e,new Array)},e.prototype.setTitle=function(e){},e}(),T=n(7),E=function(){function e(e,t,n){this.id=e,this.begin=t,this.end=n}return e.prototype.equals=function(e){return this.id===e.id&&this.begin===e.begin&&this.end===e.end},e}(),C=function(){function e(e,t){this.richLogootSOps=e,this.intervals=t}return e.prototype.equals=function(e){return this.richLogootSOps.length===e.richLogootSOps.length&&this.intervals.length===e.intervals.length&&this.richLogootSOps.every(function(t,n){var o=e.richLogootSOps[n];return t.equals(o)})&&this.intervals.every(function(t,n){var o=e.intervals[n];return t.equals(o)})},e}(),P=function(){function e(e,t,n){this.id=e,this.clock=t,this.logootSOp=n}return e.fromPlain=function(t){if("object"==typeof t&&null!==t&&"number"==typeof t.id&&Number.isInteger(t.id)&&"number"==typeof t.clock&&Number.isInteger(t.clock)){var n=M.LogootSAdd.fromPlain(t.logootSOp);if(n instanceof M.LogootSAdd)return new e(t.id,t.clock,n);var o=M.LogootSDel.fromPlain(t.logootSOp);if(o instanceof M.LogootSDel)return new e(t.id,t.clock,o)}return null},e.prototype.equals=function(e){var t=this.id===e.id&&this.clock===e.clock;return this.logootSOp instanceof M.LogootSAdd&&e.logootSOp instanceof M.LogootSAdd?t&&this.logootSOp.equals(e.logootSOp):this.logootSOp instanceof M.LogootSDel&&e.logootSOp instanceof M.LogootSDel&&(t&&this.logootSOp.equals(e.logootSOp))},e}(),L=function(){return function(e,t){this.vector=e,this.richLogootSOps=t}}(),B=function(){function e(e){e&&e.forEach(function(e){console.assert(e>=0,"Each value of a state vector must be positive")}),this.vector=new Map(e)}return e.prototype.get=function(e){return this.vector.get(e)},e.prototype.set=function(e,t){console.assert(t>=0,"clock must be positive"),console.assert(this.isDeliverable(e,t)),this.vector.set(e,t)},e.prototype.clear=function(){this.vector.clear()},Object.defineProperty(e.prototype,"size",{get:function(){return this.vector.size},enumerable:!0,configurable:!0}),e.prototype.isAlreadyDelivered=function(e,t){var n=this.get(e);return void 0!==n&&n>=t},e.prototype.isDeliverable=function(e,t){if(this.isAlreadyDelivered(e,t))return!1;var n=this.get(e);return void 0===n?0===t:t===n+1},e.prototype.forEach=function(e){this.vector.forEach(e)},e.prototype.asMap=function(){return new Map(this.vector)},e.prototype.computeMissingIntervals=function(e){var t=this,n=[];return e.vector.forEach(function(e,o){var r=t.get(o);if(void 0===r){var i=0,s=e;n.push(new E(o,i,s))}else if(r<e){i=r+1,s=e;n.push(new E(o,i,s))}}),n},e}(),R=function(){function e(e){this.id=-1,this.clock=0,this.richLogootSOps=[],this.id=e,this.vector=new B,this.appliedOperationsSubject=new s.Subject,this.disposeSubject=new s.Subject,this.isReadySubject=new s.Subject,this.localRichLogootSOperationSubject=new s.Subject,this.querySyncSubject=new s.Subject,this.remoteLogootSOperationSubject=new s.Subject,this.replySyncSubject=new s.Subject,this.stateSubject=new s.Subject,this.triggerQuerySyncSubject=new s.Subject,this.initPeriodicQuerySync()}return Object.defineProperty(e.prototype,"onLocalRichLogootSOperation",{get:function(){return this.localRichLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onQuerySync",{get:function(){return this.querySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteLogootSOperation",{get:function(){return this.remoteLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onReplySync",{get:function(){return this.replySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onState",{get:function(){return this.stateSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return new L(this.vector.asMap(),this.richLogootSOps)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"localLogootSOperationSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){var n=new P(t.id,t.clock,e);t.updateState(n),t.stateSubject.next(t.state),t.localRichLogootSOperationSubject.next(n),t.clock++})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteQuerySyncSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){var n=t.computeMissingOps(e),o=t.vector.computeMissingIntervals(e),r=new C(n,o);t.replySyncSubject.next(r)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteReplySyncSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){e.richLogootSOps.length>0&&(t.applyRichLogootSOperations(e.richLogootSOps),t.stateSubject.next(t.state)),e.intervals.forEach(function(e){t.richLogootSOps.filter(function(t){var n=t.id,o=t.clock;return e.id===n&&e.begin<=o&&o<=e.end}).forEach(function(e){t.localRichLogootSOperationSubject.next(e)})})})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"remoteRichLogootSOperationSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.applyRichLogootSOperations([e]),t.stateSubject.next(t.state)})},enumerable:!0,configurable:!0}),e.prototype.setJoinAndStateSources=function(e,t){var n=this,o=e;t&&(this.storedStateSource=t,o=e.pipe(Object(i.takeUntil)(this.disposeSubject),Object(i.zip)(this.isReadySubject,function(e){return e}))),o.pipe(Object(i.take)(1)).subscribe(function(e){e.created||n.querySyncSubject.next(n.vector)})},e.prototype.computeMissingOps=function(e){return this.richLogootSOps.filter(function(t){var n=t.id,o=t.clock,r=e.get(n);return void 0===r||r<o})},e.prototype.dispose=function(){this.appliedOperationsSubject.complete(),this.disposeSubject.next(),this.disposeSubject.complete(),this.isReadySubject.complete(),this.localRichLogootSOperationSubject.complete(),this.querySyncSubject.complete(),this.remoteLogootSOperationSubject.complete(),this.replySyncSubject.complete(),this.stateSubject.complete()},Object.defineProperty(e.prototype,"storedStateSource",{set:function(e){var t=this;e.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(e){t.richLogootSOps=[],t.vector.clear(),t.applyRichLogootSOperations(e.richLogootSOps),t.isReadySubject.next()})},enumerable:!0,configurable:!0}),e.prototype.initPeriodicQuerySync=function(){var e=this;this.triggerQuerySyncSubject.pipe(Object(i.takeUntil)(this.disposeSubject)).subscribe(function(){e.querySyncSubject.next(e.vector),e.triggerPeriodicQuerySync()}),this.triggerPeriodicQuerySync()},e.prototype.triggerPeriodicQuerySync=function(){var e=this,t=Math.floor(2*Math.random()*5e3)+-5e3;setTimeout(function(){e.triggerQuerySyncSubject.next()},1e4+t)},e.prototype.applyRichLogootSOperations=function(e){var t=this,n=e.filter(function(e){var n=e.id,o=e.clock;return!t.vector.isAlreadyDelivered(n,o)});if(n.length>0){var o=[],r=[];n.forEach(function(e){var n=e.id,s=e.clock;t.vector.isDeliverable(n,s)?(t.updateState(e),o.push(e.logootSOp),r.push({id:n,clock:s})):t.vector.isAlreadyDelivered(n,s)||(console.log("SyncService: Buffering operation: ",{id:n,clock:s}),t.appliedOperationsSubject.pipe(Object(i.filter)(function(t){var n=t.id,o=t.clock;return e.id===n&&e.clock===o+1}),Object(i.take)(1)).subscribe(function(){console.log("SyncService: Delivering operation: ",{id:n,clock:s}),t.vector.isAlreadyDelivered(n,s)||t.applyRichLogootSOperations([e])}))}),this.remoteLogootSOperationSubject.next(o),r.forEach(function(e){t.appliedOperationsSubject.next(e)})}},e.prototype.updateState=function(e){console.assert(this.vector.isDeliverable(e.id,e.clock)),this.vector.set(e.id,e.clock),this.richLogootSOps.push(e)},e}(),N=n(18),x=function(){function e(){this.disposeSubject=new s.Subject,this.msgToBroadcastSubject=new s.Subject,this.msgToSendRandomlySubject=new s.Subject,this.msgToSendToSubject=new s.Subject,this.remoteQuerySyncSubject=new s.Subject,this.remoteQuerySyncIdSubject=new s.Subject,this.remoteRichLogootSOperationSubject=new s.Subject,this.remoteReplySyncSubject=new s.Subject}return Object.defineProperty(e.prototype,"localRichLogootSOperationSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.onDispose)).subscribe(function(t){var o=n.generateRichLogootSOpMsg(t),r=new u(e.ID,o);n.msgToBroadcastSubject.next(r)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.onDispose),Object(i.filter)(function(t){return t.service===e.ID})).subscribe(function(e){var t=O.SyncMsg.decode(e.content);switch(t.type){case"richLogootSOpMsg":n.handleRichLogootSOpMsg(t.richLogootSOpMsg);break;case"querySync":n.remoteQuerySyncIdSubject.next(e.id),n.handleQuerySyncMsg(t.querySync);break;case"replySync":n.handleReplySyncMsg(t.replySync)}})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"querySyncSource",{set:function(t){var n=this;t.pipe(Object(i.takeUntil)(this.onDispose)).subscribe(function(t){var o=n.generateQuerySyncMsg(t),r=new d(e.ID,o);n.msgToSendRandomlySubject.next(r)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"replySyncSource",{set:function(t){var n=this;Object(N.zip)(t,this.remoteQuerySyncIdSubject.asObservable(),function(e,t){return{id:t,replySyncEvent:e}}).pipe(Object(i.takeUntil)(this.onDispose)).subscribe(function(t){var o=t.id,r=t.replySyncEvent,i=n.generateReplySyncMsg(r.richLogootSOps,r.intervals),s=new b(e.ID,o,i);n.msgToSendToSubject.next(s)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{get:function(){return this.disposeSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToBroadcast",{get:function(){return this.msgToBroadcastSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendRandomly",{get:function(){return this.msgToSendRandomlySubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendTo",{get:function(){return this.msgToSendToSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteRichLogootSOperation",{get:function(){return this.remoteRichLogootSOperationSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteQuerySync",{get:function(){return this.remoteQuerySyncSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onRemoteReplySync",{get:function(){return this.remoteReplySyncSubject.asObservable()},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.disposeSubject.next(),this.disposeSubject.complete(),this.msgToBroadcastSubject.complete(),this.msgToSendRandomlySubject.complete(),this.msgToSendToSubject.complete(),this.remoteQuerySyncSubject.complete(),this.remoteQuerySyncIdSubject.complete(),this.remoteRichLogootSOperationSubject.complete(),this.remoteReplySyncSubject.complete()},e.prototype.handleRichLogootSOpMsg=function(e){var t=this.deserializeRichLogootSOperation(e);this.remoteRichLogootSOperationSubject.next(t)},e.prototype.handleQuerySyncMsg=function(e){var t=new Map;Object.keys(e.vector).forEach(function(n){var o=parseInt(n,10);t.set(o,e.vector[n])});var n=new B(t);this.remoteQuerySyncSubject.next(n)},e.prototype.handleReplySyncMsg=function(e){var t=this,n=e.richLogootSOpsMsg.map(function(e){return t.deserializeRichLogootSOperation(e)}),o=e.intervals.map(function(e){return new E(e.id,e.begin,e.end)}),r=new C(n,o);this.remoteReplySyncSubject.next(r)},e.prototype.generateRichLogootSOpMsg=function(e){var t=this.serializeRichLogootSOperation(e),n=O.SyncMsg.create({richLogootSOpMsg:t});return O.SyncMsg.encode(n).finish()},e.prototype.serializeRichLogootSOperation=function(e){var t=O.RichLogootSOperationMsg.create({id:e.id,clock:e.clock}),n=e.logootSOp;return n instanceof M.LogootSDel?t.logootSDelMsg=O.LogootSDelMsg.create(n):n instanceof M.LogootSAdd&&(t.logootSAddMsg=O.LogootSAddMsg.create(n)),t},e.prototype.deserializeRichLogootSOperation=function(e){var t,n=e.id,o=e.clock;if(e.logootSAddMsg){var r=e.logootSAddMsg;t=M.LogootSAdd.fromPlain(r)}else{var i=e.logootSDelMsg;t=M.LogootSDel.fromPlain(i)}return new P(n,o,t)},e.prototype.generateQuerySyncMsg=function(e){var t=O.QuerySyncMsg.create();e.forEach(function(e,n){t.vector[n]=e});var n=O.SyncMsg.create({querySync:t});return O.SyncMsg.encode(n).finish()},e.prototype.generateReplySyncMsg=function(e,t){var n=this,o=O.ReplySyncMsg.create();o.richLogootSOpsMsg=e.map(function(e){return n.serializeRichLogootSOperation(e)});var r=t.map(function(e){return O.IntervalMsg.create({id:e.id,begin:e.begin,end:e.end})});o.intervals=r;var i=O.SyncMsg.create({replySync:o});return O.SyncMsg.encode(i).finish()},e.ID="SyncMessage",e}(),D=function(){function e(e){this.initSubject=new s.Subject,this.collaboratorsService=new j,this.docService=new k(e),this.syncService=new R(e),this.syncMessageService=new x,this.docService.initSource=this.initSubject,this.docService.remoteLogootSOperationSource=this.syncService.onRemoteLogootSOperation,this.syncService.localLogootSOperationSource=this.docService.onLocalLogootSOperation,this.syncService.remoteQuerySyncSource=this.syncMessageService.onRemoteQuerySync,this.syncService.remoteReplySyncSource=this.syncMessageService.onRemoteReplySync,this.syncService.remoteRichLogootSOperationSource=this.syncMessageService.onRemoteRichLogootSOperation,this.syncMessageService.localRichLogootSOperationSource=this.syncService.onLocalRichLogootSOperation,this.syncMessageService.querySyncSource=this.syncService.onQuerySync,this.syncMessageService.replySyncSource=this.syncService.onReplySync}return Object.defineProperty(e.prototype,"messageSource",{set:function(e){this.collaboratorsService.messageSource=e,this.syncMessageService.messageSource=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onInit",{get:function(){return this.initSubject.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToBroadcast",{get:function(){return Object(T.merge)(this.collaboratorsService.onMsgToBroadcast,this.syncMessageService.onMsgToBroadcast)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendRandomly",{get:function(){return Object(T.merge)(this.collaboratorsService.onMsgToSendRandomly,this.syncMessageService.onMsgToSendRandomly)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMsgToSendTo",{get:function(){return Object(T.merge)(this.collaboratorsService.onMsgToSendTo,this.syncMessageService.onMsgToSendTo)},enumerable:!0,configurable:!0}),e.prototype.init=function(e){this.initSubject.next(e)},e.prototype.dispose=function(){this.collaboratorsService.dispose(),this.docService.dispose(),this.syncService.dispose(),this.syncMessageService.dispose()},e}();n.d(t,"Collaborator",function(){return r}),n.d(t,"CollaboratorsService",function(){return j}),n.d(t,"DocService",function(){return k}),n.d(t,"BroadcastMessage",function(){return u}),n.d(t,"JoinEvent",function(){return l}),n.d(t,"NetworkMessage",function(){return p}),n.d(t,"SendRandomlyMessage",function(){return d}),n.d(t,"SendToMessage",function(){return b}),n.d(t,"AbstractMessage",function(){return c}),n.d(t,"MuteCore",function(){return D}),n.d(t,"RichLogootSOperation",function(){return P}),n.d(t,"State",function(){return L})},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("mongoose")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(25);t.MongooseAdapter=class{constructor(){this.DocModel=o.model("Doc",new o.Schema({key:{type:String,require:!0},operations:Array}))}connect(e,t){return o.connection.on("close",()=>log.warn("Connection to the database has been closed")),o.connect(`mongodb://${e}/${t}`)}find(e){return this.DocModel.findOne({key:e}).exec()}list(){return this.DocModel.find().exec()}whichExist(e){return this.DocModel.find({key:{$in:e}}).exec().then(e=>{if(null!==e)return e.map(e=>e.key)})}create(e){return this.DocModel.create({key:e})}}},function(e,t){e.exports=require("bunyan")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(27);t.createLogger=function(e,t){let n;const r={name:"mute-bot-storage"};switch(""!==e&&(r.streams=[{type:"rotating-file",period:"1d",count:3,path:`${e}/${r.name}.log`}]),n=o.createLogger(r),t){case"none":n.level(o.FATAL+1);break;case"trace":n.level(o.TRACE);break;case"debug":n.level(o.DEBUG);break;case"info":n.level(o.INFO);break;case"warn":n.level(o.WARN);break;case"error":n.level(o.ERROR);break;case"fatal":n.level(o.FATAL);break;default:n.level(o.INFO)}return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.Keys=t.BotResponse=t.BotProtocol=t.Message=void 0;var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4));var r=o.Reader,i=o.Writer,s=o.util,c=o.roots.default||(o.roots.default={});t.Message=c.Message=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.service="",e.prototype.content=s.newBuffer([]),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=i.create()),null!=e.service&&e.hasOwnProperty("service")&&t.uint32(10).string(e.service),null!=e.content&&e.hasOwnProperty("content")&&t.uint32(18).bytes(e.content),t},e.decode=function(e,t){e instanceof r||(e=r.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new c.Message;e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:o.service=e.string();break;case 2:o.content=e.bytes();break;default:e.skipType(7&i)}}return o},e}(),t.BotProtocol=c.BotProtocol=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.key="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=i.create()),null!=e.key&&e.hasOwnProperty("key")&&t.uint32(10).string(e.key),t},e.decode=function(e,t){e instanceof r||(e=r.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new c.BotProtocol;e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:o.key=e.string();break;default:e.skipType(7&i)}}return o},e}(),t.BotResponse=c.BotResponse=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.url="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=i.create()),null!=e.url&&e.hasOwnProperty("url")&&t.uint32(10).string(e.url),t},e.decode=function(e,t){e instanceof r||(e=r.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new c.BotResponse;e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:o.url=e.string();break;default:e.skipType(7&i)}}return o},e}(),t.Keys=c.Keys=function(){function e(e){if(this.keys=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.keys=s.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=i.create()),null!=e.keys&&e.keys.length)for(var n=0;n<e.keys.length;++n)t.uint32(10).string(e.keys[n]);return t},e.decode=function(e,t){e instanceof r||(e=r.create(e));for(var n=void 0===t?e.len:e.pos+t,o=new c.Keys;e.pos<n;){var i=e.uint32();switch(i>>>3){case 1:o.keys&&o.keys.length||(o.keys=[]),o.keys.push(e.string());break;default:e.skipType(7&i)}}return o},e}();t.default=c},function(e,t){e.exports=require("rxjs")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compareBase=function(e,t){var n=e.idBegin,o=e.begin,r=e.end,i=t.idBegin,s=t.begin,c=t.end;return n.equalsBase(i)?o===s&&r===c?6:r+1===s?4:o===c+1?5:r<s?1:c<o?0:(console.warn("Trying to duplicate existing identifiers: ",e,t),6):function(e,t){var n=e.idBegin,o=t.idBegin;return console.assert(!n.equalsBase(o),"the bases of the ids must be different"),e.containsId(o)?3:t.containsId(n)?2:-1===n.compareTo(o)?1:0}(e,t)}},function(e,t,n){"use strict";var o=this&&this.__generator||function(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=o[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),i=n(9),s=n(3),c=new i.IdentifierTuple(s.INT32_BOTTOM,0,0,0),a=new i.IdentifierTuple(s.INT32_TOP,0,0,0);function u(e,t){var n,r;return o(this,function(o){switch(o.label){case 0:n=0,r=e,o.label=1;case 1:return n<r.length?[4,r[n]]:[3,4];case 2:o.sent(),o.label=3;case 3:return n++,[3,1];case 4:return[4,t];case 5:return o.sent(),[3,4];case 6:return[2]}})}function l(e){return null!==e?e.tuples:[]}t.createBetweenPosition=function(e,t,n,o){console.assert(null===e||null===t||-1===e.compareTo(t),"id1 < id2"),console.assert(s.isInt32(n),"replicaNumber is an int32"),console.assert(s.isInt32(o),"clock is an int32");for(var f=u(l(e),c),p=u(l(t),a),h=[],d=f.next().value,g=p.next().value;g.random-d.random<2;)h.push(d),d=f.next().value,g=p.next().value;var b=s.randomInt32(d.random+1,g.random);return h.push(new i.IdentifierTuple(b,n,o,0)),new r.Identifier(h)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=n(5),i=n(32),s=n(3),c=n(31),a=n(16),u=n(8),l=n(15),f=n(14),p=n(13),h=n(12),d=n(11);function g(e){return e.left}function b(e){return e.right}var y=function(){function e(e,t,n,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),void 0===o&&(o=""),console.assert(s.isInt32(e),"replica ∈ int32"),console.assert(s.isInt32(t),"clock ∈ int32"),this.replicaNumber=e,this.clock=t,this.root=n,this.str=o;var r={};if(null!==n){console.assert(o.length===n.sizeNodeAndChildren,"str length must match the number of elements in the model");for(var i=0,c=n.getBlocks();i<c.length;i++){var a=c[i];r[a.idInterval.base.join(",")]=a}}else console.assert(0===o.length,"str must be empty when no root is provided");this.mapBaseToBlock=r}return e.empty=function(){return new e(0,0)},e.fromPlain=function(t,n,o){if(console.assert(s.isInt32(t),"replica ∈ int32"),console.assert(s.isInt32(n),"clock ∈ int32"),"object"==typeof o&&null!==o){var r=o.str,i=o.root;if("string"==typeof r){var c=f.RopesNodes.fromPlain(i);if(null!==c&&r.length===c.sizeNodeAndChildren)return new e(t,n,c,r)}}return null},e.prototype.getBlock=function(e){var t,n=this.mapBaseToBlock,o=e.base.join(",");return n.hasOwnProperty(o)?t=n[o]:(t=new u.LogootSBlock(e,0),this.mapBaseToBlock[o]=t),t},e.prototype.addBlockFrom=function(e,t,n,o){var r=this,i=this.addBlockFromRec(e,t,n,o);return i.forEach(function(e){r.applyTextInsert(e)}),i},e.prototype.addBlockFromRec=function(e,t,n,i){for(var s=[],a=[],u=!0,l=i;u;)switch(s.push(n),c.compareBase(t,n.getIdentifierInterval())){case 0:null===n.right?(n.right=f.RopesNodes.leaf(this.getBlock(t),t.begin,e.length),l=l+n.leftSubtreeSize()+n.length,a.push(new h.TextInsert(l,e)),u=!1):(l=l+n.leftSubtreeSize()+n.length,n=n.right);break;case 1:null===n.left?(n.left=f.RopesNodes.leaf(this.getBlock(t),t.begin,e.length),a.push(new h.TextInsert(l,e)),u=!1):n=n.left;break;case 2:var p=n.getIdBegin().length-1,d=t.idBegin.tuples[p].offset,g=f.RopesNodes.leaf(this.getBlock(t),t.begin,e.length);s.push(n.split(d-n.actualBegin+1,g)),l+=n.leftSubtreeSize(),a.push(new h.TextInsert(l+d-n.actualBegin+1,e)),u=!1;break;case 3:p=t.idBegin.length-1,d=n.getIdBegin().tuples[p].offset;var b=e.substr(0,d+1-t.begin),y=new r.IdentifierInterval(t.idBegin,d);null===n.left?(n.left=f.RopesNodes.leaf(this.getBlock(y),y.begin,b.length),a.push(new h.TextInsert(l,b))):Array.prototype.push.apply(a,this.addBlockFromRec(b,y,n.left,l)),b=e.substr(d+1-t.begin,e.length);var v=o.Identifier.fromBase(t.idBegin,d+1);y=new r.IdentifierInterval(v,t.end),l=l+n.leftSubtreeSize()+n.length,null===n.right?(n.right=f.RopesNodes.leaf(this.getBlock(y),y.begin,b.length),a.push(new h.TextInsert(l,b))):Array.prototype.push.apply(a,this.addBlockFromRec(b,y,n.right,l)),u=!1;break;case 4:if(null!==n.left){var m=n.getIdBegin().minOffsetAfterPrev(n.left.getIdEnd(),t.begin);(S=e.substr(m-t.begin,e.length)).length>0&&(n.appendBegin(S.length),a.push(new h.TextInsert(l+n.leftSubtreeSize(),S)),this.ascendentUpdate(s,S.length)),m-1>=t.begin?(e=e.substr(0,m-t.begin),t=new r.IdentifierInterval(t.idBegin,m-1),n=n.left):u=!1}else a.push(new h.TextInsert(l,e)),n.appendBegin(e.length),this.ascendentUpdate(s,e.length),u=!1;break;case 5:if(null!==n.right){m=n.getIdEnd().maxOffsetBeforeNext(n.right.getIdBegin(),t.end);var S=e.substr(0,m+1-t.begin);if(l=l+n.leftSubtreeSize()+n.length,S.length>0&&(n.appendEnd(S.length),a.push(new h.TextInsert(l,S)),this.ascendentUpdate(s,S.length)),t.end>=m+1){e=e.substr(m+1-t.begin,e.length);v=o.Identifier.fromBase(t.idBegin,m+1);t=new r.IdentifierInterval(v,t.end),n=n.right,l+=S.length}else u=!1}else l=l+n.leftSubtreeSize()+n.length,a.push(new h.TextInsert(l,e)),n.appendEnd(e.length),this.ascendentUpdate(s,e.length),u=!1;break;case 6:u=!1}return this.balance(s),a},e.prototype.applyTextInsert=function(e){this.str=d.insert(this.str,e.offset,e.content)},e.prototype.applyTextDelete=function(e){var t=e.offset+e.length-1;this.str=d.del(this.str,e.offset,t)},e.prototype.addBlock=function(e,t){var n=new r.IdentifierInterval(t,t.lastOffset+e.length-1);if(null===this.root){var o=new u.LogootSBlock(n,0);this.mapBaseToBlock[o.idInterval.base.join(",")]=o,this.root=f.RopesNodes.leaf(o,t.lastOffset,e.length);var i=new h.TextInsert(0,e);return this.applyTextInsert(i),[i]}return this.addBlockFrom(e,n,this.root,0)},e.prototype.mkNode=function(e,t,n){console.assert(s.isInt32(n)&&n>0,"length ∈ int32"),console.assert(n>0,"length > 0");var o=i.createBetweenPosition(e,t,this.replicaNumber,this.clock++),c=new r.IdentifierInterval(o,n-1),a=new u.LogootSBlock(c,0);return this.mapBaseToBlock[c.base.join(",")]=a,f.RopesNodes.leaf(a,0,n)},e.prototype.insertLocal=function(e,t){if(console.assert(s.isInt32(e),"pos ∈ int32"),null===this.root)return this.root=this.mkNode(null,null,t.length),this.str=d.insert(this.str,e,t),new a.LogootSAdd(this.root.getIdBegin(),t);var n=void 0,o=this.str.length;this.str=d.insert(this.str,e,t);var r=void 0;if(0===e){if((r=[]).push(this.root),(c=this.getXest(g,r)).isAppendableBefore(this.replicaNumber,t.length)){var i=c.appendBegin(t.length);return this.ascendentUpdate(r,t.length),new a.LogootSAdd(i,t)}n=this.mkNode(null,c.getIdBegin(),t.length),c.left=n}else if(e>=o){var c;if((r=[]).push(this.root),(c=this.getXest(b,r)).isAppendableAfter(this.replicaNumber,t.length)){var u=c.appendEnd(t.length);return this.ascendentUpdate(r,t.length),new a.LogootSAdd(u,t)}n=this.mkNode(c.getIdEnd(),null,t.length),c.right=n}else{var l=this.searchNode(e);if(l.i>0){var f=l.node.block.idInterval.getBaseId(l.node.actualBegin+l.i-1),p=l.node.block.idInterval.getBaseId(l.node.actualBegin+l.i);n=this.mkNode(f,p,t.length),(r=l.path).push(l.node.split(l.i,n))}else{var h=this.searchNode(e-1);if(l.node.isAppendableBefore(this.replicaNumber,t.length)){var y=l.node.appendBegin(t.length);return this.ascendentUpdate(l.path,t.length),new a.LogootSAdd(y,t)}if(h.node.isAppendableAfter(this.replicaNumber,t.length)){var v=h.node.appendEnd(t.length);return this.ascendentUpdate(h.path,t.length),new a.LogootSAdd(v,t)}(n=this.mkNode(h.node.getIdEnd(),l.node.getIdBegin(),t.length)).right=h.node.right,h.node.right=n,(r=h.path).push(n)}}return this.balance(r),new a.LogootSAdd(n.getIdBegin(),t)},e.prototype.getXest=function(e,t){for(var n=t[t.length-1],o=e(n);null!==o;)n=o,t[t.length]=o,o=e(o);return n},e.prototype.searchPos=function(e,t){for(var n=0,o=this.root;null!==o;)if(t.push(o),-1===e.compareTo(o.getIdBegin()))o=o.left;else if(1===e.compareTo(o.getIdEnd()))n=n+o.leftSubtreeSize()+o.length,o=o.right;else{if(e.equalsBase(o.getIdBegin()))return n+o.leftSubtreeSize();o=null}return-1},e.prototype.searchNode=function(e){console.assert(s.isInt32(e),"pos ∈ int32");for(var t=this.root,n=[];null!==t;){n.push(t);var o=t.leftSubtreeSize();if(e<o)t=t.left;else{if(e<o+t.length)return{i:e-o,node:t,path:n};e-=o+t.length,t=t.right}}return null},e.prototype.ascendentUpdate=function(e,t){console.assert(s.isInt32(t),"length ∈ int32");for(var n=0,o=e;n<o.length;n++){o[n].addString(t)}},e.prototype.delBlock=function(e){for(var t,n=this,i=[];;){var s=[];if(-1===(t=this.searchPos(e.idBegin,s))){if(!(e.begin<e.end))break;var c=o.Identifier.fromBase(e.idBegin,e.begin+1);e=new r.IdentifierInterval(c,e.end)}else{var a=s[s.length-1],u=Math.min(e.end,a.actualEnd),l=t+e.begin-a.actualBegin,f=u-e.begin+1;i.push(new p.TextDelete(l,f));var h=a.deleteOffsets(e.begin,u);if(0===a.length?this.delNode(s):null!==h?(s.push(h),this.balance(s)):this.ascendentUpdate(s,e.begin-u-1),u===e.end)break;c=o.Identifier.fromBase(e.idBegin,u);e=new r.IdentifierInterval(c,e.end)}}return i.forEach(function(e){n.applyTextDelete(e)}),i},e.prototype.delLocal=function(e,t){console.assert(s.isInt32(e),"begin ∈ int32"),console.assert(s.isInt32(t),"end ∈ int32"),console.assert(e<=t,""+e," <= "+t),this.str=d.del(this.str,e,t);var n=t-e+1,i=[];do{var c=this.searchNode(e);if(null!==c){var a=c.node.actualBegin+c.i,u=Math.min(a+n-1,c.node.actualEnd),f=c.node.getIdBegin(),p=o.Identifier.fromBase(f,a);i.push(new r.IdentifierInterval(p,u));var h=c.node.deleteOffsets(a,u);n-=u-a+1,0===c.node.length?this.delNode(c.path):null!==h?(c.path.push(h),this.balance(c.path)):this.ascendentUpdate(c.path,a-u-1)}else n=0}while(n>0);return new l.LogootSDel(i)},e.prototype.delNode=function(e){var t=e[e.length-1];if(0===t.block.nbElement&&delete this.mapBaseToBlock[t.block.idInterval.base.join(",")],null===t.right)t===this.root?this.root=t.left:(e.pop(),e[e.length-1].replaceChildren(t,t.left));else if(null===t.left)t===this.root?this.root=t.right:(e.pop(),e[e.length-1].replaceChildren(t,t.right));else{e.push(t.right);var n=this.getMinPath(e);t.become(n),e.pop(),e[e.length-1].replaceChildren(n,n.right)}this.balance(e)},e.prototype.getMinPath=function(e){console.assert(0!==e.length,"path has at least one item");for(var t=e[e.length-1];null!==t.left;)t=t.left,e.push(t);return t},e.prototype.balance=function(e){for(;e.length>0;){var t=e.pop(),n=0===e.length?null:e[e.length-1];t.sumDirectChildren();for(var o=t.balanceScore();Math.abs(o)>=2;)n=o>=2?null!==t.right&&t.right.balanceScore()<=-1?this.rotateRL(t,n):this.rotateLeft(t,n):null!==t.left&&t.left.balanceScore()>=1?this.rotateLR(t,n):this.rotateRight(t,n),e.push(n),o=t.balanceScore()}},e.prototype.rotateLeft=function(e,t){console.assert(null!==e.right,"There exists a right node"),console.assert(e===this.root==(null===t),"The father is null when we are rotating left the root");var n=e.right;return e===this.root?this.root=n:t.replaceChildren(e,n),e.right=n.left,n.left=e,e.sumDirectChildren(),n.sumDirectChildren(),n},e.prototype.rotateRight=function(e,t){console.assert(null!==e.left,"There exists a left node"),console.assert(e===this.root==(null===t),"The father is null when we are rotating right the root");var n=e.left;return e===this.root?this.root=n:t.replaceChildren(e,n),e.left=n.right,n.right=e,e.sumDirectChildren(),n.sumDirectChildren(),n},e.prototype.rotateRL=function(e,t){console.assert(null!==e.right,"There exists a right node");var n=e.right;return console.assert(null!==n.left,"There exists a left node of the right node"),this.rotateRight(n,e),this.rotateLeft(e,t)},e.prototype.rotateLR=function(e,t){console.assert(null!==e.left,"There exists a left node");var n=e.left;return console.assert(null!==n.right,"There exists a right node of the left node"),this.rotateLeft(n,e),this.rotateRight(e,t)},e.prototype.getNext=function(e){var t=e[e.length-1];if(null===t.right){if(e.length>1)if(e[e.length-2].left===t)return e.pop(),!0;return!1}return e.push(t.right),this.getXest(g,e),!0},e.prototype.digest=function(){var e=0,t=this.root;if(null!==t)for(var n=0,o=t.toList();n<o.length;n++){e=17*e+o[n].digest()|0}return e},e}();t.LogootSRopes=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDot=function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.replicaNumber&&Number.isInteger(e.replicaNumber)&&"number"==typeof e.clock&&Number.isInteger(e.clock)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(22),r=n(30),i=n(29),s=6e4;t.BotStorage=class{constructor(e,t,n){this.pseudonym=e,this.wg=t,this.mongooseAdapter=n,this.joinSubject=new r.Subject,this.messageSubject=new r.ReplaySubject,this.peerJoinSubject=new r.ReplaySubject,this.peerLeaveSubject=new r.ReplaySubject,this.stateSubject=new r.Subject,this.saveInterval=setInterval(()=>{this.mongoDoc&&this.save()},s),t.onMessage=((e,n)=>{const r=i.Message.decode(n);"botprotocol"===r.service?(this.key=i.BotProtocol.decode(r.content).key,this.mongooseAdapter.find(this.key).then(e=>e?(log.info(`Document "${this.key}" retreived from database`),e):(log.info(`"${this.key}" document was not found in database: a new document has been created`),this.mongooseAdapter.create(this.key))).then(e=>{this.mongoDoc=e,this.operations=e.get("operations").map(e=>o.RichLogootSOperation.fromPlain(e)),this.initMuteCore(),this.joinSubject.next(new o.JoinEvent(this.wg.myId,this.key,!1)),this.stateSubject.next(new o.State(new Map,this.operations))}).catch(e=>{log.error(`Error when searching for the document ${this.key}`,e)}),t.onMessage=((e,t)=>{const n=i.Message.decode(t);this.messageSubject.next(new o.NetworkMessage(n.service,e,!0,n.content))})):this.messageSubject.next(new o.NetworkMessage(r.service,e,!0,r.content))}),t.onMemberJoin=(e=>this.peerJoinSubject.next(e)),t.onMemberLeave=(e=>this.peerLeaveSubject.next(e))}init(){this.wg.sendTo(this.wg.members[1],this.encode({service:"botprotocol",content:i.BotProtocol.encode(i.BotProtocol.create({key:""})).finish()}))}clean(){this.save(),global.clearInterval(this.saveInterval)}save(){this.lastReceivedState!==this.lastSaveState&&(log.info("Saving document: "+this.key),this.mongoDoc.set({operations:this.lastReceivedState.richLogootSOps}),this.mongoDoc.save(),this.lastSaveState=this.lastReceivedState)}initMuteCore(){this.muteCore=new o.MuteCore(42),this.muteCore.messageSource=this.messageSubject.asObservable(),this.muteCore.onMsgToBroadcast.subscribe(e=>{this.wg.send(this.encode(e))}),this.muteCore.onMsgToSendRandomly.subscribe(e=>{const t=this.wg.members.filter(e=>e!==this.wg.myId),n=Math.ceil(Math.random()*t.length)-1;this.wg.sendTo(t[n],this.encode(e))}),this.muteCore.onMsgToSendTo.subscribe(e=>{this.wg.sendTo(e.id,this.encode(e))}),this.muteCore.collaboratorsService.peerJoinSource=this.peerJoinSubject.asObservable(),this.muteCore.collaboratorsService.peerLeaveSource=this.peerLeaveSubject.asObservable();const e=new r.BehaviorSubject(this.pseudonym);this.muteCore.collaboratorsService.pseudoSource=e.asObservable(),this.muteCore.syncService.onState.subscribe(e=>this.lastReceivedState=e),this.muteCore.syncService.setJoinAndStateSources(this.joinSubject.asObservable(),this.stateSubject.asObservable()),this.muteCore.init(this.key)}encode(e){return i.Message.encode(i.Message.create(e)).finish()}}},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("text-encoding")},function(e,t,n){"use strict";try{var o=n(!function(){var e=new Error('Cannot find module "wrtc"');throw e.code="MODULE_NOT_FOUND",e}());global.RTCPeerConnection=o.RTCPeerConnection,global.RTCDataChannel=o.RTCDataChannel,global.RTCIceCandidate=o.RTCIceCandidate}catch(e){console.warn(e.message)}global.WebSocket=n(17);var r=n(38);global.TextEncoder=r.TextEncoder,global.TextDecoder=r.TextDecoder,global.crypto=n(37),global.Event=function(){return function(e){this.name=e}}()},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("kcors")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("commander")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(45),i=n(44),s=n(43),c=n(42),a=n(41),u=n(40),l=n(21),f=n(35),p=n(28),h=n(26),d="Repono",g="0.0.0.0",b=2e4,y="ws://localhost:20000",v="ws://localhost:10000",m="mutedocs",S="info",w="";if(r.option("-n, --name <bot name>",`Bot name. Default: "${d}"`,d).option("-h, --host <ip or host name>",`Host address to bind to, Default: "${g}"`,g).option("-p, --port <n>",`Port to use for the server. Default: ${b}`,b).option("-b, --botURL <n>",`Bot public URL, to be shared on the p2p network. Default: ${y}`,y).option("-d, --database <n>",`Database name. Default: ${m}`,m).option("-s, --signalingURL <url>",`Signaling server url. Default: ${v}\n`,v).option("-t, --https","If present, the REST API server is listening on HTTPS instead of HTTP").option("-k, --key <value>","Private key for the certificate").option("-c, --cert <value>","The server certificate").option("-a, --ca <value>","The additional intermediate certificate or certificates that web browsers\n      will need in order to validate the server certificate.").option("-l, --logLevel <none|trace|debug|info|warn|error|fatal>",'Logging level. Default: "info". ',/^(none|trace|debug|info|warn|error|fatal)$/i,S).option("-f, --logFolder <path>","Path to where log files would be stored.\n                              If not specified stdout will used.",w).parse(process.argv),!r.host)throw new Error("-h, --host options is required");const{name:O,host:I,port:j,botURL:M,signalingURL:k,database:T,key:E,cert:C,ca:P,logLevel:L,logFolder:B}=r;global.log=p.createLogger(B,L),process.on("uncaughtException",e=>log.fatal(e));const R=new h.MongooseAdapter;R.connect("localhost",T).then(()=>{log.info("Connected to the database  ✓");const e=new c,t=new u;return t.get("/name",(e,t)=>{e.body=O}).post("/exist",(e,t)=>o(this,void 0,void 0,function*(){const t=e.request.body,n=yield R.whichExist(t);e.body=JSON.stringify(n)})).get("/docs",(e,t)=>o(this,void 0,void 0,function*(){yield R.list().then(t=>{const n=t.map(e=>({id:e.get("key")}));e.body=n}).catch(t=>{log.error("Could not retreive the document list stored in database",t),e.status=500})})),e.use(s()).use(a()).use(t.routes()).use(t.allowedMethods())}).then(e=>{if(log.info("Configured routes  ✓"),E&&C&&P){const t=n(24);return n(23).createServer({key:t.readFileSync(E),cert:t.readFileSync(C),ca:t.readFileSync(P)},e.callback())}return i.createServer(e.callback())}).then(e=>{return log.info("Configured server  ✓"),new l.WebGroupBotServer({url:M,server:e,webGroupOptions:{signalingServer:k}}).onWebGroup=(e=>{log.info("New peer to peer network invitation received. Waiting for a document key...");const t=new f.BotStorage(O,e,R);e.onStateChange=(e=>{e===l.WebGroupState.JOINED&&t.init(),e===l.WebGroupState.LEFT&&t.clean()})}),new Promise((t,n)=>{e.listen(j,I,t)})}).then(()=>{log.info(`Successfully started the storage bot server at ${I}:${j} with the following settings`,{name:O,host:I,port:j,botURL:M,signalingURL:k,logLevel:L,logFolder:B})}).catch(e=>{log.fatal(e)})}]);